<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>TIPS: /renoir/fourmano/Desktop/OUSIM/TIPS/branches/tips_build/src/axesim/drz2pet_utils.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>/renoir/fourmano/Desktop/OUSIM/TIPS/branches/tips_build/src/axesim/drz2pet_utils.c File Reference</h1><code>#include &lt;gsl/gsl_vector.h&gt;</code><br/>
<code>#include &lt;gsl/gsl_matrix.h&gt;</code><br/>
<code>#include &quot;<a class="el" href="aXe__grism_8h_source.html">aXe_grism.h</a>&quot;</code><br/>
<code>#include &lt;math.h&gt;</code><br/>
<code>#include &lt;string.h&gt;</code><br/>
<code>#include &lt;ctype.h&gt;</code><br/>
<code>#include &quot;<a class="el" href="drz2pet__utils_8h_source.html">drz2pet_utils.h</a>&quot;</code><br/>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Namespaces</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">namespace &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacedrz2pet__utils.html">drz2pet_utils</a></td></tr>
<tr><td colspan="2"><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="structap__pixel.html">ap_pixel</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="drz2pet__utils_8c.html#a9c231344c8a2af0c74777dd4b13ed22f">make_spc_drztable</a> (<a class="el" href="structobservation.html">observation</a> *const obs, <a class="el" href="structobservation.html">observation</a> *const wobs, const <a class="el" href="structobject.html">object</a> *ob, const double lambda0, const double dlambda)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="drz2pet__utils_8c.html#a3c3ec826594e43ab1fec0ad549fac954">get_ID_num</a> (char *grism_image, char *extname)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="drz2pet__utils_8c.html#ad70f842615bbd5d0277252f63e7564a7">normalize_weight</a> (<a class="el" href="structobservation.html">observation</a> *wobs, <a class="el" href="structobject.html">object</a> *ob, const int opt_extr)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">gsl_matrix *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="drz2pet__utils_8c.html#a57174076d9e90251f8a3cf8681d679d3">comp_equ_weight</a> (gsl_matrix *exp_map, const <a class="el" href="structobject.html">object</a> *ob)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">gsl_matrix *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="drz2pet__utils_8c.html#aa6f230c18a0868f3cf4357d413b9015c">comp_exp_weight</a> (gsl_matrix *exp_map, const <a class="el" href="structobject.html">object</a> *ob)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">gsl_matrix *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="drz2pet__utils_8c.html#a93ff2fe5d61878d9a772cdf10406e81d">comp_opt_weight</a> (gsl_matrix *mod_map, gsl_matrix *var_map, const <a class="el" href="structobject.html">object</a> *ob)</td></tr>
</table>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="a57174076d9e90251f8a3cf8681d679d3"></a><!-- doxytag: member="drz2pet_utils.c::comp_equ_weight" ref="a57174076d9e90251f8a3cf8681d679d3" args="(gsl_matrix *exp_map, const object *ob)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">gsl_matrix* comp_equ_weight </td>
          <td>(</td>
          <td class="paramtype">gsl_matrix *&nbsp;</td>
          <td class="paramname"> <em>exp_map</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structobject.html">object</a> *&nbsp;</td>
          <td class="paramname"> <em>ob</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p><div class="fragment"><pre class="fragment"><a name="l00201"></a>00201 {
<a name="l00202"></a>00202   <a class="code" href="aXe__grism_8h.html#a6117e17bb3108107676f4486e62d40e5">gsl_matrix</a> *weight;
<a name="l00203"></a>00203   <span class="keywordtype">int</span> i, j;
<a name="l00204"></a>00204   <span class="keywordtype">int</span> beamInt = 0;
<a name="l00205"></a>00205 
<a name="l00206"></a>00206   <span class="comment">// allocate the matrix and set it to the default</span>
<a name="l00207"></a>00207   weight = <a class="code" href="aXe__grism_8h.html#a1214ab1bea5fd80474d7a27db0bfb429">gsl_matrix_alloc</a>(exp_map-&gt;size1, exp_map-&gt;size2);
<a name="l00208"></a>00208   <a class="code" href="aXe__grism_8h.html#af6161aeb008a1ffa7d888df6ccbef7cc">gsl_matrix_set_all</a>(weight, 0.0);
<a name="l00209"></a>00209 
<a name="l00210"></a>00210    <span class="comment">// go over all columns</span>
<a name="l00211"></a>00211   <span class="keywordflow">for</span> (i=0; i &lt; exp_map-&gt;size1; i++)
<a name="l00212"></a>00212     <span class="comment">// go over all rows</span>
<a name="l00213"></a>00213     <span class="keywordflow">for</span> (j=0; j &lt; exp_map-&gt;size2; j++)
<a name="l00214"></a>00214       <span class="comment">// check whether the pixel is inside the extraction</span>
<a name="l00215"></a>00215       <span class="comment">// area and has a positive exposure time</span>
<a name="l00216"></a>00216       <span class="keywordflow">if</span> (fabs(ob-&gt;<a class="code" href="structobject.html#ad643757142781f8265b430e19700cfe5">beams</a>[beamInt].<a class="code" href="structbeam.html#a54c64670a8b3e8732c1468d156ddb0ca">refpoint</a>.<a class="code" href="structd__point.html#ad9846a025508bf8873a501ca5fcefbf4">y</a>-(<span class="keywordtype">double</span>)j) &lt;= ob-&gt;<a class="code" href="structobject.html#ad643757142781f8265b430e19700cfe5">beams</a>[beamInt].<a class="code" href="structbeam.html#ae99ff960c070381b6e76af5a58cb9c45">width</a>+0.5 &amp;&amp;
<a name="l00217"></a>00217           <a class="code" href="aXe__grism_8h.html#acf709ee71c580f1cd65d726ed03200ea">gsl_matrix_get</a>(exp_map, i, j) &gt; 0.0 )
<a name="l00218"></a>00218         <span class="comment">// set the weight to one</span>
<a name="l00219"></a>00219         <a class="code" href="aXe__grism_8h.html#a1f386ef5cd5a3b916246c2bee80f083a">gsl_matrix_set</a>(weight, i,j,1.0);
<a name="l00220"></a>00220 
<a name="l00221"></a>00221   <span class="comment">// return the resulting weight map</span>
<a name="l00222"></a>00222   <span class="keywordflow">return</span> weight;
<a name="l00223"></a>00223 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="aa6f230c18a0868f3cf4357d413b9015c"></a><!-- doxytag: member="drz2pet_utils.c::comp_exp_weight" ref="aa6f230c18a0868f3cf4357d413b9015c" args="(gsl_matrix *exp_map, const object *ob)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">gsl_matrix* comp_exp_weight </td>
          <td>(</td>
          <td class="paramtype">gsl_matrix *&nbsp;</td>
          <td class="paramname"> <em>exp_map</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structobject.html">object</a> *&nbsp;</td>
          <td class="paramname"> <em>ob</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p><div class="fragment"><pre class="fragment"><a name="l00243"></a>00243 {
<a name="l00244"></a>00244   <a class="code" href="aXe__grism_8h.html#a6117e17bb3108107676f4486e62d40e5">gsl_matrix</a> *weight;
<a name="l00245"></a>00245   <span class="keywordtype">int</span> i, j;
<a name="l00246"></a>00246   <span class="keywordtype">double</span> sum, contr, norm, allweight;
<a name="l00247"></a>00247   <span class="keywordtype">int</span> beamInt = 0;
<a name="l00248"></a>00248 
<a name="l00249"></a>00249   <span class="comment">// allocate the matrix and set it to the default</span>
<a name="l00250"></a>00250   weight = <a class="code" href="aXe__grism_8h.html#a1214ab1bea5fd80474d7a27db0bfb429">gsl_matrix_alloc</a>(exp_map-&gt;size1, exp_map-&gt;size2);
<a name="l00251"></a>00251   <a class="code" href="aXe__grism_8h.html#af6161aeb008a1ffa7d888df6ccbef7cc">gsl_matrix_set_all</a>(weight, 1000.0);
<a name="l00252"></a>00252 
<a name="l00253"></a>00253     <span class="comment">//* go over all columns</span>
<a name="l00254"></a>00254   <span class="keywordflow">for</span> (i=0; i &lt; exp_map-&gt;size1; i++)
<a name="l00255"></a>00255     {
<a name="l00256"></a>00256       sum = 0.0;
<a name="l00257"></a>00257       contr = 0.0;
<a name="l00258"></a>00258       allweight = 0.0;
<a name="l00259"></a>00259 
<a name="l00260"></a>00260       <span class="comment">// determine for each column the total exposure time</span>
<a name="l00261"></a>00261       <span class="comment">// and the number of pixels with non-zero exposure time</span>
<a name="l00262"></a>00262       <span class="keywordflow">for</span> (j=0; j &lt; exp_map-&gt;size2; j++)
<a name="l00263"></a>00263         {
<a name="l00264"></a>00264           <span class="comment">// check whether the pixel is inside the extraction</span>
<a name="l00265"></a>00265           <span class="comment">// area and has a positive weight</span>
<a name="l00266"></a>00266           <span class="keywordflow">if</span> (fabs(ob-&gt;<a class="code" href="structobject.html#ad643757142781f8265b430e19700cfe5">beams</a>[beamInt].<a class="code" href="structbeam.html#a54c64670a8b3e8732c1468d156ddb0ca">refpoint</a>.<a class="code" href="structd__point.html#ad9846a025508bf8873a501ca5fcefbf4">y</a>-(<span class="keywordtype">double</span>)j) &lt;= ob-&gt;<a class="code" href="structobject.html#ad643757142781f8265b430e19700cfe5">beams</a>[beamInt].<a class="code" href="structbeam.html#ae99ff960c070381b6e76af5a58cb9c45">width</a>+0.5 &amp;&amp;
<a name="l00267"></a>00267               <a class="code" href="aXe__grism_8h.html#acf709ee71c580f1cd65d726ed03200ea">gsl_matrix_get</a>(exp_map, i, j) &gt; 0.0 )
<a name="l00268"></a>00268             {
<a name="l00269"></a>00269               <span class="comment">// sum up the weigth and the number of pixels</span>
<a name="l00270"></a>00270               sum = sum + <a class="code" href="aXe__grism_8h.html#acf709ee71c580f1cd65d726ed03200ea">gsl_matrix_get</a>(exp_map, i, j);
<a name="l00271"></a>00271               contr = contr + 1.0;
<a name="l00272"></a>00272             }
<a name="l00273"></a>00273         }
<a name="l00274"></a>00274 
<a name="l00275"></a>00275       <span class="comment">// check whether the row has exposure time at all</span>
<a name="l00276"></a>00276       <span class="keywordflow">if</span> (sum &gt; 0.0)
<a name="l00277"></a>00277         {
<a name="l00278"></a>00278           <span class="comment">// if the row is exposed:</span>
<a name="l00279"></a>00279           <span class="comment">// determine the mean exposure time</span>
<a name="l00280"></a>00280           norm = sum / contr;
<a name="l00281"></a>00281 
<a name="l00282"></a>00282           <span class="comment">// go over each pixel</span>
<a name="l00283"></a>00283           <span class="keywordflow">for</span> (j=0; j &lt; exp_map-&gt;size2; j++)
<a name="l00284"></a>00284             {
<a name="l00285"></a>00285               <span class="comment">// check whether the pixel is inside the extraction are</span>
<a name="l00286"></a>00286               <span class="keywordflow">if</span> (fabs(ob-&gt;<a class="code" href="structobject.html#ad643757142781f8265b430e19700cfe5">beams</a>[beamInt].<a class="code" href="structbeam.html#a54c64670a8b3e8732c1468d156ddb0ca">refpoint</a>.<a class="code" href="structd__point.html#ad9846a025508bf8873a501ca5fcefbf4">y</a>-(<span class="keywordtype">double</span>)j) &lt;= ob-&gt;<a class="code" href="structobject.html#ad643757142781f8265b430e19700cfe5">beams</a>[beamInt].<a class="code" href="structbeam.html#ae99ff960c070381b6e76af5a58cb9c45">width</a>+0.5)
<a name="l00287"></a>00287                 {
<a name="l00288"></a>00288                   <span class="comment">// compute and store the relative exposure time (==weight)</span>
<a name="l00289"></a>00289                   <span class="comment">// for positive exposure time</span>
<a name="l00290"></a>00290                   <span class="keywordflow">if</span> (<a class="code" href="aXe__grism_8h.html#acf709ee71c580f1cd65d726ed03200ea">gsl_matrix_get</a>(exp_map, i, j) &gt; 0.0)
<a name="l00291"></a>00291                     {
<a name="l00292"></a>00292                       <a class="code" href="aXe__grism_8h.html#a1f386ef5cd5a3b916246c2bee80f083a">gsl_matrix_set</a>(weight, i,j,<a class="code" href="aXe__grism_8h.html#acf709ee71c580f1cd65d726ed03200ea">gsl_matrix_get</a>(exp_map, i, j)/norm);
<a name="l00293"></a>00293                       allweight = allweight + <a class="code" href="aXe__grism_8h.html#acf709ee71c580f1cd65d726ed03200ea">gsl_matrix_get</a>(weight, i, j);
<a name="l00294"></a>00294                     }
<a name="l00295"></a>00295                   <span class="comment">// make a default to avoid values &lt;0.0</span>
<a name="l00296"></a>00296                   <span class="keywordflow">else</span>
<a name="l00297"></a>00297                     {
<a name="l00298"></a>00298                       <a class="code" href="aXe__grism_8h.html#a1f386ef5cd5a3b916246c2bee80f083a">gsl_matrix_set</a>(weight, i,j,0.0);
<a name="l00299"></a>00299                     }
<a name="l00300"></a>00300                 }
<a name="l00301"></a>00301             }
<a name="l00302"></a>00302         }
<a name="l00303"></a>00303       <span class="comment">// treat unexposed columns differently:</span>
<a name="l00304"></a>00304       <span class="keywordflow">else</span>
<a name="l00305"></a>00305         {
<a name="l00306"></a>00306 
<a name="l00307"></a>00307           <span class="comment">// go over each row</span>
<a name="l00308"></a>00308           <span class="keywordflow">for</span> (j=0; j &lt; exp_map-&gt;size2; j++)
<a name="l00309"></a>00309             {
<a name="l00310"></a>00310               <span class="comment">// check whether the pixel is inside the extraction are</span>
<a name="l00311"></a>00311               <span class="keywordflow">if</span> (fabs(ob-&gt;<a class="code" href="structobject.html#ad643757142781f8265b430e19700cfe5">beams</a>[beamInt].<a class="code" href="structbeam.html#a54c64670a8b3e8732c1468d156ddb0ca">refpoint</a>.<a class="code" href="structd__point.html#ad9846a025508bf8873a501ca5fcefbf4">y</a>-(<span class="keywordtype">double</span>)j) &lt;= ob-&gt;<a class="code" href="structobject.html#ad643757142781f8265b430e19700cfe5">beams</a>[beamInt].<a class="code" href="structbeam.html#ae99ff960c070381b6e76af5a58cb9c45">width</a>+0.5)
<a name="l00312"></a>00312                 {
<a name="l00313"></a>00313                   <span class="comment">// set inside pixels to the defaulkt 1.0</span>
<a name="l00314"></a>00314                   <a class="code" href="aXe__grism_8h.html#a1f386ef5cd5a3b916246c2bee80f083a">gsl_matrix_set</a>(weight, i,j,1.0);
<a name="l00315"></a>00315                   allweight = allweight + <a class="code" href="aXe__grism_8h.html#acf709ee71c580f1cd65d726ed03200ea">gsl_matrix_get</a>(weight, i, j);
<a name="l00316"></a>00316                 }
<a name="l00317"></a>00317             }
<a name="l00318"></a>00318         }
<a name="l00319"></a>00319     }
<a name="l00320"></a>00320 
<a name="l00321"></a>00321   <span class="comment">// return the resulting weight map</span>
<a name="l00322"></a>00322   <span class="keywordflow">return</span> weight;
<a name="l00323"></a>00323 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a93ff2fe5d61878d9a772cdf10406e81d"></a><!-- doxytag: member="drz2pet_utils.c::comp_opt_weight" ref="a93ff2fe5d61878d9a772cdf10406e81d" args="(gsl_matrix *mod_map, gsl_matrix *var_map, const object *ob)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">gsl_matrix* comp_opt_weight </td>
          <td>(</td>
          <td class="paramtype">gsl_matrix *&nbsp;</td>
          <td class="paramname"> <em>mod_map</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">gsl_matrix *&nbsp;</td>
          <td class="paramname"> <em>var_map</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structobject.html">object</a> *&nbsp;</td>
          <td class="paramname"> <em>ob</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p><div class="fragment"><pre class="fragment"><a name="l00344"></a>00344 {
<a name="l00345"></a>00345   <a class="code" href="aXe__grism_8h.html#a6117e17bb3108107676f4486e62d40e5">gsl_matrix</a> *weight;
<a name="l00346"></a>00346   <span class="keywordtype">int</span> i, j;
<a name="l00347"></a>00347   <span class="keywordtype">double</span> mod_sum, weight_sum, contr, norm, allweight;
<a name="l00348"></a>00348   <span class="keywordtype">int</span> beamInt = 0;
<a name="l00349"></a>00349   <span class="keywordtype">double</span> mod_val;
<a name="l00350"></a>00350   <span class="comment">//double var_val;</span>
<a name="l00351"></a>00351 
<a name="l00352"></a>00352   <span class="comment">// allocate the weight matrix and set the default</span>
<a name="l00353"></a>00353   weight = <a class="code" href="aXe__grism_8h.html#a1214ab1bea5fd80474d7a27db0bfb429">gsl_matrix_alloc</a>(mod_map-&gt;size1, mod_map-&gt;size2);
<a name="l00354"></a>00354   <a class="code" href="aXe__grism_8h.html#af6161aeb008a1ffa7d888df6ccbef7cc">gsl_matrix_set_all</a>(weight, 0.0);
<a name="l00355"></a>00355 
<a name="l00356"></a>00356   <span class="comment">//* go over all columns</span>
<a name="l00357"></a>00357   <span class="keywordflow">for</span> (i=0; i &lt; mod_map-&gt;size1; i++)
<a name="l00358"></a>00358     {
<a name="l00359"></a>00359       mod_sum = 0.0;
<a name="l00360"></a>00360       contr = 0.0;
<a name="l00361"></a>00361       allweight = 0.0;
<a name="l00362"></a>00362       weight_sum=0.0;
<a name="l00363"></a>00363 
<a name="l00364"></a>00364       <span class="comment">// determine for each column the total model counts</span>
<a name="l00365"></a>00365       <span class="comment">// and the number of pixels with non-zero model_counts</span>
<a name="l00366"></a>00366       <span class="keywordflow">for</span> (j=0; j &lt; mod_map-&gt;size2; j++)
<a name="l00367"></a>00367         {
<a name="l00368"></a>00368           <span class="keywordflow">if</span> (fabs(ob-&gt;<a class="code" href="structobject.html#ad643757142781f8265b430e19700cfe5">beams</a>[beamInt].<a class="code" href="structbeam.html#a54c64670a8b3e8732c1468d156ddb0ca">refpoint</a>.<a class="code" href="structd__point.html#ad9846a025508bf8873a501ca5fcefbf4">y</a>-(<span class="keywordtype">double</span>)j) &lt;= ob-&gt;<a class="code" href="structobject.html#ad643757142781f8265b430e19700cfe5">beams</a>[beamInt].<a class="code" href="structbeam.html#ae99ff960c070381b6e76af5a58cb9c45">width</a>+0.5 &amp;&amp;
<a name="l00369"></a>00369               <a class="code" href="aXe__grism_8h.html#acf709ee71c580f1cd65d726ed03200ea">gsl_matrix_get</a>(mod_map, i, j) &gt; 0.0 )
<a name="l00370"></a>00370             {
<a name="l00371"></a>00371               mod_sum = mod_sum + <a class="code" href="aXe__grism_8h.html#acf709ee71c580f1cd65d726ed03200ea">gsl_matrix_get</a>(mod_map, i, j);
<a name="l00372"></a>00372               contr = contr + 1.0;
<a name="l00373"></a>00373             }
<a name="l00374"></a>00374         }
<a name="l00375"></a>00375 
<a name="l00376"></a>00376       <span class="comment">// check whether the column has model values.</span>
<a name="l00377"></a>00377       <span class="comment">// normalize the model values and compute</span>
<a name="l00378"></a>00378       <span class="comment">// optimal weights if yes.</span>
<a name="l00379"></a>00379       <span class="keywordflow">if</span> (mod_sum &gt; 0.0)
<a name="l00380"></a>00380         {
<a name="l00381"></a>00381           <span class="comment">//* determine the mean model value</span>
<a name="l00382"></a>00382           <span class="comment">//      norm = mod_sum / contr;</span>
<a name="l00383"></a>00383           norm = mod_sum;
<a name="l00384"></a>00384 
<a name="l00385"></a>00385           <span class="comment">// go over each row</span>
<a name="l00386"></a>00386           <span class="keywordflow">for</span> (j=0; j &lt; mod_map-&gt;size2; j++)
<a name="l00387"></a>00387             {
<a name="l00388"></a>00388               <span class="comment">// check whether the pixel is inside the extraction area</span>
<a name="l00389"></a>00389               <span class="keywordflow">if</span> (fabs(ob-&gt;<a class="code" href="structobject.html#ad643757142781f8265b430e19700cfe5">beams</a>[beamInt].<a class="code" href="structbeam.html#a54c64670a8b3e8732c1468d156ddb0ca">refpoint</a>.<a class="code" href="structd__point.html#ad9846a025508bf8873a501ca5fcefbf4">y</a>-(<span class="keywordtype">double</span>)j) &lt;= ob-&gt;<a class="code" href="structobject.html#ad643757142781f8265b430e19700cfe5">beams</a>[beamInt].<a class="code" href="structbeam.html#ae99ff960c070381b6e76af5a58cb9c45">width</a>+0.5 &amp;&amp;
<a name="l00390"></a>00390                   <a class="code" href="aXe__grism_8h.html#acf709ee71c580f1cd65d726ed03200ea">gsl_matrix_get</a>(mod_map, i, j) &gt; 0.0 )
<a name="l00391"></a>00391                 {
<a name="l00392"></a>00392                   <span class="comment">// normalize the model counts</span>
<a name="l00393"></a>00393                   mod_val = <a class="code" href="aXe__grism_8h.html#acf709ee71c580f1cd65d726ed03200ea">gsl_matrix_get</a>(mod_map, i, j)/norm;
<a name="l00394"></a>00394 
<a name="l00395"></a>00395                   <span class="comment">// store the normalized model counts</span>
<a name="l00396"></a>00396                   <a class="code" href="aXe__grism_8h.html#a1f386ef5cd5a3b916246c2bee80f083a">gsl_matrix_set</a>(mod_map, i, j, mod_val);
<a name="l00397"></a>00397 
<a name="l00398"></a>00398                   <span class="comment">// add up the normalization value for the optimal weights</span>
<a name="l00399"></a>00399                   weight_sum = weight_sum + mod_val*mod_val/<a class="code" href="aXe__grism_8h.html#acf709ee71c580f1cd65d726ed03200ea">gsl_matrix_get</a>(var_map, i, j);
<a name="l00400"></a>00400                 }
<a name="l00401"></a>00401             }
<a name="l00402"></a>00402 
<a name="l00403"></a>00403           <span class="comment">// finally compute and write the weights:</span>
<a name="l00404"></a>00404           <span class="comment">// go over each pixel</span>
<a name="l00405"></a>00405           <span class="keywordflow">for</span> (j=0; j &lt; mod_map-&gt;size2; j++)
<a name="l00406"></a>00406             {
<a name="l00407"></a>00407               <span class="comment">// check whether the pixel is inside the extraction area</span>
<a name="l00408"></a>00408               <span class="keywordflow">if</span> (fabs(ob-&gt;<a class="code" href="structobject.html#ad643757142781f8265b430e19700cfe5">beams</a>[beamInt].<a class="code" href="structbeam.html#a54c64670a8b3e8732c1468d156ddb0ca">refpoint</a>.<a class="code" href="structd__point.html#ad9846a025508bf8873a501ca5fcefbf4">y</a>-(<span class="keywordtype">double</span>)j) &lt;= ob-&gt;<a class="code" href="structobject.html#ad643757142781f8265b430e19700cfe5">beams</a>[beamInt].<a class="code" href="structbeam.html#ae99ff960c070381b6e76af5a58cb9c45">width</a>+0.5)
<a name="l00409"></a>00409                 {
<a name="l00410"></a>00410                   <span class="keywordflow">if</span> (<a class="code" href="aXe__grism_8h.html#acf709ee71c580f1cd65d726ed03200ea">gsl_matrix_get</a>(mod_map, i, j) &gt; 0.0 )
<a name="l00411"></a>00411                     {
<a name="l00412"></a>00412                       <span class="comment">// compute and set the individual pixel weight</span>
<a name="l00413"></a>00413                       <a class="code" href="aXe__grism_8h.html#a1f386ef5cd5a3b916246c2bee80f083a">gsl_matrix_set</a>(weight, i, j, <a class="code" href="aXe__grism_8h.html#acf709ee71c580f1cd65d726ed03200ea">gsl_matrix_get</a>(mod_map, i, j)/<a class="code" href="aXe__grism_8h.html#acf709ee71c580f1cd65d726ed03200ea">gsl_matrix_get</a>(var_map, i, j)/weight_sum);
<a name="l00414"></a>00414                       allweight = allweight + <a class="code" href="aXe__grism_8h.html#acf709ee71c580f1cd65d726ed03200ea">gsl_matrix_get</a>(weight, i, j);
<a name="l00415"></a>00415                     }
<a name="l00416"></a>00416                   <span class="keywordflow">else</span>
<a name="l00417"></a>00417                     {
<a name="l00418"></a>00418                       <span class="comment">// set the default value if no model value is zero</span>
<a name="l00419"></a>00419                       <a class="code" href="aXe__grism_8h.html#a1f386ef5cd5a3b916246c2bee80f083a">gsl_matrix_set</a>(weight, i, j,0.0);
<a name="l00420"></a>00420                     }
<a name="l00421"></a>00421                 }
<a name="l00422"></a>00422             }
<a name="l00423"></a>00423         }
<a name="l00424"></a>00424       <span class="comment">// if the column does not have model values at all:</span>
<a name="l00425"></a>00425       <span class="keywordflow">else</span>
<a name="l00426"></a>00426         {
<a name="l00427"></a>00427           <span class="comment">// go over each row</span>
<a name="l00428"></a>00428           <span class="keywordflow">for</span> (j=0; j &lt; mod_map-&gt;size2; j++)
<a name="l00429"></a>00429             {
<a name="l00430"></a>00430               <span class="comment">// check whether the pixel is within the extraction area</span>
<a name="l00431"></a>00431               <span class="keywordflow">if</span> (fabs(ob-&gt;<a class="code" href="structobject.html#ad643757142781f8265b430e19700cfe5">beams</a>[beamInt].<a class="code" href="structbeam.html#a54c64670a8b3e8732c1468d156ddb0ca">refpoint</a>.<a class="code" href="structd__point.html#ad9846a025508bf8873a501ca5fcefbf4">y</a>-(<span class="keywordtype">double</span>)j) &lt;= ob-&gt;<a class="code" href="structobject.html#ad643757142781f8265b430e19700cfe5">beams</a>[beamInt].<a class="code" href="structbeam.html#ae99ff960c070381b6e76af5a58cb9c45">width</a>+0.5)
<a name="l00432"></a>00432                 {
<a name="l00433"></a>00433                   <span class="comment">// set the inside default value</span>
<a name="l00434"></a>00434                   <a class="code" href="aXe__grism_8h.html#a1f386ef5cd5a3b916246c2bee80f083a">gsl_matrix_set</a>(weight, i,j,1.0);
<a name="l00435"></a>00435                   allweight = allweight + <a class="code" href="aXe__grism_8h.html#acf709ee71c580f1cd65d726ed03200ea">gsl_matrix_get</a>(mod_map, i, j);
<a name="l00436"></a>00436                 }
<a name="l00437"></a>00437             }
<a name="l00438"></a>00438         }
<a name="l00439"></a>00439     }
<a name="l00440"></a>00440 
<a name="l00441"></a>00441   <span class="comment">// return the weight matrix</span>
<a name="l00442"></a>00442   <span class="keywordflow">return</span> weight;
<a name="l00443"></a>00443 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a3c3ec826594e43ab1fec0ad549fac954"></a><!-- doxytag: member="drz2pet_utils.c::get_ID_num" ref="a3c3ec826594e43ab1fec0ad549fac954" args="(char *grism_image, char *extname)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char* get_ID_num </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>grism_image</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>extname</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Function: get_ID_num The function generates the extension name used in the PET for a 2D drizzled grism image</p>
<p>Parameters: </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>grism_image</em>&nbsp;</td><td>- the name of the 2D drizzled grism image </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>extname</em>&nbsp;</td><td>- The ID number of the image</td></tr>
  </table>
  </dd>
</dl>
<p>Returns: </p>
<dl class="return"><dt><b>Returns:</b></dt><dd>WorkPtr - Pointer to the ID-string </dd></dl>

<p><div class="fragment"><pre class="fragment"><a name="l00114"></a>00114                                               {
<a name="l00115"></a>00115 
<a name="l00116"></a>00116   <span class="keywordtype">char</span> *WorkPtr;
<a name="l00117"></a>00117   <span class="keywordtype">char</span> *WorkPtr2;
<a name="l00118"></a>00118   <span class="keywordtype">char</span> **t_err=NULL;
<a name="l00119"></a>00119   <span class="keywordtype">char</span> tmp[<a class="code" href="aXe__grism_8h.html#ac1535592e39e7edf0cafbd5e695ea622">MAXCHAR</a>];
<a name="l00120"></a>00120   <span class="keywordtype">char</span> ID[4];
<a name="l00121"></a>00121 
<a name="l00122"></a>00122   <span class="keywordtype">int</span> <a class="code" href="spc__utils_8c.html#a7360b55975153b822efc5217b7734e6a">len</a>;
<a name="l00123"></a>00123   <span class="keywordtype">int</span> i=0;
<a name="l00124"></a>00124 
<a name="l00125"></a>00125   strcpy(ID,<span class="stringliteral">&quot;_ID&quot;</span>);
<a name="l00126"></a>00126   strcpy(tmp, grism_image);
<a name="l00127"></a>00127 
<a name="l00128"></a>00128   t_err = (<span class="keywordtype">char</span> **) malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">char</span> *)*1);
<a name="l00129"></a>00129 
<a name="l00130"></a>00130   WorkPtr = strstr(tmp, ID)+3;
<a name="l00131"></a>00131   WorkPtr2 = WorkPtr + strlen (WorkPtr);
<a name="l00132"></a>00132   <span class="keywordflow">while</span> (isspace ((<span class="keywordtype">int</span>) *WorkPtr2))
<a name="l00133"></a>00133     *WorkPtr2-- = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00134"></a>00134   WorkPtr2 = WorkPtr2 - 1;
<a name="l00135"></a>00135   len = strlen(WorkPtr);
<a name="l00136"></a>00136   <span class="keywordflow">while</span>  (i++ &lt; len){
<a name="l00137"></a>00137     strtol(WorkPtr,t_err,10);
<a name="l00138"></a>00138     <span class="keywordflow">if</span> (strlen(t_err[0])==0)
<a name="l00139"></a>00139       <span class="keywordflow">break</span>;
<a name="l00140"></a>00140     *WorkPtr2-- = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00141"></a>00141   }
<a name="l00142"></a>00142   strcpy(extname,WorkPtr);
<a name="l00143"></a>00143   free(t_err);
<a name="l00144"></a>00144   <span class="keywordflow">return</span> WorkPtr;
<a name="l00145"></a>00145 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a9c231344c8a2af0c74777dd4b13ed22f"></a><!-- doxytag: member="drz2pet_utils.c::make_spc_drztable" ref="a9c231344c8a2af0c74777dd4b13ed22f" args="(observation *const obs, observation *const wobs, const object *ob, const double lambda0, const double dlambda)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structap__pixel.html">ap_pixel</a>* make_spc_drztable </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structobservation.html">observation</a> *const &nbsp;</td>
          <td class="paramname"> <em>obs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structobservation.html">observation</a> *const &nbsp;</td>
          <td class="paramname"> <em>wobs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structobject.html">object</a> *&nbsp;</td>
          <td class="paramname"> <em>ob</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const double&nbsp;</td>
          <td class="paramname"> <em>lambda0</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const double&nbsp;</td>
          <td class="paramname"> <em>dlambda</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Function: make_spc_drztable The function generates and fills an <a class="el" href="structap__pixel.html">ap_pixel</a> vector for one drizzled 2D grism image.</p>
<p>Parameters: </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>obs</em>&nbsp;</td><td>- pointer to <a class="el" href="structobservation.html">observation</a> structure with image values </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>obs</em>&nbsp;</td><td>- pointer to <a class="el" href="structobservation.html">observation</a> structure with image values </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>ob</em>&nbsp;</td><td>- pointer to the description of the current <a class="el" href="structbeam.html">beam</a> </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>lambda0</em>&nbsp;</td><td>- the starting wavelength in this drizzled image </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>dlambda</em>&nbsp;</td><td>- the dispersion in this drizzled image</td></tr>
  </table>
  </dd>
</dl>
<p>Returns: </p>
<dl class="return"><dt><b>Returns:</b></dt><dd>table - pointer to an <a class="el" href="structap__pixel.html">ap_pixel</a> vector </dd></dl>

<p><div class="fragment"><pre class="fragment"><a name="l00038"></a>00038                                        {
<a name="l00039"></a>00039 
<a name="l00040"></a>00040   <a class="code" href="structap__pixel.html">ap_pixel</a> *<a class="code" href="spc__utils_8c.html#a3278fc9538370857ff6034411692abd1">table</a>, *cur_ap;
<a name="l00041"></a>00041 
<a name="l00042"></a>00042   <span class="keywordtype">int</span> npix1, npix2;
<a name="l00043"></a>00043   <span class="keywordtype">int</span> nsub1=1, nsub2=1;
<a name="l00044"></a>00044   <span class="keywordtype">int</span> i, j;
<a name="l00045"></a>00045   <span class="keywordtype">int</span> beamInt = 0;
<a name="l00046"></a>00046 
<a name="l00047"></a>00047   npix1 = obs-&gt;<a class="code" href="structobservation.html#a012c0ff489fbb74fc6c9abfbd7c6e320">grism</a>-&gt;size1;
<a name="l00048"></a>00048   npix2 = obs-&gt;<a class="code" href="structobservation.html#a012c0ff489fbb74fc6c9abfbd7c6e320">grism</a>-&gt;size2;
<a name="l00049"></a>00049 
<a name="l00050"></a>00050 
<a name="l00051"></a>00051   <span class="keywordflow">if</span> (!(table = malloc ((npix1 * npix2 + 1) * <span class="keyword">sizeof</span> (<a class="code" href="structap__pixel.html">ap_pixel</a>) * nsub1 * nsub2)))
<a name="l00052"></a>00052     <span class="keywordflow">return</span> NULL;
<a name="l00053"></a>00053 
<a name="l00054"></a>00054   cur_ap = table;
<a name="l00055"></a>00055 
<a name="l00056"></a>00056   <span class="keywordflow">for</span> (i = 0; i &lt; npix1; i++){
<a name="l00057"></a>00057     <span class="keywordflow">for</span> (j = 0; j &lt; npix2; j++){
<a name="l00058"></a>00058 
<a name="l00059"></a>00059       <span class="comment">//* check whether the pixel is within the extraction box</span>
<a name="l00060"></a>00060       <span class="keywordflow">if</span> (fabs((<span class="keywordtype">double</span>)j - ob-&gt;<a class="code" href="structobject.html#ad643757142781f8265b430e19700cfe5">beams</a>[beamInt].<a class="code" href="structbeam.html#a54c64670a8b3e8732c1468d156ddb0ca">refpoint</a>.<a class="code" href="structd__point.html#ad9846a025508bf8873a501ca5fcefbf4">y</a>) &gt; ob-&gt;<a class="code" href="structobject.html#ad643757142781f8265b430e19700cfe5">beams</a>[beamInt].<a class="code" href="structbeam.html#ae99ff960c070381b6e76af5a58cb9c45">width</a> + .5)
<a name="l00061"></a>00061         <span class="keywordflow">continue</span>;
<a name="l00062"></a>00062 
<a name="l00063"></a>00063       <span class="comment">//* fill the ap_pixel</span>
<a name="l00064"></a>00064       cur_ap-&gt;<a class="code" href="structap__pixel.html#abca28f0936fbd5a569ad548fb25e5a38">p_x</a>  = i;
<a name="l00065"></a>00065       cur_ap-&gt;<a class="code" href="structap__pixel.html#aadf7ee52df3875792fbf13d4d52ed298">p_y</a>  = j;
<a name="l00066"></a>00066 
<a name="l00067"></a>00067       cur_ap-&gt;<a class="code" href="structap__pixel.html#a0ce028c33a28f543bd9255324800e9ea">x</a>       = (double)i - ob-&gt;<a class="code" href="structobject.html#ad643757142781f8265b430e19700cfe5">beams</a>[beamInt].<a class="code" href="structbeam.html#a54c64670a8b3e8732c1468d156ddb0ca">refpoint</a>.<a class="code" href="structd__point.html#a922a3b5d82a119168ba85e5f939d02c3">x</a>;
<a name="l00068"></a>00068       cur_ap-&gt;<a class="code" href="structap__pixel.html#a1df90884734bfaea8ec545b69d802281">y</a>       = (<span class="keywordtype">double</span>)j - ob-&gt;<a class="code" href="structobject.html#ad643757142781f8265b430e19700cfe5">beams</a>[beamInt].<a class="code" href="structbeam.html#a54c64670a8b3e8732c1468d156ddb0ca">refpoint</a>.<a class="code" href="structd__point.html#ad9846a025508bf8873a501ca5fcefbf4">y</a>;
<a name="l00069"></a>00069       cur_ap-&gt;<a class="code" href="structap__pixel.html#abd0f197da151fac01c9e4cbd4146f212">dist</a>    = (double)j - ob-&gt;<a class="code" href="structobject.html#ad643757142781f8265b430e19700cfe5">beams</a>[beamInt].<a class="code" href="structbeam.html#a54c64670a8b3e8732c1468d156ddb0ca">refpoint</a>.<a class="code" href="structd__point.html#ad9846a025508bf8873a501ca5fcefbf4">y</a>;
<a name="l00070"></a>00070       cur_ap-&gt;<a class="code" href="structap__pixel.html#aa6a80bf7f2a556b5d846bb3b987450ee">xs</a>      = (<span class="keywordtype">double</span>)i - ob-&gt;<a class="code" href="structobject.html#ad643757142781f8265b430e19700cfe5">beams</a>[beamInt].<a class="code" href="structbeam.html#a54c64670a8b3e8732c1468d156ddb0ca">refpoint</a>.<a class="code" href="structd__point.html#a922a3b5d82a119168ba85e5f939d02c3">x</a>;
<a name="l00071"></a>00071       cur_ap-&gt;<a class="code" href="structap__pixel.html#a54b55a4bbb06f7a9065699d976dae956">ys</a>      = 0.0;
<a name="l00072"></a>00072       cur_ap-&gt;<a class="code" href="structap__pixel.html#a92d9e84a233d0a1ad482830b23c5e5ba">dxs</a>     = 0.0;  <span class="comment">// be reminded: dxs is the LOCAL TRACEANGLE, not the pixels size..</span>
<a name="l00073"></a>00073       cur_ap-&gt;<a class="code" href="structap__pixel.html#aeae2e14e0f53bd1090acb2a8758104a5">xi</a>      = (double)i - ob-&gt;<a class="code" href="structobject.html#ad643757142781f8265b430e19700cfe5">beams</a>[beamInt].<a class="code" href="structbeam.html#a54c64670a8b3e8732c1468d156ddb0ca">refpoint</a>.<a class="code" href="structd__point.html#a922a3b5d82a119168ba85e5f939d02c3">x</a>;
<a name="l00074"></a>00074       cur_ap-&gt;<a class="code" href="structap__pixel.html#ac36fd281b7d91081490e41ce07a60501">lambda</a>  = lambda0 + dlambda * ((<span class="keywordtype">double</span>)i - ob-&gt;<a class="code" href="structobject.html#ad643757142781f8265b430e19700cfe5">beams</a>[beamInt].<a class="code" href="structbeam.html#a54c64670a8b3e8732c1468d156ddb0ca">refpoint</a>.<a class="code" href="structd__point.html#a922a3b5d82a119168ba85e5f939d02c3">x</a>);
<a name="l00075"></a>00075       cur_ap-&gt;<a class="code" href="structap__pixel.html#a8c1c7b5a35a04145fccfc3f84c420cde">dlambda</a> = dlambda;
<a name="l00076"></a>00076 
<a name="l00077"></a>00077       <span class="comment">// transfer the cps values and the weight values</span>
<a name="l00078"></a>00078       cur_ap-&gt;<a class="code" href="structap__pixel.html#a846018a7e3b143259419bd74e2d9073f">count</a>  = <a class="code" href="aXe__grism_8h.html#acf709ee71c580f1cd65d726ed03200ea">gsl_matrix_get</a>(obs-&gt;<a class="code" href="structobservation.html#a012c0ff489fbb74fc6c9abfbd7c6e320">grism</a>, i, j);
<a name="l00079"></a>00079       cur_ap-&gt;<a class="code" href="structap__pixel.html#a34600405e114d4bd366c1d33860aff14">weight</a> = <a class="code" href="aXe__grism_8h.html#acf709ee71c580f1cd65d726ed03200ea">gsl_matrix_get</a>(wobs-&gt;<a class="code" href="structobservation.html#a012c0ff489fbb74fc6c9abfbd7c6e320">grism</a>, i, j);
<a name="l00080"></a>00080 
<a name="l00081"></a>00081       cur_ap-&gt;<a class="code" href="structap__pixel.html#a70b0f2e20878570616d81ffac4c15c68">error</a>  = <a class="code" href="aXe__grism_8h.html#acf709ee71c580f1cd65d726ed03200ea">gsl_matrix_get</a>(obs-&gt;<a class="code" href="structobservation.html#a79ef486b081fa7b1973c39323f163010">pixerrs</a>, i, j);
<a name="l00082"></a>00082       cur_ap-&gt;<a class="code" href="structap__pixel.html#a2191ef670b1b5c515fda841dda181f62">contam</a> = <a class="code" href="aXe__grism_8h.html#acf709ee71c580f1cd65d726ed03200ea">gsl_matrix_get</a>(obs-&gt;<a class="code" href="structobservation.html#a6698fa09a4524a5928ad9f98d620ba4e">dq</a>, i, j);
<a name="l00083"></a>00083 
<a name="l00084"></a>00084       <span class="comment">// dq is always set to zero, bad (=unexposed) pixels</span>
<a name="l00085"></a>00085       <span class="comment">// have exptime=weight=0.0</span>
<a name="l00086"></a>00086       cur_ap-&gt;<a class="code" href="structap__pixel.html#ae86ffac921bd79b2b8e1ee6b2a9b3cd9">dq</a>     = 0;
<a name="l00087"></a>00087 
<a name="l00088"></a>00088       <span class="comment">// go to the next</span>
<a name="l00089"></a>00089       <span class="comment">// PET pixel</span>
<a name="l00090"></a>00090       cur_ap++;
<a name="l00091"></a>00091     }
<a name="l00092"></a>00092   }
<a name="l00093"></a>00093 
<a name="l00094"></a>00094   cur_ap-&gt;<a class="code" href="structap__pixel.html#abca28f0936fbd5a569ad548fb25e5a38">p_x</a> = -1;
<a name="l00095"></a>00095   cur_ap-&gt;<a class="code" href="structap__pixel.html#aadf7ee52df3875792fbf13d4d52ed298">p_y</a> = -1;
<a name="l00096"></a>00096   cur_ap-&gt;<a class="code" href="structap__pixel.html#a846018a7e3b143259419bd74e2d9073f">count</a> = -1;
<a name="l00097"></a>00097 
<a name="l00098"></a>00098   <span class="keywordflow">return</span> table;
<a name="l00099"></a>00099 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ad70f842615bbd5d0277252f63e7564a7"></a><!-- doxytag: member="drz2pet_utils.c::normalize_weight" ref="ad70f842615bbd5d0277252f63e7564a7" args="(observation *wobs, object *ob, const int opt_extr)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void normalize_weight </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structobservation.html">observation</a> *&nbsp;</td>
          <td class="paramname"> <em>wobs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structobject.html">object</a> *&nbsp;</td>
          <td class="paramname"> <em>ob</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const int&nbsp;</td>
          <td class="paramname"> <em>opt_extr</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Function: normalize_weight The function computes the weights used in the extraction from the exposure times given for each pixel in a column.</p>
<p>Parameters: </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>wobs</em>&nbsp;</td><td>- pointer to the structure which carries the pixel data </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>ob</em>&nbsp;</td><td>- pointer to the <a class="el" href="structbeam.html">beam</a> description </td></tr>
  </table>
  </dd>
</dl>

<p><div class="fragment"><pre class="fragment"><a name="l00159"></a>00159 {
<a name="l00160"></a>00160   <a class="code" href="aXe__grism_8h.html#a6117e17bb3108107676f4486e62d40e5">gsl_matrix</a> *weight;
<a name="l00161"></a>00161   <span class="comment">//int i, j;</span>
<a name="l00162"></a>00162   <span class="comment">// check for optimal extraction</span>
<a name="l00163"></a>00163   <span class="keywordflow">if</span> (opt_extr)
<a name="l00164"></a>00164     {
<a name="l00165"></a>00165       <span class="comment">// let the optimal weights compute</span>
<a name="l00166"></a>00166       fprintf(stdout, <span class="stringliteral">&quot;aXe_DRZ2PET: Use otpimal weighting.\n&quot;</span>);
<a name="l00167"></a>00167       weight = <a class="code" href="drz2pet__utils_8c.html#a93ff2fe5d61878d9a772cdf10406e81d">comp_opt_weight</a>(wobs-&gt;<a class="code" href="structobservation.html#a79ef486b081fa7b1973c39323f163010">pixerrs</a>, wobs-&gt;<a class="code" href="structobservation.html#a6698fa09a4524a5928ad9f98d620ba4e">dq</a>, ob);
<a name="l00168"></a>00168     }
<a name="l00169"></a>00169   <span class="keywordflow">else</span>
<a name="l00170"></a>00170     {
<a name="l00171"></a>00171       <span class="comment">// let the exposure time weights compute</span>
<a name="l00172"></a>00172       fprintf(stdout, <span class="stringliteral">&quot;aXe_DRZ2PET: Use normal, flat  weighting.\n&quot;</span>);
<a name="l00173"></a>00173       weight = <a class="code" href="drz2pet__utils_8c.html#a57174076d9e90251f8a3cf8681d679d3">comp_equ_weight</a>(wobs-&gt;<a class="code" href="structobservation.html#a012c0ff489fbb74fc6c9abfbd7c6e320">grism</a>, ob);
<a name="l00174"></a>00174 
<a name="l00175"></a>00175       <span class="comment">// code lines for exposure time weighting</span>
<a name="l00176"></a>00176       <span class="comment">//fprintf(stdout, &quot;use exposure time  weighting\n&quot;);</span>
<a name="l00177"></a>00177       <span class="comment">//weight = comp_exp_weight(wobs-&gt;grism, ob);</span>
<a name="l00178"></a>00178     }
<a name="l00179"></a>00179 
<a name="l00180"></a>00180   <span class="comment">// replace the weight extension with the new weights</span>
<a name="l00181"></a>00181   <a class="code" href="aXe__grism_8h.html#a61aa1d37853a90711852146f18d0b85f">gsl_matrix_free</a>(wobs-&gt;<a class="code" href="structobservation.html#a012c0ff489fbb74fc6c9abfbd7c6e320">grism</a>);
<a name="l00182"></a>00182   wobs-&gt;<a class="code" href="structobservation.html#a012c0ff489fbb74fc6c9abfbd7c6e320">grism</a> = weight;
<a name="l00183"></a>00183 }
</pre></div></p>

</div>
</div>
</div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&nbsp;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&nbsp;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr size="1"/><address style="text-align: right;"><small>Generated on 12 Oct 2014 for TIPS by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
