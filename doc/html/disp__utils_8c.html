<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>TIPS: /renoir/fourmano/Desktop/OUSIM/TIPS/branches/tips_build/src/axesim/disp_utils.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>/renoir/fourmano/Desktop/OUSIM/TIPS/branches/tips_build/src/axesim/disp_utils.c File Reference</h1><code>#include &lt;time.h&gt;</code><br/>
<code>#include &lt;math.h&gt;</code><br/>
<code>#include &lt;gsl/gsl_matrix.h&gt;</code><br/>
<code>#include &lt;gsl/gsl_vector.h&gt;</code><br/>
<code>#include &lt;gsl/gsl_interp.h&gt;</code><br/>
<code>#include &lt;stdio.h&gt;</code><br/>
<code>#include &lt;stdlib.h&gt;</code><br/>
<code>#include &lt;string.h&gt;</code><br/>
<code>#include &lt;fitsio.h&gt;</code><br/>
<code>#include &lt;unistd.h&gt;</code><br/>
<code>#include &quot;<a class="el" href="aXe__utils_8h_source.html">aXe_utils.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="inout__aper_8h_source.html">inout_aper.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="aXe__grism_8h_source.html">aXe_grism.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="spce__sect_8h_source.html">spce_sect.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="spc__back_8h_source.html">spc_back.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="spce__PET_8h_source.html">spce_PET.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="spc__wl__calib_8h_source.html">spc_wl_calib.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="aXe__errors_8h_source.html">aXe_errors.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="fringe__conf_8h_source.html">fringe_conf.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="spc__resp_8h_source.html">spc_resp.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="spce__pathlength_8h_source.html">spce_pathlength.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="aper__conf_8h_source.html">aper_conf.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="specmodel__utils_8h_source.html">specmodel_utils.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="model__utils_8h_source.html">model_utils.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="spc__fluxcube_8h_source.html">spc_fluxcube.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="spc__model_8h_source.html">spc_model.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="crossdisp__utils_8h_source.html">crossdisp_utils.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="disp__utils_8h_source.html">disp_utils.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="spc__FITScards_8h_source.html">spc_FITScards.h</a>&quot;</code><br/>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Namespaces</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">namespace &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacedisp__utils.html">disp_utils</a></td></tr>
<tr><td colspan="2"><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="disp__utils_8c.html#a09732c20cb3478586970093886a379ab">compute_disp</a> (char grism_file[], char OAF_file[], char CONF_file[], const char specmod_file[], const char objmod_file[], const double lambda_psf, <a class="el" href="structobservation.html">observation</a> *obs)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="disp__utils_8c.html#a2665684d5c0fdbca115fd3f8f096bb16">add2image</a> (const <a class="el" href="structpx__point.html">px_point</a> npixels, <a class="el" href="structobservation.html">observation</a> *obs, <a class="el" href="structbeamspec.html">beamspec</a> *spec)</td></tr>
</table>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="a2665684d5c0fdbca115fd3f8f096bb16"></a><!-- doxytag: member="disp_utils.c::add2image" ref="a2665684d5c0fdbca115fd3f8f096bb16" args="(const px_point npixels, observation *obs, beamspec *spec)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int add2image </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="structpx__point.html">px_point</a>&nbsp;</td>
          <td class="paramname"> <em>npixels</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structobservation.html">observation</a> *&nbsp;</td>
          <td class="paramname"> <em>obs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structbeamspec.html">beamspec</a> *&nbsp;</td>
          <td class="paramname"> <em>spec</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Function: add2image The function add a model spectra to the grism image. Uses the Kahan summation <a href="http://en.wikipedia.org/wiki/Kahan_summation_algorithm">http://en.wikipedia.org/wiki/Kahan_summation_algorithm</a> in order to reduce the numerical error. The pixerrs-array of the <a class="el" href="structobservation.html">observation</a> struct, which is not used in the simulations here, is taken to store the low-order bits. </p>

<p><div class="fragment"><pre class="fragment"><a name="l00273"></a>00273 {
<a name="l00274"></a>00274         <span class="keywordtype">double</span> y, t;
<a name="l00275"></a>00275         <span class="keywordtype">int</span> xact, yact;
<a name="l00276"></a>00276         <span class="keywordtype">int</span> ix, iy;
<a name="l00277"></a>00277 
<a name="l00278"></a>00278         <span class="comment">// go over each pixel in the array of the beam model</span>
<a name="l00279"></a>00279         <span class="keywordflow">for</span> (xact=0; xact &lt; spec-&gt;<a class="code" href="structbeamspec.html#a5585f5d3885305e980e09fed9a79a618">model</a>-&gt;size1; xact++)
<a name="l00280"></a>00280         {
<a name="l00281"></a>00281                 <span class="keywordflow">for</span> (yact=0; yact &lt; spec-&gt;<a class="code" href="structbeamspec.html#a5585f5d3885305e980e09fed9a79a618">model</a>-&gt;size2; yact++)
<a name="l00282"></a>00282                 {
<a name="l00283"></a>00283                         <span class="comment">// find the coordinates of the pixels in the whole image model</span>
<a name="l00284"></a>00284                         ix = (int)spec-&gt;<a class="code" href="structbeamspec.html#a4526cf634c09ad9fbd3f566dba8ea0fd">model_ref</a>.<a class="code" href="structd__point.html#a922a3b5d82a119168ba85e5f939d02c3">x</a> + xact;
<a name="l00285"></a>00285                         iy = (<span class="keywordtype">int</span>)spec-&gt;<a class="code" href="structbeamspec.html#a4526cf634c09ad9fbd3f566dba8ea0fd">model_ref</a>.<a class="code" href="structd__point.html#ad9846a025508bf8873a501ca5fcefbf4">y</a> + yact;
<a name="l00286"></a>00286 
<a name="l00287"></a>00287                         <span class="comment">// check for safety reasons whether the coordinates are inside</span>
<a name="l00288"></a>00288                         <span class="keywordflow">if</span> (ix &lt; 0 || iy &lt; 0 || ix &gt; (npixels.<a class="code" href="structpx__point.html#ab715a558731a820a25b50bd7797dd004">x</a>-1) || iy &gt; (npixels.<a class="code" href="structpx__point.html#a2d02b900722a71f22a8d5100822bda61">y</a>-1))
<a name="l00289"></a>00289                         {
<a name="l00290"></a>00290                                 fprintf(stderr, <span class="stringliteral">&quot;aXe_DISPIMAGE: function add2image\n\</span>
<a name="l00291"></a>00291 <span class="stringliteral">                       object %i beam %c pixel %i,%i is outside the image\n\</span>
<a name="l00292"></a>00292 <span class="stringliteral">                       This should not happend!!!&quot;</span>, spec-&gt;<a class="code" href="structbeamspec.html#ac47c161554a61fa65c4f5a744f761252">objectID</a>, <a class="code" href="aXe__grism_8h.html#a7d90dabb6016bb0e09b6ab84087b70a7">BEAM</a>(spec-&gt;<a class="code" href="structbeamspec.html#a8185e83f23ffbab21ec47ec3d2bea13c">beamID</a>), xact, yact);
<a name="l00293"></a>00293                         }
<a name="l00294"></a>00294                         <span class="keywordflow">else</span> {
<a name="l00295"></a>00295                                 <span class="comment">// sum up the pixels</span>
<a name="l00296"></a>00296                                 y = <a class="code" href="aXe__grism_8h.html#acf709ee71c580f1cd65d726ed03200ea">gsl_matrix_get</a>(spec-&gt;<a class="code" href="structbeamspec.html#a5585f5d3885305e980e09fed9a79a618">model</a>, xact, yact) - <a class="code" href="aXe__grism_8h.html#acf709ee71c580f1cd65d726ed03200ea">gsl_matrix_get</a>(obs-&gt;<a class="code" href="structobservation.html#a79ef486b081fa7b1973c39323f163010">pixerrs</a>, ix, iy);
<a name="l00297"></a>00297                                 t = <a class="code" href="aXe__grism_8h.html#acf709ee71c580f1cd65d726ed03200ea">gsl_matrix_get</a>(obs-&gt;<a class="code" href="structobservation.html#a012c0ff489fbb74fc6c9abfbd7c6e320">grism</a>, ix, iy) + y;
<a name="l00298"></a>00298                                 <a class="code" href="aXe__grism_8h.html#a1f386ef5cd5a3b916246c2bee80f083a">gsl_matrix_set</a>(obs-&gt;<a class="code" href="structobservation.html#a79ef486b081fa7b1973c39323f163010">pixerrs</a>, ix, iy, (t-<a class="code" href="aXe__grism_8h.html#acf709ee71c580f1cd65d726ed03200ea">gsl_matrix_get</a>(obs-&gt;<a class="code" href="structobservation.html#a012c0ff489fbb74fc6c9abfbd7c6e320">grism</a>, ix, iy))-y);
<a name="l00299"></a>00299                                 <a class="code" href="aXe__grism_8h.html#a1f386ef5cd5a3b916246c2bee80f083a">gsl_matrix_set</a>(obs-&gt;<a class="code" href="structobservation.html#a012c0ff489fbb74fc6c9abfbd7c6e320">grism</a>, ix, iy, t);
<a name="l00300"></a>00300                         }
<a name="l00301"></a>00301                 }
<a name="l00302"></a>00302         }
<a name="l00303"></a>00303 
<a name="l00304"></a>00304         <span class="keywordflow">return</span> 1;
<a name="l00305"></a>00305 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a09732c20cb3478586970093886a379ab"></a><!-- doxytag: member="disp_utils.c::compute_disp" ref="a09732c20cb3478586970093886a379ab" args="(char grism_file[], char OAF_file[], char CONF_file[], const char specmod_file[], const char objmod_file[], const double lambda_psf, observation *obs)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int compute_disp </td>
          <td>(</td>
          <td class="paramtype">char&nbsp;</td>
          <td class="paramname"> <em>grism_file</em>[], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char&nbsp;</td>
          <td class="paramname"> <em>OAF_file</em>[], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char&nbsp;</td>
          <td class="paramname"> <em>CONF_file</em>[], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char&nbsp;</td>
          <td class="paramname"> <em>specmod_file</em>[], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char&nbsp;</td>
          <td class="paramname"> <em>objmod_file</em>[], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const double&nbsp;</td>
          <td class="paramname"> <em>lambda_psf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structobservation.html">observation</a> *&nbsp;</td>
          <td class="paramname"> <em>obs</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Function: compute_disp The function computes the grism image. </p>

<p><div class="fragment"><pre class="fragment"><a name="l00049"></a>00049 {
<a name="l00050"></a>00050         <span class="keywordtype">object</span> **oblist;
<a name="l00051"></a>00051 
<a name="l00052"></a>00052         <a class="code" href="structbeamspec.html">beamspec</a> *spec;
<a name="l00053"></a>00053 
<a name="l00054"></a>00054         <a class="code" href="structfits__access.html">fits_access</a> *spectrum_access;
<a name="l00055"></a>00055         <a class="code" href="structfits__access.html">fits_access</a> *modim_access;
<a name="l00056"></a>00056 
<a name="l00057"></a>00057         <a class="code" href="structpx__point.html">px_point</a> npixels;
<a name="l00058"></a>00058         <a class="code" href="aXe__grism_8h.html#a6117e17bb3108107676f4486e62d40e5">gsl_matrix</a> *drzcoeffs;
<a name="l00059"></a>00059         <span class="keywordtype">int</span> nobjects=0;
<a name="l00060"></a>00060         <span class="keywordtype">int</span> i=0;
<a name="l00061"></a>00061         <span class="keywordtype">int</span> j=0;
<a name="l00062"></a>00062         <span class="keywordtype">int</span> beamID;
<a name="l00063"></a>00063         <span class="keywordtype">int</span> max_offs;
<a name="l00064"></a>00064 
<a name="l00065"></a>00065         <a class="code" href="structcalib__function.html">calib_function</a> *wl_calibration;
<a name="l00066"></a>00066         <span class="keywordtype">double</span> psf_offset=0;
<a name="l00067"></a>00067         <a class="code" href="structspectrum.html">spectrum</a> *resp;
<a name="l00068"></a>00068 
<a name="l00069"></a>00069         <a class="code" href="structaperture__conf.html">aperture_conf</a> *conf;
<a name="l00070"></a>00070 
<a name="l00071"></a>00071         <a class="code" href="structbeam.html">beam</a> actbeam;
<a name="l00072"></a>00072 
<a name="l00073"></a>00073         <span class="keywordtype">int</span> nx, ny;
<a name="l00074"></a>00074         <a class="code" href="structd__point.html">d_point</a> dpixel;
<a name="l00075"></a>00075         <span class="keywordtype">double</span> sval;
<a name="l00076"></a>00076 
<a name="l00077"></a>00077         <span class="keywordtype">int</span> f_status = 0;
<a name="l00078"></a>00078 
<a name="l00079"></a>00079         <a class="code" href="structdirobject.html">dirobject</a> *actdir;
<a name="l00080"></a>00080         <a class="code" href="structtracedata.html">tracedata</a> *acttrace;
<a name="l00081"></a>00081 
<a name="l00082"></a>00082         <a class="code" href="structFITScards.html">FITScards</a> *gcards;
<a name="l00083"></a>00083 
<a name="l00084"></a>00084         <span class="keywordtype">char</span> ID[60];
<a name="l00085"></a>00085 
<a name="l00086"></a>00086         <span class="comment">// load the object list</span>
<a name="l00087"></a>00087         fprintf (stdout, <span class="stringliteral">&quot;aXe_DISPIMAGE: Loading object aperture list...&quot;</span>);
<a name="l00088"></a>00088         oblist = <a class="code" href="inout__aper_8c.html#ae18fecd8e762c35bae1376a8d637d8e8">file_to_object_list_seq</a> (OAF_file, obs);
<a name="l00089"></a>00089         fprintf (stdout,<span class="stringliteral">&quot;%d objects loaded.\n&quot;</span>,<a class="code" href="inout__aper_8c.html#aa4bd812673400180537c7ea98650d3fe">object_list_size</a>(oblist));
<a name="l00090"></a>00090 
<a name="l00091"></a>00091         <span class="comment">// check whether highres spectra are given are available</span>
<a name="l00092"></a>00092         <span class="keywordflow">if</span> (strlen(specmod_file) &gt; 0) {
<a name="l00093"></a>00093                 <span class="comment">// load the spectral models</span>
<a name="l00094"></a>00094                 fprintf (stdout, <span class="stringliteral">&quot;aXe_DISPIMAGE: Loading spectral models...&quot;</span>);
<a name="l00095"></a>00095                 spectrum_access = <a class="code" href="specmodel__utils_8c.html#a5fd3ec3fb04fbdc2e1ce7ed627dbfc48">access_fits_models</a>(specmod_file);
<a name="l00096"></a>00096                 <span class="comment">// report the number of models loaded</span>
<a name="l00097"></a>00097                 fprintf (stdout,<span class="stringliteral">&quot;%d models available.\n&quot;</span>, spectrum_access-&gt;<a class="code" href="structfits__access.html#a241260b89300c1d0fa1356f279c1319c">n_modelHDU</a>);
<a name="l00098"></a>00098         }
<a name="l00099"></a>00099         <span class="keywordflow">else</span> {
<a name="l00100"></a>00100                 <span class="comment">// or set the struct to NULL</span>
<a name="l00101"></a>00101                 spectrum_access = NULL;
<a name="l00102"></a>00102         }
<a name="l00103"></a>00103 
<a name="l00104"></a>00104         <span class="comment">// check whether direct emission models are available</span>
<a name="l00105"></a>00105         <span class="keywordflow">if</span> (strlen(objmod_file) &gt; 0) {
<a name="l00106"></a>00106                 <span class="comment">// load the image models</span>
<a name="l00107"></a>00107                 fprintf (stdout, <span class="stringliteral">&quot;aXe_DISPIMAGE: Loading direct image models...&quot;</span>);
<a name="l00108"></a>00108                 modim_access = <a class="code" href="specmodel__utils_8c.html#a5fd3ec3fb04fbdc2e1ce7ed627dbfc48">access_fits_models</a>(objmod_file);
<a name="l00109"></a>00109                 objmod_file = NULL;
<a name="l00110"></a>00110                 fprintf (stdout,<span class="stringliteral">&quot;%d images available.\n&quot;</span>, modim_access-&gt;<a class="code" href="structfits__access.html#a241260b89300c1d0fa1356f279c1319c">n_modelHDU</a>);
<a name="l00111"></a>00111         }
<a name="l00112"></a>00112         <span class="keywordflow">else</span> {
<a name="l00113"></a>00113                 modim_access = NULL;
<a name="l00114"></a>00114         }
<a name="l00115"></a>00115 
<a name="l00116"></a>00116         <span class="comment">// allocate memory for the error-matrix, which is used for the Kahan summation;</span>
<a name="l00117"></a>00117         <span class="comment">// initialize the two arrays</span>
<a name="l00118"></a>00118         <span class="keywordflow">if</span> (!obs-&gt;<a class="code" href="structobservation.html#a79ef486b081fa7b1973c39323f163010">pixerrs</a>)
<a name="l00119"></a>00119                 obs-&gt;<a class="code" href="structobservation.html#a79ef486b081fa7b1973c39323f163010">pixerrs</a> = <a class="code" href="aXe__grism_8h.html#a1214ab1bea5fd80474d7a27db0bfb429">gsl_matrix_alloc</a> (obs-&gt;<a class="code" href="structobservation.html#a012c0ff489fbb74fc6c9abfbd7c6e320">grism</a>-&gt;size1, obs-&gt;<a class="code" href="structobservation.html#a012c0ff489fbb74fc6c9abfbd7c6e320">grism</a>-&gt;size2);
<a name="l00120"></a>00120         <a class="code" href="aXe__grism_8h.html#af6161aeb008a1ffa7d888df6ccbef7cc">gsl_matrix_set_all</a>(obs-&gt;<a class="code" href="structobservation.html#a012c0ff489fbb74fc6c9abfbd7c6e320">grism</a>,   0.0);
<a name="l00121"></a>00121         <a class="code" href="aXe__grism_8h.html#af6161aeb008a1ffa7d888df6ccbef7cc">gsl_matrix_set_all</a>(obs-&gt;<a class="code" href="structobservation.html#a79ef486b081fa7b1973c39323f163010">pixerrs</a>, 0.0);
<a name="l00122"></a>00122 
<a name="l00123"></a>00123         <span class="comment">// get the image dimensions</span>
<a name="l00124"></a>00124         npixels = <a class="code" href="aXe__utils_8c.html#ae7f4f277c2b5d03b7ce52b2392d176b2">get_npixel</a>(obs);
<a name="l00125"></a>00125 
<a name="l00126"></a>00126         conf = <a class="code" href="aper__conf_8c.html#a45d84f2fc00f438b5da9054c45b7736c">get_aperture_descriptor</a> (CONF_file);
<a name="l00127"></a>00127         <a class="code" href="aper__conf_8c.html#aa1383c872a0151435880f6ad28f9bd88">get_extension_numbers</a>(grism_file, conf, conf-&gt;<a class="code" href="structaperture__conf.html#a730cc39bb91c34d0dfe92977cb2aaf46">optkey1</a>, conf-&gt;<a class="code" href="structaperture__conf.html#a6b84a9e8edd79d020ea2e189839d86ba">optval1</a>);
<a name="l00128"></a>00128         <span class="comment">// save the fits header</span>
<a name="l00129"></a>00129         gcards = <a class="code" href="aXe__utils_8c.html#aa1a7ef7b7d19206e1df681bf2bea0d7c">get_FITS_cards</a>(grism_file, conf-&gt;<a class="code" href="structaperture__conf.html#abe36ba97113a8ccb1916acdbe5db113f">science_numext</a>);
<a name="l00130"></a>00130 
<a name="l00131"></a>00131         <span class="comment">// get the  matrix with the drizzle coefficients</span>
<a name="l00132"></a>00132         drzcoeffs = <a class="code" href="crossdisp__utils_8c.html#a24fed0f1bc1490134a2c5c5baaee6ad5">get_crossdisp_matrix</a>(grism_file, conf-&gt;<a class="code" href="structaperture__conf.html#abe36ba97113a8ccb1916acdbe5db113f">science_numext</a>);
<a name="l00133"></a>00133         <span class="keywordflow">if</span> (drzcoeffs-&gt;size1 &lt; 2 || !drzcoeffs-&gt;size2)
<a name="l00134"></a>00134                 fprintf (stderr, <span class="stringliteral">&quot;aXe_DISPIMAGE: function oblist_to_dirlist\n\</span>
<a name="l00135"></a>00135 <span class="stringliteral">                    Could not get the drizzle coefficients in file: %s\n&quot;</span>, grism_file);
<a name="l00136"></a>00136 
<a name="l00137"></a>00137         <span class="comment">// determine an offset from the PSF_OFFSET</span>
<a name="l00138"></a>00138         max_offs = (int)ceil(<a class="code" href="aper__conf_8c.html#a63e3b3bf0beebc0fe4677687d96b85df">get_max_offset</a>(conf));
<a name="l00139"></a>00139 
<a name="l00140"></a>00140         <span class="comment">// determine the number of objects in the object list</span>
<a name="l00141"></a>00141         nobjects = <a class="code" href="inout__aper_8c.html#aa4bd812673400180537c7ea98650d3fe">object_list_size</a>(oblist);
<a name="l00142"></a>00142 
<a name="l00143"></a>00143         <span class="comment">// for each object</span>
<a name="l00144"></a>00144         <span class="keywordflow">for</span> (i = 0; i &lt; nobjects; i++)
<a name="l00145"></a>00145         {
<a name="l00146"></a>00146                 <span class="keywordflow">if</span> (oblist[i]-&gt;nbeams &gt; 0) {
<a name="l00147"></a>00147                         <span class="comment">//---</span>
<a name="l00148"></a>00148                         <span class="comment">//new way to get the direct image</span>
<a name="l00149"></a>00149                         <span class="keywordflow">if</span> (<a class="code" href="specmodel__utils_8c.html#a24e2a40a5d4d62193ae91e05f9c395ae">has_aper_dirim</a>(modim_access, oblist[i]))
<a name="l00150"></a>00150                                 actdir = <a class="code" href="model__utils_8c.html#a3c08d3f85de2d04b0f383f9beda7447e">load_dirobj_img</a>(oblist[i], modim_access);
<a name="l00151"></a>00151                         <span class="keywordflow">else</span>
<a name="l00152"></a>00152                                 actdir = <a class="code" href="model__utils_8c.html#ae01b7359b803f5823de49af7ba8de948">fill_dirobject</a>(oblist[i], npixels, drzcoeffs, 5, max_offs);
<a name="l00153"></a>00153                         <span class="comment">//---</span>
<a name="l00154"></a>00154 
<a name="l00155"></a>00155                         <span class="comment">// load the spectral values into the dirobject</span>
<a name="l00156"></a>00156                         <a class="code" href="model__utils_8c.html#adee63ef5db37c64dcdd2288a4cff5113">load_spectrum</a>(oblist[i], actdir, spectrum_access, 1);
<a name="l00157"></a>00157 
<a name="l00158"></a>00158                         <span class="keywordflow">for</span> (beamID=0; beamID &lt; conf-&gt;<a class="code" href="structaperture__conf.html#af53b09fa4f86ff116c002640c3e817d9">nbeams</a>; beamID++) {
<a name="l00159"></a>00159                                 actdir-&gt;<a class="code" href="structdirobject.html#a804b505c34bbecd0eb09832e34cbd5ce">xy_off</a>[beamID].<a class="code" href="structd__point.html#a922a3b5d82a119168ba85e5f939d02c3">x</a> = 0.0;
<a name="l00160"></a>00160                                 actdir-&gt;<a class="code" href="structdirobject.html#a804b505c34bbecd0eb09832e34cbd5ce">xy_off</a>[beamID].<a class="code" href="structd__point.html#ad9846a025508bf8873a501ca5fcefbf4">y</a> = 0.0;
<a name="l00161"></a>00161                         }
<a name="l00162"></a>00162 
<a name="l00163"></a>00163                         <span class="comment">// for each beam</span>
<a name="l00164"></a>00164                         <span class="keywordflow">for</span> (j=0; j &lt; oblist[i]-&gt;<a class="code" href="structobject.html#a14120e3b048a2118f7acd75ea1571c60">nbeams</a>; j++) {
<a name="l00165"></a>00165                                 spec=<a class="code" href="spc__model_8c.html#a8a1e63b6f29be161a726a1c08a26ebb9">dimension_beamspec</a>(actdir, oblist[i], npixels, conf, j);
<a name="l00166"></a>00166 
<a name="l00167"></a>00167                                 <span class="keywordflow">if</span> (spec == NULL) {
<a name="l00168"></a>00168                                         fprintf(stderr, <span class="stringliteral">&quot;aXe_DISPIMAGE: function compute_disp\n\</span>
<a name="l00169"></a>00169 <span class="stringliteral">                                beamspec is NULL\n\</span>
<a name="l00170"></a>00170 <span class="stringliteral">                                skipping object %i beam %c ...&quot;</span>, oblist[i]-&gt;ID, <a class="code" href="aXe__grism_8h.html#a7d90dabb6016bb0e09b6ab84087b70a7">BEAM</a>(j));
<a name="l00171"></a>00171                                 }
<a name="l00172"></a>00172                                 <span class="keywordflow">else</span> {
<a name="l00173"></a>00173                                         actbeam = <a class="code" href="model__utils_8c.html#a457e67339a8e12cee377ffebf7410c0d">get_beam_for_beamspec</a>(oblist, nobjects, spec);
<a name="l00174"></a>00174                                         <span class="keywordflow">if</span> (actbeam.<a class="code" href="structbeam.html#a8c7dc459dedfd957741d35c59440972f">ignore</a> != 1)
<a name="l00175"></a>00175                                         {
<a name="l00176"></a>00176                                                 psf_offset = <a class="code" href="aper__conf_8c.html#a8164c87851c09beb885a55483557a0f2">get_psf_offset</a>(conf, actbeam);
<a name="l00177"></a>00177                                                 wl_calibration = <a class="code" href="model__utils_8c.html#a89e076f16fb5ab1d68d6fd60a8c56818">get_calib_function</a>(spec, actdir, CONF_file, conf);
<a name="l00178"></a>00178                                                 resp = <a class="code" href="model__utils_8c.html#ac1c970f8545c70717925e789935baf15">get_throughput_spec</a>(spec, CONF_file);
<a name="l00179"></a>00179                                                 acttrace = <a class="code" href="model__utils_8c.html#a0ad6a3c9e3542d3085e0b4d840e76ad1">compute_short_tracedata</a>(conf, actbeam, actdir, wl_calibration, spec);
<a name="l00180"></a>00180 
<a name="l00181"></a>00181                                                 <span class="keywordflow">if</span> (acttrace-&gt;<a class="code" href="structtracedata.html#af5aed7b8f1629b86be33dc7d57056bcc">npoints</a> &lt; 1)
<a name="l00182"></a>00182                                                 {
<a name="l00183"></a>00183                                                         fprintf(stderr, <span class="stringliteral">&quot;aXe_DISPIMAGE: function compute_disp\n\</span>
<a name="l00184"></a>00184 <span class="stringliteral">                                        trace is empty\n\</span>
<a name="l00185"></a>00185 <span class="stringliteral">                                        skipping object %i beam %c ...&quot;</span>, spec-&gt;<a class="code" href="structbeamspec.html#ac47c161554a61fa65c4f5a744f761252">objectID</a>, <a class="code" href="aXe__grism_8h.html#a7d90dabb6016bb0e09b6ab84087b70a7">BEAM</a>(spec-&gt;<a class="code" href="structbeamspec.html#a8185e83f23ffbab21ec47ec3d2bea13c">beamID</a>));
<a name="l00186"></a>00186                                                 }
<a name="l00187"></a>00187                                                 <span class="keywordflow">else</span> {
<a name="l00188"></a>00188 
<a name="l00189"></a>00189                                                         <span class="comment">// fill the flux information into the tracedata</span>
<a name="l00190"></a>00190                                                         <a class="code" href="model__utils_8c.html#ab5aca9ee955a502955517d541422cc27">fill_fluxfrom_SED</a>(actdir, acttrace);
<a name="l00191"></a>00191                                                         fprintf(stdout, <span class="stringliteral">&quot;aXe_DISPIMAGE: modelling object %i beam %c ...&quot;</span>, spec-&gt;<a class="code" href="structbeamspec.html#ac47c161554a61fa65c4f5a744f761252">objectID</a>, <a class="code" href="aXe__grism_8h.html#a7d90dabb6016bb0e09b6ab84087b70a7">BEAM</a>(spec-&gt;<a class="code" href="structbeamspec.html#a8185e83f23ffbab21ec47ec3d2bea13c">beamID</a>));
<a name="l00192"></a>00192 
<a name="l00193"></a>00193                                                         <span class="comment">// iterate over the direct image area</span>
<a name="l00194"></a>00194                                                         <span class="keywordflow">for</span> (nx=actdir-&gt;<a class="code" href="structdirobject.html#ac068f35c585eec4cd1e5d3392c2dd698">ix_min</a>; nx&lt;=actdir-&gt;ix_max; nx++) {
<a name="l00195"></a>00195                                                                 <span class="keywordflow">for</span> (ny=actdir-&gt;<a class="code" href="structdirobject.html#af24c9a92fa18516591e43d96eec13272">iy_min</a>; ny&lt;=actdir-&gt;iy_max; ny++) {
<a name="l00196"></a>00196 
<a name="l00197"></a>00197                                                                         <span class="comment">// fill the dpixel structure</span>
<a name="l00198"></a>00198                                                                         dpixel.<a class="code" href="structd__point.html#a922a3b5d82a119168ba85e5f939d02c3">x</a> = (double)nx;
<a name="l00199"></a>00199                                                                         dpixel.<a class="code" href="structd__point.html#ad9846a025508bf8873a501ca5fcefbf4">y</a> = (double)ny;
<a name="l00200"></a>00200 
<a name="l00201"></a>00201                                                                         <span class="keywordflow">if</span> (actdir-&gt;<a class="code" href="structdirobject.html#a484dadbe6f9bdade97aa303366b4ef6a">dirim</a>)
<a name="l00202"></a>00202                                                                         {
<a name="l00203"></a>00203                                                                                 sval = <a class="code" href="specmodel__utils_8c.html#a90e8278f78014bbbaa595341f92cedb5">get_diremission_value</a>(actdir-&gt;<a class="code" href="structdirobject.html#a484dadbe6f9bdade97aa303366b4ef6a">dirim</a>, dpixel.<a class="code" href="structd__point.html#a922a3b5d82a119168ba85e5f939d02c3">x</a> - actbeam.<a class="code" href="structbeam.html#a54c64670a8b3e8732c1468d156ddb0ca">refpoint</a>.<a class="code" href="structd__point.html#a922a3b5d82a119168ba85e5f939d02c3">x</a>, dpixel.<a class="code" href="structd__point.html#ad9846a025508bf8873a501ca5fcefbf4">y</a> - actbeam.<a class="code" href="structbeam.html#a54c64670a8b3e8732c1468d156ddb0ca">refpoint</a>.<a class="code" href="structd__point.html#ad9846a025508bf8873a501ca5fcefbf4">y</a>);
<a name="l00204"></a>00204                                                                                 gsl_vector_set_all (acttrace-&gt;<a class="code" href="structtracedata.html#a263d2f1a51308e73d79c77f5e62c01fb">gvalue</a>, sval);
<a name="l00205"></a>00205                                                                         }
<a name="l00206"></a>00206                                                                         <span class="keywordflow">else</span> {
<a name="l00207"></a>00207                                                                                 <span class="comment">// check whether a wavelength-dependent</span>
<a name="l00208"></a>00208                                                                                 <span class="comment">// emission profile is given</span>
<a name="l00209"></a>00209                                                                                 <span class="keywordflow">if</span> ((conf-&gt;<a class="code" href="structaperture__conf.html#a904a154040bedf410b669b65791c96e2">psfcoeffs</a> &amp;&amp; conf-&gt;<a class="code" href="structaperture__conf.html#a469dc826e363a3b9e340aa99824e2f30">psfrange</a>) || psf_offset) {
<a name="l00210"></a>00210                                                                                         <span class="comment">// fill in the wavelength dependend</span>
<a name="l00211"></a>00211                                                                                         <span class="comment">// emission values</span>
<a name="l00212"></a>00212                                                                                         <a class="code" href="model__utils_8c.html#ae73d0c2c001f041062d3f9776fd55dc1">fill_gaussvalues</a>(dpixel, actbeam, actdir, lambda_psf, conf, psf_offset, acttrace);
<a name="l00213"></a>00213                                                                                 }
<a name="l00214"></a>00214                                                                                 <span class="keywordflow">else</span> {
<a name="l00215"></a>00215                                                                                         <span class="comment">// do a subsampling over the pixel</span>
<a name="l00216"></a>00216                                                                                         <span class="comment">// to get a more appropriate value for the</span>
<a name="l00217"></a>00217                                                                                         <span class="comment">// emission val</span>
<a name="l00218"></a>00218                                                                                         sval = <a class="code" href="model__utils_8c.html#a5d8695af668aaed17d349ca4eb36292c">get_sub_emodel_value</a>(dpixel, actbeam, actdir-&gt;<a class="code" href="structdirobject.html#a1e61e87181abdea5dab21eb1dc3564dc">drzscale</a>);
<a name="l00219"></a>00219                                                                                         gsl_vector_set_all (acttrace-&gt;<a class="code" href="structtracedata.html#a263d2f1a51308e73d79c77f5e62c01fb">gvalue</a>, sval);
<a name="l00220"></a>00220                                                                                 }
<a name="l00221"></a>00221                                                                         }
<a name="l00222"></a>00222 
<a name="l00223"></a>00223                                                                         <span class="comment">// transfer the pixel contribution to the beam spectrum</span>
<a name="l00224"></a>00224                                                                         <a class="code" href="spc__model_8c.html#a069e0ff507381b9e8d1351c4fcd7f788">fill_pixel_in_speed</a>(actdir, acttrace, dpixel, resp, spec, wl_calibration);
<a name="l00225"></a>00225                                                                 }
<a name="l00226"></a>00226                                                         }
<a name="l00227"></a>00227 
<a name="l00228"></a>00228                                                         <span class="comment">// add the beam spectrum to the simulation</span>
<a name="l00229"></a>00229                                                         <a class="code" href="disp__utils_8c.html#a2665684d5c0fdbca115fd3f8f096bb16">add2image</a>(npixels, obs, spec);
<a name="l00230"></a>00230                                                 }
<a name="l00231"></a>00231 
<a name="l00232"></a>00232                                                 <span class="comment">// release the memory for the various structures</span>
<a name="l00233"></a>00233                                                 fprintf(stdout, <span class="stringliteral">&quot; Done\n&quot;</span>);
<a name="l00234"></a>00234                                                 <a class="code" href="spc__wl__calib_8c.html#ac0c65c345f1f8183331d4b858f5c5b29">free_calib</a>(wl_calibration);
<a name="l00235"></a>00235                                                 <a class="code" href="spc__spc_8c.html#a7e957a43837d35fe0e2195ddcdcda221">free_spectrum</a>(resp);
<a name="l00236"></a>00236                                                 <a class="code" href="model__utils_8c.html#aa698da13e1ad04e38c6ce9c51e4d2923">free_tracedata</a>(acttrace);
<a name="l00237"></a>00237                                                 <a class="code" href="aXe__grism_8h.html#a61aa1d37853a90711852146f18d0b85f">gsl_matrix_free</a> (spec-&gt;<a class="code" href="structbeamspec.html#a5585f5d3885305e980e09fed9a79a618">model</a>);
<a name="l00238"></a>00238                                                 free(spec);
<a name="l00239"></a>00239                                         }
<a name="l00240"></a>00240                                 }
<a name="l00241"></a>00241                         }
<a name="l00242"></a>00242                         <span class="comment">// free the entire direct image</span>
<a name="l00243"></a>00243                         <a class="code" href="model__utils_8c.html#aa711bf6afa5532517ed581be9e59d2d1">free_dirobject</a> (actdir);
<a name="l00244"></a>00244                 }
<a name="l00245"></a>00245         }
<a name="l00246"></a>00246 
<a name="l00247"></a>00247         <span class="comment">// write grism image and copy the FITS header</span>
<a name="l00248"></a>00248         <a class="code" href="aXe__utils_8c.html#a6a5d64fa0baa598fc20741fa603bee11">gsl_to_FITSimage</a>(obs-&gt;<a class="code" href="structobservation.html#a012c0ff489fbb74fc6c9abfbd7c6e320">grism</a>, grism_file, 1, <span class="stringliteral">&quot;SCI&quot;</span>);
<a name="l00249"></a>00249         <a class="code" href="aXe__utils_8c.html#a8abd9ee69f161e0ac3ee47dc722cebf0">put_FITS_cards</a>(grism_file, 2, gcards);
<a name="l00250"></a>00250 
<a name="l00251"></a>00251         <span class="keywordflow">if</span> (oblist !=NULL)
<a name="l00252"></a>00252                 <a class="code" href="aXe__utils_8c.html#a1f63bfb071e9d0ea1f8854efdfae4692">free_oblist</a> (oblist);
<a name="l00253"></a>00253         <span class="keywordflow">if</span> (spectrum_access != NULL)
<a name="l00254"></a>00254                 <a class="code" href="specmodel__utils_8c.html#a05bec4559d0ac39512725211cee1d2ff">free_fits_access</a>(spectrum_access);
<a name="l00255"></a>00255         <span class="keywordflow">if</span> (modim_access!=NULL)
<a name="l00256"></a>00256                 <a class="code" href="specmodel__utils_8c.html#a05bec4559d0ac39512725211cee1d2ff">free_fits_access</a>(modim_access);
<a name="l00257"></a>00257         <a class="code" href="aXe__grism_8h.html#a61aa1d37853a90711852146f18d0b85f">gsl_matrix_free</a>(drzcoeffs);
<a name="l00258"></a>00258         <a class="code" href="spc__FITScards_8c.html#aaaba4aea09f708f12bf52e9446e5384b">free_FITScards</a>(gcards);
<a name="l00259"></a>00259         <a class="code" href="aper__conf_8c.html#a608428f59a2adb25874101610cd6afe4">free_aperture_conf</a>(conf);
<a name="l00260"></a>00260 
<a name="l00261"></a>00261         <span class="keywordflow">return</span> 1;
<a name="l00262"></a>00262 }
</pre></div></p>

</div>
</div>
</div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&nbsp;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&nbsp;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr size="1"/><address style="text-align: right;"><small>Generated on 12 Oct 2014 for TIPS by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
