<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>TIPS: /renoir/fourmano/Desktop/OUSIM/TIPS/branches/tips_build/include/axesim/dirimage_model.h File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>/renoir/fourmano/Desktop/OUSIM/TIPS/branches/tips_build/include/axesim/dirimage_model.h File Reference</h1><code>#include &lt;math.h&gt;</code><br/>
<code>#include &lt;fitsio.h&gt;</code><br/>
<code>#include &lt;gsl/gsl_matrix.h&gt;</code><br/>
<code>#include &lt;gsl/gsl_vector.h&gt;</code><br/>
<code>#include &lt;gsl/gsl_interp.h&gt;</code><br/>
<code>#include &quot;<a class="el" href="spc__cfg_8h_source.html">spc_cfg.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="aXe__utils_8h_source.html">aXe_utils.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="aXe__errors_8h_source.html">aXe_errors.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="aXe__grism_8h_source.html">aXe_grism.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="fringe__conf_8h_source.html">fringe_conf.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="model__utils_8h_source.html">model_utils.h</a>&quot;</code><br/>

<p><a href="dirimage__model_8h_source.html">Go to the source code of this file.</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Namespaces</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">namespace &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacedirimage__model.html">dirimage_model</a></td></tr>
<tr><td colspan="2"><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="dirimage__model_8h.html#ae28fee8b129f82673cf655e1a6eac570">TPASS_INTERP_TYPE</a>&nbsp;&nbsp;&nbsp;gsl_interp_linear</td></tr>
<tr><td colspan="2"><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="dirimage__model_8h.html#ac3812e89e6731d07be8b48e2ad4d158d">compute_dirimage_modelOld</a> (char dirim_file_path[], char conf_file_path[], char tpass_file_path[], char specmod_file_path[], char objmod_file_path[], char aper_file_path[], const double model_scale, const double tel_area, const double lambda_psf, <a class="el" href="structobservation.html">observation</a> *obs, char map_file_path[])</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="dirimage__model_8h.html#aa668e0817fc30101757af60f38adc8f4">compute_dirimage_model</a> (char dirim_file_path[], char conf_file_path[], char tpass_file_path[], char specmod_file_path[], char objmod_file_path[], char aper_file_path[], const double model_scale, const double tel_area, const double lambda_psf, <a class="el" href="structobservation.html">observation</a> *obs, char map_file_path[])</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="structinterpolator.html">interpolator</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="dirimage__model_8h.html#a9ad9a6858c9a87180afb5cddfbdab204">get_filter_sensitivity</a> (const char tpass_file[], const double tel_area)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="dirimage__model_8h.html#a371e3a170621827e2ec09b3746df0ffb">make_dirimage_object</a> (<a class="el" href="structobject.html">object</a> *actobject, <a class="el" href="structdirobject.html">dirobject</a> *actdir, <a class="el" href="structinterpolator.html">interpolator</a> *tpass, gsl_matrix *dirimage_matrix)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">gsl_matrix *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="dirimage__model_8h.html#a18d35af5ae5d98dcf27d0ef9b47cfdf0">make_dirimage</a> (<a class="el" href="structobject.html">object</a> **oblist, <a class="el" href="structdirobject.html">dirobject</a> **dirlist, const <a class="el" href="structpx__point.html">px_point</a> npixels, const double lambda_psf, <a class="el" href="structinterpolator.html">interpolator</a> *tpass)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">double&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="dirimage__model_8h.html#a35f00ade0db1ab9b955eb2daa34a1c8f">get_cps_for_dirobject</a> (<a class="el" href="structinterpolator.html">interpolator</a> *tpass, <a class="el" href="structdirobject.html">dirobject</a> *actdir)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">double&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="dirimage__model_8h.html#af910d0984d034fc1377290e01bdaf1a5">integrate_interpolator</a> (<a class="el" href="structinterpolator.html">interpolator</a> *combine)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="structinterpolator.html">interpolator</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="dirimage__model_8h.html#af16f00a45c2122acf9e354440470502f">combine_tpass_SED</a> (<a class="el" href="structinterpolator.html">interpolator</a> *tpass, <a class="el" href="structdirobject.html">dirobject</a> *actdir)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="structinterpolator.html">interpolator</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="dirimage__model_8h.html#ad920380d8766ba433e531afd159f5ed4">get_combined_tpass_SED</a> (gsl_vector *indep_data, <a class="el" href="structinterpolator.html">interpolator</a> *tpass, <a class="el" href="structdirobject.html">dirobject</a> *actdir)</td></tr>
</table>
<hr/><h2>Define Documentation</h2>
<a class="anchor" id="ae28fee8b129f82673cf655e1a6eac570"></a><!-- doxytag: member="dirimage_model.h::TPASS_INTERP_TYPE" ref="ae28fee8b129f82673cf655e1a6eac570" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define TPASS_INTERP_TYPE&nbsp;&nbsp;&nbsp;gsl_interp_linear</td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="af16f00a45c2122acf9e354440470502f"></a><!-- doxytag: member="dirimage_model.h::combine_tpass_SED" ref="af16f00a45c2122acf9e354440470502f" args="(interpolator *tpass, dirobject *actdir)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structinterpolator.html">interpolator</a>* combine_tpass_SED </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structinterpolator.html">interpolator</a> *&nbsp;</td>
          <td class="paramname"> <em>tpass</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structdirobject.html">dirobject</a> *&nbsp;</td>
          <td class="paramname"> <em>actdir</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p><div class="fragment"><pre class="fragment"><a name="l00501"></a>00501 {
<a name="l00502"></a>00502   <a class="code" href="structinterpolator.html">interpolator</a> *combine;
<a name="l00503"></a>00503 
<a name="l00504"></a>00504   <span class="keywordtype">int</span> index=0;
<a name="l00505"></a>00505   <span class="keywordtype">int</span> n_additional=0;
<a name="l00506"></a>00506   <span class="keywordtype">int</span> act_index;
<a name="l00507"></a>00507 
<a name="l00508"></a>00508   gsl_vector     *indep_data;
<a name="l00509"></a>00509   
<a name="l00510"></a>00510   <span class="comment">// go over all SED data points</span>
<a name="l00511"></a>00511   <span class="keywordflow">for</span> (index = 0; index &lt; actdir-&gt;<a class="code" href="structdirobject.html#a79645e83aebf3988bd3464b2079d24c1">SED</a>-&gt;<a class="code" href="structenergy__distrib.html#ae5e24fde4a41b46a8b8510118f646e67">npoints</a>; index++)
<a name="l00512"></a>00512     {
<a name="l00513"></a>00513       <span class="comment">// transform to Angstrom</span>
<a name="l00514"></a>00514       actdir-&gt;<a class="code" href="structdirobject.html#a79645e83aebf3988bd3464b2079d24c1">SED</a>-&gt;<a class="code" href="structenergy__distrib.html#ac32d12647e9ef7f158b0d4532c09a568">wavelength</a>[index] *= 10.0;
<a name="l00515"></a>00515 
<a name="l00516"></a>00516       <span class="comment">// check whether the independent data point</span>
<a name="l00517"></a>00517       <span class="comment">// falls in the area of the sensitivity</span>
<a name="l00518"></a>00518       <span class="keywordflow">if</span> (actdir-&gt;<a class="code" href="structdirobject.html#a79645e83aebf3988bd3464b2079d24c1">SED</a>-&gt;<a class="code" href="structenergy__distrib.html#ac32d12647e9ef7f158b0d4532c09a568">wavelength</a>[index] &lt; tpass-&gt;<a class="code" href="structinterpolator.html#a4ccf4f1e42f5207f311bffcbebb7ea9c">xmax</a> 
<a name="l00519"></a>00519           &amp;&amp; actdir-&gt;<a class="code" href="structdirobject.html#a79645e83aebf3988bd3464b2079d24c1">SED</a>-&gt;<a class="code" href="structenergy__distrib.html#ac32d12647e9ef7f158b0d4532c09a568">wavelength</a>[index] &gt;  tpass-&gt;<a class="code" href="structinterpolator.html#a09c1238a6c4be948ef51e29676074b6f">xmin</a>)
<a name="l00520"></a>00520         <span class="comment">// enhance the number </span>
<a name="l00521"></a>00521         <span class="comment">// of additional data points</span>
<a name="l00522"></a>00522         n_additional += 1;
<a name="l00523"></a>00523     }
<a name="l00524"></a>00524 
<a name="l00525"></a>00525   <span class="comment">// allocate memory for the new independent value list</span>
<a name="l00526"></a>00526   indep_data   = gsl_vector_alloc(tpass-&gt;<a class="code" href="structinterpolator.html#a058a378f76dfb0349cd2016f450a7332">nvals</a> + n_additional);
<a name="l00527"></a>00527 
<a name="l00528"></a>00528   <span class="comment">// go over all sensitivity data points and fill in</span>
<a name="l00529"></a>00529   <span class="comment">// the independent values</span>
<a name="l00530"></a>00530   <span class="keywordflow">for</span> (index = 0; index &lt; tpass-&gt;<a class="code" href="structinterpolator.html#a058a378f76dfb0349cd2016f450a7332">nvals</a>; index++)
<a name="l00531"></a>00531     gsl_vector_set(indep_data, index, tpass-&gt;<a class="code" href="structinterpolator.html#a0114ddc19b1dd09d7920d11970e22a8e">xvals</a>[index]);
<a name="l00532"></a>00532 
<a name="l00533"></a>00533   <span class="comment">// set the counter to the next free index</span>
<a name="l00534"></a>00534   act_index = tpass-&gt;<a class="code" href="structinterpolator.html#a058a378f76dfb0349cd2016f450a7332">nvals</a>;
<a name="l00535"></a>00535 
<a name="l00536"></a>00536   <span class="comment">// go over all SED data points</span>
<a name="l00537"></a>00537   <span class="keywordflow">for</span> (index = 0; index &lt; actdir-&gt;<a class="code" href="structdirobject.html#a79645e83aebf3988bd3464b2079d24c1">SED</a>-&gt;<a class="code" href="structenergy__distrib.html#ae5e24fde4a41b46a8b8510118f646e67">npoints</a>; index++)
<a name="l00538"></a>00538     <span class="comment">// check whether the independent data point</span>
<a name="l00539"></a>00539     <span class="comment">// falls in the area of the sensitivity</span>
<a name="l00540"></a>00540     <span class="keywordflow">if</span> (actdir-&gt;<a class="code" href="structdirobject.html#a79645e83aebf3988bd3464b2079d24c1">SED</a>-&gt;<a class="code" href="structenergy__distrib.html#ac32d12647e9ef7f158b0d4532c09a568">wavelength</a>[index] &lt; tpass-&gt;<a class="code" href="structinterpolator.html#a4ccf4f1e42f5207f311bffcbebb7ea9c">xmax</a> 
<a name="l00541"></a>00541         &amp;&amp; actdir-&gt;<a class="code" href="structdirobject.html#a79645e83aebf3988bd3464b2079d24c1">SED</a>-&gt;<a class="code" href="structenergy__distrib.html#ac32d12647e9ef7f158b0d4532c09a568">wavelength</a>[index] &gt;  tpass-&gt;<a class="code" href="structinterpolator.html#a09c1238a6c4be948ef51e29676074b6f">xmin</a>)
<a name="l00542"></a>00542       {
<a name="l00543"></a>00543         <span class="comment">// fill in the additional independent data point</span>
<a name="l00544"></a>00544         <span class="comment">// from the SED</span>
<a name="l00545"></a>00545         gsl_vector_set(indep_data, act_index, actdir-&gt;<a class="code" href="structdirobject.html#a79645e83aebf3988bd3464b2079d24c1">SED</a>-&gt;<a class="code" href="structenergy__distrib.html#ac32d12647e9ef7f158b0d4532c09a568">wavelength</a>[index]);
<a name="l00546"></a>00546 
<a name="l00547"></a>00547         <span class="comment">// enhance the counter</span>
<a name="l00548"></a>00548         act_index += 1;
<a name="l00549"></a>00549       }
<a name="l00550"></a>00550 
<a name="l00551"></a>00551   <span class="comment">// sort the vector</span>
<a name="l00552"></a>00552   gsl_sort_vector(indep_data);
<a name="l00553"></a>00553 
<a name="l00554"></a>00554 
<a name="l00555"></a>00555   <span class="comment">// compose a new interpolator from the independent values</span>
<a name="l00556"></a>00556   combine = <a class="code" href="dirimage__model_8c.html#ad920380d8766ba433e531afd159f5ed4">get_combined_tpass_SED</a>(indep_data, tpass, actdir);
<a name="l00557"></a>00557 
<a name="l00558"></a>00558   <span class="comment">// release memory in the weight vector </span>
<a name="l00559"></a>00559   gsl_vector_free(indep_data); 
<a name="l00560"></a>00560 
<a name="l00561"></a>00561   <span class="comment">// go over all SED data points</span>
<a name="l00562"></a>00562   <span class="keywordflow">for</span> (index = 0; index &lt; actdir-&gt;<a class="code" href="structdirobject.html#a79645e83aebf3988bd3464b2079d24c1">SED</a>-&gt;<a class="code" href="structenergy__distrib.html#ae5e24fde4a41b46a8b8510118f646e67">npoints</a>; index++)
<a name="l00563"></a>00563     <span class="comment">// transform to nm</span>
<a name="l00564"></a>00564     actdir-&gt;<a class="code" href="structdirobject.html#a79645e83aebf3988bd3464b2079d24c1">SED</a>-&gt;<a class="code" href="structenergy__distrib.html#ac32d12647e9ef7f158b0d4532c09a568">wavelength</a>[index] /= 10.0;
<a name="l00565"></a>00565 
<a name="l00566"></a>00566   <span class="comment">// return the interpolator</span>
<a name="l00567"></a>00567   <span class="keywordflow">return</span> combine;
<a name="l00568"></a>00568 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="aa668e0817fc30101757af60f38adc8f4"></a><!-- doxytag: member="dirimage_model.h::compute_dirimage_model" ref="aa668e0817fc30101757af60f38adc8f4" args="(char dirim_file_path[], char conf_file_path[], char tpass_file_path[], char specmod_file_path[], char objmod_file_path[], char aper_file_path[], const double model_scale, const double tel_area, const double lambda_psf, observation *obs, char map_file_path[])" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int compute_dirimage_model </td>
          <td>(</td>
          <td class="paramtype">char&nbsp;</td>
          <td class="paramname"> <em>dirim_file_path</em>[], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char&nbsp;</td>
          <td class="paramname"> <em>conf_file_path</em>[], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char&nbsp;</td>
          <td class="paramname"> <em>tpass_file_path</em>[], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char&nbsp;</td>
          <td class="paramname"> <em>specmod_file_path</em>[], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char&nbsp;</td>
          <td class="paramname"> <em>objmod_file_path</em>[], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char&nbsp;</td>
          <td class="paramname"> <em>aper_file_path</em>[], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const double&nbsp;</td>
          <td class="paramname"> <em>model_scale</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const double&nbsp;</td>
          <td class="paramname"> <em>tel_area</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const double&nbsp;</td>
          <td class="paramname"> <em>lambda_psf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structobservation.html">observation</a> *&nbsp;</td>
          <td class="paramname"> <em>obs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char&nbsp;</td>
          <td class="paramname"> <em>map_file_path</em>[]</td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p><div class="fragment"><pre class="fragment"><a name="l00123"></a>00123 {
<a name="l00124"></a>00124         <a class="code" href="structdirobject.html">dirobject</a>       *actdir;
<a name="l00125"></a>00125         <span class="keywordtype">object</span>          **oblist;
<a name="l00126"></a>00126 
<a name="l00127"></a>00127         <a class="code" href="structfits__access.html">fits_access</a> *spectrum_access;
<a name="l00128"></a>00128         <a class="code" href="structfits__access.html">fits_access</a> *modim_access;
<a name="l00129"></a>00129 
<a name="l00130"></a>00130         <a class="code" href="structinterpolator.html">interpolator</a>    *tpass;
<a name="l00131"></a>00131         <a class="code" href="aXe__grism_8h.html#a6117e17bb3108107676f4486e62d40e5">gsl_matrix</a>      *dirimage_matrix=NULL;
<a name="l00132"></a>00132         <a class="code" href="structpx__point.html">px_point</a>         npixels;
<a name="l00133"></a>00133         <a class="code" href="structaperture__conf.html">aperture_conf</a>  *conf=NULL;
<a name="l00134"></a>00134         <a class="code" href="aXe__grism_8h.html#a6117e17bb3108107676f4486e62d40e5">gsl_matrix</a>     *drzcoeffs=NULL;
<a name="l00135"></a>00135 
<a name="l00136"></a>00136         <span class="keywordtype">int</span> nobjects=0;
<a name="l00137"></a>00137         <span class="keywordtype">int</span> i=0;
<a name="l00138"></a>00138         <span class="keywordtype">int</span> j=0;
<a name="l00139"></a>00139         <span class="keywordtype">int</span> beamID;
<a name="l00140"></a>00140         <span class="keywordtype">int</span> max_offs;
<a name="l00141"></a>00141 
<a name="l00142"></a>00142         <span class="comment">// third block</span>
<a name="l00143"></a>00143         gsl_vector *x_coeffs;
<a name="l00144"></a>00144         gsl_vector *y_coeffs;
<a name="l00145"></a>00145         <a class="code" href="structd__point.html">d_point</a> m_point;
<a name="l00146"></a>00146 
<a name="l00147"></a>00147         <span class="comment">// load the object list</span>
<a name="l00148"></a>00148         fprintf (stdout, <span class="stringliteral">&quot;aXe_DIRIMAGE: Loading object aperture list...&quot;</span>);
<a name="l00149"></a>00149         oblist = <a class="code" href="inout__aper_8c.html#ae18fecd8e762c35bae1376a8d637d8e8">file_to_object_list_seq</a> (aper_file, obs);
<a name="l00150"></a>00150         fprintf (stdout,<span class="stringliteral">&quot;%d objects loaded.\n&quot;</span>,<a class="code" href="inout__aper_8c.html#aa4bd812673400180537c7ea98650d3fe">object_list_size</a>(oblist));
<a name="l00151"></a>00151 
<a name="l00152"></a>00152         <span class="comment">// check whether highres spectra are given are available</span>
<a name="l00153"></a>00153         <span class="keywordflow">if</span> (strlen(specmod_file) &gt; 0) {
<a name="l00154"></a>00154                 <span class="comment">// load the spectral models</span>
<a name="l00155"></a>00155                 fprintf (stdout, <span class="stringliteral">&quot;aXe_DISPIMAGE: Loading spectral models...&quot;</span>);
<a name="l00156"></a>00156                 spectrum_access = <a class="code" href="specmodel__utils_8c.html#a5fd3ec3fb04fbdc2e1ce7ed627dbfc48">access_fits_models</a>(specmod_file);
<a name="l00157"></a>00157                 <span class="comment">// report the number of models loaded</span>
<a name="l00158"></a>00158                 fprintf (stdout,<span class="stringliteral">&quot;%d models available.\n&quot;</span>, spectrum_access-&gt;<a class="code" href="structfits__access.html#a241260b89300c1d0fa1356f279c1319c">n_modelHDU</a>);
<a name="l00159"></a>00159         }
<a name="l00160"></a>00160         <span class="keywordflow">else</span> {
<a name="l00161"></a>00161                 <span class="comment">// or set the struct to NULL</span>
<a name="l00162"></a>00162                 spectrum_access = NULL;
<a name="l00163"></a>00163         }
<a name="l00164"></a>00164 
<a name="l00165"></a>00165         <span class="comment">// check whether direct emission models are available</span>
<a name="l00166"></a>00166         <span class="keywordflow">if</span> (strlen(objmod_file) &gt; 0) {
<a name="l00167"></a>00167                 <span class="comment">// load the image models</span>
<a name="l00168"></a>00168                 fprintf (stdout, <span class="stringliteral">&quot;aXe_DISPIMAGE: Loading direct image models...&quot;</span>);
<a name="l00169"></a>00169                 modim_access = <a class="code" href="specmodel__utils_8c.html#a5fd3ec3fb04fbdc2e1ce7ed627dbfc48">access_fits_models</a>(objmod_file);
<a name="l00170"></a>00170                 objmod_file = NULL;
<a name="l00171"></a>00171                 fprintf (stdout,<span class="stringliteral">&quot;%d images available.\n&quot;</span>, modim_access-&gt;<a class="code" href="structfits__access.html#a241260b89300c1d0fa1356f279c1319c">n_modelHDU</a>);
<a name="l00172"></a>00172         }
<a name="l00173"></a>00173         <span class="keywordflow">else</span> {
<a name="l00174"></a>00174                 modim_access = NULL;
<a name="l00175"></a>00175         }
<a name="l00176"></a>00176 
<a name="l00177"></a>00177         <span class="comment">// get the sensitivity curve of the total passband</span>
<a name="l00178"></a>00178         tpass =  <a class="code" href="dirimage__model_8c.html#a9ad9a6858c9a87180afb5cddfbdab204">get_filter_sensitivity</a>(tpass_file, tel_area);
<a name="l00179"></a>00179 
<a name="l00180"></a>00180         <span class="comment">// get the image dimensions</span>
<a name="l00181"></a>00181         npixels = <a class="code" href="aXe__utils_8c.html#ae7f4f277c2b5d03b7ce52b2392d176b2">get_npixel</a>(obs);
<a name="l00182"></a>00182 
<a name="l00183"></a>00183         <span class="comment">// load the configuration file</span>
<a name="l00184"></a>00184         conf = <a class="code" href="aper__conf_8c.html#a45d84f2fc00f438b5da9054c45b7736c">get_aperture_descriptor</a> (conf_file);
<a name="l00185"></a>00185 
<a name="l00186"></a>00186         <span class="comment">// load the extension numbers</span>
<a name="l00187"></a>00187         <a class="code" href="aper__conf_8c.html#aa1383c872a0151435880f6ad28f9bd88">get_extension_numbers</a>(dirim_file, conf,conf-&gt;<a class="code" href="structaperture__conf.html#a730cc39bb91c34d0dfe92977cb2aaf46">optkey1</a>,conf-&gt;<a class="code" href="structaperture__conf.html#a6b84a9e8edd79d020ea2e189839d86ba">optval1</a>);
<a name="l00188"></a>00188 
<a name="l00189"></a>00189         <span class="comment">// get the  matrix with the drizzle coefficients</span>
<a name="l00190"></a>00190         drzcoeffs = <a class="code" href="crossdisp__utils_8c.html#a24fed0f1bc1490134a2c5c5baaee6ad5">get_crossdisp_matrix</a>(dirim_file, conf-&gt;<a class="code" href="structaperture__conf.html#abe36ba97113a8ccb1916acdbe5db113f">science_numext</a>);
<a name="l00191"></a>00191         <span class="keywordflow">if</span> (drzcoeffs-&gt;size1 &lt; 2 || !drzcoeffs-&gt;size2)
<a name="l00192"></a>00192                 <a class="code" href="aXe__errors_8c.html#a7ef7588e5f91237ba7ce4084e6ed3c11">aXe_message</a> (<a class="code" href="aXe__errors_8h.html#a2556a67874555249b07691c37aa6d6e9">aXe_M_FATAL</a>, __FILE__, __LINE__,
<a name="l00193"></a>00193                                 <span class="stringliteral">&quot;oblist_to_dirlist:&quot;</span> <span class="stringliteral">&quot; Could not get&quot;</span>
<a name="l00194"></a>00194                                 <span class="stringliteral">&quot; the drizzle coefficients in file: %s\n&quot;</span>, dirim_file);
<a name="l00195"></a>00195 
<a name="l00196"></a>00196         <span class="comment">// determine an offset from the PSF_OFFSET</span>
<a name="l00197"></a>00197         max_offs = (int)ceil(<a class="code" href="aper__conf_8c.html#a63e3b3bf0beebc0fe4677687d96b85df">get_max_offset</a>(conf));
<a name="l00198"></a>00198 
<a name="l00199"></a>00199         <span class="comment">// determine the number of objects in the object list</span>
<a name="l00200"></a>00200         nobjects = <a class="code" href="inout__aper_8c.html#aa4bd812673400180537c7ea98650d3fe">object_list_size</a>(oblist);
<a name="l00201"></a>00201 
<a name="l00202"></a>00202         <span class="comment">// allocate memory for the image matrix</span>
<a name="l00203"></a>00203         dirimage_matrix = <a class="code" href="aXe__grism_8h.html#a1214ab1bea5fd80474d7a27db0bfb429">gsl_matrix_alloc</a>(npixels.<a class="code" href="structpx__point.html#ab715a558731a820a25b50bd7797dd004">x</a>, npixels.<a class="code" href="structpx__point.html#a2d02b900722a71f22a8d5100822bda61">y</a>);
<a name="l00204"></a>00204         <a class="code" href="aXe__grism_8h.html#af6161aeb008a1ffa7d888df6ccbef7cc">gsl_matrix_set_all</a>(dirimage_matrix,0.0);
<a name="l00205"></a>00205 
<a name="l00206"></a>00206         <span class="comment">// loop over all objects</span>
<a name="l00207"></a>00207         <span class="keywordflow">for</span> (i = 0; i &lt; nobjects; i++){
<a name="l00208"></a>00208 
<a name="l00209"></a>00209                 <span class="comment">// make sure that there are beams in the object</span>
<a name="l00210"></a>00210                 <span class="keywordflow">if</span> (oblist[i]-&gt;nbeams &gt; 0){
<a name="l00211"></a>00211 
<a name="l00212"></a>00212                         <span class="keywordflow">if</span> (<a class="code" href="specmodel__utils_8c.html#a24e2a40a5d4d62193ae91e05f9c395ae">has_aper_dirim</a>(modim_access, oblist[i]))
<a name="l00213"></a>00213                                 actdir = <a class="code" href="model__utils_8c.html#a3c08d3f85de2d04b0f383f9beda7447e">load_dirobj_img</a>(oblist[i], modim_access);
<a name="l00214"></a>00214                         <span class="keywordflow">else</span>
<a name="l00215"></a>00215                                 <span class="comment">// create a dirobject for each object</span>
<a name="l00216"></a>00216                                 actdir = <a class="code" href="model__utils_8c.html#ae01b7359b803f5823de49af7ba8de948">fill_dirobject</a>(oblist[i], npixels, drzcoeffs, model_scale, max_offs);
<a name="l00217"></a>00217 
<a name="l00218"></a>00218                         <span class="comment">// load the spectral values into the dirobject</span>
<a name="l00219"></a>00219                         <a class="code" href="model__utils_8c.html#adee63ef5db37c64dcdd2288a4cff5113">load_spectrum</a>(oblist[i], actdir, spectrum_access, 1);
<a name="l00220"></a>00220 
<a name="l00221"></a>00221                         <span class="comment">// go over each beam defined in the configuration file</span>
<a name="l00222"></a>00222                         <span class="keywordflow">for</span> (beamID=0; beamID &lt; conf-&gt;<a class="code" href="structaperture__conf.html#af53b09fa4f86ff116c002640c3e817d9">nbeams</a>; beamID++) {
<a name="l00223"></a>00223 
<a name="l00224"></a>00224                                 <span class="comment">// set the offset values to 0.0</span>
<a name="l00225"></a>00225                                 actdir-&gt;<a class="code" href="structdirobject.html#a804b505c34bbecd0eb09832e34cbd5ce">xy_off</a>[beamID].<a class="code" href="structd__point.html#a922a3b5d82a119168ba85e5f939d02c3">x</a> = 0.0;
<a name="l00226"></a>00226                                 actdir-&gt;<a class="code" href="structdirobject.html#a804b505c34bbecd0eb09832e34cbd5ce">xy_off</a>[beamID].<a class="code" href="structd__point.html#ad9846a025508bf8873a501ca5fcefbf4">y</a> = 0.0;
<a name="l00227"></a>00227 
<a name="l00228"></a>00228                                 <span class="comment">// determine the coeeficients for the offsets</span>
<a name="l00229"></a>00229                                 <span class="comment">// in x and in y</span>
<a name="l00230"></a>00230                                 x_coeffs = <a class="code" href="trace__conf_8c.html#aead378057f951a43c28c4031ca3fd71a">get_beam_trace_xoff</a> (conf_file, beamID);
<a name="l00231"></a>00231                                 y_coeffs = <a class="code" href="trace__conf_8c.html#aeea3871e481f563841b276e4c8633be7">get_beam_trace_yoff</a> (conf_file, beamID);
<a name="l00232"></a>00232 
<a name="l00233"></a>00233                                 <span class="comment">// get the mean direct object position</span>
<a name="l00234"></a>00234                                 m_point = <a class="code" href="model__utils_8c.html#a6dbc5b3a67592030d394cee3570b44e8">get_dirobject_meanpos</a>(actdir);
<a name="l00235"></a>00235 
<a name="l00236"></a>00236                                 <span class="comment">// evaluate the coefficients for the 2D variable offsets</span>
<a name="l00237"></a>00237                                 <span class="comment">// at the mean position</span>
<a name="l00238"></a>00238                                 actdir-&gt;<a class="code" href="structdirobject.html#a804b505c34bbecd0eb09832e34cbd5ce">xy_off</a>[beamID].<a class="code" href="structd__point.html#a922a3b5d82a119168ba85e5f939d02c3">x</a> = <a class="code" href="trace__conf_8c.html#a9eed4438755d4ceab064f95250f6218e">eval_trace_off_at_pos</a> (x_coeffs, m_point, beamID);
<a name="l00239"></a>00239                                 actdir-&gt;<a class="code" href="structdirobject.html#a804b505c34bbecd0eb09832e34cbd5ce">xy_off</a>[beamID].<a class="code" href="structd__point.html#ad9846a025508bf8873a501ca5fcefbf4">y</a> = <a class="code" href="trace__conf_8c.html#a9eed4438755d4ceab064f95250f6218e">eval_trace_off_at_pos</a> (y_coeffs, m_point, beamID);
<a name="l00240"></a>00240 
<a name="l00241"></a>00241                                 <span class="comment">// free the vectors for the coefficients</span>
<a name="l00242"></a>00242                                 gsl_vector_free(x_coeffs);
<a name="l00243"></a>00243                                 gsl_vector_free(y_coeffs);
<a name="l00244"></a>00244                         }
<a name="l00245"></a>00245 
<a name="l00246"></a>00246                         <span class="comment">// add the current direct object to the image</span>
<a name="l00247"></a>00247                         <a class="code" href="dirimage__model_8c.html#a371e3a170621827e2ec09b3746df0ffb">make_dirimage_object</a>(oblist[i], actdir, tpass, dirimage_matrix);
<a name="l00248"></a>00248                 }
<a name="l00249"></a>00249                 <span class="comment">// free the direct object</span>
<a name="l00250"></a>00250                 <a class="code" href="model__utils_8c.html#aa711bf6afa5532517ed581be9e59d2d1">free_dirobject</a> (actdir);
<a name="l00251"></a>00251         }
<a name="l00252"></a>00252 
<a name="l00253"></a>00253         <span class="comment">// store the contamination image</span>
<a name="l00254"></a>00254         <a class="code" href="aXe__utils_8c.html#a6a5d64fa0baa598fc20741fa603bee11">gsl_to_FITSimage</a> (dirimage_matrix, map_file, 1, NULL);
<a name="l00255"></a>00255 
<a name="l00256"></a>00256         <span class="comment">// release memory</span>
<a name="l00257"></a>00257         <span class="keywordflow">if</span> (conf!=NULL)
<a name="l00258"></a>00258                 <a class="code" href="aper__conf_8c.html#a608428f59a2adb25874101610cd6afe4">free_aperture_conf</a>(conf);
<a name="l00259"></a>00259 
<a name="l00260"></a>00260         <span class="comment">// release the memory for the drizzle matrix</span>
<a name="l00261"></a>00261         <span class="keywordflow">if</span> (drzcoeffs!=NULL)
<a name="l00262"></a>00262                 <a class="code" href="aXe__grism_8h.html#a61aa1d37853a90711852146f18d0b85f">gsl_matrix_free</a>(drzcoeffs);
<a name="l00263"></a>00263 
<a name="l00264"></a>00264         <span class="comment">// check if memory must be released;</span>
<a name="l00265"></a>00265         <span class="comment">// do it if necessary</span>
<a name="l00266"></a>00266         <span class="keywordflow">if</span> (spectrum_access != NULL)
<a name="l00267"></a>00267                 <a class="code" href="specmodel__utils_8c.html#a05bec4559d0ac39512725211cee1d2ff">free_fits_access</a>(spectrum_access);
<a name="l00268"></a>00268         <span class="keywordflow">if</span> (modim_access!=NULL)
<a name="l00269"></a>00269                 <a class="code" href="specmodel__utils_8c.html#a05bec4559d0ac39512725211cee1d2ff">free_fits_access</a>(modim_access);
<a name="l00270"></a>00270         <span class="keywordflow">if</span> (oblist !=NULL)
<a name="l00271"></a>00271                 <a class="code" href="aXe__utils_8c.html#a1f63bfb071e9d0ea1f8854efdfae4692">free_oblist</a> (oblist);
<a name="l00272"></a>00272 
<a name="l00273"></a>00273         <span class="comment">// always release these</span>
<a name="l00274"></a>00274         <span class="comment">// objects</span>
<a name="l00275"></a>00275         <a class="code" href="aXe__grism_8h.html#a61aa1d37853a90711852146f18d0b85f">gsl_matrix_free</a>(dirimage_matrix);
<a name="l00276"></a>00276         <a class="code" href="fringe__conf_8c.html#a518a01a879febbaf974b85585defaf7c">free_interp</a>(tpass);
<a name="l00277"></a>00277 
<a name="l00278"></a>00278         <span class="comment">// return always &apos;1&apos;</span>
<a name="l00279"></a>00279         <span class="keywordflow">return</span> 1;
<a name="l00280"></a>00280 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ac3812e89e6731d07be8b48e2ad4d158d"></a><!-- doxytag: member="dirimage_model.h::compute_dirimage_modelOld" ref="ac3812e89e6731d07be8b48e2ad4d158d" args="(char dirim_file_path[], char conf_file_path[], char tpass_file_path[], char specmod_file_path[], char objmod_file_path[], char aper_file_path[], const double model_scale, const double tel_area, const double lambda_psf, observation *obs, char map_file_path[])" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int compute_dirimage_modelOld </td>
          <td>(</td>
          <td class="paramtype">char&nbsp;</td>
          <td class="paramname"> <em>dirim_file_path</em>[], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char&nbsp;</td>
          <td class="paramname"> <em>conf_file_path</em>[], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char&nbsp;</td>
          <td class="paramname"> <em>tpass_file_path</em>[], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char&nbsp;</td>
          <td class="paramname"> <em>specmod_file_path</em>[], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char&nbsp;</td>
          <td class="paramname"> <em>objmod_file_path</em>[], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char&nbsp;</td>
          <td class="paramname"> <em>aper_file_path</em>[], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const double&nbsp;</td>
          <td class="paramname"> <em>model_scale</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const double&nbsp;</td>
          <td class="paramname"> <em>tel_area</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const double&nbsp;</td>
          <td class="paramname"> <em>lambda_psf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structobservation.html">observation</a> *&nbsp;</td>
          <td class="paramname"> <em>obs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char&nbsp;</td>
          <td class="paramname"> <em>map_file_path</em>[]</td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p><div class="fragment"><pre class="fragment"><a name="l00045"></a>00045 {
<a name="l00046"></a>00046   <span class="keywordtype">object</span>          **oblist;
<a name="l00047"></a>00047   <a class="code" href="structdirobject.html">dirobject</a>       **dirlist;
<a name="l00048"></a>00048   <a class="code" href="structspectral__models.html">spectral_models</a> *spec_mod;
<a name="l00049"></a>00049   <a class="code" href="structobject__models.html">object_models</a>   *obj_mod;
<a name="l00050"></a>00050 
<a name="l00051"></a>00051   <a class="code" href="structinterpolator.html">interpolator</a>    *tpass;
<a name="l00052"></a>00052 
<a name="l00053"></a>00053   <a class="code" href="aXe__grism_8h.html#a6117e17bb3108107676f4486e62d40e5">gsl_matrix</a> *dirimage_matrix=NULL;
<a name="l00054"></a>00054 
<a name="l00055"></a>00055   <a class="code" href="structpx__point.html">px_point</a> npixels;
<a name="l00056"></a>00056 
<a name="l00057"></a>00057   <span class="comment">// load the object list</span>
<a name="l00058"></a>00058   fprintf (stdout, <span class="stringliteral">&quot;aXe_DIRIMAGE: Loading object aperture list...&quot;</span>);
<a name="l00059"></a>00059   oblist = <a class="code" href="inout__aper_8c.html#ae18fecd8e762c35bae1376a8d637d8e8">file_to_object_list_seq</a> (aper_file, obs);
<a name="l00060"></a>00060   fprintf (stdout,<span class="stringliteral">&quot;%d objects loaded.\n&quot;</span>,<a class="code" href="inout__aper_8c.html#aa4bd812673400180537c7ea98650d3fe">object_list_size</a>(oblist));
<a name="l00061"></a>00061 
<a name="l00062"></a>00062   <span class="comment">// check whether highres models</span>
<a name="l00063"></a>00063   <span class="comment">// are given</span>
<a name="l00064"></a>00064   <span class="keywordflow">if</span> (strlen(specmod_file) &gt; 0)
<a name="l00065"></a>00065     <span class="comment">// load the spectral models</span>
<a name="l00066"></a>00066     spec_mod = <a class="code" href="specmodel__utils_8c.html#a815d1f785501fd2a9cc3f33a6a95c34d">load_spectral_models</a>(specmod_file);
<a name="l00067"></a>00067   <span class="keywordflow">else</span>
<a name="l00068"></a>00068     <span class="comment">// or set the struct to NULL</span>
<a name="l00069"></a>00069     spec_mod = NULL;
<a name="l00070"></a>00070 
<a name="l00071"></a>00071   <span class="comment">// check whether direct emission models</span>
<a name="l00072"></a>00072   <span class="comment">// are given</span>
<a name="l00073"></a>00073   <span class="keywordflow">if</span> (strlen(objmod_file) &gt; 0)
<a name="l00074"></a>00074     obj_mod = <a class="code" href="specmodel__utils_8c.html#a2683e0be35d7cfb48bb1950f84989643">load_object_models</a>(objmod_file);
<a name="l00075"></a>00075   <span class="keywordflow">else</span>
<a name="l00076"></a>00076     obj_mod = NULL;
<a name="l00077"></a>00077 
<a name="l00078"></a>00078   <span class="comment">// get the sensitivity curve of the total passband</span>
<a name="l00079"></a>00079   tpass =  <a class="code" href="dirimage__model_8c.html#a9ad9a6858c9a87180afb5cddfbdab204">get_filter_sensitivity</a>(tpass_file, tel_area);
<a name="l00080"></a>00080 
<a name="l00081"></a>00081   <span class="comment">// get the image dimensions</span>
<a name="l00082"></a>00082   npixels = <a class="code" href="aXe__utils_8c.html#ae7f4f277c2b5d03b7ce52b2392d176b2">get_npixel</a>(obs);
<a name="l00083"></a>00083 
<a name="l00084"></a>00084   <span class="comment">// create the list of direct objects to be simulated</span>
<a name="l00085"></a>00085   <span class="comment">// the interpolation type is fixed to linear</span>
<a name="l00086"></a>00086   dirlist = <a class="code" href="model__utils_8c.html#a763b05dcf96d0f69417a38f7bf0a61da">oblist_to_dirlist2</a>(dirim_file, conf_file, npixels, oblist,
<a name="l00087"></a>00087                                spec_mod, obj_mod, model_scale, 1);
<a name="l00088"></a>00088 
<a name="l00089"></a>00089   <span class="comment">// determine the XOFF and YOFF values </span>
<a name="l00090"></a>00090   <span class="comment">// for the various beams</span>
<a name="l00091"></a>00091   <a class="code" href="spc__fluxcube_8c.html#aecabb3459b749d8e33ea85f4e0bcfcbe">fill_xy_offsets</a>(dirlist, conf_file);
<a name="l00092"></a>00092 
<a name="l00093"></a>00093   <span class="comment">// create and fill the pixel matrix for the direct images</span>
<a name="l00094"></a>00094   dirimage_matrix = <a class="code" href="dirimage__model_8c.html#a18d35af5ae5d98dcf27d0ef9b47cfdf0">make_dirimage</a>(oblist, dirlist, npixels, lambda_psf, tpass);
<a name="l00095"></a>00095 
<a name="l00096"></a>00096   <span class="comment">// store the contamination image</span>
<a name="l00097"></a>00097   <a class="code" href="aXe__utils_8c.html#a6a5d64fa0baa598fc20741fa603bee11">gsl_to_FITSimage</a> (dirimage_matrix, map_file, 1, NULL);
<a name="l00098"></a>00098 
<a name="l00099"></a>00099   <span class="comment">// check if memory must be released;</span>
<a name="l00100"></a>00100   <span class="comment">// do it if necessary</span>
<a name="l00101"></a>00101   <span class="keywordflow">if</span> (spec_mod != NULL)
<a name="l00102"></a>00102     <a class="code" href="specmodel__utils_8c.html#aacf21452ac18d26013430240df196892">free_spectral_models</a>(spec_mod);
<a name="l00103"></a>00103   <span class="keywordflow">if</span> (obj_mod != NULL)
<a name="l00104"></a>00104     <a class="code" href="specmodel__utils_8c.html#ae180cf6fd252d1eae9ddd146f288f9b5">free_object_models</a>(obj_mod);
<a name="l00105"></a>00105   <span class="keywordflow">if</span> (oblist !=NULL)
<a name="l00106"></a>00106     <a class="code" href="aXe__utils_8c.html#a1f63bfb071e9d0ea1f8854efdfae4692">free_oblist</a> (oblist);
<a name="l00107"></a>00107 
<a name="l00108"></a>00108   <span class="comment">// always release these</span>
<a name="l00109"></a>00109   <span class="comment">// objects</span>
<a name="l00110"></a>00110   <a class="code" href="model__utils_8c.html#a72c9efb6343e03f3e19b0c81af37a54f">free_dirlist</a>(dirlist);
<a name="l00111"></a>00111   <a class="code" href="aXe__grism_8h.html#a61aa1d37853a90711852146f18d0b85f">gsl_matrix_free</a>(dirimage_matrix);
<a name="l00112"></a>00112   <a class="code" href="fringe__conf_8c.html#a518a01a879febbaf974b85585defaf7c">free_interp</a>(tpass);
<a name="l00113"></a>00113 
<a name="l00114"></a>00114   <span class="comment">// return always &apos;1&apos;</span>
<a name="l00115"></a>00115   <span class="keywordflow">return</span> 1;
<a name="l00116"></a>00116 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ad920380d8766ba433e531afd159f5ed4"></a><!-- doxytag: member="dirimage_model.h::get_combined_tpass_SED" ref="ad920380d8766ba433e531afd159f5ed4" args="(gsl_vector *indep_data, interpolator *tpass, dirobject *actdir)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structinterpolator.html">interpolator</a>* get_combined_tpass_SED </td>
          <td>(</td>
          <td class="paramtype">gsl_vector *&nbsp;</td>
          <td class="paramname"> <em>indep_data</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structinterpolator.html">interpolator</a> *&nbsp;</td>
          <td class="paramname"> <em>tpass</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structdirobject.html">dirobject</a> *&nbsp;</td>
          <td class="paramname"> <em>actdir</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p><div class="fragment"><pre class="fragment"><a name="l00572"></a>00572 {
<a name="l00573"></a>00573   <a class="code" href="structinterpolator.html">interpolator</a> *combine;
<a name="l00574"></a>00574 
<a name="l00575"></a>00575   gsl_vector_int *indep_weight;
<a name="l00576"></a>00576 
<a name="l00577"></a>00577   <span class="keywordtype">int</span> n_new=0;
<a name="l00578"></a>00578   <span class="keywordtype">int</span> index;
<a name="l00579"></a>00579   <span class="keywordtype">int</span> act_index;
<a name="l00580"></a>00580 
<a name="l00581"></a>00581   <span class="keywordtype">double</span> *xvals_new;
<a name="l00582"></a>00582   <span class="keywordtype">double</span> *yvals_new;
<a name="l00583"></a>00583 
<a name="l00584"></a>00584   <span class="comment">// allocat memory for the weight vector</span>
<a name="l00585"></a>00585   indep_weight = gsl_vector_int_alloc(indep_data-&gt;size);
<a name="l00586"></a>00586 
<a name="l00587"></a>00587   <span class="comment">// set all the weights</span>
<a name="l00588"></a>00588   gsl_vector_int_set_all(indep_weight, 1);
<a name="l00589"></a>00589   
<a name="l00590"></a>00590   <span class="comment">// go over the independent data</span>
<a name="l00591"></a>00591   <span class="keywordflow">for</span> (index = 1; index &lt; indep_data-&gt;size; index++)
<a name="l00592"></a>00592     <span class="comment">// check whether the current entry is equal the previous one</span>
<a name="l00593"></a>00593     <span class="keywordflow">if</span> (gsl_vector_get(indep_data, index) ==  gsl_vector_get(indep_data, index-1))
<a name="l00594"></a>00594       <span class="comment">// set the weight of the current entry to zero</span>
<a name="l00595"></a>00595       gsl_vector_int_set(indep_weight,index, 0);
<a name="l00596"></a>00596 
<a name="l00597"></a>00597 
<a name="l00598"></a>00598   <span class="comment">// initialize the</span>
<a name="l00599"></a>00599   <span class="comment">// final number</span>
<a name="l00600"></a>00600   n_new = 0;
<a name="l00601"></a>00601   
<a name="l00602"></a>00602   <span class="comment">// go over the weight array</span>
<a name="l00603"></a>00603   <span class="keywordflow">for</span> (index=0; index &lt; indep_weight-&gt;size; index++)
<a name="l00604"></a>00604     <span class="comment">// just count the weights</span>
<a name="l00605"></a>00605     n_new += gsl_vector_int_get(indep_weight, index);
<a name="l00606"></a>00606 
<a name="l00607"></a>00607   <span class="comment">// allocate memory for the interpolator data</span>
<a name="l00608"></a>00608   xvals_new = (<span class="keywordtype">double</span> *)malloc(n_new * <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
<a name="l00609"></a>00609   yvals_new = (<span class="keywordtype">double</span> *)malloc(n_new * <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
<a name="l00610"></a>00610 
<a name="l00611"></a>00611   <span class="comment">// go over the weight array</span>
<a name="l00612"></a>00612   act_index=0;
<a name="l00613"></a>00613   <span class="keywordflow">for</span> (index=0; index &lt; indep_weight-&gt;size; index++)
<a name="l00614"></a>00614     <span class="comment">// check for weight</span>
<a name="l00615"></a>00615     <span class="keywordflow">if</span> (gsl_vector_int_get(indep_weight, index))
<a name="l00616"></a>00616       {
<a name="l00617"></a>00617         <span class="comment">// take the independent value from the vector</span>
<a name="l00618"></a>00618         xvals_new[act_index] = gsl_vector_get(indep_data, index);
<a name="l00619"></a>00619 
<a name="l00620"></a>00620         <span class="comment">// compute the new dependent value bye multiplying</span>
<a name="l00621"></a>00621         <span class="comment">// the brightness with the sensitivity</span>
<a name="l00622"></a>00622     yvals_new[act_index] = <a class="code" href="fringe__conf_8c.html#ace9546cd2761b6436b8295f6ce94fba1">eval_interp</a>(tpass, xvals_new[act_index])
<a name="l00623"></a>00623                           * <a class="code" href="model__utils_8c.html#ac6e79df79a058ccf4d82853e08a0c2df">get_flux_from_SED</a>(actdir-&gt;<a class="code" href="structdirobject.html#a79645e83aebf3988bd3464b2079d24c1">SED</a>, xvals_new[act_index]);
<a name="l00624"></a>00624 
<a name="l00625"></a>00625         <span class="comment">// enhance the counter</span>
<a name="l00626"></a>00626         act_index++;
<a name="l00627"></a>00627       }
<a name="l00628"></a>00628 
<a name="l00629"></a>00629   <span class="comment">// create a new interpolator</span>
<a name="l00630"></a>00630   combine = <a class="code" href="fringe__conf_8c.html#a970b309082c5565bd69f416eef888c2f">create_interp</a>(n_new, <a class="code" href="dirimage__model_8h.html#ae28fee8b129f82673cf655e1a6eac570">TPASS_INTERP_TYPE</a>, xvals_new, yvals_new);
<a name="l00631"></a>00631 
<a name="l00632"></a>00632 
<a name="l00633"></a>00633   <span class="comment">// release memory in the weight vector </span>
<a name="l00634"></a>00634   gsl_vector_int_free(indep_weight); 
<a name="l00635"></a>00635 
<a name="l00636"></a>00636   <span class="comment">// return the interpolator</span>
<a name="l00637"></a>00637   <span class="keywordflow">return</span> combine;
<a name="l00638"></a>00638 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a35f00ade0db1ab9b955eb2daa34a1c8f"></a><!-- doxytag: member="dirimage_model.h::get_cps_for_dirobject" ref="a35f00ade0db1ab9b955eb2daa34a1c8f" args="(interpolator *tpass, dirobject *actdir)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">double get_cps_for_dirobject </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structinterpolator.html">interpolator</a> *&nbsp;</td>
          <td class="paramname"> <em>tpass</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structdirobject.html">dirobject</a> *&nbsp;</td>
          <td class="paramname"> <em>actdir</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p><div class="fragment"><pre class="fragment"><a name="l00460"></a>00460 {
<a name="l00461"></a>00461   <a class="code" href="structinterpolator.html">interpolator</a> *combine;
<a name="l00462"></a>00462 
<a name="l00463"></a>00463   <span class="keywordtype">double</span> cps=0.0;
<a name="l00464"></a>00464 
<a name="l00465"></a>00465   <span class="comment">// create aa new multiplicator</span>
<a name="l00466"></a>00466   <span class="comment">// interpolator</span>
<a name="l00467"></a>00467   combine = <a class="code" href="dirimage__model_8c.html#af16f00a45c2122acf9e354440470502f">combine_tpass_SED</a>(tpass, actdir);
<a name="l00468"></a>00468 
<a name="l00469"></a>00469   <span class="comment">// integrate over the interpolator</span>
<a name="l00470"></a>00470   cps = <a class="code" href="dirimage__model_8c.html#af910d0984d034fc1377290e01bdaf1a5">integrate_interpolator</a>(combine);
<a name="l00471"></a>00471 
<a name="l00472"></a>00472   <span class="comment">// release memory</span>
<a name="l00473"></a>00473   <a class="code" href="fringe__conf_8c.html#a518a01a879febbaf974b85585defaf7c">free_interp</a>(combine);
<a name="l00474"></a>00474 
<a name="l00475"></a>00475   <span class="comment">// return the cps value</span>
<a name="l00476"></a>00476   <span class="keywordflow">return</span> cps;
<a name="l00477"></a>00477 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a9ad9a6858c9a87180afb5cddfbdab204"></a><!-- doxytag: member="dirimage_model.h::get_filter_sensitivity" ref="a9ad9a6858c9a87180afb5cddfbdab204" args="(const char tpass_file[], const double tel_area)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structinterpolator.html">interpolator</a>* get_filter_sensitivity </td>
          <td>(</td>
          <td class="paramtype">const char&nbsp;</td>
          <td class="paramname"> <em>tpass_file</em>[], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const double&nbsp;</td>
          <td class="paramname"> <em>tel_area</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p><div class="fragment"><pre class="fragment"><a name="l00657"></a>00657 {
<a name="l00658"></a>00658   <a class="code" href="structinterpolator.html">interpolator</a>    *tpass;
<a name="l00659"></a>00659 
<a name="l00660"></a>00660   <span class="keywordtype">double</span> h_erg  = 6.6260693E-27;
<a name="l00661"></a>00661   <span class="keywordtype">double</span> c_cm   = 2.99792458E+10;
<a name="l00662"></a>00662 
<a name="l00663"></a>00663   <span class="keywordtype">double</span> factor = 0.0;
<a name="l00664"></a>00664 
<a name="l00665"></a>00665   <span class="keywordtype">int</span> index=0;
<a name="l00666"></a>00666 
<a name="l00667"></a>00667   fprintf(stdout, <span class="stringliteral">&quot;Load Total bandpass table :%s\n&quot;</span>, tpass_file);
<a name="l00668"></a>00668   tpass =  <a class="code" href="fringe__conf_8c.html#a4cddb24f157311f9a23ef00c3e279fc3">create_interp_ftable</a>(tpass_file, 2,<span class="stringliteral">&quot;WAVELENGTH&quot;</span>,<span class="stringliteral">&quot;THROUGHPUT&quot;</span>, <a class="code" href="dirimage__model_8h.html#ae28fee8b129f82673cf655e1a6eac570">TPASS_INTERP_TYPE</a>);
<a name="l00669"></a>00669 
<a name="l00670"></a>00670   <span class="keywordflow">for</span> (index=0; index &lt; tpass-&gt;<a class="code" href="structinterpolator.html#a058a378f76dfb0349cd2016f450a7332">nvals</a>; index++)
<a name="l00671"></a>00671     {
<a name="l00672"></a>00672       <span class="comment">// compute the conversion factor</span>
<a name="l00673"></a>00673       factor = tel_area / (h_erg * c_cm / (1.0E-08 * tpass-&gt;<a class="code" href="structinterpolator.html#a0114ddc19b1dd09d7920d11970e22a8e">xvals</a>[index]));
<a name="l00674"></a>00674 
<a name="l00675"></a>00675       <span class="comment">// apply the conversion factor</span>
<a name="l00676"></a>00676       tpass-&gt;<a class="code" href="structinterpolator.html#a990b3a655c74b64fd02f04b5fc344ff0">yvals</a>[index] = tpass-&gt;<a class="code" href="structinterpolator.html#a990b3a655c74b64fd02f04b5fc344ff0">yvals</a>[index] * factor;
<a name="l00677"></a>00677     }
<a name="l00678"></a>00678 
<a name="l00679"></a>00679   <span class="comment">// return the filter sensitivity</span>
<a name="l00680"></a>00680   <span class="keywordflow">return</span> tpass;
<a name="l00681"></a>00681 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="af910d0984d034fc1377290e01bdaf1a5"></a><!-- doxytag: member="dirimage_model.h::integrate_interpolator" ref="af910d0984d034fc1377290e01bdaf1a5" args="(interpolator *combine)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">double integrate_interpolator </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structinterpolator.html">interpolator</a> *&nbsp;</td>
          <td class="paramname"> <em>combine</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p><div class="fragment"><pre class="fragment"><a name="l00482"></a>00482 {
<a name="l00483"></a>00483   <span class="keywordtype">double</span> integral=0.0;
<a name="l00484"></a>00484 
<a name="l00485"></a>00485   <span class="keywordtype">int</span> index;
<a name="l00486"></a>00486 
<a name="l00487"></a>00487   <span class="keywordflow">for</span> (index=1; index &lt; combine-&gt;<a class="code" href="structinterpolator.html#a058a378f76dfb0349cd2016f450a7332">nvals</a>-1; index++)
<a name="l00488"></a>00488     <span class="comment">// add the increment</span>
<a name="l00489"></a>00489     integral +=  combine-&gt;<a class="code" href="structinterpolator.html#a990b3a655c74b64fd02f04b5fc344ff0">yvals</a>[index] * (combine-&gt;<a class="code" href="structinterpolator.html#a0114ddc19b1dd09d7920d11970e22a8e">xvals</a>[index+1] - combine-&gt;<a class="code" href="structinterpolator.html#a0114ddc19b1dd09d7920d11970e22a8e">xvals</a>[index-1]);
<a name="l00490"></a>00490 
<a name="l00491"></a>00491   <span class="comment">// dont forget the start and end piece</span>
<a name="l00492"></a>00492   integral +=  combine-&gt;<a class="code" href="structinterpolator.html#a990b3a655c74b64fd02f04b5fc344ff0">yvals</a>[0]                * (combine-&gt;<a class="code" href="structinterpolator.html#a0114ddc19b1dd09d7920d11970e22a8e">xvals</a>[1]                - combine-&gt;<a class="code" href="structinterpolator.html#a0114ddc19b1dd09d7920d11970e22a8e">xvals</a>[0]);
<a name="l00493"></a>00493   integral +=  combine-&gt;<a class="code" href="structinterpolator.html#a990b3a655c74b64fd02f04b5fc344ff0">yvals</a>[combine-&gt;<a class="code" href="structinterpolator.html#a058a378f76dfb0349cd2016f450a7332">nvals</a>-1] * (combine-&gt;<a class="code" href="structinterpolator.html#a0114ddc19b1dd09d7920d11970e22a8e">xvals</a>[combine-&gt;<a class="code" href="structinterpolator.html#a058a378f76dfb0349cd2016f450a7332">nvals</a>-1] - combine-&gt;<a class="code" href="structinterpolator.html#a0114ddc19b1dd09d7920d11970e22a8e">xvals</a>[combine-&gt;<a class="code" href="structinterpolator.html#a058a378f76dfb0349cd2016f450a7332">nvals</a>-2]);
<a name="l00494"></a>00494 
<a name="l00495"></a>00495   <span class="comment">// then return the half</span>
<a name="l00496"></a>00496   <span class="keywordflow">return</span> integral/2.0;
<a name="l00497"></a>00497 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a18d35af5ae5d98dcf27d0ef9b47cfdf0"></a><!-- doxytag: member="dirimage_model.h::make_dirimage" ref="a18d35af5ae5d98dcf27d0ef9b47cfdf0" args="(object **oblist, dirobject **dirlist, const px_point npixels, const double lambda_psf, interpolator *tpass)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">gsl_matrix* make_dirimage </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structobject.html">object</a> **&nbsp;</td>
          <td class="paramname"> <em>oblist</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structdirobject.html">dirobject</a> **&nbsp;</td>
          <td class="paramname"> <em>dirlist</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structpx__point.html">px_point</a>&nbsp;</td>
          <td class="paramname"> <em>npixels</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const double&nbsp;</td>
          <td class="paramname"> <em>lambda_psf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structinterpolator.html">interpolator</a> *&nbsp;</td>
          <td class="paramname"> <em>tpass</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p><div class="fragment"><pre class="fragment"><a name="l00360"></a>00360 {
<a name="l00361"></a>00361   <a class="code" href="structdirobject.html">dirobject</a>       *actdir;
<a name="l00362"></a>00362   <a class="code" href="structbeam.html">beam</a>             actbeam;
<a name="l00363"></a>00363 
<a name="l00364"></a>00364   <a class="code" href="aXe__grism_8h.html#a6117e17bb3108107676f4486e62d40e5">gsl_matrix</a>      *dirimage_matrix;
<a name="l00365"></a>00365 
<a name="l00366"></a>00366   <span class="keywordtype">double</span> cps        = 0.0;
<a name="l00367"></a>00367   <span class="keywordtype">double</span> sval       = 0.0;
<a name="l00368"></a>00368   <span class="keywordtype">double</span> value      = 0.0;
<a name="l00369"></a>00369 
<a name="l00370"></a>00370   <span class="keywordtype">int</span> ii=0;
<a name="l00371"></a>00371   <span class="keywordtype">int</span> nx=0;
<a name="l00372"></a>00372   <span class="keywordtype">int</span> ny=0;
<a name="l00373"></a>00373 
<a name="l00374"></a>00374   <a class="code" href="structd__point.html">d_point</a> dpixel;
<a name="l00375"></a>00375 
<a name="l00376"></a>00376    <span class="comment">// allocate memory for the image matrix</span>
<a name="l00377"></a>00377   dirimage_matrix = <a class="code" href="aXe__grism_8h.html#a1214ab1bea5fd80474d7a27db0bfb429">gsl_matrix_alloc</a>(npixels.<a class="code" href="structpx__point.html#ab715a558731a820a25b50bd7797dd004">x</a>, npixels.<a class="code" href="structpx__point.html#a2d02b900722a71f22a8d5100822bda61">y</a>);
<a name="l00378"></a>00378   <a class="code" href="aXe__grism_8h.html#af6161aeb008a1ffa7d888df6ccbef7cc">gsl_matrix_set_all</a>(dirimage_matrix,0.0);
<a name="l00379"></a>00379 
<a name="l00380"></a>00380   <span class="comment">// go over each beam model</span>
<a name="l00381"></a>00381   ii = 0;
<a name="l00382"></a>00382   <span class="keywordflow">while</span> (oblist[ii] != NULL)
<a name="l00383"></a>00383     {
<a name="l00384"></a>00384 
<a name="l00385"></a>00385       <span class="comment">// get the direct object for the actual model spectrum</span>
<a name="l00386"></a>00386       actdir = <a class="code" href="model__utils_8c.html#a39965b9d4410809472bb1a5fd4328026">get_dirobject_from_list</a>(dirlist, oblist[ii]-&gt;ID);
<a name="l00387"></a>00387 
<a name="l00388"></a>00388       <span class="comment">// get the beam for the actual model spectrum</span>
<a name="l00389"></a>00389       actbeam = oblist[ii]-&gt;<a class="code" href="structobject.html#ad643757142781f8265b430e19700cfe5">beams</a>[0];
<a name="l00390"></a>00390 
<a name="l00391"></a>00391       <span class="comment">// report onto the screen</span>
<a name="l00392"></a>00392       fprintf(stdout, <span class="stringliteral">&quot;NNNNEW aXe_DIRIMAGE: modelling object %i ...&quot;</span>, oblist[ii]-&gt;ID);
<a name="l00393"></a>00393 
<a name="l00394"></a>00394       <span class="comment">// get the integrated direct image intensity in cps</span>
<a name="l00395"></a>00395       cps = <a class="code" href="dirimage__model_8c.html#a35f00ade0db1ab9b955eb2daa34a1c8f">get_cps_for_dirobject</a>(tpass, actdir);
<a name="l00396"></a>00396 
<a name="l00397"></a>00397       <span class="comment">// correct the direct image positions for </span>
<a name="l00398"></a>00398       <span class="comment">// the offset values introduced by building</span>
<a name="l00399"></a>00399       <span class="comment">// the direct image objects around the reference</span>
<a name="l00400"></a>00400       <span class="comment">// position, which is shifted from the true</span>
<a name="l00401"></a>00401       <span class="comment">// direct image position by XOFF and YOFF as</span>
<a name="l00402"></a>00402       <span class="comment">// given in the aXe configuration file</span>
<a name="l00403"></a>00403       actdir-&gt;<a class="code" href="structdirobject.html#ac068f35c585eec4cd1e5d3392c2dd698">ix_min</a> -= (int)floor(actdir-&gt;<a class="code" href="structdirobject.html#a804b505c34bbecd0eb09832e34cbd5ce">xy_off</a>[actbeam.<a class="code" href="structbeam.html#a5c3f06b67e4cc3c79be539d1b515f3c6">ID</a>].<a class="code" href="structd__point.html#a922a3b5d82a119168ba85e5f939d02c3">x</a> + 0.5);
<a name="l00404"></a>00404       actdir-&gt;<a class="code" href="structdirobject.html#ac8c6104f2c2e1384c64bba61ecf40d69">ix_max</a> -= (int)floor(actdir-&gt;<a class="code" href="structdirobject.html#a804b505c34bbecd0eb09832e34cbd5ce">xy_off</a>[actbeam.<a class="code" href="structbeam.html#a5c3f06b67e4cc3c79be539d1b515f3c6">ID</a>].<a class="code" href="structd__point.html#a922a3b5d82a119168ba85e5f939d02c3">x</a> + 0.5);
<a name="l00405"></a>00405       actdir-&gt;<a class="code" href="structdirobject.html#af24c9a92fa18516591e43d96eec13272">iy_min</a> -= (int)floor(actdir-&gt;<a class="code" href="structdirobject.html#a804b505c34bbecd0eb09832e34cbd5ce">xy_off</a>[actbeam.<a class="code" href="structbeam.html#a5c3f06b67e4cc3c79be539d1b515f3c6">ID</a>].<a class="code" href="structd__point.html#ad9846a025508bf8873a501ca5fcefbf4">y</a> + 0.5);
<a name="l00406"></a>00406       actdir-&gt;<a class="code" href="structdirobject.html#a3b36973dd52d158c059bfe6587a04244">iy_max</a> -= (int)floor(actdir-&gt;<a class="code" href="structdirobject.html#a804b505c34bbecd0eb09832e34cbd5ce">xy_off</a>[actbeam.<a class="code" href="structbeam.html#a5c3f06b67e4cc3c79be539d1b515f3c6">ID</a>].<a class="code" href="structd__point.html#ad9846a025508bf8873a501ca5fcefbf4">y</a> + 0.5);
<a name="l00407"></a>00407       actbeam.<a class="code" href="structbeam.html#a54c64670a8b3e8732c1468d156ddb0ca">refpoint</a>.<a class="code" href="structd__point.html#a922a3b5d82a119168ba85e5f939d02c3">x</a> -= actdir-&gt;<a class="code" href="structdirobject.html#a804b505c34bbecd0eb09832e34cbd5ce">xy_off</a>[actbeam.<a class="code" href="structbeam.html#a5c3f06b67e4cc3c79be539d1b515f3c6">ID</a>].<a class="code" href="structd__point.html#a922a3b5d82a119168ba85e5f939d02c3">x</a>;
<a name="l00408"></a>00408       actbeam.<a class="code" href="structbeam.html#a54c64670a8b3e8732c1468d156ddb0ca">refpoint</a>.<a class="code" href="structd__point.html#ad9846a025508bf8873a501ca5fcefbf4">y</a> -= actdir-&gt;<a class="code" href="structdirobject.html#a804b505c34bbecd0eb09832e34cbd5ce">xy_off</a>[actbeam.<a class="code" href="structbeam.html#a5c3f06b67e4cc3c79be539d1b515f3c6">ID</a>].<a class="code" href="structd__point.html#ad9846a025508bf8873a501ca5fcefbf4">y</a>;
<a name="l00409"></a>00409 
<a name="l00410"></a>00410       <span class="comment">// go over each pixel in the direct object area</span>
<a name="l00411"></a>00411       <span class="keywordflow">for</span> (nx=actdir-&gt;<a class="code" href="structdirobject.html#ac068f35c585eec4cd1e5d3392c2dd698">ix_min</a>; nx&lt;=actdir-&gt;ix_max; nx++)
<a name="l00412"></a>00412         {
<a name="l00413"></a>00413           <span class="comment">// make sure to be inside the image</span>
<a name="l00414"></a>00414           <span class="keywordflow">if</span> (nx &lt; 0 || nx &gt;=  dirimage_matrix-&gt;size1)
<a name="l00415"></a>00415             <span class="comment">// skip column if not</span>
<a name="l00416"></a>00416             <span class="keywordflow">continue</span>;
<a name="l00417"></a>00417           <span class="keywordflow">for</span> (ny=actdir-&gt;<a class="code" href="structdirobject.html#af24c9a92fa18516591e43d96eec13272">iy_min</a>; ny&lt;=actdir-&gt;iy_max; ny++)
<a name="l00418"></a>00418             {
<a name="l00419"></a>00419               <span class="comment">// make sure to be inside the image</span>
<a name="l00420"></a>00420               <span class="keywordflow">if</span> (ny &lt; 0 || ny &gt;=  dirimage_matrix-&gt;size2)
<a name="l00421"></a>00421                 <span class="comment">// skip element if not</span>
<a name="l00422"></a>00422                 <span class="keywordflow">continue</span>;
<a name="l00423"></a>00423 
<a name="l00424"></a>00424               <span class="comment">// fill the dpixel structure</span>
<a name="l00425"></a>00425               dpixel.<a class="code" href="structd__point.html#a922a3b5d82a119168ba85e5f939d02c3">x</a> = (double)nx;
<a name="l00426"></a>00426               dpixel.<a class="code" href="structd__point.html#ad9846a025508bf8873a501ca5fcefbf4">y</a> = (double)ny;
<a name="l00427"></a>00427 
<a name="l00428"></a>00428               <span class="comment">// check whether there is</span>
<a name="l00429"></a>00429               <span class="comment">// an image template</span>
<a name="l00430"></a>00430               <span class="keywordflow">if</span> (actdir-&gt;<a class="code" href="structdirobject.html#a484dadbe6f9bdade97aa303366b4ef6a">dirim</a>)
<a name="l00431"></a>00431                 <span class="comment">// get the pixel intensity from the image template</span>
<a name="l00432"></a>00432                 sval = <a class="code" href="specmodel__utils_8c.html#a90e8278f78014bbbaa595341f92cedb5">get_diremission_value</a>(actdir-&gt;<a class="code" href="structdirobject.html#a484dadbe6f9bdade97aa303366b4ef6a">dirim</a>, dpixel.<a class="code" href="structd__point.html#a922a3b5d82a119168ba85e5f939d02c3">x</a> - actbeam.<a class="code" href="structbeam.html#a54c64670a8b3e8732c1468d156ddb0ca">refpoint</a>.<a class="code" href="structd__point.html#a922a3b5d82a119168ba85e5f939d02c3">x</a>, dpixel.<a class="code" href="structd__point.html#ad9846a025508bf8873a501ca5fcefbf4">y</a> - actbeam.<a class="code" href="structbeam.html#a54c64670a8b3e8732c1468d156ddb0ca">refpoint</a>.<a class="code" href="structd__point.html#ad9846a025508bf8873a501ca5fcefbf4">y</a>);
<a name="l00433"></a>00433               <span class="keywordflow">else</span>
<a name="l00434"></a>00434                 <span class="comment">// get the Gaussian pixel intensity;</span>
<a name="l00435"></a>00435                 <span class="comment">//</span>
<a name="l00436"></a>00436                 <span class="comment">// do a subsampling over the pixel</span>
<a name="l00437"></a>00437                 <span class="comment">// to get a more appropriate value for the</span>
<a name="l00438"></a>00438                 <span class="comment">// emission val</span>
<a name="l00439"></a>00439                 sval = <a class="code" href="model__utils_8c.html#a5d8695af668aaed17d349ca4eb36292c">get_sub_emodel_value</a>(dpixel, actbeam, actdir-&gt;<a class="code" href="structdirobject.html#a1e61e87181abdea5dab21eb1dc3564dc">drzscale</a>);
<a name="l00440"></a>00440               
<a name="l00441"></a>00441               <span class="comment">// compute and set the new pixel values</span>
<a name="l00442"></a>00442               value = <a class="code" href="aXe__grism_8h.html#acf709ee71c580f1cd65d726ed03200ea">gsl_matrix_get</a>(dirimage_matrix, nx, ny) + sval*cps;
<a name="l00443"></a>00443               <a class="code" href="aXe__grism_8h.html#a1f386ef5cd5a3b916246c2bee80f083a">gsl_matrix_set</a>(dirimage_matrix, nx, ny, value);
<a name="l00444"></a>00444             }
<a name="l00445"></a>00445         }
<a name="l00446"></a>00446 
<a name="l00447"></a>00447       <span class="comment">// release the space for the various structures</span>
<a name="l00448"></a>00448       fprintf(stdout, <span class="stringliteral">&quot; Done\n&quot;</span>);
<a name="l00449"></a>00449       ii++;
<a name="l00450"></a>00450     }
<a name="l00451"></a>00451 
<a name="l00452"></a>00452   <span class="comment">// return the image matrix</span>
<a name="l00453"></a>00453   <span class="keywordflow">return</span> dirimage_matrix;
<a name="l00454"></a>00454 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a371e3a170621827e2ec09b3746df0ffb"></a><!-- doxytag: member="dirimage_model.h::make_dirimage_object" ref="a371e3a170621827e2ec09b3746df0ffb" args="(object *actobject, dirobject *actdir, interpolator *tpass, gsl_matrix *dirimage_matrix)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void make_dirimage_object </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structobject.html">object</a> *&nbsp;</td>
          <td class="paramname"> <em>actobject</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structdirobject.html">dirobject</a> *&nbsp;</td>
          <td class="paramname"> <em>actdir</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structinterpolator.html">interpolator</a> *&nbsp;</td>
          <td class="paramname"> <em>tpass</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">gsl_matrix *&nbsp;</td>
          <td class="paramname"> <em>dirimage_matrix</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p><div class="fragment"><pre class="fragment"><a name="l00283"></a>00283                                                                                                             {
<a name="l00284"></a>00284 
<a name="l00285"></a>00285         <a class="code" href="structbeam.html">beam</a>  actbeam;
<a name="l00286"></a>00286         <span class="keywordtype">double</span> cps        = 0.0;
<a name="l00287"></a>00287         <span class="keywordtype">double</span> sval       = 0.0;
<a name="l00288"></a>00288         <span class="keywordtype">double</span> value      = 0.0;
<a name="l00289"></a>00289         <span class="keywordtype">int</span> nx=0;
<a name="l00290"></a>00290         <span class="keywordtype">int</span> ny=0;
<a name="l00291"></a>00291         <a class="code" href="structd__point.html">d_point</a> dpixel;
<a name="l00292"></a>00292 
<a name="l00293"></a>00293         <span class="comment">// get the beam for the actual model spectrum</span>
<a name="l00294"></a>00294         actbeam = actobject-&gt;<a class="code" href="structobject.html#ad643757142781f8265b430e19700cfe5">beams</a>[0];
<a name="l00295"></a>00295 
<a name="l00296"></a>00296         <span class="comment">// report onto the screen</span>
<a name="l00297"></a>00297         fprintf(stdout, <span class="stringliteral">&quot;aXe_DIRIMAGE: modelling object %i ...&quot;</span>, actobject-&gt;<a class="code" href="structobject.html#a8575880bdfc1c0bf44914b4efd2665bf">ID</a>);
<a name="l00298"></a>00298 
<a name="l00299"></a>00299         <span class="comment">// get the integrated direct image intensity in cps</span>
<a name="l00300"></a>00300         cps = <a class="code" href="dirimage__model_8c.html#a35f00ade0db1ab9b955eb2daa34a1c8f">get_cps_for_dirobject</a>(tpass, actdir);
<a name="l00301"></a>00301 
<a name="l00302"></a>00302         <span class="comment">// correct the direct image positions for</span>
<a name="l00303"></a>00303         <span class="comment">// the offset values introduced by building</span>
<a name="l00304"></a>00304         <span class="comment">// the direct image objects around the reference</span>
<a name="l00305"></a>00305         <span class="comment">// position, which is shifted from the true</span>
<a name="l00306"></a>00306         <span class="comment">// direct image position by XOFF and YOFF as</span>
<a name="l00307"></a>00307         <span class="comment">// given in the aXe configuration file</span>
<a name="l00308"></a>00308         actdir-&gt;<a class="code" href="structdirobject.html#ac068f35c585eec4cd1e5d3392c2dd698">ix_min</a> -= (int)floor(actdir-&gt;<a class="code" href="structdirobject.html#a804b505c34bbecd0eb09832e34cbd5ce">xy_off</a>[actbeam.<a class="code" href="structbeam.html#a5c3f06b67e4cc3c79be539d1b515f3c6">ID</a>].<a class="code" href="structd__point.html#a922a3b5d82a119168ba85e5f939d02c3">x</a> + 0.5);
<a name="l00309"></a>00309         actdir-&gt;<a class="code" href="structdirobject.html#ac8c6104f2c2e1384c64bba61ecf40d69">ix_max</a> -= (int)floor(actdir-&gt;<a class="code" href="structdirobject.html#a804b505c34bbecd0eb09832e34cbd5ce">xy_off</a>[actbeam.<a class="code" href="structbeam.html#a5c3f06b67e4cc3c79be539d1b515f3c6">ID</a>].<a class="code" href="structd__point.html#a922a3b5d82a119168ba85e5f939d02c3">x</a> + 0.5);
<a name="l00310"></a>00310         actdir-&gt;<a class="code" href="structdirobject.html#af24c9a92fa18516591e43d96eec13272">iy_min</a> -= (int)floor(actdir-&gt;<a class="code" href="structdirobject.html#a804b505c34bbecd0eb09832e34cbd5ce">xy_off</a>[actbeam.<a class="code" href="structbeam.html#a5c3f06b67e4cc3c79be539d1b515f3c6">ID</a>].<a class="code" href="structd__point.html#ad9846a025508bf8873a501ca5fcefbf4">y</a> + 0.5);
<a name="l00311"></a>00311         actdir-&gt;<a class="code" href="structdirobject.html#a3b36973dd52d158c059bfe6587a04244">iy_max</a> -= (int)floor(actdir-&gt;<a class="code" href="structdirobject.html#a804b505c34bbecd0eb09832e34cbd5ce">xy_off</a>[actbeam.<a class="code" href="structbeam.html#a5c3f06b67e4cc3c79be539d1b515f3c6">ID</a>].<a class="code" href="structd__point.html#ad9846a025508bf8873a501ca5fcefbf4">y</a> + 0.5);
<a name="l00312"></a>00312         actbeam.<a class="code" href="structbeam.html#a54c64670a8b3e8732c1468d156ddb0ca">refpoint</a>.<a class="code" href="structd__point.html#a922a3b5d82a119168ba85e5f939d02c3">x</a> -= actdir-&gt;<a class="code" href="structdirobject.html#a804b505c34bbecd0eb09832e34cbd5ce">xy_off</a>[actbeam.<a class="code" href="structbeam.html#a5c3f06b67e4cc3c79be539d1b515f3c6">ID</a>].<a class="code" href="structd__point.html#a922a3b5d82a119168ba85e5f939d02c3">x</a>;
<a name="l00313"></a>00313         actbeam.<a class="code" href="structbeam.html#a54c64670a8b3e8732c1468d156ddb0ca">refpoint</a>.<a class="code" href="structd__point.html#ad9846a025508bf8873a501ca5fcefbf4">y</a> -= actdir-&gt;<a class="code" href="structdirobject.html#a804b505c34bbecd0eb09832e34cbd5ce">xy_off</a>[actbeam.<a class="code" href="structbeam.html#a5c3f06b67e4cc3c79be539d1b515f3c6">ID</a>].<a class="code" href="structd__point.html#ad9846a025508bf8873a501ca5fcefbf4">y</a>;
<a name="l00314"></a>00314 
<a name="l00315"></a>00315         <span class="comment">// go over each pixel in the direct object area</span>
<a name="l00316"></a>00316         <span class="keywordflow">for</span> (nx=actdir-&gt;<a class="code" href="structdirobject.html#ac068f35c585eec4cd1e5d3392c2dd698">ix_min</a>; nx&lt;=actdir-&gt;ix_max; nx++)
<a name="l00317"></a>00317         {
<a name="l00318"></a>00318                 <span class="comment">// make sure to be inside the image</span>
<a name="l00319"></a>00319                 <span class="keywordflow">if</span> (nx &lt; 0 || nx &gt;=  dirimage_matrix-&gt;size1)
<a name="l00320"></a>00320                         <span class="comment">// skip column if not</span>
<a name="l00321"></a>00321                         <span class="keywordflow">continue</span>;
<a name="l00322"></a>00322                 <span class="keywordflow">for</span> (ny=actdir-&gt;<a class="code" href="structdirobject.html#af24c9a92fa18516591e43d96eec13272">iy_min</a>; ny&lt;=actdir-&gt;iy_max; ny++)
<a name="l00323"></a>00323                 {
<a name="l00324"></a>00324                         <span class="comment">// make sure to be inside the image</span>
<a name="l00325"></a>00325                         <span class="keywordflow">if</span> (ny &lt; 0 || ny &gt;=  dirimage_matrix-&gt;size2)
<a name="l00326"></a>00326                                 <span class="comment">// skip element if not</span>
<a name="l00327"></a>00327                                 <span class="keywordflow">continue</span>;
<a name="l00328"></a>00328 
<a name="l00329"></a>00329                         <span class="comment">// fill the dpixel structure</span>
<a name="l00330"></a>00330                         dpixel.<a class="code" href="structd__point.html#a922a3b5d82a119168ba85e5f939d02c3">x</a> = (double)nx;
<a name="l00331"></a>00331                         dpixel.<a class="code" href="structd__point.html#ad9846a025508bf8873a501ca5fcefbf4">y</a> = (double)ny;
<a name="l00332"></a>00332 
<a name="l00333"></a>00333                         <span class="comment">// check whether there is</span>
<a name="l00334"></a>00334                         <span class="comment">// an image template</span>
<a name="l00335"></a>00335                         <span class="keywordflow">if</span> (actdir-&gt;<a class="code" href="structdirobject.html#a484dadbe6f9bdade97aa303366b4ef6a">dirim</a>)
<a name="l00336"></a>00336                                 <span class="comment">// get the pixel intensity from the image template</span>
<a name="l00337"></a>00337                                 sval = <a class="code" href="specmodel__utils_8c.html#a90e8278f78014bbbaa595341f92cedb5">get_diremission_value</a>(actdir-&gt;<a class="code" href="structdirobject.html#a484dadbe6f9bdade97aa303366b4ef6a">dirim</a>, dpixel.<a class="code" href="structd__point.html#a922a3b5d82a119168ba85e5f939d02c3">x</a> - actbeam.<a class="code" href="structbeam.html#a54c64670a8b3e8732c1468d156ddb0ca">refpoint</a>.<a class="code" href="structd__point.html#a922a3b5d82a119168ba85e5f939d02c3">x</a>, dpixel.<a class="code" href="structd__point.html#ad9846a025508bf8873a501ca5fcefbf4">y</a> - actbeam.<a class="code" href="structbeam.html#a54c64670a8b3e8732c1468d156ddb0ca">refpoint</a>.<a class="code" href="structd__point.html#ad9846a025508bf8873a501ca5fcefbf4">y</a>);
<a name="l00338"></a>00338                         <span class="keywordflow">else</span>
<a name="l00339"></a>00339                                 <span class="comment">// get the Gaussian pixel intensity;</span>
<a name="l00340"></a>00340                                 <span class="comment">//</span>
<a name="l00341"></a>00341                                 <span class="comment">// do a subsampling over the pixel</span>
<a name="l00342"></a>00342                                 <span class="comment">// to get a more appropriate value for the</span>
<a name="l00343"></a>00343                                 <span class="comment">// emission val</span>
<a name="l00344"></a>00344                                 sval = <a class="code" href="model__utils_8c.html#a5d8695af668aaed17d349ca4eb36292c">get_sub_emodel_value</a>(dpixel, actbeam, actdir-&gt;<a class="code" href="structdirobject.html#a1e61e87181abdea5dab21eb1dc3564dc">drzscale</a>);
<a name="l00345"></a>00345 
<a name="l00346"></a>00346                         <span class="comment">// compute and set the new pixel values</span>
<a name="l00347"></a>00347                         value = <a class="code" href="aXe__grism_8h.html#acf709ee71c580f1cd65d726ed03200ea">gsl_matrix_get</a>(dirimage_matrix, nx, ny) + sval*cps;
<a name="l00348"></a>00348                         <a class="code" href="aXe__grism_8h.html#a1f386ef5cd5a3b916246c2bee80f083a">gsl_matrix_set</a>(dirimage_matrix, nx, ny, value);
<a name="l00349"></a>00349                 }
<a name="l00350"></a>00350         }
<a name="l00351"></a>00351 
<a name="l00352"></a>00352         <span class="comment">// release the space for the various structures</span>
<a name="l00353"></a>00353         fprintf(stdout, <span class="stringliteral">&quot; Done\n&quot;</span>);
<a name="l00354"></a>00354 
<a name="l00355"></a>00355 }
</pre></div></p>

</div>
</div>
</div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&nbsp;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&nbsp;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr size="1"/><address style="text-align: right;"><small>Generated on 12 Oct 2014 for TIPS by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
