<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>TIPS: /renoir/fourmano/Desktop/OUSIM/TIPS/branches/tips_build/include/axesim/spc_model.h File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>/renoir/fourmano/Desktop/OUSIM/TIPS/branches/tips_build/include/axesim/spc_model.h File Reference</h1><code>#include &lt;time.h&gt;</code><br/>
<code>#include &lt;math.h&gt;</code><br/>
<code>#include &lt;gsl/gsl_matrix.h&gt;</code><br/>
<code>#include &lt;gsl/gsl_vector.h&gt;</code><br/>
<code>#include &lt;gsl/gsl_interp.h&gt;</code><br/>
<code>#include &quot;<a class="el" href="inout__aper_8h_source.html">inout_aper.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="aXe__grism_8h_source.html">aXe_grism.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="spce__sect_8h_source.html">spce_sect.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="spc__back_8h_source.html">spc_back.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="spce__PET_8h_source.html">spce_PET.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="spc__wl__calib_8h_source.html">spc_wl_calib.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="aXe__errors_8h_source.html">aXe_errors.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="fringe__conf_8h_source.html">fringe_conf.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="spc__resp_8h_source.html">spc_resp.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="spce__pathlength_8h_source.html">spce_pathlength.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="aper__conf_8h_source.html">aper_conf.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="specmodel__utils_8h_source.html">specmodel_utils.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="model__utils_8h_source.html">model_utils.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="spc__fluxcube_8h_source.html">spc_fluxcube.h</a>&quot;</code><br/>

<p><a href="spc__model_8h_source.html">Go to the source code of this file.</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Namespaces</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">namespace &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacespcmodel.html">spcmodel</a></td></tr>
<tr><td colspan="2"><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="spc__model_8h.html#a38b6ce346cbc8cd237fdfd3694c9b11e">compute_gauss_cont</a> (char grism_file[], char OAF_file[], char CONF_file[], const char specmod_file[], const double model_scale, const int inter_type, const double lambda_psf, <a class="el" href="structobservation.html">observation</a> *obs, const char PET_file[], char map_file[], const int store)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="spc__model_8h.html#ac807e950441746662b1ae3eab9ef2b33">compute_gaussdirim_cont</a> (char grism_file[], char OAF_file[], char CONF_file[], const char specmod_file[], const char objmod_file[], const double model_scale, const int inter_type, const double lambda_psf, <a class="el" href="structobservation.html">observation</a> *obs, const char PET_file[], char map_file[], const int store)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="spc__model_8h.html#aa0440d5bc85fc01a75dca2c32a3239fe">compute_gauss_dirim</a> (char grism_file[], char OAF_file[], char CONF_file[], const double model_scale, const int inter_type, const double lambda_psf, <a class="el" href="structobservation.html">observation</a> *obs, const char PET_file[], char map_file[], const int store)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="spc__model_8h.html#a523b7a0a13a92f1b0a61ab5324c4facf">compute_fcube_cont</a> (char grism_file[], char OAF_file[], char fcube_file[], char CONF_file[], const double model_scale, const int inter_type, <a class="el" href="structobservation.html">observation</a> *obs, const char PET_file[], char map_file[], const int store)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="spc__model_8h.html#a3e988115996eb29019bb46673cdacb12">compute_geometr_cont</a> (char OAF_file[], <a class="el" href="structobservation.html">observation</a> *obs, const char PET_file[], char map_file[], const int store)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="spc__model_8h.html#a3d953255a2ae0faf92105f0909a05053">fill_contam_info</a> (const char PET_file[], <a class="el" href="structbeamspec.html">beamspec</a> **speclist, const gsl_matrix *all_models, char model_name[])</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">gsl_matrix *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="spc__model_8h.html#aa210c0aa4d37a6f3914b73a39162301b">make_model_image</a> (const <a class="el" href="structpx__point.html">px_point</a> npixels, <a class="el" href="structobservation.html">observation</a> *obs, <a class="el" href="structbeamspec.html">beamspec</a> **speclist)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="structbeamspec.html">beamspec</a> **&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="spc__model_8h.html#a15bbdbd96e729c0edb66bd4e3c9f6b8c">make_fcube_spectra</a> (<a class="el" href="structobject.html">object</a> **oblist, <a class="el" href="structdirobject.html">dirobject</a> **dirlist, const <a class="el" href="structpx__point.html">px_point</a> npixels, char CONF_file[], const <a class="el" href="structflux__cube.html">flux_cube</a> *fcube, const int inter_type)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="structbeamspec.html">beamspec</a> **&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="spc__model_8h.html#aba4320035294553956a3f535cc484ead">alloc_beamlist_from_dirlist</a> (<a class="el" href="structobject.html">object</a> **oblist, <a class="el" href="structdirobject.html">dirobject</a> **dirlist, const <a class="el" href="structpx__point.html">px_point</a> npixels, <a class="el" href="structaperture__conf.html">aperture_conf</a> *conf)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">gsl_matrix *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="spc__model_8h.html#a64acb42dee15b4bd66149391bbdb982e">make_gauss_dirim</a> (<a class="el" href="structobject.html">object</a> **oblist, <a class="el" href="structdirobject.html">dirobject</a> **dirlist, const double lambda_psf, const <a class="el" href="structpx__point.html">px_point</a> npixels, char CONF_file[], <a class="el" href="structobservation.html">observation</a> *obs)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="structbeamspec.html">beamspec</a> **&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="spc__model_8h.html#a537ee6c7685fe9d7749342e56437f02d">make_gauss_spectra</a> (<a class="el" href="structobject.html">object</a> **oblist, <a class="el" href="structdirobject.html">dirobject</a> **dirlist, const double lambda_psf, const <a class="el" href="structpx__point.html">px_point</a> npixels, char CONF_file[])</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="structbeamspec.html">beamspec</a> **&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="spc__model_8h.html#ae7dcf882713246ce40e28942522142a5">make_gauss_spectra2</a> (<a class="el" href="structobject.html">object</a> **oblist, <a class="el" href="structdirobject.html">dirobject</a> **dirlist, const double lambda_psf, const <a class="el" href="structpx__point.html">px_point</a> npixels, char CONF_file[])</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="spc__model_8h.html#a4761f8467dc7a48825badf15b3905a47">get_index_for_tracepoint</a> (const <a class="el" href="structtracedata.html">tracedata</a> *acttrace, const double dx)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="spc__model_8h.html#a069e0ff507381b9e8d1351c4fcd7f788">fill_pixel_in_speed</a> (const <a class="el" href="structdirobject.html">dirobject</a> *actdir, const <a class="el" href="structtracedata.html">tracedata</a> *acttrace, const <a class="el" href="structd__point.html">d_point</a> dpixel, const <a class="el" href="structspectrum.html">spectrum</a> *resp, <a class="el" href="structbeamspec.html">beamspec</a> *actspec, const <a class="el" href="structcalib__function.html">calib_function</a> *wl_calibration)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="spc__model_8h.html#a39fc258229e615e5b82c1f81b8c09bde">no_diffuse_spectrum</a> (int ix, int iy, double cps, <a class="el" href="structbeamspec.html">beamspec</a> *actspec)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="spc__model_8h.html#a144898574df3c20e24cac35dc2e4df8f">diffuse_spectrum</a> (double ddx, double ddy, double cps, <a class="el" href="structbeamspec.html">beamspec</a> *actspec)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="spc__model_8h.html#a8fe760d3449f5cedb4bbf7ecc5abab08">diffuse_spectrumII</a> (double ddx, double ddy, double cps, <a class="el" href="structbeamspec.html">beamspec</a> *actspec)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="structbeamspec.html">beamspec</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="spc__model_8h.html#a8a1e63b6f29be161a726a1c08a26ebb9">dimension_beamspec</a> (<a class="el" href="structdirobject.html">dirobject</a> *actdir, <a class="el" href="structobject.html">object</a> *actobject, const <a class="el" href="structpx__point.html">px_point</a> npixels, const <a class="el" href="structaperture__conf.html">aperture_conf</a> *conf, int j)</td></tr>
</table>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="aba4320035294553956a3f535cc484ead"></a><!-- doxytag: member="spc_model.h::alloc_beamlist_from_dirlist" ref="aba4320035294553956a3f535cc484ead" args="(object **oblist, dirobject **dirlist, const px_point npixels, aperture_conf *conf)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structbeamspec.html">beamspec</a>** alloc_beamlist_from_dirlist </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structobject.html">object</a> **&nbsp;</td>
          <td class="paramname"> <em>oblist</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structdirobject.html">dirobject</a> **&nbsp;</td>
          <td class="paramname"> <em>dirlist</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structpx__point.html">px_point</a>&nbsp;</td>
          <td class="paramname"> <em>npixels</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structaperture__conf.html">aperture_conf</a> *&nbsp;</td>
          <td class="paramname"> <em>conf</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Function: alloc_beamlist_from_dirlist The function determines which beams of a direct <a class="el" href="structobject.html">object</a> are included in the contamination model. Then the size for each of the spectral beams is estimated, and the space is allocated.</p>
<p>Parameters: </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>oblist</em>&nbsp;</td><td>- the <a class="el" href="structobject.html">object</a> list as input to select beams </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>dirlist</em>&nbsp;</td><td>- the direct <a class="el" href="structobject.html">object</a> list to dimension the models </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>npixels</em>&nbsp;</td><td>- the dimensions of the model for the whole image </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>conf</em>&nbsp;</td><td>- configuration structure</td></tr>
  </table>
  </dd>
</dl>
<p>Returns: </p>
<dl class="return"><dt><b>Returns:</b></dt><dd>speclist - the list of modelled beams </dd></dl>

<p><div class="fragment"><pre class="fragment"><a name="l00887"></a>00887 {
<a name="l00888"></a>00888   <a class="code" href="structbeamspec.html">beamspec</a>  **speclist;
<a name="l00889"></a>00889   <span class="comment">//dirobject  *actdir;</span>
<a name="l00890"></a>00890   <span class="comment">//object     *actobj;</span>
<a name="l00891"></a>00891 
<a name="l00892"></a>00892   <span class="keywordtype">int</span> nspecs;
<a name="l00893"></a>00893   <span class="keywordtype">int</span> i, j, jj=0;
<a name="l00894"></a>00894   <span class="keywordtype">int</span> objindex;
<a name="l00895"></a>00895 
<a name="l00896"></a>00896   <span class="comment">// get the number of beams included in the contamination</span>
<a name="l00897"></a>00897   <span class="comment">// (mag &lt; mag_mark(BEAM)</span>
<a name="l00898"></a>00898   nspecs = <a class="code" href="inout__aper_8c.html#aa120fb983e10b94e79858e51b4d3e25e">get_beamspec_size</a>(oblist);
<a name="l00899"></a>00899 
<a name="l00900"></a>00900   <span class="comment">// allocate space for the vector of spectral beams</span>
<a name="l00901"></a>00901   speclist = (<a class="code" href="structbeamspec.html">beamspec</a>  **) malloc((nspecs+1) * <span class="keyword">sizeof</span>(<a class="code" href="structbeamspec.html">beamspec</a>  *));
<a name="l00902"></a>00902   <span class="keywordflow">if</span> (speclist == NULL)
<a name="l00903"></a>00903     <a class="code" href="aXe__errors_8c.html#a7ef7588e5f91237ba7ce4084e6ed3c11">aXe_message</a> (<a class="code" href="aXe__errors_8h.html#a2556a67874555249b07691c37aa6d6e9">aXe_M_FATAL</a>, __FILE__, __LINE__,
<a name="l00904"></a>00904                  <span class="stringliteral">&quot;make_model_spectra:&quot;</span> <span class="stringliteral">&quot; Could not allocate&quot;</span>
<a name="l00905"></a>00905                  <span class="stringliteral">&quot; memory for pointers to %i beamspec objects&quot;</span>, nspecs+1);
<a name="l00906"></a>00906 
<a name="l00907"></a>00907   fprintf(stdout, <span class="stringliteral">&quot;aXe_PETCONT: %i beams are included in the contamination.\n&quot;</span>,nspecs);
<a name="l00908"></a>00908 
<a name="l00909"></a>00909   <span class="comment">// go over all objects</span>
<a name="l00910"></a>00910   i=0;
<a name="l00911"></a>00911   <span class="keywordflow">while</span> (dirlist[i] != NULL)
<a name="l00912"></a>00912     {
<a name="l00913"></a>00913 
<a name="l00914"></a>00914       <span class="comment">// find the object structure to the directo object</span>
<a name="l00915"></a>00915       objindex = <a class="code" href="inout__aper_8c.html#a12854533fd67781a0bf70a93a6ad91e4">find_object_in_object_list</a>(oblist, dirlist[i]-&gt;ID);
<a name="l00916"></a>00916       <span class="keywordflow">if</span> (objindex &lt; 0)
<a name="l00917"></a>00917         {
<a name="l00918"></a>00918           i++;
<a name="l00919"></a>00919           <span class="keywordflow">continue</span>;
<a name="l00920"></a>00920         }
<a name="l00921"></a>00921 
<a name="l00922"></a>00922       <span class="comment">// go over each beam in an object</span>
<a name="l00923"></a>00923       <span class="keywordflow">for</span> (j=0; j &lt; oblist[objindex]-&gt;<a class="code" href="structobject.html#a14120e3b048a2118f7acd75ea1571c60">nbeams</a>; j++)
<a name="l00924"></a>00924         {
<a name="l00925"></a>00925 
<a name="l00926"></a>00926           <span class="comment">// check whether the beam is included in the contamination</span>
<a name="l00927"></a>00927           <span class="keywordflow">if</span> (oblist[objindex]-&gt;beams[j].ignore != 1)
<a name="l00928"></a>00928             {
<a name="l00929"></a>00929               <span class="comment">// check whether the beam is inside the image,</span>
<a name="l00930"></a>00930               <span class="comment">// if yes, allocate space for the beam model</span>
<a name="l00931"></a>00931               <span class="comment">//              fprintf(stdout, &quot;Trying %i, beam %c\n&quot;, dirlist[i]-&gt;ID, BEAM(j));</span>
<a name="l00932"></a>00932               speclist[jj] = <a class="code" href="spc__model_8c.html#a8a1e63b6f29be161a726a1c08a26ebb9">dimension_beamspec</a>(dirlist[i], oblist[objindex],  npixels, conf, j);
<a name="l00933"></a>00933 
<a name="l00934"></a>00934               <span class="comment">// increment the counter if space was allocated</span>
<a name="l00935"></a>00935               <span class="keywordflow">if</span> (speclist[jj] != NULL)
<a name="l00936"></a>00936                 jj++;
<a name="l00937"></a>00937 
<a name="l00938"></a>00938             }
<a name="l00939"></a>00939         }
<a name="l00940"></a>00940       i++;
<a name="l00941"></a>00941     }
<a name="l00942"></a>00942 
<a name="l00943"></a>00943   fprintf(stdout, <span class="stringliteral">&quot;aXe_PETCONT: %i beams are modelled.\n&quot;</span>,jj);
<a name="l00944"></a>00944 
<a name="l00945"></a>00945   <span class="comment">// terminate the beamspec list with NULL&apos;s</span>
<a name="l00946"></a>00946   <span class="keywordflow">for</span> (i=jj; i &lt; nspecs+1; i++)
<a name="l00947"></a>00947     speclist[i] = NULL;
<a name="l00948"></a>00948 
<a name="l00949"></a>00949   <span class="comment">// return the list of spectral beams</span>
<a name="l00950"></a>00950   <span class="keywordflow">return</span> speclist;
<a name="l00951"></a>00951 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a523b7a0a13a92f1b0a61ab5324c4facf"></a><!-- doxytag: member="spc_model.h::compute_fcube_cont" ref="a523b7a0a13a92f1b0a61ab5324c4facf" args="(char grism_file[], char OAF_file[], char fcube_file[], char CONF_file[], const double model_scale, const int inter_type, observation *obs, const char PET_file[], char map_file[], const int store)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int compute_fcube_cont </td>
          <td>(</td>
          <td class="paramtype">char&nbsp;</td>
          <td class="paramname"> <em>grism_file</em>[], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char&nbsp;</td>
          <td class="paramname"> <em>OAF_file</em>[], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char&nbsp;</td>
          <td class="paramname"> <em>fcube_file</em>[], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char&nbsp;</td>
          <td class="paramname"> <em>CONF_file</em>[], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const double&nbsp;</td>
          <td class="paramname"> <em>model_scale</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const int&nbsp;</td>
          <td class="paramname"> <em>inter_type</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structobservation.html">observation</a> *&nbsp;</td>
          <td class="paramname"> <em>obs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char&nbsp;</td>
          <td class="paramname"> <em>PET_file</em>[], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char&nbsp;</td>
          <td class="paramname"> <em>map_file</em>[], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const int&nbsp;</td>
          <td class="paramname"> <em>store</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p><div class="fragment"><pre class="fragment"><a name="l00665"></a>00665 {
<a name="l00666"></a>00666   <span class="keywordtype">object</span>    **oblist;
<a name="l00667"></a>00667   <a class="code" href="structdirobject.html">dirobject</a> **dirlist;
<a name="l00668"></a>00668   <a class="code" href="structbeamspec.html">beamspec</a>  **speclist;
<a name="l00669"></a>00669   <a class="code" href="structflux__cube.html">flux_cube</a>  *fcube;
<a name="l00670"></a>00670 
<a name="l00671"></a>00671   <span class="comment">//dirobject  *actdir;</span>
<a name="l00672"></a>00672   <a class="code" href="aXe__grism_8h.html#a6117e17bb3108107676f4486e62d40e5">gsl_matrix</a> *all_models;
<a name="l00673"></a>00673 
<a name="l00674"></a>00674   <span class="keywordtype">char</span> model_name[60];
<a name="l00675"></a>00675 
<a name="l00676"></a>00676   <a class="code" href="structpx__point.html">px_point</a> npixels;
<a name="l00677"></a>00677 
<a name="l00678"></a>00678   <span class="keywordtype">int</span> i_type;
<a name="l00679"></a>00679 
<a name="l00680"></a>00680   fprintf (stdout, <span class="stringliteral">&quot;aXe_PETCONT: Loading fluxcube image %s ...&quot;</span>, fcube_file);
<a name="l00681"></a>00681   fcube = <a class="code" href="spc__fluxcube_8c.html#ab4f88c30f07f1b2e86e3c156ae495691">load_fluxcube</a>(fcube_file);
<a name="l00682"></a>00682   fprintf (stdout, <span class="stringliteral">&quot; Done\n&quot;</span>);
<a name="l00683"></a>00683 
<a name="l00684"></a>00684   <span class="comment">//  load the object list</span>
<a name="l00685"></a>00685   fprintf (stdout, <span class="stringliteral">&quot;aXe_PETCONT: Loading object aperture list...&quot;</span>);
<a name="l00686"></a>00686   oblist = <a class="code" href="inout__aper_8c.html#ae18fecd8e762c35bae1376a8d637d8e8">file_to_object_list_seq</a> (OAF_file, obs);
<a name="l00687"></a>00687   fprintf (stdout,<span class="stringliteral">&quot;%d objects loaded.\n&quot;</span>,<a class="code" href="inout__aper_8c.html#aa4bd812673400180537c7ea98650d3fe">object_list_size</a>(oblist));
<a name="l00688"></a>00688 
<a name="l00689"></a>00689   <span class="comment">// get the dimension of the grism images</span>
<a name="l00690"></a>00690   npixels = <a class="code" href="aXe__utils_8c.html#ae7f4f277c2b5d03b7ce52b2392d176b2">get_npixel</a>(obs);
<a name="l00691"></a>00691 
<a name="l00692"></a>00692   <span class="comment">// generate the list of emitters from the</span>
<a name="l00693"></a>00693   <span class="comment">// fluxcube image</span>
<a name="l00694"></a>00694   dirlist = <a class="code" href="spc__fluxcube_8c.html#a682c533a63bf1a76022725edab374764">fluxcube_to_dirlist</a>(fcube, oblist);
<a name="l00695"></a>00695 
<a name="l00696"></a>00696   <span class="comment">// make the offsets??</span>
<a name="l00697"></a>00697   <a class="code" href="spc__fluxcube_8c.html#aecabb3459b749d8e33ea85f4e0bcfcbe">fill_xy_offsets</a>(dirlist, CONF_file);
<a name="l00698"></a>00698 
<a name="l00699"></a>00699   <span class="comment">// check whether there is enough information</span>
<a name="l00700"></a>00700   <span class="comment">// for the desired interpolation type</span>
<a name="l00701"></a>00701   i_type = <a class="code" href="model__utils_8c.html#ade00a122791415b1ec8ba98f979bf914">check_interp_type</a>(inter_type, fcube-&gt;<a class="code" href="structflux__cube.html#ad2a0926e5395663598768f3e09a14c69">n_fimage</a>, 0);
<a name="l00702"></a>00702 
<a name="l00703"></a>00703   <span class="comment">// model the beams</span>
<a name="l00704"></a>00704   speclist = <a class="code" href="spc__model_8c.html#a15bbdbd96e729c0edb66bd4e3c9f6b8c">make_fcube_spectra</a>(oblist, dirlist, npixels, CONF_file, fcube, i_type);
<a name="l00705"></a>00705 
<a name="l00706"></a>00706   <span class="comment">// compute the contamination image from the</span>
<a name="l00707"></a>00707   <span class="comment">// modelled beams</span>
<a name="l00708"></a>00708   all_models = <a class="code" href="spc__model_8c.html#aa210c0aa4d37a6f3914b73a39162301b">make_model_image</a>(npixels, obs, speclist);
<a name="l00709"></a>00709 
<a name="l00710"></a>00710   <span class="comment">// check whether the contamination</span>
<a name="l00711"></a>00711   <span class="comment">// image should be stored</span>
<a name="l00712"></a>00712   <span class="keywordflow">if</span> (store)
<a name="l00713"></a>00713     <span class="comment">// store the contamination image</span>
<a name="l00714"></a>00714     <a class="code" href="aXe__utils_8c.html#a6a5d64fa0baa598fc20741fa603bee11">gsl_to_FITSimage</a> (all_models, map_file, 1, NULL);
<a name="l00715"></a>00715 
<a name="l00716"></a>00716   <span class="comment">// store the name of the contamination model</span>
<a name="l00717"></a>00717   sprintf (model_name, <span class="stringliteral">&quot;FLUXCUBE&quot;</span>);
<a name="l00718"></a>00718 
<a name="l00719"></a>00719   <span class="comment">// check whether a PET exists</span>
<a name="l00720"></a>00720   <span class="keywordflow">if</span> (strlen(PET_file) &gt; 0)
<a name="l00721"></a>00721     <span class="comment">// compute and transfer the contamination</span>
<a name="l00722"></a>00722     <span class="comment">// information fot the PET pixels</span>
<a name="l00723"></a>00723     <a class="code" href="spc__model_8c.html#a3d953255a2ae0faf92105f0909a05053">fill_contam_info</a>(PET_file, speclist, all_models, model_name);
<a name="l00724"></a>00724 
<a name="l00725"></a>00725   <span class="comment">// free the memory allocated</span>
<a name="l00726"></a>00726   <span class="comment">// in the various structures</span>
<a name="l00727"></a>00727   <a class="code" href="aXe__grism_8h.html#a61aa1d37853a90711852146f18d0b85f">gsl_matrix_free</a>(all_models);
<a name="l00728"></a>00728   <a class="code" href="model__utils_8c.html#a9869f818df7a666d983da7b3d1956532">free_speclist</a>(speclist);
<a name="l00729"></a>00729   <a class="code" href="model__utils_8c.html#a72c9efb6343e03f3e19b0c81af37a54f">free_dirlist</a> (dirlist);
<a name="l00730"></a>00730   <a class="code" href="spc__fluxcube_8c.html#a4326413c31d848f7f10076d3776b2d08">free_fluxcube</a>(fcube);
<a name="l00731"></a>00731   <span class="keywordflow">if</span> (oblist != NULL)
<a name="l00732"></a>00732     <a class="code" href="aXe__utils_8c.html#a1f63bfb071e9d0ea1f8854efdfae4692">free_oblist</a> (oblist);
<a name="l00733"></a>00733 
<a name="l00734"></a>00734   <span class="comment">// return &apos;1&apos; as a dummy</span>
<a name="l00735"></a>00735   <span class="keywordflow">return</span> 1;
<a name="l00736"></a>00736 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a38b6ce346cbc8cd237fdfd3694c9b11e"></a><!-- doxytag: member="spc_model.h::compute_gauss_cont" ref="a38b6ce346cbc8cd237fdfd3694c9b11e" args="(char grism_file[], char OAF_file[], char CONF_file[], const char specmod_file[], const double model_scale, const int inter_type, const double lambda_psf, observation *obs, const char PET_file[], char map_file[], const int store)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int compute_gauss_cont </td>
          <td>(</td>
          <td class="paramtype">char&nbsp;</td>
          <td class="paramname"> <em>grism_file</em>[], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char&nbsp;</td>
          <td class="paramname"> <em>OAF_file</em>[], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char&nbsp;</td>
          <td class="paramname"> <em>CONF_file</em>[], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char&nbsp;</td>
          <td class="paramname"> <em>specmod_file</em>[], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const double&nbsp;</td>
          <td class="paramname"> <em>model_scale</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const int&nbsp;</td>
          <td class="paramname"> <em>inter_type</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const double&nbsp;</td>
          <td class="paramname"> <em>lambda_psf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structobservation.html">observation</a> *&nbsp;</td>
          <td class="paramname"> <em>obs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char&nbsp;</td>
          <td class="paramname"> <em>PET_file</em>[], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char&nbsp;</td>
          <td class="paramname"> <em>map_file</em>[], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const int&nbsp;</td>
          <td class="paramname"> <em>store</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Function: compute_gauss_cont The subroutine computes ans stores the quantitative contamination using the Gaussian emission model. The emitting <a class="el" href="structobject.html">object</a> with Gaussian shape and SED as derived from the AB filter magnitudes are composed The individual nbeams are modelled, then the complete contamination image is composed from the <a class="el" href="structbeam.html">beam</a> models. Finally, the contaminating flux is computed by subtracting the <a class="el" href="structbeam.html">beam</a> emission from the contamination image for all PET pixels.</p>
<p>Parameters: </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>grism_file</em>&nbsp;</td><td>- the full name of the grism file </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>OAF_file</em>&nbsp;</td><td>- the name of the aperture file </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>CONF_file</em>&nbsp;</td><td>- the full name of configuration file </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>specmod_file-</em>&nbsp;</td><td>fits table with the model spectra </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>model_scale</em>&nbsp;</td><td>- the scale for extension of the direct <a class="el" href="structobject.html">object</a> area </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>inter_type</em>&nbsp;</td><td>- the interpolation method for the flux values </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>lambda_psf</em>&nbsp;</td><td>- wavelength the Gaussian parameters were determined at </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>obs</em>&nbsp;</td><td>- the <a class="el" href="structobservation.html">observation</a> </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>PET_file</em>&nbsp;</td><td>- the name of the PET which is modified </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>map_file</em>&nbsp;</td><td>- the name of the contamination map </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>store</em>&nbsp;</td><td>- flag whether the contamination image is stored or not</td></tr>
  </table>
  </dd>
</dl>
<p>Returns: </p>
<dl class="return"><dt><b>Returns:</b></dt><dd>status - returns success or failure </dd></dl>

<p><div class="fragment"><pre class="fragment"><a name="l00074"></a>00074 {
<a name="l00075"></a>00075 
<a name="l00076"></a>00076   <span class="keywordtype">object</span>    **oblist;
<a name="l00077"></a>00077   <a class="code" href="structdirobject.html">dirobject</a> **dirlist;
<a name="l00078"></a>00078   <a class="code" href="structbeamspec.html">beamspec</a>  **speclist;
<a name="l00079"></a>00079   <a class="code" href="structspectral__models.html">spectral_models</a> *spec_mod;
<a name="l00080"></a>00080 
<a name="l00081"></a>00081   <span class="comment">//dirobject  *actdir;</span>
<a name="l00082"></a>00082   <a class="code" href="aXe__grism_8h.html#a6117e17bb3108107676f4486e62d40e5">gsl_matrix</a> *all_models;
<a name="l00083"></a>00083   <span class="keywordtype">char</span> model_name[60];
<a name="l00084"></a>00084 
<a name="l00085"></a>00085   <a class="code" href="structpx__point.html">px_point</a> npixels;
<a name="l00086"></a>00086 
<a name="l00087"></a>00087   <span class="comment">//time_t timer;</span>
<a name="l00088"></a>00088 
<a name="l00089"></a>00089   <span class="comment">// load the object list</span>
<a name="l00090"></a>00090   fprintf (stdout, <span class="stringliteral">&quot;aXe_PETCONT: Loading object aperture list...&quot;</span>);
<a name="l00091"></a>00091   oblist = <a class="code" href="inout__aper_8c.html#ae18fecd8e762c35bae1376a8d637d8e8">file_to_object_list_seq</a> (OAF_file, obs);
<a name="l00092"></a>00092   fprintf (stdout,<span class="stringliteral">&quot;%d objects loaded.\n&quot;</span>,<a class="code" href="inout__aper_8c.html#aa4bd812673400180537c7ea98650d3fe">object_list_size</a>(oblist));
<a name="l00093"></a>00093 
<a name="l00094"></a>00094   <span class="comment">// check whether highres models</span>
<a name="l00095"></a>00095   <span class="comment">// are given</span>
<a name="l00096"></a>00096   <span class="keywordflow">if</span> (strlen(specmod_file) &gt; 0)
<a name="l00097"></a>00097     <span class="comment">// load the spectral models</span>
<a name="l00098"></a>00098     spec_mod = <a class="code" href="specmodel__utils_8c.html#a815d1f785501fd2a9cc3f33a6a95c34d">load_spectral_models</a>(specmod_file);
<a name="l00099"></a>00099   <span class="keywordflow">else</span>
<a name="l00100"></a>00100     <span class="comment">// or set the struct to NULL</span>
<a name="l00101"></a>00101     spec_mod = NULL;
<a name="l00102"></a>00102 
<a name="l00103"></a>00103   <span class="comment">// get the image dimensions</span>
<a name="l00104"></a>00104   npixels = <a class="code" href="aXe__utils_8c.html#ae7f4f277c2b5d03b7ce52b2392d176b2">get_npixel</a>(obs);
<a name="l00105"></a>00105 
<a name="l00106"></a>00106   <span class="comment">// create the list of direct objects to be simulated</span>
<a name="l00107"></a>00107   dirlist = <a class="code" href="model__utils_8c.html#ab4a6c2b0e26ff79ca76b2887d670b1df">oblist_to_dirlist</a>(grism_file, CONF_file, npixels, oblist, spec_mod, model_scale, inter_type);
<a name="l00108"></a>00108 
<a name="l00109"></a>00109   <span class="comment">//  timer=time(NULL);</span>
<a name="l00110"></a>00110   <span class="comment">//  printf(&quot;The current time is %s.\n&quot;,asctime(localtime(&amp;timer)));</span>
<a name="l00111"></a>00111   speclist = <a class="code" href="spc__model_8c.html#a537ee6c7685fe9d7749342e56437f02d">make_gauss_spectra</a>(oblist, dirlist, lambda_psf, npixels, CONF_file);
<a name="l00112"></a>00112   <span class="comment">//  timer=time(NULL);</span>
<a name="l00113"></a>00113   <span class="comment">//  printf(&quot;The current time is %s.\n&quot;,asctime(localtime(&amp;timer)));</span>
<a name="l00114"></a>00114 
<a name="l00115"></a>00115   <span class="comment">// compose the contamination image from the modelled beams</span>
<a name="l00116"></a>00116   all_models = <a class="code" href="spc__model_8c.html#aa210c0aa4d37a6f3914b73a39162301b">make_model_image</a>(npixels, obs, speclist);
<a name="l00117"></a>00117 
<a name="l00118"></a>00118   <span class="comment">// check whether the contamination image</span>
<a name="l00119"></a>00119   <span class="comment">// should be stored</span>
<a name="l00120"></a>00120   <span class="keywordflow">if</span> (store)
<a name="l00121"></a>00121     <span class="comment">// store the contamination image</span>
<a name="l00122"></a>00122     <a class="code" href="aXe__utils_8c.html#a6a5d64fa0baa598fc20741fa603bee11">gsl_to_FITSimage</a> (all_models, map_file, 1, NULL);
<a name="l00123"></a>00123 
<a name="l00124"></a>00124   <span class="comment">// store the name of the</span>
<a name="l00125"></a>00125   <span class="comment">// contamination model</span>
<a name="l00126"></a>00126   sprintf (model_name, <span class="stringliteral">&quot;GAUSS&quot;</span>);
<a name="l00127"></a>00127 
<a name="l00128"></a>00128   <span class="comment">// put the contamination info into the PET</span>
<a name="l00129"></a>00129   <a class="code" href="spc__model_8c.html#a3d953255a2ae0faf92105f0909a05053">fill_contam_info</a>(PET_file, speclist, all_models, model_name);
<a name="l00130"></a>00130 
<a name="l00131"></a>00131   <span class="comment">// release allocated memory</span>
<a name="l00132"></a>00132   <span class="comment">// in the various structures</span>
<a name="l00133"></a>00133   <a class="code" href="aXe__grism_8h.html#a61aa1d37853a90711852146f18d0b85f">gsl_matrix_free</a>(all_models);
<a name="l00134"></a>00134   <span class="keywordflow">if</span> (spec_mod != NULL)
<a name="l00135"></a>00135     <a class="code" href="specmodel__utils_8c.html#aacf21452ac18d26013430240df196892">free_spectral_models</a>(spec_mod);
<a name="l00136"></a>00136   <a class="code" href="model__utils_8c.html#a72c9efb6343e03f3e19b0c81af37a54f">free_dirlist</a>(dirlist);
<a name="l00137"></a>00137   <a class="code" href="model__utils_8c.html#a9869f818df7a666d983da7b3d1956532">free_speclist</a>(speclist);
<a name="l00138"></a>00138   <span class="keywordflow">if</span> (oblist !=NULL)
<a name="l00139"></a>00139     <a class="code" href="aXe__utils_8c.html#a1f63bfb071e9d0ea1f8854efdfae4692">free_oblist</a> (oblist);
<a name="l00140"></a>00140 
<a name="l00141"></a>00141   <span class="comment">// return always &apos;1&apos;</span>
<a name="l00142"></a>00142   <span class="keywordflow">return</span> 1;
<a name="l00143"></a>00143 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="aa0440d5bc85fc01a75dca2c32a3239fe"></a><!-- doxytag: member="spc_model.h::compute_gauss_dirim" ref="aa0440d5bc85fc01a75dca2c32a3239fe" args="(char grism_file[], char OAF_file[], char CONF_file[], const double model_scale, const int inter_type, const double lambda_psf, observation *obs, const char PET_file[], char map_file[], const int store)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int compute_gauss_dirim </td>
          <td>(</td>
          <td class="paramtype">char&nbsp;</td>
          <td class="paramname"> <em>grism_file</em>[], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char&nbsp;</td>
          <td class="paramname"> <em>OAF_file</em>[], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char&nbsp;</td>
          <td class="paramname"> <em>CONF_file</em>[], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const double&nbsp;</td>
          <td class="paramname"> <em>model_scale</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const int&nbsp;</td>
          <td class="paramname"> <em>inter_type</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const double&nbsp;</td>
          <td class="paramname"> <em>lambda_psf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structobservation.html">observation</a> *&nbsp;</td>
          <td class="paramname"> <em>obs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char&nbsp;</td>
          <td class="paramname"> <em>PET_file</em>[], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char&nbsp;</td>
          <td class="paramname"> <em>map_file</em>[], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const int&nbsp;</td>
          <td class="paramname"> <em>store</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Function: compute_gauss_dirim</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>grism_file</em>&nbsp;</td><td>- the full name of the grism file </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>OAF_file</em>&nbsp;</td><td>- the name of the aperture file </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>obs</em>&nbsp;</td><td>- the <a class="el" href="structobservation.html">observation</a> </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>PET_file</em>&nbsp;</td><td>- the name of the PET which is modified </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>CONF_file</em>&nbsp;</td><td>- the full name of configuration file </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>map_file</em>&nbsp;</td><td>- the name of the contamination map </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>model_scale</em>&nbsp;</td><td>- the scale for extension of the direct <a class="el" href="structobject.html">object</a> area </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>store</em>&nbsp;</td><td>- flagg whether the contamination image is stored or not</td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>status - returns success or failure </dd></dl>

<p><div class="fragment"><pre class="fragment"><a name="l01840"></a>01840                                                                             {
<a name="l01841"></a>01841 
<a name="l01842"></a>01842   <span class="keywordtype">object</span>    **oblist;
<a name="l01843"></a>01843   <a class="code" href="structdirobject.html">dirobject</a> **dirlist;
<a name="l01844"></a>01844 
<a name="l01845"></a>01845   <span class="comment">//dirobject  *actdir;</span>
<a name="l01846"></a>01846   <a class="code" href="aXe__grism_8h.html#a6117e17bb3108107676f4486e62d40e5">gsl_matrix</a> *all_models;
<a name="l01847"></a>01847 
<a name="l01848"></a>01848   <span class="comment">//char model_name[60];</span>
<a name="l01849"></a>01849 
<a name="l01850"></a>01850   <a class="code" href="structpx__point.html">px_point</a> npixels;
<a name="l01851"></a>01851 
<a name="l01852"></a>01852   <span class="comment">//  load the object list</span>
<a name="l01853"></a>01853   fprintf (stdout, <span class="stringliteral">&quot;aXe_PETCONT: Loading object aperture list...&quot;</span>);
<a name="l01854"></a>01854   oblist = <a class="code" href="inout__aper_8c.html#ae18fecd8e762c35bae1376a8d637d8e8">file_to_object_list_seq</a> (OAF_file, obs);
<a name="l01855"></a>01855   fprintf (stdout,<span class="stringliteral">&quot;%d objects loaded.\n&quot;</span>,<a class="code" href="inout__aper_8c.html#aa4bd812673400180537c7ea98650d3fe">object_list_size</a>(oblist));
<a name="l01856"></a>01856 
<a name="l01857"></a>01857   npixels = <a class="code" href="aXe__utils_8c.html#ae7f4f277c2b5d03b7ce52b2392d176b2">get_npixel</a>(obs);
<a name="l01858"></a>01858 
<a name="l01859"></a>01859   dirlist = <a class="code" href="model__utils_8c.html#ab4a6c2b0e26ff79ca76b2887d670b1df">oblist_to_dirlist</a>(grism_file, CONF_file, npixels, oblist, NULL, model_scale, inter_type);
<a name="l01860"></a>01860 
<a name="l01861"></a>01861   all_models = <a class="code" href="spc__model_8c.html#a64acb42dee15b4bd66149391bbdb982e">make_gauss_dirim</a>(oblist, dirlist, lambda_psf, npixels, CONF_file, obs);
<a name="l01862"></a>01862 
<a name="l01863"></a>01863 
<a name="l01864"></a>01864   <span class="keywordflow">if</span> (store)
<a name="l01865"></a>01865     <a class="code" href="aXe__utils_8c.html#a6a5d64fa0baa598fc20741fa603bee11">gsl_to_FITSimage</a> (all_models, map_file, 1, NULL);
<a name="l01866"></a>01866 
<a name="l01867"></a>01867 
<a name="l01868"></a>01868   <a class="code" href="aXe__grism_8h.html#a61aa1d37853a90711852146f18d0b85f">gsl_matrix_free</a>(all_models);
<a name="l01869"></a>01869   <a class="code" href="model__utils_8c.html#a72c9efb6343e03f3e19b0c81af37a54f">free_dirlist</a> (dirlist);
<a name="l01870"></a>01870   <span class="keywordflow">if</span> (oblist != NULL)
<a name="l01871"></a>01871     <a class="code" href="aXe__utils_8c.html#a1f63bfb071e9d0ea1f8854efdfae4692">free_oblist</a> (oblist);
<a name="l01872"></a>01872 
<a name="l01873"></a>01873   <span class="keywordflow">return</span> 1;
<a name="l01874"></a>01874 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ac807e950441746662b1ae3eab9ef2b33"></a><!-- doxytag: member="spc_model.h::compute_gaussdirim_cont" ref="ac807e950441746662b1ae3eab9ef2b33" args="(char grism_file[], char OAF_file[], char CONF_file[], const char specmod_file[], const char objmod_file[], const double model_scale, const int inter_type, const double lambda_psf, observation *obs, const char PET_file[], char map_file[], const int store)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int compute_gaussdirim_cont </td>
          <td>(</td>
          <td class="paramtype">char&nbsp;</td>
          <td class="paramname"> <em>grism_file</em>[], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char&nbsp;</td>
          <td class="paramname"> <em>OAF_file</em>[], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char&nbsp;</td>
          <td class="paramname"> <em>CONF_file</em>[], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char&nbsp;</td>
          <td class="paramname"> <em>specmod_file</em>[], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char&nbsp;</td>
          <td class="paramname"> <em>objmod_file</em>[], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const double&nbsp;</td>
          <td class="paramname"> <em>model_scale</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const int&nbsp;</td>
          <td class="paramname"> <em>inter_type</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const double&nbsp;</td>
          <td class="paramname"> <em>lambda_psf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structobservation.html">observation</a> *&nbsp;</td>
          <td class="paramname"> <em>obs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char&nbsp;</td>
          <td class="paramname"> <em>PET_file</em>[], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char&nbsp;</td>
          <td class="paramname"> <em>map_file</em>[], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const int&nbsp;</td>
          <td class="paramname"> <em>store</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Function: compute_gaussdirim_cont The subroutine computes ans stores the quantitative contamination using the Gaussian emission model. The <a class="el" href="structobject.html">object</a> shape can be defined in a fits file with <a class="el" href="structobject.html">object</a> models, and the SED may be defined in a fits table with high resolution spectra. If no detailed <a class="el" href="structobject.html">object</a> shape or SED is given for an individual <a class="el" href="structobject.html">object</a>, Gaussian shape and SED as derived from the AB filter magnitudes are composed. The individual nbeams are modelled, then the complete contamination image is composed from the <a class="el" href="structbeam.html">beam</a> models. Finally, the contaminating flux is computed by subtracting the <a class="el" href="structbeam.html">beam</a> emission from the contamination image for all PET pixels.</p>
<p>Parameters: </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>grism_file</em>&nbsp;</td><td>- the full name of the grism file </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>OAF_file</em>&nbsp;</td><td>- the name of the aperture file </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>CONF_file</em>&nbsp;</td><td>- the full name of configuration file </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>specmod_file-</em>&nbsp;</td><td>fits table with the model spectra </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>objmod_file</em>&nbsp;</td><td>- fits image with <a class="el" href="structobject.html">object</a> models </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>model_scale</em>&nbsp;</td><td>- the scale for extension of the direct <a class="el" href="structobject.html">object</a> area </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>inter_type</em>&nbsp;</td><td>- the interpolation method for the flux values </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>lambda_psf</em>&nbsp;</td><td>- wavelength the Gaussian parameters were determined at </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>obs</em>&nbsp;</td><td>- the <a class="el" href="structobservation.html">observation</a> </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>PET_file</em>&nbsp;</td><td>- the name of the PET which is modified </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>map_file</em>&nbsp;</td><td>- the name of the contamination map </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>store</em>&nbsp;</td><td>- flag whether the contamination image is stored or not</td></tr>
  </table>
  </dd>
</dl>
<p>Returns: </p>
<dl class="return"><dt><b>Returns:</b></dt><dd>status - returns success or failure </dd></dl>

<p><div class="fragment"><pre class="fragment"><a name="l00181"></a>00181 {
<a name="l00182"></a>00182 
<a name="l00183"></a>00183   <span class="keywordtype">object</span>        **oblist;
<a name="l00184"></a>00184   <a class="code" href="structdirobject.html">dirobject</a>     **dirlist;
<a name="l00185"></a>00185   <a class="code" href="structbeamspec.html">beamspec</a>      **speclist;
<a name="l00186"></a>00186   <a class="code" href="structspectral__models.html">spectral_models</a> *spec_mod;
<a name="l00187"></a>00187   <a class="code" href="structobject__models.html">object_models</a>   *obj_mod;
<a name="l00188"></a>00188 
<a name="l00189"></a>00189   <span class="comment">//dirobject  *actdir;</span>
<a name="l00190"></a>00190   <a class="code" href="aXe__grism_8h.html#a6117e17bb3108107676f4486e62d40e5">gsl_matrix</a> *all_models;
<a name="l00191"></a>00191   <span class="keywordtype">char</span> model_name[60];
<a name="l00192"></a>00192 
<a name="l00193"></a>00193   <a class="code" href="structpx__point.html">px_point</a> npixels;
<a name="l00194"></a>00194 
<a name="l00195"></a>00195   <span class="comment">//time_t timer;</span>
<a name="l00196"></a>00196 
<a name="l00197"></a>00197   <span class="comment">// load the object list</span>
<a name="l00198"></a>00198   fprintf (stdout, <span class="stringliteral">&quot;aXe_PETCONT: Loading object aperture list...&quot;</span>);
<a name="l00199"></a>00199   oblist = <a class="code" href="inout__aper_8c.html#ae18fecd8e762c35bae1376a8d637d8e8">file_to_object_list_seq</a> (OAF_file, obs);
<a name="l00200"></a>00200   fprintf (stdout,<span class="stringliteral">&quot;%d objects loaded.\n&quot;</span>,<a class="code" href="inout__aper_8c.html#aa4bd812673400180537c7ea98650d3fe">object_list_size</a>(oblist));
<a name="l00201"></a>00201 
<a name="l00202"></a>00202   <span class="comment">// check whether highres models</span>
<a name="l00203"></a>00203   <span class="comment">// are given</span>
<a name="l00204"></a>00204   <span class="keywordflow">if</span> (strlen(specmod_file) &gt; 0)
<a name="l00205"></a>00205     <span class="comment">// load the spectral models</span>
<a name="l00206"></a>00206     spec_mod = <a class="code" href="specmodel__utils_8c.html#a815d1f785501fd2a9cc3f33a6a95c34d">load_spectral_models</a>(specmod_file);
<a name="l00207"></a>00207   <span class="keywordflow">else</span>
<a name="l00208"></a>00208     <span class="comment">// or set the struct to NULL</span>
<a name="l00209"></a>00209     spec_mod = NULL;
<a name="l00210"></a>00210 
<a name="l00211"></a>00211   <span class="comment">// check whether direct emission models</span>
<a name="l00212"></a>00212   <span class="comment">// are given</span>
<a name="l00213"></a>00213   <span class="keywordflow">if</span> (strlen(objmod_file) &gt; 0)
<a name="l00214"></a>00214     obj_mod = <a class="code" href="specmodel__utils_8c.html#a2683e0be35d7cfb48bb1950f84989643">load_object_models</a>(objmod_file);
<a name="l00215"></a>00215   <span class="keywordflow">else</span>
<a name="l00216"></a>00216     obj_mod = NULL;
<a name="l00217"></a>00217 
<a name="l00218"></a>00218   <span class="comment">// get the image dimensions</span>
<a name="l00219"></a>00219   npixels = <a class="code" href="aXe__utils_8c.html#ae7f4f277c2b5d03b7ce52b2392d176b2">get_npixel</a>(obs);
<a name="l00220"></a>00220 
<a name="l00221"></a>00221   <span class="comment">// create the list of direct objects to be simulated</span>
<a name="l00222"></a>00222   dirlist = <a class="code" href="model__utils_8c.html#a763b05dcf96d0f69417a38f7bf0a61da">oblist_to_dirlist2</a>(grism_file, CONF_file, npixels, oblist,
<a name="l00223"></a>00223                                spec_mod, obj_mod, model_scale, inter_type);
<a name="l00224"></a>00224 
<a name="l00225"></a>00225   <span class="comment">//timer=time(NULL);</span>
<a name="l00226"></a>00226   <span class="comment">//printf(&quot;The current time is %s.\n&quot;,asctime(localtime(&amp;timer)));</span>
<a name="l00227"></a>00227   speclist = <a class="code" href="spc__model_8c.html#ae7dcf882713246ce40e28942522142a5">make_gauss_spectra2</a>(oblist, dirlist, lambda_psf, npixels, CONF_file);
<a name="l00228"></a>00228   <span class="comment">//timer=time(NULL);</span>
<a name="l00229"></a>00229   <span class="comment">//printf(&quot;The current time is %s.\n&quot;,asctime(localtime(&amp;timer)));</span>
<a name="l00230"></a>00230 
<a name="l00231"></a>00231   <span class="comment">// compose the contamination image from the modelled beams</span>
<a name="l00232"></a>00232   all_models = <a class="code" href="spc__model_8c.html#aa210c0aa4d37a6f3914b73a39162301b">make_model_image</a>(npixels, obs, speclist);
<a name="l00233"></a>00233 
<a name="l00234"></a>00234   <span class="comment">// check whether the contamination image</span>
<a name="l00235"></a>00235   <span class="comment">// should be stored</span>
<a name="l00236"></a>00236   <span class="keywordflow">if</span> (store)
<a name="l00237"></a>00237     <span class="comment">// store the contamination image</span>
<a name="l00238"></a>00238     <a class="code" href="aXe__utils_8c.html#a6a5d64fa0baa598fc20741fa603bee11">gsl_to_FITSimage</a> (all_models, map_file, 1, NULL);
<a name="l00239"></a>00239 
<a name="l00240"></a>00240   <span class="comment">// store the name of the</span>
<a name="l00241"></a>00241   <span class="comment">// contamination model</span>
<a name="l00242"></a>00242   <span class="keywordflow">if</span> (obj_mod != NULL)
<a name="l00243"></a>00243     sprintf (model_name, <span class="stringliteral">&quot;DIRIM&quot;</span>);
<a name="l00244"></a>00244   <span class="keywordflow">else</span>
<a name="l00245"></a>00245     sprintf (model_name, <span class="stringliteral">&quot;GAUSS&quot;</span>);
<a name="l00246"></a>00246 
<a name="l00247"></a>00247   <span class="comment">// check whether a PET exists</span>
<a name="l00248"></a>00248   <span class="keywordflow">if</span> (strlen(PET_file) &gt; 0)
<a name="l00249"></a>00249     <span class="comment">// put the contamination info into the PET</span>
<a name="l00250"></a>00250     <a class="code" href="spc__model_8c.html#a3d953255a2ae0faf92105f0909a05053">fill_contam_info</a>(PET_file, speclist, all_models, model_name);
<a name="l00251"></a>00251 
<a name="l00252"></a>00252   <span class="comment">// release allocated memory</span>
<a name="l00253"></a>00253   <span class="comment">// in the various structures</span>
<a name="l00254"></a>00254   <a class="code" href="aXe__grism_8h.html#a61aa1d37853a90711852146f18d0b85f">gsl_matrix_free</a>(all_models);
<a name="l00255"></a>00255   <span class="keywordflow">if</span> (spec_mod != NULL)
<a name="l00256"></a>00256     <a class="code" href="specmodel__utils_8c.html#aacf21452ac18d26013430240df196892">free_spectral_models</a>(spec_mod);
<a name="l00257"></a>00257   <a class="code" href="model__utils_8c.html#a72c9efb6343e03f3e19b0c81af37a54f">free_dirlist</a>(dirlist);
<a name="l00258"></a>00258   <span class="keywordflow">if</span> (obj_mod != NULL)
<a name="l00259"></a>00259     <a class="code" href="specmodel__utils_8c.html#ae180cf6fd252d1eae9ddd146f288f9b5">free_object_models</a>(obj_mod);
<a name="l00260"></a>00260   <a class="code" href="model__utils_8c.html#a9869f818df7a666d983da7b3d1956532">free_speclist</a>(speclist);
<a name="l00261"></a>00261   <span class="keywordflow">if</span> (oblist !=NULL)
<a name="l00262"></a>00262     <a class="code" href="aXe__utils_8c.html#a1f63bfb071e9d0ea1f8854efdfae4692">free_oblist</a> (oblist);
<a name="l00263"></a>00263 
<a name="l00264"></a>00264   <span class="comment">// return always &apos;1&apos;</span>
<a name="l00265"></a>00265   <span class="keywordflow">return</span> 1;
<a name="l00266"></a>00266 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a3e988115996eb29019bb46673cdacb12"></a><!-- doxytag: member="spc_model.h::compute_geometr_cont" ref="a3e988115996eb29019bb46673cdacb12" args="(char OAF_file[], observation *obs, const char PET_file[], char map_file[], const int store)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int compute_geometr_cont </td>
          <td>(</td>
          <td class="paramtype">char&nbsp;</td>
          <td class="paramname"> <em>OAF_file</em>[], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structobservation.html">observation</a> *&nbsp;</td>
          <td class="paramname"> <em>obs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char&nbsp;</td>
          <td class="paramname"> <em>PET_file</em>[], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char&nbsp;</td>
          <td class="paramname"> <em>map_file</em>[], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const int&nbsp;</td>
          <td class="paramname"> <em>store</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Function: compute_geometr_cont The subroutine computes the original, geometrical contamination model where every beams contaminates the area he occupies. Source brightness and source shape are not taken into account. For every <a class="el" href="structbeam.html">beam</a> the sum of all contaminations by othe beams is written into the PET.</p>
<p>Parameters: </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>OAF_file</em>&nbsp;</td><td>- the name of the aperture file </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>obs</em>&nbsp;</td><td>- the <a class="el" href="structobservation.html">observation</a> </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>PET_file</em>&nbsp;</td><td>- the name of the PET which is modified </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>map_file</em>&nbsp;</td><td>- the name of the contamination map </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>store</em>&nbsp;</td><td>- flagg whether the contamination image is stored or not</td></tr>
  </table>
  </dd>
</dl>
<p>Returns: </p>
<dl class="return"><dt><b>Returns:</b></dt><dd>status - returns success or failure </dd></dl>

<p><div class="fragment"><pre class="fragment"><a name="l01702"></a>01702                                      {
<a name="l01703"></a>01703 
<a name="l01704"></a>01704   <span class="keywordtype">object</span> **oblist;
<a name="l01705"></a>01705   <a class="code" href="structap__pixel.html">ap_pixel</a> *PET;
<a name="l01706"></a>01706   <span class="keywordtype">int</span> f_status=0;
<a name="l01707"></a>01707   fitsfile *OPET_ptr;
<a name="l01708"></a>01708   <span class="keywordtype">int</span> aperID, beamID, objindex;
<a name="l01709"></a>01709   <a class="code" href="aXe__grism_8h.html#a6117e17bb3108107676f4486e62d40e5">gsl_matrix</a> *aper_mask;
<a name="l01710"></a>01710   <span class="keywordtype">int</span> status=0;
<a name="l01711"></a>01711   <span class="keywordtype">char</span> model_name[60];
<a name="l01712"></a>01712 
<a name="l01713"></a>01713   <span class="comment">//  load the object list</span>
<a name="l01714"></a>01714   fprintf (stdout, <span class="stringliteral">&quot;aXe_PETCONT: Loading object aperture list...&quot;</span>);
<a name="l01715"></a>01715   oblist = <a class="code" href="inout__aper_8c.html#ae18fecd8e762c35bae1376a8d637d8e8">file_to_object_list_seq</a> (OAF_file, obs);
<a name="l01716"></a>01716   fprintf (stdout,<span class="stringliteral">&quot;%d objects loaded.\n&quot;</span>,<a class="code" href="inout__aper_8c.html#aa4bd812673400180537c7ea98650d3fe">object_list_size</a>(oblist));
<a name="l01717"></a>01717 
<a name="l01718"></a>01718   <span class="comment">// Open the OPET file for reading/writing</span>
<a name="l01719"></a>01719   ffopen (&amp;OPET_ptr, PET_file, READWRITE, &amp;f_status);
<a name="l01720"></a>01720   <span class="keywordflow">if</span> (f_status)
<a name="l01721"></a>01721     <a class="code" href="aXe__errors_8c.html#a7ef7588e5f91237ba7ce4084e6ed3c11">aXe_message</a> (<a class="code" href="aXe__errors_8h.html#a2556a67874555249b07691c37aa6d6e9">aXe_M_FATAL</a>, __FILE__, __LINE__,
<a name="l01722"></a>01722                  <span class="stringliteral">&quot;aXe_PETCONT: Could not open file: %s\n&quot;</span>,
<a name="l01723"></a>01723                  PET_file);
<a name="l01724"></a>01724 
<a name="l01725"></a>01725   <span class="comment">// store the contamination model name in the PET</span>
<a name="l01726"></a>01726   sprintf (model_name, <span class="stringliteral">&quot;GEOM&quot;</span>);
<a name="l01727"></a>01727   <a class="code" href="spc__FITScards_8c.html#a6cb1187c647e381a5d1803846ee73a3e">update_contam_model</a>(OPET_ptr, model_name);
<a name="l01728"></a>01728 
<a name="l01729"></a>01729   <span class="comment">// do something in case that there are objects</span>
<a name="l01730"></a>01730   <span class="keywordflow">if</span> (oblist!=NULL)
<a name="l01731"></a>01731     {
<a name="l01732"></a>01732 
<a name="l01733"></a>01733       <span class="comment">// make the aperture mask</span>
<a name="l01734"></a>01734       aper_mask = <a class="code" href="spc__back_8c.html#a84505bc11501c5f2abc6c1f45d68e79b">aperture_mask</a>(obs,oblist);
<a name="l01735"></a>01735 
<a name="l01736"></a>01736       <span class="comment">// store the aperture mask into a fits file if requested</span>
<a name="l01737"></a>01737       <span class="keywordflow">if</span> (store)
<a name="l01738"></a>01738         <a class="code" href="aXe__utils_8c.html#a6a5d64fa0baa598fc20741fa603bee11">gsl_to_FITSimage</a> (aper_mask, map_file, 1, NULL);
<a name="l01739"></a>01739 
<a name="l01740"></a>01740       <span class="comment">// loop over all beams</span>
<a name="l01741"></a>01741       <span class="keywordflow">while</span> (1)
<a name="l01742"></a>01742         {
<a name="l01743"></a>01743 
<a name="l01744"></a>01744           <span class="comment">// get the PET at the actual position of the PET file</span>
<a name="l01745"></a>01745           PET = <a class="code" href="spce__PET_8c.html#a6d9546246608829c70349f2d8ca69543">get_ALL_from_next_in_PET</a>(OPET_ptr, &amp;aperID, &amp;beamID);
<a name="l01746"></a>01746 
<a name="l01747"></a>01747           <span class="comment">// leave the while loop if there is the end</span>
<a name="l01748"></a>01748           <span class="keywordflow">if</span> ((aperID==-1) &amp;&amp; (beamID==-1))
<a name="l01749"></a>01749             <span class="keywordflow">break</span>;
<a name="l01750"></a>01750 
<a name="l01751"></a>01751           <span class="comment">// search for the particular beam in &apos;oblist&apos;, continue</span>
<a name="l01752"></a>01752           <span class="comment">// if PET is empty</span>
<a name="l01753"></a>01753           fprintf (stdout, <span class="stringliteral">&quot;aXe_PETCONT: BEAM %d%c&quot;</span>, aperID, <a class="code" href="aXe__grism_8h.html#a7d90dabb6016bb0e09b6ab84087b70a7">BEAM</a>(beamID));
<a name="l01754"></a>01754           objindex =  <a class="code" href="inout__aper_8c.html#a12854533fd67781a0bf70a93a6ad91e4">find_object_in_object_list</a>(oblist,aperID);
<a name="l01755"></a>01755           <span class="keywordflow">if</span> (PET==NULL)
<a name="l01756"></a>01756             {
<a name="l01757"></a>01757               fprintf (stdout, <span class="stringliteral">&quot;.Done\n&quot;</span>);
<a name="l01758"></a>01758               <span class="keywordflow">continue</span>;
<a name="l01759"></a>01759             }
<a name="l01760"></a>01760 
<a name="l01761"></a>01761           <span class="comment">// transfer the information from the aperture mask</span>
<a name="l01762"></a>01762           <span class="comment">// into the beam</span>
<a name="l01763"></a>01763           {
<a name="l01764"></a>01764             <span class="keywordtype">int</span> j = 0;
<a name="l01765"></a>01765             <span class="keywordtype">double</span> c;
<a name="l01766"></a>01766 
<a name="l01767"></a>01767             <span class="comment">// go over all PET entries</span>
<a name="l01768"></a>01768             <span class="keywordflow">while</span>  (PET[j].p_x != -1)
<a name="l01769"></a>01769               {
<a name="l01770"></a>01770                 <span class="comment">// subtract self contamination, then store the contamination</span>
<a name="l01771"></a>01771                 c = <a class="code" href="aXe__grism_8h.html#acf709ee71c580f1cd65d726ed03200ea">gsl_matrix_get</a>(aper_mask,PET[j].p_x,PET[j].p_y)-1.0;
<a name="l01772"></a>01772                 <span class="keywordflow">if</span> (c &lt; 0.0)
<a name="l01773"></a>01773                   c = 0.0;
<a name="l01774"></a>01774                 PET[j].<a class="code" href="structap__pixel.html#a2191ef670b1b5c515fda841dda181f62">contam</a> = c;
<a name="l01775"></a>01775                 j++;
<a name="l01776"></a>01776               }
<a name="l01777"></a>01777           }
<a name="l01778"></a>01778 
<a name="l01779"></a>01779           <span class="comment">// write the updated PET into the PET file</span>
<a name="l01780"></a>01780           {
<a name="l01781"></a>01781             <span class="keywordtype">char</span> ID[60];
<a name="l01782"></a>01782             sprintf (ID, <span class="stringliteral">&quot;%d%c&quot;</span>, oblist[objindex]-&gt;ID, <a class="code" href="aXe__grism_8h.html#a7d90dabb6016bb0e09b6ab84087b70a7">BEAM</a> (oblist[objindex]-&gt;beams[beamID].ID));
<a name="l01783"></a>01783             <a class="code" href="spce__PET_8c.html#a4082a46c2f846c9f3c65aa81e2c5679f">add_ALL_to_PET</a> (PET, ID, OPET_ptr,1);
<a name="l01784"></a>01784           }
<a name="l01785"></a>01785 
<a name="l01786"></a>01786           <span class="comment">// free PET memory</span>
<a name="l01787"></a>01787           <span class="keywordflow">if</span> (PET!=NULL)
<a name="l01788"></a>01788             {
<a name="l01789"></a>01789               free(PET);
<a name="l01790"></a>01790               PET=NULL;
<a name="l01791"></a>01791             }
<a name="l01792"></a>01792           fprintf (stdout, <span class="stringliteral">&quot;.Done\n&quot;</span>);
<a name="l01793"></a>01793         }
<a name="l01794"></a>01794     }
<a name="l01795"></a>01795 
<a name="l01796"></a>01796   <span class="comment">// free obl;ist memory</span>
<a name="l01797"></a>01797   <span class="keywordflow">if</span> (oblist!=NULL)
<a name="l01798"></a>01798     <a class="code" href="aXe__utils_8c.html#a1f63bfb071e9d0ea1f8854efdfae4692">free_oblist</a> (oblist);
<a name="l01799"></a>01799 
<a name="l01800"></a>01800   <span class="comment">// free observation memory</span>
<a name="l01801"></a>01801   <a class="code" href="aXe__utils_8c.html#aaf6850286e924fd44f65af2cf80894f0">free_observation</a>(obs);
<a name="l01802"></a>01802 
<a name="l01803"></a>01803   <span class="comment">// close the PET file</span>
<a name="l01804"></a>01804   fits_close_file (OPET_ptr, &amp;f_status);
<a name="l01805"></a>01805   <span class="keywordflow">if</span> (f_status)
<a name="l01806"></a>01806     {
<a name="l01807"></a>01807       ffrprt (stderr, f_status);
<a name="l01808"></a>01808       <a class="code" href="aXe__errors_8c.html#a7ef7588e5f91237ba7ce4084e6ed3c11">aXe_message</a> (<a class="code" href="aXe__errors_8h.html#a2556a67874555249b07691c37aa6d6e9">aXe_M_FATAL</a>, __FILE__, __LINE__,
<a name="l01809"></a>01809                    <span class="stringliteral">&quot;aXe_PETCONT: &quot;</span> <span class="stringliteral">&quot;Error closing PET: %s \n&quot;</span>,
<a name="l01810"></a>01810                    PET_file);
<a name="l01811"></a>01811     }
<a name="l01812"></a>01812 
<a name="l01813"></a>01813   <span class="comment">// set the status to &apos;success&apos; and return it</span>
<a name="l01814"></a>01814   status=1;
<a name="l01815"></a>01815   <span class="keywordflow">return</span> status;
<a name="l01816"></a>01816 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a144898574df3c20e24cac35dc2e4df8f"></a><!-- doxytag: member="spc_model.h::diffuse_spectrum" ref="a144898574df3c20e24cac35dc2e4df8f" args="(double ddx, double ddy, double cps, beamspec *actspec)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int diffuse_spectrum </td>
          <td>(</td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>ddx</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>ddy</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>cps</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structbeamspec.html">beamspec</a> *&nbsp;</td>
          <td class="paramname"> <em>actspec</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Function diffuse_spectrum Distribute the flux simulated for the area of one pixel square in the emission model over a pixel square in the <a class="el" href="structbeam.html">beam</a> model. This method uses sub-steps starting from the exact center of the light This smoothes the modelled <a class="el" href="structbeam.html">beam</a> by avoiding integer rounding effects.</p>
<p>Parameters: </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>ddx</em>&nbsp;</td><td>- the exact x-position in the <a class="el" href="structbeam.html">beam</a> </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>ddy</em>&nbsp;</td><td>- the exact y-position in the <a class="el" href="structbeam.html">beam</a> </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>cps</em>&nbsp;</td><td>- the cps-value for one entire pixel </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>actspec</em>&nbsp;</td><td>- the <a class="el" href="structbeam.html">beam</a> to model</td></tr>
  </table>
  </dd>
</dl>
<p>Returns: </p>
<dl class="return"><dt><b>Returns:</b></dt><dd>1.0 - return a dummy value </dd></dl>

<p><div class="fragment"><pre class="fragment"><a name="l01293"></a>01293 {
<a name="l01294"></a>01294   <span class="keywordtype">double</span> step;
<a name="l01295"></a>01295   <span class="keywordtype">double</span> offset;
<a name="l01296"></a>01296   <span class="keywordtype">double</span> ncps;
<a name="l01297"></a>01297   <span class="keywordtype">double</span> oldvalue;
<a name="l01298"></a>01298 
<a name="l01299"></a>01299   <span class="keywordtype">double</span> sum=0.0;
<a name="l01300"></a>01300 
<a name="l01301"></a>01301   <span class="keywordtype">double</span> dx_act;
<a name="l01302"></a>01302   <span class="keywordtype">double</span> dy_act;
<a name="l01303"></a>01303 
<a name="l01304"></a>01304   <span class="keywordtype">int</span> irange;
<a name="l01305"></a>01305   <span class="keywordtype">int</span> kk, ll;
<a name="l01306"></a>01306 
<a name="l01307"></a>01307   <span class="keywordtype">int</span> ix, iy;
<a name="l01308"></a>01308 
<a name="l01309"></a>01309   <span class="comment">// convert the number of steps to a local integer</span>
<a name="l01310"></a>01310   irange = (int)<a class="code" href="model__utils_8h.html#abd6e7e30c19663eeeaa34968fadfdfa1">NDIFF</a>;
<a name="l01311"></a>01311 
<a name="l01312"></a>01312   <span class="comment">// compute the step size</span>
<a name="l01313"></a>01313   step = 1.0/(2.0*(double)<a class="code" href="model__utils_8h.html#abd6e7e30c19663eeeaa34968fadfdfa1">NDIFF</a>);
<a name="l01314"></a>01314 
<a name="l01315"></a>01315   <span class="comment">// compute the initial offset</span>
<a name="l01316"></a>01316   offset = step/2.0;
<a name="l01317"></a>01317 
<a name="l01318"></a>01318   <span class="comment">// compute the incremental flux</span>
<a name="l01319"></a>01319   ncps = cps * step * step;
<a name="l01320"></a>01320 
<a name="l01321"></a>01321   <span class="keywordflow">for</span> (kk=-irange; kk &lt; irange; kk++)
<a name="l01322"></a>01322     {
<a name="l01323"></a>01323       <span class="keywordflow">for</span> (ll=-irange; ll &lt; irange; ll++)
<a name="l01324"></a>01324         {
<a name="l01325"></a>01325           <span class="comment">// determine the actual grid position</span>
<a name="l01326"></a>01326           dx_act = ddx + (double)kk * step + offset;
<a name="l01327"></a>01327           dy_act = ddy + (double)ll * step + offset;
<a name="l01328"></a>01328 
<a name="l01329"></a>01329           <span class="comment">// get the current pixel grid value</span>
<a name="l01330"></a>01330           ix = floor(dx_act + 0.5);
<a name="l01331"></a>01331           iy = floor(dy_act + 0.5);
<a name="l01332"></a>01332 
<a name="l01333"></a>01333           <span class="comment">// double check whether we are inside the image</span>
<a name="l01334"></a>01334           <span class="keywordflow">if</span> (ix &lt; 0 || iy &lt; 0 || ix &gt; (actspec-&gt;<a class="code" href="structbeamspec.html#a5585f5d3885305e980e09fed9a79a618">model</a>-&gt;size1-1) || iy &gt; (actspec-&gt;<a class="code" href="structbeamspec.html#a5585f5d3885305e980e09fed9a79a618">model</a>-&gt;size2-1))
<a name="l01335"></a>01335             <span class="keywordflow">continue</span>;
<a name="l01336"></a>01336 
<a name="l01337"></a>01337           <span class="comment">// add the contribution of the actual dx value to the model spectrum</span>
<a name="l01338"></a>01338           oldvalue = <a class="code" href="aXe__grism_8h.html#acf709ee71c580f1cd65d726ed03200ea">gsl_matrix_get</a>(actspec-&gt;<a class="code" href="structbeamspec.html#a5585f5d3885305e980e09fed9a79a618">model</a>, ix, iy);
<a name="l01339"></a>01339           <a class="code" href="aXe__grism_8h.html#a1f386ef5cd5a3b916246c2bee80f083a">gsl_matrix_set</a>(actspec-&gt;<a class="code" href="structbeamspec.html#a5585f5d3885305e980e09fed9a79a618">model</a>, ix, iy, oldvalue + ncps);
<a name="l01340"></a>01340           sum += ncps;
<a name="l01341"></a>01341         }
<a name="l01342"></a>01342     }
<a name="l01343"></a>01343 
<a name="l01344"></a>01344   <span class="comment">// return a dummy</span>
<a name="l01345"></a>01345   <span class="keywordflow">return</span> 1.0;
<a name="l01346"></a>01346 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a8fe760d3449f5cedb4bbf7ecc5abab08"></a><!-- doxytag: member="spc_model.h::diffuse_spectrumII" ref="a8fe760d3449f5cedb4bbf7ecc5abab08" args="(double ddx, double ddy, double cps, beamspec *actspec)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int diffuse_spectrumII </td>
          <td>(</td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>ddx</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>ddy</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>cps</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structbeamspec.html">beamspec</a> *&nbsp;</td>
          <td class="paramname"> <em>actspec</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Function diffuse_spectrumII Distribute the flux simulated for the area of one pixel square in the emission model over a pixel square in the <a class="el" href="structbeam.html">beam</a> model. Starting from the exact center of the light, the exact fraction falling on the four affected pixels is comuted and then added to the spectral <a class="el" href="structbeam.html">beam</a>. This smoothes the modelled <a class="el" href="structbeam.html">beam</a> by avoiding integer rounding effects.</p>
<p>Parameters: </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>ddx</em>&nbsp;</td><td>- the exact x-position in the <a class="el" href="structbeam.html">beam</a> </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>ddy</em>&nbsp;</td><td>- the exact y-position in the <a class="el" href="structbeam.html">beam</a> </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>cps</em>&nbsp;</td><td>- the cps-value for one entire pixel </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>actspec</em>&nbsp;</td><td>- the <a class="el" href="structbeam.html">beam</a> to model</td></tr>
  </table>
  </dd>
</dl>
<p>Returns: </p>
<dl class="return"><dt><b>Returns:</b></dt><dd>1.0 - return a dummy value </dd></dl>

<p><div class="fragment"><pre class="fragment"><a name="l01370"></a>01370 {
<a name="l01371"></a>01371   <span class="keywordtype">int</span> ix;
<a name="l01372"></a>01372   <span class="keywordtype">int</span> iy;
<a name="l01373"></a>01373   <span class="keywordtype">int</span> ix_rem;
<a name="l01374"></a>01374   <span class="keywordtype">int</span> iy_rem;
<a name="l01375"></a>01375 
<a name="l01376"></a>01376   <span class="keywordtype">double</span> p=0.0;
<a name="l01377"></a>01377   <span class="keywordtype">double</span> q=0.0;
<a name="l01378"></a>01378   <span class="keywordtype">double</span> p_rem=0.0;
<a name="l01379"></a>01379   <span class="keywordtype">double</span> q_rem=0.0;
<a name="l01380"></a>01380 
<a name="l01381"></a>01381   <span class="keywordtype">double</span> d_incr = 0.0;
<a name="l01382"></a>01382   <span class="keywordtype">double</span> oldvalue;
<a name="l01383"></a>01383 
<a name="l01384"></a>01384   <span class="keywordtype">double</span> sum = 0.0;
<a name="l01385"></a>01385 
<a name="l01386"></a>01386   <span class="comment">// compute the indices</span>
<a name="l01387"></a>01387   <span class="comment">// of the pixels involved</span>
<a name="l01388"></a>01388   ix     = (int)floor(ddx);
<a name="l01389"></a>01389   iy     = (int)floor(ddy);
<a name="l01390"></a>01390   ix_rem = ix + 1;
<a name="l01391"></a>01391   iy_rem = iy + 1;
<a name="l01392"></a>01392 
<a name="l01393"></a>01393 
<a name="l01394"></a>01394   <span class="comment">// compute the basic</span>
<a name="l01395"></a>01395   <span class="comment">// quantities for</span>
<a name="l01396"></a>01396   <span class="comment">// the increments;</span>
<a name="l01397"></a>01397   <span class="comment">// it seems to be the wrong way,</span>
<a name="l01398"></a>01398   <span class="comment">// however we are talking about</span>
<a name="l01399"></a>01399   <span class="comment">// pixels, not coordinates...</span>
<a name="l01400"></a>01400   p_rem = ddx - floor(ddx);
<a name="l01401"></a>01401   q_rem = ddy - floor(ddy);
<a name="l01402"></a>01402   p     = 1.0 - p_rem;
<a name="l01403"></a>01403   q     = 1.0 - q_rem;
<a name="l01404"></a>01404 
<a name="l01405"></a>01405 
<a name="l01406"></a>01406   <span class="comment">// increment the first quarter</span>
<a name="l01407"></a>01407   <span class="comment">// double check whether we are inside the image</span>
<a name="l01408"></a>01408   <span class="keywordflow">if</span> ( ! (ix &lt; 0 || iy &lt; 0 || ix &gt; (actspec-&gt;<a class="code" href="structbeamspec.html#a5585f5d3885305e980e09fed9a79a618">model</a>-&gt;size1-1) || iy &gt; (actspec-&gt;<a class="code" href="structbeamspec.html#a5585f5d3885305e980e09fed9a79a618">model</a>-&gt;size2-1)))
<a name="l01409"></a>01409     {
<a name="l01410"></a>01410       <span class="comment">// compute the area</span>
<a name="l01411"></a>01411       d_incr = p * q;
<a name="l01412"></a>01412 
<a name="l01413"></a>01413       <span class="comment">// add the fractional contribution to the model spectrum</span>
<a name="l01414"></a>01414       oldvalue = <a class="code" href="aXe__grism_8h.html#acf709ee71c580f1cd65d726ed03200ea">gsl_matrix_get</a>(actspec-&gt;<a class="code" href="structbeamspec.html#a5585f5d3885305e980e09fed9a79a618">model</a>, ix, iy);
<a name="l01415"></a>01415       <a class="code" href="aXe__grism_8h.html#a1f386ef5cd5a3b916246c2bee80f083a">gsl_matrix_set</a>(actspec-&gt;<a class="code" href="structbeamspec.html#a5585f5d3885305e980e09fed9a79a618">model</a>, ix, iy, oldvalue + d_incr*cps);
<a name="l01416"></a>01416       sum += d_incr;
<a name="l01417"></a>01417     }
<a name="l01418"></a>01418 
<a name="l01419"></a>01419   <span class="comment">// increment the second quarter</span>
<a name="l01420"></a>01420   <span class="comment">// double check whether we are inside the image</span>
<a name="l01421"></a>01421   <span class="keywordflow">if</span> ( ! (ix &lt; 0 || iy_rem &lt; 0 || ix &gt; (actspec-&gt;<a class="code" href="structbeamspec.html#a5585f5d3885305e980e09fed9a79a618">model</a>-&gt;size1-1) || iy_rem &gt; (actspec-&gt;<a class="code" href="structbeamspec.html#a5585f5d3885305e980e09fed9a79a618">model</a>-&gt;size2-1)))
<a name="l01422"></a>01422     {
<a name="l01423"></a>01423       <span class="comment">// compute the area</span>
<a name="l01424"></a>01424       d_incr = p * q_rem;
<a name="l01425"></a>01425 
<a name="l01426"></a>01426       <span class="comment">// add the fractional contribution to the model spectrum</span>
<a name="l01427"></a>01427       oldvalue = <a class="code" href="aXe__grism_8h.html#acf709ee71c580f1cd65d726ed03200ea">gsl_matrix_get</a>(actspec-&gt;<a class="code" href="structbeamspec.html#a5585f5d3885305e980e09fed9a79a618">model</a>, ix, iy_rem);
<a name="l01428"></a>01428       <a class="code" href="aXe__grism_8h.html#a1f386ef5cd5a3b916246c2bee80f083a">gsl_matrix_set</a>(actspec-&gt;<a class="code" href="structbeamspec.html#a5585f5d3885305e980e09fed9a79a618">model</a>, ix, iy_rem, oldvalue + d_incr*cps);
<a name="l01429"></a>01429       sum += d_incr;
<a name="l01430"></a>01430     }
<a name="l01431"></a>01431 
<a name="l01432"></a>01432   <span class="comment">// increment the third quarter</span>
<a name="l01433"></a>01433   <span class="comment">// double check whether we are inside the image</span>
<a name="l01434"></a>01434   <span class="keywordflow">if</span> ( ! (ix_rem &lt; 0 || iy &lt; 0 || ix_rem &gt; (actspec-&gt;<a class="code" href="structbeamspec.html#a5585f5d3885305e980e09fed9a79a618">model</a>-&gt;size1-1) || iy &gt; (actspec-&gt;<a class="code" href="structbeamspec.html#a5585f5d3885305e980e09fed9a79a618">model</a>-&gt;size2-1)))
<a name="l01435"></a>01435     {
<a name="l01436"></a>01436       <span class="comment">// compute the area</span>
<a name="l01437"></a>01437       d_incr = p_rem * q;
<a name="l01438"></a>01438 
<a name="l01439"></a>01439       <span class="comment">// add the fractional contribution to the model spectrum</span>
<a name="l01440"></a>01440       oldvalue = <a class="code" href="aXe__grism_8h.html#acf709ee71c580f1cd65d726ed03200ea">gsl_matrix_get</a>(actspec-&gt;<a class="code" href="structbeamspec.html#a5585f5d3885305e980e09fed9a79a618">model</a>, ix_rem, iy);
<a name="l01441"></a>01441       <a class="code" href="aXe__grism_8h.html#a1f386ef5cd5a3b916246c2bee80f083a">gsl_matrix_set</a>(actspec-&gt;<a class="code" href="structbeamspec.html#a5585f5d3885305e980e09fed9a79a618">model</a>, ix_rem, iy, oldvalue + d_incr*cps);
<a name="l01442"></a>01442       sum += d_incr;
<a name="l01443"></a>01443     }
<a name="l01444"></a>01444 
<a name="l01445"></a>01445   <span class="comment">// increment the fourth quarter</span>
<a name="l01446"></a>01446   <span class="comment">// double check whether we are inside the image</span>
<a name="l01447"></a>01447   <span class="keywordflow">if</span> ( ! (ix_rem &lt; 0 || iy_rem &lt; 0 || ix_rem &gt; (actspec-&gt;<a class="code" href="structbeamspec.html#a5585f5d3885305e980e09fed9a79a618">model</a>-&gt;size1-1) || iy_rem &gt; (actspec-&gt;<a class="code" href="structbeamspec.html#a5585f5d3885305e980e09fed9a79a618">model</a>-&gt;size2-1)))
<a name="l01448"></a>01448     {
<a name="l01449"></a>01449       <span class="comment">// compute the area</span>
<a name="l01450"></a>01450       d_incr = p_rem * q_rem;
<a name="l01451"></a>01451 
<a name="l01452"></a>01452       <span class="comment">// add the fractional contribution to the model spectrum</span>
<a name="l01453"></a>01453       oldvalue = <a class="code" href="aXe__grism_8h.html#acf709ee71c580f1cd65d726ed03200ea">gsl_matrix_get</a>(actspec-&gt;<a class="code" href="structbeamspec.html#a5585f5d3885305e980e09fed9a79a618">model</a>, ix_rem, iy_rem);
<a name="l01454"></a>01454       <a class="code" href="aXe__grism_8h.html#a1f386ef5cd5a3b916246c2bee80f083a">gsl_matrix_set</a>(actspec-&gt;<a class="code" href="structbeamspec.html#a5585f5d3885305e980e09fed9a79a618">model</a>, ix_rem, iy_rem, oldvalue + d_incr*cps);
<a name="l01455"></a>01455       sum += d_incr;
<a name="l01456"></a>01456     }
<a name="l01457"></a>01457 
<a name="l01458"></a>01458 
<a name="l01459"></a>01459   <span class="comment">// return a dummy</span>
<a name="l01460"></a>01460   <span class="keywordflow">return</span> 1.0;
<a name="l01461"></a>01461 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a8a1e63b6f29be161a726a1c08a26ebb9"></a><!-- doxytag: member="spc_model.h::dimension_beamspec" ref="a8a1e63b6f29be161a726a1c08a26ebb9" args="(dirobject *actdir, object *actobject, const px_point npixels, const aperture_conf *conf, int j)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structbeamspec.html">beamspec</a>* dimension_beamspec </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structdirobject.html">dirobject</a> *&nbsp;</td>
          <td class="paramname"> <em>actdir</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structobject.html">object</a> *&nbsp;</td>
          <td class="paramname"> <em>actobject</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structpx__point.html">px_point</a>&nbsp;</td>
          <td class="paramname"> <em>npixels</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structaperture__conf.html">aperture_conf</a> *&nbsp;</td>
          <td class="paramname"> <em>conf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>j</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Function: dimension_beamspec The function checks the boundaries of a candidate model <a class="el" href="structspectrum.html">spectrum</a> of a <a class="el" href="structbeam.html">beam</a>. In case that the model <a class="el" href="structspectrum.html">spectrum</a> is completely outside the frame, a NULL model <a class="el" href="structspectrum.html">spectrum</a> is returned. Otherwise space is allocated for the model <a class="el" href="structspectrum.html">spectrum</a> and the matrix therein, and the data are filled in. Only the matrix is not defined and filled.</p>
<p>Parameters: </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>dirlist</em>&nbsp;</td><td>- the list with all dirobjects </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>actobject</em>&nbsp;</td><td>- one <a class="el" href="structbeam.html">beam</a> of this <a class="el" href="structobject.html">object</a> is examined </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>npixels</em>&nbsp;</td><td>- the size of the CCD </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>conf</em>&nbsp;</td><td>- the configutration structure </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>j</em>&nbsp;</td><td>- the <a class="el" href="structbeam.html">beam</a> number to be examined</td></tr>
  </table>
  </dd>
</dl>
<p>Returns: </p>
<dl class="return"><dt><b>Returns:</b></dt><dd>actspec - the <a class="el" href="structbeamspec.html">beamspec</a> <a class="el" href="structobject.html">object</a> created </dd></dl>

<p><div class="fragment"><pre class="fragment"><a name="l00981"></a>00981 {
<a name="l00982"></a>00982   <a class="code" href="structbeamspec.html">beamspec</a>   *actspec;
<a name="l00983"></a>00983   <a class="code" href="structtrace__func.html">trace_func</a> *tracefun;
<a name="l00984"></a>00984   <a class="code" href="aXe__grism_8h.html#a6117e17bb3108107676f4486e62d40e5">gsl_matrix</a> *stamp;
<a name="l00985"></a>00985   <span class="keywordtype">double</span>     dx0, dy0, dx1, dy1;
<a name="l00986"></a>00986   <span class="keywordtype">double</span>     xmin, xmax, ymin, ymax;
<a name="l00987"></a>00987 
<a name="l00988"></a>00988 
<a name="l00989"></a>00989   <span class="comment">// allocate space for the beamspoec</span>
<a name="l00990"></a>00990   actspec = (<a class="code" href="structbeamspec.html">beamspec</a> *)malloc(<span class="keyword">sizeof</span>(<a class="code" href="structbeamspec.html">beamspec</a>));
<a name="l00991"></a>00991   <span class="keywordflow">if</span> (actspec == NULL)
<a name="l00992"></a>00992     <a class="code" href="aXe__errors_8c.html#a7ef7588e5f91237ba7ce4084e6ed3c11">aXe_message</a> (<a class="code" href="aXe__errors_8h.html#a2556a67874555249b07691c37aa6d6e9">aXe_M_FATAL</a>, __FILE__, __LINE__,
<a name="l00993"></a>00993                  <span class="stringliteral">&quot;make_model_spectra:&quot;</span> <span class="stringliteral">&quot; Could not allocate&quot;</span>
<a name="l00994"></a>00994                  <span class="stringliteral">&quot; memory for a beamspec object&quot;</span>);
<a name="l00995"></a>00995 
<a name="l00996"></a>00996   <span class="comment">// determine the range of x-values covered by that beam</span>
<a name="l00997"></a>00997   <span class="comment">// (relative to a refpoint)</span>
<a name="l00998"></a>00998   tracefun =  actobject-&gt;<a class="code" href="structobject.html#ad643757142781f8265b430e19700cfe5">beams</a>[j].<a class="code" href="structbeam.html#a918b8655ff4142f173ca73226ce27922">spec_trace</a>;
<a name="l00999"></a>00999   dx0 = (double)conf-&gt;<a class="code" href="structaperture__conf.html#aa1f52d8496707cab4631dc2369d3dec2">beam</a>[actobject-&gt;<a class="code" href="structobject.html#ad643757142781f8265b430e19700cfe5">beams</a>[j].<a class="code" href="structbeam.html#a5c3f06b67e4cc3c79be539d1b515f3c6">ID</a>].<a class="code" href="structbeam__conf.html#a55f5257b40a3f5f6b43980c779734e84">offset</a>.<a class="code" href="structpx__offset.html#a5d141ef035baf4fefab88956ea1a7060">dx0</a>;
<a name="l01000"></a>01000   dx1 = (<span class="keywordtype">double</span>)conf-&gt;<a class="code" href="structaperture__conf.html#aa1f52d8496707cab4631dc2369d3dec2">beam</a>[actobject-&gt;<a class="code" href="structobject.html#ad643757142781f8265b430e19700cfe5">beams</a>[j].<a class="code" href="structbeam.html#a5c3f06b67e4cc3c79be539d1b515f3c6">ID</a>].<a class="code" href="structbeam__conf.html#a55f5257b40a3f5f6b43980c779734e84">offset</a>.<a class="code" href="structpx__offset.html#a81678dca036abb27f0c829b3aabca784">dx1</a>;
<a name="l01001"></a>01001 
<a name="l01002"></a>01002   <span class="comment">// determine the range of y-values covered by that beam</span>
<a name="l01003"></a>01003   <span class="comment">// (relative to a refpoint)</span>
<a name="l01004"></a>01004   dy0 = tracefun-&gt;<a class="code" href="structtrace__func.html#a7c1a538b7ae1293d6e0fc1bdd4c2739c">func</a> (dx0, tracefun-&gt;<a class="code" href="structtrace__func.html#aa610d641940ef4a567aef884dd0b32da">data</a>);
<a name="l01005"></a>01005   dy1 = tracefun-&gt;<a class="code" href="structtrace__func.html#a7c1a538b7ae1293d6e0fc1bdd4c2739c">func</a> (dx1, tracefun-&gt;<a class="code" href="structtrace__func.html#aa610d641940ef4a567aef884dd0b32da">data</a>);
<a name="l01006"></a>01006 
<a name="l01007"></a>01007   <span class="comment">// apply the positional corrections;</span>
<a name="l01008"></a>01008   <span class="comment">// in case of the fluxcube model</span>
<a name="l01009"></a>01009   <span class="comment">// they are needed to transform</span>
<a name="l01010"></a>01010   <span class="comment">// the coordinates from the direct</span>
<a name="l01011"></a>01011   <span class="comment">// image to the grism image system</span>
<a name="l01012"></a>01012   dx0 = dx0 + actdir-&gt;<a class="code" href="structdirobject.html#a804b505c34bbecd0eb09832e34cbd5ce">xy_off</a>[j].<a class="code" href="structd__point.html#a922a3b5d82a119168ba85e5f939d02c3">x</a>;
<a name="l01013"></a>01013   dx1 = dx1 + actdir-&gt;<a class="code" href="structdirobject.html#a804b505c34bbecd0eb09832e34cbd5ce">xy_off</a>[j].<a class="code" href="structd__point.html#a922a3b5d82a119168ba85e5f939d02c3">x</a>;
<a name="l01014"></a>01014   dy0 = dy0 + actdir-&gt;<a class="code" href="structdirobject.html#a804b505c34bbecd0eb09832e34cbd5ce">xy_off</a>[j].<a class="code" href="structd__point.html#ad9846a025508bf8873a501ca5fcefbf4">y</a>;
<a name="l01015"></a>01015   dy1 = dy1 + actdir-&gt;<a class="code" href="structdirobject.html#a804b505c34bbecd0eb09832e34cbd5ce">xy_off</a>[j].<a class="code" href="structd__point.html#ad9846a025508bf8873a501ca5fcefbf4">y</a>;
<a name="l01016"></a>01016 
<a name="l01017"></a>01017   <span class="comment">// using the corners of the direct image object as refpoints,</span>
<a name="l01018"></a>01018   <span class="comment">// translate the x- and y-ranges to the real area subtended</span>
<a name="l01019"></a>01019   <span class="comment">// bye that model beam on the CCD</span>
<a name="l01020"></a>01020   xmin = floor(<a class="code" href="aXe__utils_8c.html#a74e75242132eaabbc1c512488a135926">MIN</a>((<span class="keywordtype">double</span>)actdir-&gt;<a class="code" href="structdirobject.html#ac068f35c585eec4cd1e5d3392c2dd698">ix_min</a> + dx0, (<span class="keywordtype">double</span>)actdir-&gt;<a class="code" href="structdirobject.html#ac068f35c585eec4cd1e5d3392c2dd698">ix_min</a> + dx1)+0.5);
<a name="l01021"></a>01021   xmax = floor(<a class="code" href="aper__conf_8c.html#aacc3ee1a7f283f8ef65cea31f4436a95">MAX</a>((<span class="keywordtype">double</span>)actdir-&gt;<a class="code" href="structdirobject.html#ac8c6104f2c2e1384c64bba61ecf40d69">ix_max</a> + dx0, (<span class="keywordtype">double</span>)actdir-&gt;<a class="code" href="structdirobject.html#ac8c6104f2c2e1384c64bba61ecf40d69">ix_max</a> + dx1)+0.5);
<a name="l01022"></a>01022   ymin = floor(<a class="code" href="aXe__utils_8c.html#a74e75242132eaabbc1c512488a135926">MIN</a>((<span class="keywordtype">double</span>)actdir-&gt;<a class="code" href="structdirobject.html#af24c9a92fa18516591e43d96eec13272">iy_min</a> + dy0, (<span class="keywordtype">double</span>)actdir-&gt;<a class="code" href="structdirobject.html#af24c9a92fa18516591e43d96eec13272">iy_min</a> + dy1)+0.5);
<a name="l01023"></a>01023   ymax = floor(<a class="code" href="aper__conf_8c.html#aacc3ee1a7f283f8ef65cea31f4436a95">MAX</a>((<span class="keywordtype">double</span>)actdir-&gt;<a class="code" href="structdirobject.html#a3b36973dd52d158c059bfe6587a04244">iy_max</a> + dy0, (<span class="keywordtype">double</span>)actdir-&gt;<a class="code" href="structdirobject.html#a3b36973dd52d158c059bfe6587a04244">iy_max</a> + dy1)+0.5);
<a name="l01024"></a>01024 
<a name="l01025"></a>01025   <span class="comment">// check whether the area is completely outside the CCD</span>
<a name="l01026"></a>01026   <span class="keywordflow">if</span> ((xmax &lt; 0.0) || (ymax &lt; 0.0))
<a name="l01027"></a>01027     {
<a name="l01028"></a>01028       <span class="comment">//      fprintf(stdout, &quot;Beam&apos;s too low: %i %i\n&quot;,actobject-&gt;ID, actobject-&gt;beams[j].ID);</span>
<a name="l01029"></a>01029       <span class="comment">// if yes, release the memory and return NULL</span>
<a name="l01030"></a>01030       free(actspec);
<a name="l01031"></a>01031       actspec = NULL;
<a name="l01032"></a>01032       <span class="keywordflow">return</span> actspec;
<a name="l01033"></a>01033     }
<a name="l01034"></a>01034 
<a name="l01035"></a>01035   <span class="comment">// check whether the area is completely outside the CCD</span>
<a name="l01036"></a>01036   <span class="keywordflow">if</span> ((xmin &gt; (<span class="keywordtype">double</span>)(npixels.<a class="code" href="structpx__point.html#ab715a558731a820a25b50bd7797dd004">x</a>-1)) || (ymin &gt; (<span class="keywordtype">double</span>)(npixels.<a class="code" href="structpx__point.html#a2d02b900722a71f22a8d5100822bda61">y</a>-1)))
<a name="l01037"></a>01037     {
<a name="l01038"></a>01038       <span class="comment">//      fprintf(stdout, &quot;Beam&apos;s too high: %i %i\n&quot;,actobject-&gt;ID, actobject-&gt;beams[j].ID);</span>
<a name="l01039"></a>01039       <span class="comment">// if yes, release the memory and return NULL</span>
<a name="l01040"></a>01040       free(actspec);
<a name="l01041"></a>01041       actspec = NULL;
<a name="l01042"></a>01042       <span class="keywordflow">return</span> actspec;
<a name="l01043"></a>01043     }
<a name="l01044"></a>01044 
<a name="l01045"></a>01045   <span class="comment">// check whether part of the are is outside;</span>
<a name="l01046"></a>01046   <span class="comment">// correct if necessary</span>
<a name="l01047"></a>01047   xmin = <a class="code" href="aper__conf_8c.html#aacc3ee1a7f283f8ef65cea31f4436a95">MAX</a>(xmin-1, 0.0);
<a name="l01048"></a>01048   ymin = <a class="code" href="aper__conf_8c.html#aacc3ee1a7f283f8ef65cea31f4436a95">MAX</a>(ymin-1, 0.0);
<a name="l01049"></a>01049 
<a name="l01050"></a>01050   <span class="comment">// check whether part of the are is outside;</span>
<a name="l01051"></a>01051   <span class="comment">// correct if necessary</span>
<a name="l01052"></a>01052   xmax = <a class="code" href="aXe__utils_8c.html#a74e75242132eaabbc1c512488a135926">MIN</a>(xmax+1, (<span class="keywordtype">double</span>)(npixels.<a class="code" href="structpx__point.html#ab715a558731a820a25b50bd7797dd004">x</a>-1.0));
<a name="l01053"></a>01053   ymax = <a class="code" href="aXe__utils_8c.html#a74e75242132eaabbc1c512488a135926">MIN</a>(ymax+1, (<span class="keywordtype">double</span>)(npixels.<a class="code" href="structpx__point.html#a2d02b900722a71f22a8d5100822bda61">y</a>-1.0));
<a name="l01054"></a>01054 
<a name="l01055"></a>01055   <span class="comment">// transfer the ID&apos;s to the model beam</span>
<a name="l01056"></a>01056   actspec-&gt;<a class="code" href="structbeamspec.html#ac47c161554a61fa65c4f5a744f761252">objectID</a> = actobject-&gt;<a class="code" href="structobject.html#a8575880bdfc1c0bf44914b4efd2665bf">ID</a>;
<a name="l01057"></a>01057   actspec-&gt;<a class="code" href="structbeamspec.html#a8185e83f23ffbab21ec47ec3d2bea13c">beamID</a>   = actobject-&gt;<a class="code" href="structobject.html#ad643757142781f8265b430e19700cfe5">beams</a>[j].<a class="code" href="structbeam.html#a5c3f06b67e4cc3c79be539d1b515f3c6">ID</a>;
<a name="l01058"></a>01058 
<a name="l01059"></a>01059   <span class="comment">// transfer the coo&apos;s of the starting point;</span>
<a name="l01060"></a>01060   <span class="comment">// leave one pixel for the &apos;drizzling&apos;</span>
<a name="l01061"></a>01061   actspec-&gt;<a class="code" href="structbeamspec.html#a4526cf634c09ad9fbd3f566dba8ea0fd">model_ref</a>.<a class="code" href="structd__point.html#a922a3b5d82a119168ba85e5f939d02c3">x</a> = (int)xmin;
<a name="l01062"></a>01062   actspec-&gt;<a class="code" href="structbeamspec.html#a4526cf634c09ad9fbd3f566dba8ea0fd">model_ref</a>.<a class="code" href="structd__point.html#ad9846a025508bf8873a501ca5fcefbf4">y</a> = (int)ymin;
<a name="l01063"></a>01063 
<a name="l01064"></a>01064   <span class="comment">// allocate space for the matrix;</span>
<a name="l01065"></a>01065   <span class="comment">// give two pixels more on each side for &apos;drizzling&apos;;</span>
<a name="l01066"></a>01066   <span class="comment">// set the matrix to 0.0 and give it to the model beam</span>
<a name="l01067"></a>01067   stamp = <a class="code" href="aXe__grism_8h.html#a1214ab1bea5fd80474d7a27db0bfb429">gsl_matrix_alloc</a>((<span class="keywordtype">int</span>)(xmax-xmin)+1, (<span class="keywordtype">int</span>)(ymax-ymin)+1);
<a name="l01068"></a>01068   <span class="keywordflow">if</span> (stamp == NULL)
<a name="l01069"></a>01069     <a class="code" href="aXe__errors_8c.html#a7ef7588e5f91237ba7ce4084e6ed3c11">aXe_message</a> (<a class="code" href="aXe__errors_8h.html#a2556a67874555249b07691c37aa6d6e9">aXe_M_FATAL</a>, __FILE__, __LINE__,
<a name="l01070"></a>01070                  <span class="stringliteral">&quot;dimension_beamspec:&quot;</span> <span class="stringliteral">&quot; Could not allocate&quot;</span>
<a name="l01071"></a>01071                  <span class="stringliteral">&quot; memory for %i x %i GSL matrix&quot;</span>, (<span class="keywordtype">int</span>)(xmax-xmin)+1, (<span class="keywordtype">int</span>)(ymax-ymin)+1);
<a name="l01072"></a>01072   <a class="code" href="aXe__grism_8h.html#af6161aeb008a1ffa7d888df6ccbef7cc">gsl_matrix_set_all</a>(stamp, 0.0);
<a name="l01073"></a>01073   actspec-&gt;<a class="code" href="structbeamspec.html#a5585f5d3885305e980e09fed9a79a618">model</a> = stamp;
<a name="l01074"></a>01074 
<a name="l01075"></a>01075   <span class="comment">// return the beam created</span>
<a name="l01076"></a>01076   <span class="keywordflow">return</span> actspec;
<a name="l01077"></a>01077 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a3d953255a2ae0faf92105f0909a05053"></a><!-- doxytag: member="spc_model.h::fill_contam_info" ref="a3d953255a2ae0faf92105f0909a05053" args="(const char PET_file[], beamspec **speclist, const gsl_matrix *all_models, char model_name[])" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int fill_contam_info </td>
          <td>(</td>
          <td class="paramtype">const char&nbsp;</td>
          <td class="paramname"> <em>PET_file</em>[], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structbeamspec.html">beamspec</a> **&nbsp;</td>
          <td class="paramname"> <em>speclist</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const gsl_matrix *&nbsp;</td>
          <td class="paramname"> <em>all_models</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char&nbsp;</td>
          <td class="paramname"> <em>model_name</em>[]</td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Function: fill_contam_info The function fills the contamination information into the PET. To do that it transfers the information from the aperture mask matrix into each PET. Self contamination is taken into account by subtracting the value from the modelled <a class="el" href="structspectrum.html">spectrum</a> before storing the contamination.</p>
<p>Parameters: </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>PET_file</em>&nbsp;</td><td>- the PET file to add contamination </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>speclist</em>&nbsp;</td><td>- the list of modelled spectra </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>all_models</em>&nbsp;</td><td>- the contamination image</td></tr>
  </table>
  </dd>
</dl>
<p>Returns: </p>
<dl class="return"><dt><b>Returns:</b></dt><dd>1 - returns always 1 </dd></dl>

<p><div class="fragment"><pre class="fragment"><a name="l01556"></a>01556 {
<a name="l01557"></a>01557   fitsfile *OPET_ptr;
<a name="l01558"></a>01558   <a class="code" href="structap__pixel.html">ap_pixel</a> *PET;
<a name="l01559"></a>01559   <a class="code" href="structbeamspec.html">beamspec</a> *actspec;
<a name="l01560"></a>01560   <span class="comment">//FITScards *cards;</span>
<a name="l01561"></a>01561 
<a name="l01562"></a>01562   <span class="keywordtype">char</span> ID[60];
<a name="l01563"></a>01563 
<a name="l01564"></a>01564   <span class="keywordtype">double</span> c;
<a name="l01565"></a>01565   <span class="keywordtype">double</span> m;
<a name="l01566"></a>01566 
<a name="l01567"></a>01567   <span class="keywordtype">int</span> aperID, beamID;
<a name="l01568"></a>01568   <span class="keywordtype">int</span> f_status=0;
<a name="l01569"></a>01569   <span class="keywordtype">int</span> status;
<a name="l01570"></a>01570   <span class="keywordtype">int</span> ix, iy;
<a name="l01571"></a>01571   <span class="keywordtype">int</span> j;
<a name="l01572"></a>01572 
<a name="l01573"></a>01573   <span class="comment">// Open the OPET file for reading/writing</span>
<a name="l01574"></a>01574   ffopen (&amp;OPET_ptr, PET_file, READWRITE, &amp;f_status);
<a name="l01575"></a>01575   <span class="keywordflow">if</span> (f_status){
<a name="l01576"></a>01576     ffrprt(stdout, f_status);
<a name="l01577"></a>01577     <a class="code" href="aXe__errors_8c.html#a7ef7588e5f91237ba7ce4084e6ed3c11">aXe_message</a> (<a class="code" href="aXe__errors_8h.html#a2556a67874555249b07691c37aa6d6e9">aXe_M_FATAL</a>, __FILE__, __LINE__,
<a name="l01578"></a>01578                  <span class="stringliteral">&quot;aXe_PETCONT: Could not open file: %s\n&quot;</span>,
<a name="l01579"></a>01579                  PET_file);
<a name="l01580"></a>01580   }
<a name="l01581"></a>01581 
<a name="l01582"></a>01582   <span class="comment">// store the contamination model name in the PET</span>
<a name="l01583"></a>01583   <a class="code" href="spc__FITScards_8c.html#a6cb1187c647e381a5d1803846ee73a3e">update_contam_model</a>(OPET_ptr, model_name);
<a name="l01584"></a>01584 
<a name="l01585"></a>01585   <span class="comment">// report the action</span>
<a name="l01586"></a>01586   fprintf (stdout, <span class="stringliteral">&quot;\naXe_PETCONT: Writing the contamination into the PET.\n&quot;</span>);
<a name="l01587"></a>01587 
<a name="l01588"></a>01588   <span class="keywordflow">while</span> (1)
<a name="l01589"></a>01589     {
<a name="l01590"></a>01590 
<a name="l01591"></a>01591       <span class="comment">// get the PET at the actual position of the PET file</span>
<a name="l01592"></a>01592       PET = <a class="code" href="spce__PET_8c.html#a6d9546246608829c70349f2d8ca69543">get_ALL_from_next_in_PET</a>(OPET_ptr, &amp;aperID, &amp;beamID);
<a name="l01593"></a>01593 
<a name="l01594"></a>01594       <span class="comment">// leave the while loop if there is the end</span>
<a name="l01595"></a>01595       <span class="keywordflow">if</span> ((aperID==-1) &amp;&amp; (beamID==-1))
<a name="l01596"></a>01596         <span class="keywordflow">break</span>;
<a name="l01597"></a>01597 
<a name="l01598"></a>01598       <span class="comment">// report progress</span>
<a name="l01599"></a>01599       fprintf(stdout, <span class="stringliteral">&quot;aXe_PETCONT: writing contamination for object %i beam %c ... &quot;</span>, aperID, <a class="code" href="aXe__grism_8h.html#a7d90dabb6016bb0e09b6ab84087b70a7">BEAM</a>(beamID));
<a name="l01600"></a>01600 
<a name="l01601"></a>01601       <span class="comment">// skip the PET if empty</span>
<a name="l01602"></a>01602       <span class="keywordflow">if</span> (PET==NULL)
<a name="l01603"></a>01603         {
<a name="l01604"></a>01604           fprintf (stdout, <span class="stringliteral">&quot;.Done\n&quot;</span>);
<a name="l01605"></a>01605           <span class="keywordflow">continue</span>;
<a name="l01606"></a>01606         }
<a name="l01607"></a>01607 
<a name="l01608"></a>01608       <span class="comment">// get the model spectrum for the actual PET</span>
<a name="l01609"></a>01609       actspec = <a class="code" href="model__utils_8c.html#ab0112661e420045b9ed86e6e8cb71794">get_beamspec_from_list</a>(speclist, aperID, beamID);
<a name="l01610"></a>01610 
<a name="l01611"></a>01611       <span class="comment">// go over all PET entries</span>
<a name="l01612"></a>01612       j=0;
<a name="l01613"></a>01613       <span class="keywordflow">while</span>  (PET[j].p_x != -1)
<a name="l01614"></a>01614         {
<a name="l01615"></a>01615 
<a name="l01616"></a>01616           <span class="comment">// get the value from the contamination matrix</span>
<a name="l01617"></a>01617           c = <a class="code" href="aXe__grism_8h.html#acf709ee71c580f1cd65d726ed03200ea">gsl_matrix_get</a>(all_models,PET[j].p_x,PET[j].p_y);
<a name="l01618"></a>01618           m = 0.0;
<a name="l01619"></a>01619 
<a name="l01620"></a>01620           <span class="comment">// correct for self-contamination if the beams was modelled</span>
<a name="l01621"></a>01621           <span class="keywordflow">if</span> (actspec != NULL){
<a name="l01622"></a>01622 
<a name="l01623"></a>01623             <span class="comment">// get the coordinates in the model array</span>
<a name="l01624"></a>01624             ix = PET[j].<a class="code" href="structap__pixel.html#abca28f0936fbd5a569ad548fb25e5a38">p_x</a> - actspec-&gt;<a class="code" href="structbeamspec.html#a4526cf634c09ad9fbd3f566dba8ea0fd">model_ref</a>.<a class="code" href="structd__point.html#a922a3b5d82a119168ba85e5f939d02c3">x</a>;
<a name="l01625"></a>01625             iy = PET[j].<a class="code" href="structap__pixel.html#aadf7ee52df3875792fbf13d4d52ed298">p_y</a> - actspec-&gt;<a class="code" href="structbeamspec.html#a4526cf634c09ad9fbd3f566dba8ea0fd">model_ref</a>.<a class="code" href="structd__point.html#ad9846a025508bf8873a501ca5fcefbf4">y</a>;
<a name="l01626"></a>01626 
<a name="l01627"></a>01627             <span class="comment">// check whether the PET entry is outside of the model array.</span>
<a name="l01628"></a>01628             <span class="comment">// correct for self contamination if the PET-etry is inside</span>
<a name="l01629"></a>01629 
<a name="l01630"></a>01630             <span class="keywordflow">if</span> (ix &gt; -1 &amp;&amp; iy &gt;-1 &amp;&amp; ix &lt; actspec-&gt;model-&gt;size1 &amp;&amp; iy &lt; actspec-&gt;model-&gt;size2)
<a name="l01631"></a>01631               {
<a name="l01632"></a>01632                 m = <a class="code" href="aXe__grism_8h.html#acf709ee71c580f1cd65d726ed03200ea">gsl_matrix_get</a>(actspec-&gt;<a class="code" href="structbeamspec.html#a5585f5d3885305e980e09fed9a79a618">model</a>, ix, iy);
<a name="l01633"></a>01633                 c = c - m;
<a name="l01634"></a>01634               }
<a name="l01635"></a>01635           }
<a name="l01636"></a>01636 
<a name="l01637"></a>01637           <span class="comment">// well, it should never be below zero</span>
<a name="l01638"></a>01638           <span class="keywordflow">if</span> (c &lt; 0.0)
<a name="l01639"></a>01639             c = 0.0;
<a name="l01640"></a>01640 
<a name="l01641"></a>01641           <span class="comment">// write the contamination into the PET-entry</span>
<a name="l01642"></a>01642           PET[j].<a class="code" href="structap__pixel.html#a2191ef670b1b5c515fda841dda181f62">contam</a> = c;
<a name="l01643"></a>01643           PET[j].<a class="code" href="structap__pixel.html#ada106f5981b17786de87cfeb2a7db0d1">model</a> = m;
<a name="l01644"></a>01644 
<a name="l01645"></a>01645           <span class="comment">// enhance the counter</span>
<a name="l01646"></a>01646           j++;
<a name="l01647"></a>01647         }
<a name="l01648"></a>01648 
<a name="l01649"></a>01649       <span class="comment">// write the updated PET into the PET file</span>
<a name="l01650"></a>01650       sprintf (ID, <span class="stringliteral">&quot;%d%c&quot;</span>, aperID, <a class="code" href="aXe__grism_8h.html#a7d90dabb6016bb0e09b6ab84087b70a7">BEAM</a> (beamID));
<a name="l01651"></a>01651       <a class="code" href="spce__PET_8c.html#a4082a46c2f846c9f3c65aa81e2c5679f">add_ALL_to_PET</a> (PET, ID, OPET_ptr,1);
<a name="l01652"></a>01652 
<a name="l01653"></a>01653       <span class="comment">// free PET memory</span>
<a name="l01654"></a>01654       <span class="keywordflow">if</span> (PET!=NULL)
<a name="l01655"></a>01655         {
<a name="l01656"></a>01656           free(PET);
<a name="l01657"></a>01657           PET=NULL;
<a name="l01658"></a>01658         }
<a name="l01659"></a>01659       fprintf (stdout, <span class="stringliteral">&quot;.Done\n&quot;</span>);
<a name="l01660"></a>01660     }
<a name="l01661"></a>01661 
<a name="l01662"></a>01662   <span class="comment">// close the PET file</span>
<a name="l01663"></a>01663   fits_close_file (OPET_ptr, &amp;f_status);
<a name="l01664"></a>01664   <span class="keywordflow">if</span> (f_status)
<a name="l01665"></a>01665     {
<a name="l01666"></a>01666       ffrprt (stderr, f_status);
<a name="l01667"></a>01667       <a class="code" href="aXe__errors_8c.html#a7ef7588e5f91237ba7ce4084e6ed3c11">aXe_message</a> (<a class="code" href="aXe__errors_8h.html#a2556a67874555249b07691c37aa6d6e9">aXe_M_FATAL</a>, __FILE__, __LINE__,
<a name="l01668"></a>01668                    <span class="stringliteral">&quot;aXe_PETCONT: &quot;</span> <span class="stringliteral">&quot;Error closing PET: %s \n&quot;</span>,
<a name="l01669"></a>01669                    PET_file);
<a name="l01670"></a>01670     }
<a name="l01671"></a>01671 
<a name="l01672"></a>01672   <span class="comment">// set the status to &apos;success&apos; and return it</span>
<a name="l01673"></a>01673   status=1;
<a name="l01674"></a>01674   <span class="keywordflow">return</span> status;
<a name="l01675"></a>01675 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a069e0ff507381b9e8d1351c4fcd7f788"></a><!-- doxytag: member="spc_model.h::fill_pixel_in_speed" ref="a069e0ff507381b9e8d1351c4fcd7f788" args="(const dirobject *actdir, const tracedata *acttrace, const d_point dpixel, const spectrum *resp, beamspec *actspec, const calib_function *wl_calibration)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int fill_pixel_in_speed </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="structdirobject.html">dirobject</a> *&nbsp;</td>
          <td class="paramname"> <em>actdir</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structtracedata.html">tracedata</a> *&nbsp;</td>
          <td class="paramname"> <em>acttrace</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structd__point.html">d_point</a>&nbsp;</td>
          <td class="paramname"> <em>dpixel</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structspectrum.html">spectrum</a> *&nbsp;</td>
          <td class="paramname"> <em>resp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structbeamspec.html">beamspec</a> *&nbsp;</td>
          <td class="paramname"> <em>actspec</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structcalib__function.html">calib_function</a> *&nbsp;</td>
          <td class="paramname"> <em>wl_calibration</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Function: fill_pixel_in_speed The function determines and coadds the contribution of a single pixel in the direct image area to the model <a class="el" href="structspectrum.html">spectrum</a>.</p>
<p>Parameters: </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>actdir</em>&nbsp;</td><td>- the direct <a class="el" href="structobject.html">object</a> of the model <a class="el" href="structspectrum.html">spectrum</a> </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>acttrace</em>&nbsp;</td><td>- the <a class="el" href="structtracedata.html">tracedata</a> of the model <a class="el" href="structspectrum.html">spectrum</a> </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>dpixel</em>&nbsp;</td><td>- the coordinates of the modelled pixel </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>eval</em>&nbsp;</td><td>- the emission value of the source at the modelled pixel </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>resp</em>&nbsp;</td><td>- the sensitivity data </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>actspec</em>&nbsp;</td><td>- the structure for the model <a class="el" href="structspectrum.html">spectrum</a></td></tr>
  </table>
  </dd>
</dl>
<p>Returns: </p>
<dl class="return"><dt><b>Returns:</b></dt><dd>1 - </dd></dl>

<p><div class="fragment"><pre class="fragment"><a name="l01100"></a>01100 {
<a name="l01101"></a>01101 
<a name="l01102"></a>01102   <span class="keywordtype">double</span> dx;
<a name="l01103"></a>01103   <span class="keywordtype">double</span> sens;
<a name="l01104"></a>01104   <span class="keywordtype">double</span> fval;
<a name="l01105"></a>01105   <span class="keywordtype">double</span> tmp1;
<a name="l01106"></a>01106   <span class="comment">//double tmp2, tmp3;</span>
<a name="l01107"></a>01107 
<a name="l01108"></a>01108   <span class="keywordtype">double</span> ddx, ddy;
<a name="l01109"></a>01109 
<a name="l01110"></a>01110   <span class="keywordtype">int</span> ix, iy;
<a name="l01111"></a>01111 
<a name="l01112"></a>01112   <span class="keywordtype">int</span> xstart, xend;
<a name="l01113"></a>01113   <span class="keywordtype">int</span> xact;
<a name="l01114"></a>01114   <span class="keywordtype">int</span> ipos;
<a name="l01115"></a>01115   <span class="keywordtype">int</span> nguess;
<a name="l01116"></a>01116 
<a name="l01117"></a>01117   <span class="comment">// define the dx-range for which a pixel is modelled</span>
<a name="l01118"></a>01118   xstart = actspec-&gt;<a class="code" href="structbeamspec.html#a4526cf634c09ad9fbd3f566dba8ea0fd">model_ref</a>.<a class="code" href="structd__point.html#a922a3b5d82a119168ba85e5f939d02c3">x</a>;
<a name="l01119"></a>01119   xend   = actspec-&gt;<a class="code" href="structbeamspec.html#a4526cf634c09ad9fbd3f566dba8ea0fd">model_ref</a>.<a class="code" href="structd__point.html#a922a3b5d82a119168ba85e5f939d02c3">x</a> + actspec-&gt;<a class="code" href="structbeamspec.html#a5585f5d3885305e980e09fed9a79a618">model</a>-&gt;size1;
<a name="l01120"></a>01120 
<a name="l01121"></a>01121   <span class="comment">// nguess is the approximate possition</span>
<a name="l01122"></a>01122   <span class="comment">// to find a wavelength in the sensitivity table.</span>
<a name="l01123"></a>01123   <span class="comment">// should speed upt things</span>
<a name="l01124"></a>01124   nguess=0;
<a name="l01125"></a>01125 
<a name="l01126"></a>01126   <span class="comment">// go over the dx-range</span>
<a name="l01127"></a>01127   <span class="keywordflow">for</span> (xact = xstart; xact &lt;  xend; xact++)
<a name="l01128"></a>01128     {
<a name="l01129"></a>01129 
<a name="l01130"></a>01130       <span class="comment">// compute the actual dx-value</span>
<a name="l01131"></a>01131       dx = xact-dpixel.<a class="code" href="structd__point.html#a922a3b5d82a119168ba85e5f939d02c3">x</a>;
<a name="l01132"></a>01132 
<a name="l01133"></a>01133       <span class="comment">// get the index to find the data for the actual</span>
<a name="l01134"></a>01134       ipos = <a class="code" href="spc__model_8c.html#a4761f8467dc7a48825badf15b3905a47">get_index_for_tracepoint</a>(acttrace, dx);
<a name="l01135"></a>01135 
<a name="l01136"></a>01136       <span class="comment">// in case that the dx-value is not in the tracedata,</span>
<a name="l01137"></a>01137       <span class="comment">// something is wrong. exit</span>
<a name="l01138"></a>01138       <span class="keywordflow">if</span> (ipos &lt;0)
<a name="l01139"></a>01139         {
<a name="l01140"></a>01140           <span class="comment">//if (wl_calibration-&gt;pr_range == NULL)</span>
<a name="l01141"></a>01141           <span class="comment">//  aXe_message(aXe_M_FATAL, __FILE__, __LINE__,</span>
<a name="l01142"></a>01142           <span class="comment">//              &quot;aXe_PETCONT: &quot; &quot;tracepoint is outside the prepared range!\n&quot;);</span>
<a name="l01143"></a>01143           <span class="comment">//else</span>
<a name="l01144"></a>01144           <span class="keywordflow">continue</span>;
<a name="l01145"></a>01145         }
<a name="l01146"></a>01146 
<a name="l01147"></a>01147       <span class="comment">// compute the y-position in the matrix of the beamspec</span>
<a name="l01148"></a>01148       iy = (int)(gsl_vector_get(acttrace-&gt;<a class="code" href="structtracedata.html#a0bdd805ca59eb0b1329694181236c191">dy</a>,ipos) + actdir-&gt;<a class="code" href="structdirobject.html#a804b505c34bbecd0eb09832e34cbd5ce">xy_off</a>[actspec-&gt;<a class="code" href="structbeamspec.html#a8185e83f23ffbab21ec47ec3d2bea13c">beamID</a>].<a class="code" href="structd__point.html#ad9846a025508bf8873a501ca5fcefbf4">y</a> + 0.5) + (int)dpixel.<a class="code" href="structd__point.html#ad9846a025508bf8873a501ca5fcefbf4">y</a> - actspec-&gt;<a class="code" href="structbeamspec.html#a4526cf634c09ad9fbd3f566dba8ea0fd">model_ref</a>.<a class="code" href="structd__point.html#ad9846a025508bf8873a501ca5fcefbf4">y</a>;
<a name="l01149"></a>01149 
<a name="l01150"></a>01150       <span class="comment">// the same quantity as a double</span>
<a name="l01151"></a>01151       ddy = gsl_vector_get(acttrace-&gt;<a class="code" href="structtracedata.html#a0bdd805ca59eb0b1329694181236c191">dy</a>,ipos) + actdir-&gt;<a class="code" href="structdirobject.html#a804b505c34bbecd0eb09832e34cbd5ce">xy_off</a>[actspec-&gt;<a class="code" href="structbeamspec.html#a8185e83f23ffbab21ec47ec3d2bea13c">beamID</a>].<a class="code" href="structd__point.html#ad9846a025508bf8873a501ca5fcefbf4">y</a> + dpixel.<a class="code" href="structd__point.html#ad9846a025508bf8873a501ca5fcefbf4">y</a> - actspec-&gt;<a class="code" href="structbeamspec.html#a4526cf634c09ad9fbd3f566dba8ea0fd">model_ref</a>.<a class="code" href="structd__point.html#ad9846a025508bf8873a501ca5fcefbf4">y</a>;
<a name="l01152"></a>01152 
<a name="l01153"></a>01153       <span class="comment">// if the y-position is outside, go to the next dx value</span>
<a name="l01154"></a>01154       <span class="keywordflow">if</span> (iy &lt; 0 || iy &gt; actspec-&gt;<a class="code" href="structbeamspec.html#a5585f5d3885305e980e09fed9a79a618">model</a>-&gt;size2-1)
<a name="l01155"></a>01155         <span class="keywordflow">continue</span>;
<a name="l01156"></a>01156 
<a name="l01157"></a>01157       <span class="comment">// in case that the actual wavelength is outside the range</span>
<a name="l01158"></a>01158       <span class="comment">// of the sensitivity data, continue with the next dx-value</span>
<a name="l01159"></a>01159       <span class="keywordflow">if</span> (gsl_vector_get(acttrace-&gt;<a class="code" href="structtracedata.html#a3c594775ee8672308604497766a66f02">lambda</a>, ipos) &lt; resp-&gt;<a class="code" href="structspectrum.html#a0c1fc08d8e906a2cf2309c7a88761fd6">lambdamin</a> || gsl_vector_get(acttrace-&gt;<a class="code" href="structtracedata.html#a3c594775ee8672308604497766a66f02">lambda</a>, ipos) &gt; resp-&gt;<a class="code" href="structspectrum.html#af417db865af6ae56481377ad9b0f0eff">lambdamax</a>)
<a name="l01160"></a>01160         <span class="keywordflow">continue</span>;
<a name="l01161"></a>01161 
<a name="l01162"></a>01162       <span class="comment">// compute the x-position in the matrix of the beamspec</span>
<a name="l01163"></a>01163       ix = (int)(gsl_vector_get(acttrace-&gt;<a class="code" href="structtracedata.html#aebca3378cacc91654b164c7818f120e2">dx</a>,ipos) + actdir-&gt;<a class="code" href="structdirobject.html#a804b505c34bbecd0eb09832e34cbd5ce">xy_off</a>[actspec-&gt;<a class="code" href="structbeamspec.html#a8185e83f23ffbab21ec47ec3d2bea13c">beamID</a>].<a class="code" href="structd__point.html#a922a3b5d82a119168ba85e5f939d02c3">x</a>) + (<span class="keywordtype">int</span>)dpixel.<a class="code" href="structd__point.html#a922a3b5d82a119168ba85e5f939d02c3">x</a> - actspec-&gt;<a class="code" href="structbeamspec.html#a4526cf634c09ad9fbd3f566dba8ea0fd">model_ref</a>.<a class="code" href="structd__point.html#a922a3b5d82a119168ba85e5f939d02c3">x</a>;
<a name="l01164"></a>01164 
<a name="l01165"></a>01165       <span class="comment">// the same quantity as double</span>
<a name="l01166"></a>01166       ddx = gsl_vector_get(acttrace-&gt;<a class="code" href="structtracedata.html#aebca3378cacc91654b164c7818f120e2">dx</a>,ipos) + actdir-&gt;<a class="code" href="structdirobject.html#a804b505c34bbecd0eb09832e34cbd5ce">xy_off</a>[actspec-&gt;<a class="code" href="structbeamspec.html#a8185e83f23ffbab21ec47ec3d2bea13c">beamID</a>].<a class="code" href="structd__point.html#a922a3b5d82a119168ba85e5f939d02c3">x</a> + dpixel.<a class="code" href="structd__point.html#a922a3b5d82a119168ba85e5f939d02c3">x</a> - actspec-&gt;<a class="code" href="structbeamspec.html#a4526cf634c09ad9fbd3f566dba8ea0fd">model_ref</a>.<a class="code" href="structd__point.html#a922a3b5d82a119168ba85e5f939d02c3">x</a>;
<a name="l01167"></a>01167 
<a name="l01168"></a>01168       <span class="comment">// get the total flux value of the source at the wavelength of the actual dx-value</span>
<a name="l01169"></a>01169       fval = gsl_vector_get(acttrace-&gt;<a class="code" href="structtracedata.html#a263d2f1a51308e73d79c77f5e62c01fb">gvalue</a>, ipos) * gsl_vector_get(acttrace-&gt;<a class="code" href="structtracedata.html#a536ca0eb0a785814fc211bcf835f666a">flux</a>, ipos);
<a name="l01170"></a>01170 
<a name="l01171"></a>01171 
<a name="l01172"></a>01172       <span class="comment">// get the sensitivity at the wavelength of the actual dx-value</span>
<a name="l01173"></a>01173       sens = <a class="code" href="spc__resp_8c.html#a92c6c9b541b7b862a2b9903e3587a8a2">get_response_value_plus</a>(resp, gsl_vector_get(acttrace-&gt;<a class="code" href="structtracedata.html#a3c594775ee8672308604497766a66f02">lambda</a>, ipos), &amp;nguess);
<a name="l01174"></a>01174 
<a name="l01175"></a>01175       <span class="comment">// compute the contribution of the actual dx-value to the model spectrum</span>
<a name="l01176"></a>01176       tmp1 = fval * sens * gsl_vector_get(acttrace-&gt;<a class="code" href="structtracedata.html#a63bce5a9b367504eb09b87f41f3373da">dlambda</a>,ipos);
<a name="l01177"></a>01177 
<a name="l01178"></a>01178       <span class="comment">// double check whether we are inside the image</span>
<a name="l01179"></a>01179       <span class="keywordflow">if</span> (ix &lt; 0 || iy &lt; 0 || ix &gt; (actspec-&gt;<a class="code" href="structbeamspec.html#a5585f5d3885305e980e09fed9a79a618">model</a>-&gt;size1-1) || iy &gt; (actspec-&gt;<a class="code" href="structbeamspec.html#a5585f5d3885305e980e09fed9a79a618">model</a>-&gt;size2-1))
<a name="l01180"></a>01180         {
<a name="l01181"></a>01181           fprintf(stdout, <span class="stringliteral">&quot;xval: %i, yval: %i, size1: %i, size2: %i\n&quot;</span>,ix, iy, (<span class="keywordtype">int</span>)actspec-&gt;<a class="code" href="structbeamspec.html#a5585f5d3885305e980e09fed9a79a618">model</a>-&gt;size1, (<span class="keywordtype">int</span>)actspec-&gt;<a class="code" href="structbeamspec.html#a5585f5d3885305e980e09fed9a79a618">model</a>-&gt;size2);
<a name="l01182"></a>01182         }
<a name="l01183"></a>01183       <span class="keywordflow">else</span>
<a name="l01184"></a>01184         {
<a name="l01185"></a>01185           <span class="comment">// add the contribution of the actual dx value to</span>
<a name="l01186"></a>01186           <span class="comment">// the model spectrum, using NO diffusion</span>
<a name="l01187"></a>01187           <span class="comment">//no_diffuse_spectrum(ix, iy, tmp1, actspec);</span>
<a name="l01188"></a>01188 
<a name="l01189"></a>01189           <span class="comment">// add the contribution of the actual dx value to</span>
<a name="l01190"></a>01190           <span class="comment">// the model spectrum, using GRID diffusion</span>
<a name="l01191"></a>01191           <span class="comment">// diffuse_spectrum(ddx, ddy, tmp1, actspec);</span>
<a name="l01192"></a>01192 
<a name="l01193"></a>01193           <span class="comment">// add the contribution of the actual dx value to</span>
<a name="l01194"></a>01194           <span class="comment">// the model spectrum, using PROPORTIONAL diffusion</span>
<a name="l01195"></a>01195           <a class="code" href="spc__model_8c.html#a8fe760d3449f5cedb4bbf7ecc5abab08">diffuse_spectrumII</a>(ddx, ddy, tmp1, actspec);
<a name="l01196"></a>01196         }
<a name="l01197"></a>01197     }
<a name="l01198"></a>01198 
<a name="l01199"></a>01199   <span class="comment">// return a dummy</span>
<a name="l01200"></a>01200   <span class="keywordflow">return</span> 1;
<a name="l01201"></a>01201 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a4761f8467dc7a48825badf15b3905a47"></a><!-- doxytag: member="spc_model.h::get_index_for_tracepoint" ref="a4761f8467dc7a48825badf15b3905a47" args="(const tracedata *acttrace, const double dx)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int get_index_for_tracepoint </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="structtracedata.html">tracedata</a> *&nbsp;</td>
          <td class="paramname"> <em>acttrace</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const double&nbsp;</td>
          <td class="paramname"> <em>dx</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Function: get_index_for_tracepoint For a given dx-value, the function derives the index under which data for this dx-value is stored in a <a class="el" href="structtracedata.html">tracedata</a> structure. The index is simply returned. If the dx-value is not inside the <a class="el" href="structtracedata.html">tracedata</a>, '-1' is returned. In contrast to the first attempt (now 'get_index_for_tracepoint2') this routine uses the minimum dx value stored in the <a class="el" href="structtracedata.html">tracedata</a> structure. It becomes much much faster by that!</p>
<p>Parameters: </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>acttrace</em>&nbsp;</td><td>- the <a class="el" href="structtracedata.html">tracedata</a> to search an index </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>dx</em>&nbsp;</td><td>- the dx-value to identify in the <a class="el" href="structtracedata.html">tracedata</a></td></tr>
  </table>
  </dd>
</dl>
<p>Returns: </p>
<dl class="return"><dt><b>Returns:</b></dt><dd>ipos - the index where the dx-value is stored </dd></dl>

<p><div class="fragment"><pre class="fragment"><a name="l01223"></a>01223 {
<a name="l01224"></a>01224   <span class="keywordtype">int</span> ipos;
<a name="l01225"></a>01225 
<a name="l01226"></a>01226   <span class="comment">// compute the index using the minimum dx value</span>
<a name="l01227"></a>01227   <span class="comment">// stored in the structure</span>
<a name="l01228"></a>01228   ipos = (int)(dx - acttrace-&gt;<a class="code" href="structtracedata.html#a30448278ba94615e1ef5d8801deab6e6">dx_start</a>);
<a name="l01229"></a>01229 
<a name="l01230"></a>01230   <span class="comment">// check whether the index is within the acceptable range</span>
<a name="l01231"></a>01231   <span class="comment">// make it -1 if not</span>
<a name="l01232"></a>01232   <span class="keywordflow">if</span> (ipos &lt; 0 || ipos &gt; (acttrace-&gt;<a class="code" href="structtracedata.html#af5aed7b8f1629b86be33dc7d57056bcc">npoints</a> -1))
<a name="l01233"></a>01233     ipos=-1;
<a name="l01234"></a>01234 
<a name="l01235"></a>01235   <span class="comment">// return the index</span>
<a name="l01236"></a>01236   <span class="keywordflow">return</span> ipos;
<a name="l01237"></a>01237 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a15bbdbd96e729c0edb66bd4e3c9f6b8c"></a><!-- doxytag: member="spc_model.h::make_fcube_spectra" ref="a15bbdbd96e729c0edb66bd4e3c9f6b8c" args="(object **oblist, dirobject **dirlist, const px_point npixels, char CONF_file[], const flux_cube *fcube, const int inter_type)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structbeamspec.html">beamspec</a>** make_fcube_spectra </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structobject.html">object</a> **&nbsp;</td>
          <td class="paramname"> <em>oblist</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structdirobject.html">dirobject</a> **&nbsp;</td>
          <td class="paramname"> <em>dirlist</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structpx__point.html">px_point</a>&nbsp;</td>
          <td class="paramname"> <em>npixels</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char&nbsp;</td>
          <td class="paramname"> <em>CONF_file</em>[], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structflux__cube.html">flux_cube</a> *&nbsp;</td>
          <td class="paramname"> <em>fcube</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const int&nbsp;</td>
          <td class="paramname"> <em>inter_type</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Function: make_fcube_spectra The function creates a spectral model for the beams that are considered in the contamination. It uses the fluxcube emission model to calculate the emission in the different beams.</p>
<p>Parameters: </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>oblist</em>&nbsp;</td><td>- the <a class="el" href="structobject.html">object</a> list as input to select beams </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>dirlist</em>&nbsp;</td><td>- the direct <a class="el" href="structobject.html">object</a> list to dimension the models </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>npixels</em>&nbsp;</td><td>- the dimensions of the model for the whole image </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>CONF_file</em>&nbsp;</td><td>- the name of the configuration file </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>fcube</em>&nbsp;</td><td>- the fluxcube to get the flux data from</td></tr>
  </table>
  </dd>
</dl>
<p>Returns: </p>
<dl class="return"><dt><b>Returns:</b></dt><dd>speclist - the list of modelled beams </dd></dl>

<p><div class="fragment"><pre class="fragment"><a name="l00760"></a>00760 {
<a name="l00761"></a>00761   <a class="code" href="structbeamspec.html">beamspec</a>       **speclist;
<a name="l00762"></a>00762   <a class="code" href="structdirobject.html">dirobject</a>       *actdir;
<a name="l00763"></a>00763   <a class="code" href="structaperture__conf.html">aperture_conf</a>   *conf;
<a name="l00764"></a>00764   <a class="code" href="structcalib__function.html">calib_function</a>  *wl_calibration;
<a name="l00765"></a>00765   <a class="code" href="structspectrum.html">spectrum</a>        *resp;
<a name="l00766"></a>00766   <a class="code" href="structbeam.html">beam</a>             actbeam;
<a name="l00767"></a>00767   <a class="code" href="structtracedata.html">tracedata</a>       *acttrace;
<a name="l00768"></a>00768 
<a name="l00769"></a>00769   <span class="keywordtype">int</span> i;
<a name="l00770"></a>00770   <span class="keywordtype">int</span> nobjects;
<a name="l00771"></a>00771 
<a name="l00772"></a>00772   <span class="keywordtype">int</span> nx, ny;
<a name="l00773"></a>00773   <span class="comment">//d_point dpixel;</span>
<a name="l00774"></a>00774   <a class="code" href="structd__point.html">d_point</a> dflt_point;
<a name="l00775"></a>00775   <a class="code" href="structpx__point.html">px_point</a> fcube_point;
<a name="l00776"></a>00776 
<a name="l00777"></a>00777   <a class="code" href="structd__point.html">d_point</a> tmp2;
<a name="l00778"></a>00778 
<a name="l00779"></a>00779 
<a name="l00780"></a>00780   <span class="comment">// determine the number of objects in the object list</span>
<a name="l00781"></a>00781   nobjects = <a class="code" href="inout__aper_8c.html#aa4bd812673400180537c7ea98650d3fe">object_list_size</a>(oblist);
<a name="l00782"></a>00782 
<a name="l00783"></a>00783   <span class="comment">// load the configuration file</span>
<a name="l00784"></a>00784   conf = <a class="code" href="aper__conf_8c.html#a45d84f2fc00f438b5da9054c45b7736c">get_aperture_descriptor</a> (CONF_file);
<a name="l00785"></a>00785 
<a name="l00786"></a>00786   speclist = <a class="code" href="spc__model_8c.html#aba4320035294553956a3f535cc484ead">alloc_beamlist_from_dirlist</a>(oblist, dirlist, npixels, conf);
<a name="l00787"></a>00787 
<a name="l00788"></a>00788   <span class="comment">// go over each beam model</span>
<a name="l00789"></a>00789   i = 0;
<a name="l00790"></a>00790   <span class="keywordflow">while</span> (speclist[i] != NULL)
<a name="l00791"></a>00791     {
<a name="l00792"></a>00792 
<a name="l00793"></a>00793       <span class="comment">// get the direct object for the actual model spectrum</span>
<a name="l00794"></a>00794       actdir = <a class="code" href="model__utils_8c.html#a39965b9d4410809472bb1a5fd4328026">get_dirobject_from_list</a>(dirlist, speclist[i]-&gt;objectID);
<a name="l00795"></a>00795 
<a name="l00796"></a>00796       <span class="comment">// get the beam for the actual model spectrum</span>
<a name="l00797"></a>00797       actbeam = <a class="code" href="model__utils_8c.html#a457e67339a8e12cee377ffebf7410c0d">get_beam_for_beamspec</a>(oblist,nobjects,speclist[i]);
<a name="l00798"></a>00798 
<a name="l00799"></a>00799       <span class="comment">// get the wavelength calibration for the actual model spectrum</span>
<a name="l00800"></a>00800       wl_calibration = <a class="code" href="model__utils_8c.html#a89e076f16fb5ab1d68d6fd60a8c56818">get_calib_function</a>(speclist[i], actdir, CONF_file, conf);
<a name="l00801"></a>00801 
<a name="l00802"></a>00802       <span class="comment">// get the sensitivity data for the actual model spectrum</span>
<a name="l00803"></a>00803       resp = <a class="code" href="model__utils_8c.html#ac1c970f8545c70717925e789935baf15">get_throughput_spec</a>(speclist[i], CONF_file);
<a name="l00804"></a>00804 
<a name="l00805"></a>00805       <span class="comment">// fill the tracedata structure for the model spectrum</span>
<a name="l00806"></a>00806       acttrace = <a class="code" href="model__utils_8c.html#a88c32a3ad7593c46dfa166a806205e05">compute_tracedata</a>(actbeam,actdir, wl_calibration,speclist[i]);
<a name="l00807"></a>00807       <span class="keywordflow">if</span> (acttrace-&gt;<a class="code" href="structtracedata.html#af5aed7b8f1629b86be33dc7d57056bcc">npoints</a> &lt; 1)
<a name="l00808"></a>00808         {
<a name="l00809"></a>00809           <span class="comment">// release the space for the various structures</span>
<a name="l00810"></a>00810           <a class="code" href="spc__wl__calib_8c.html#ac0c65c345f1f8183331d4b858f5c5b29">free_calib</a>(wl_calibration);
<a name="l00811"></a>00811           <a class="code" href="spc__spc_8c.html#a7e957a43837d35fe0e2195ddcdcda221">free_spectrum</a>(resp);
<a name="l00812"></a>00812           <a class="code" href="model__utils_8c.html#aa698da13e1ad04e38c6ce9c51e4d2923">free_tracedata</a>(acttrace);
<a name="l00813"></a>00813      fprintf(stdout, <span class="stringliteral">&quot;aXe_PETCONT: skipping object %i beam %c ...&quot;</span>, speclist[i]-&gt;objectID, <a class="code" href="aXe__grism_8h.html#a7d90dabb6016bb0e09b6ab84087b70a7">BEAM</a>(speclist[i]-&gt;beamID));
<a name="l00814"></a>00814 
<a name="l00815"></a>00815           <span class="keywordflow">continue</span>;
<a name="l00816"></a>00816         }
<a name="l00817"></a>00817 
<a name="l00818"></a>00818       fprintf(stdout, <span class="stringliteral">&quot;aXe_PETCONT: modelling object %i beam %c ...&quot;</span>, speclist[i]-&gt;objectID, <a class="code" href="aXe__grism_8h.html#a7d90dabb6016bb0e09b6ab84087b70a7">BEAM</a>(speclist[i]-&gt;beamID));
<a name="l00819"></a>00819 
<a name="l00820"></a>00820       <span class="comment">// go over each pixel in the direct object area</span>
<a name="l00821"></a>00821       <span class="keywordflow">for</span> (nx=actdir-&gt;<a class="code" href="structdirobject.html#ac068f35c585eec4cd1e5d3392c2dd698">ix_min</a>; nx&lt;=actdir-&gt;ix_max; nx++)
<a name="l00822"></a>00822         {
<a name="l00823"></a>00823           <span class="keywordflow">for</span> (ny=actdir-&gt;<a class="code" href="structdirobject.html#af24c9a92fa18516591e43d96eec13272">iy_min</a>; ny&lt;=actdir-&gt;iy_max; ny++)
<a name="l00824"></a>00824             {
<a name="l00825"></a>00825 
<a name="l00826"></a>00826               <span class="comment">// transform the flt-coordinates</span>
<a name="l00827"></a>00827               <span class="comment">// to fcube coordinates</span>
<a name="l00828"></a>00828               dflt_point.<a class="code" href="structd__point.html#a922a3b5d82a119168ba85e5f939d02c3">x</a> = (double)nx;
<a name="l00829"></a>00829               dflt_point.<a class="code" href="structd__point.html#ad9846a025508bf8873a501ca5fcefbf4">y</a> = (double)ny;
<a name="l00830"></a>00830               tmp2 = <a class="code" href="spc__fluxcube_8c.html#a350fb76c81c3285d1978f350e3a0fe8b">flt_to_fcube_trans</a>(fcube, dflt_point);
<a name="l00831"></a>00831               fcube_point.<a class="code" href="structpx__point.html#ab715a558731a820a25b50bd7797dd004">x</a> = (int)tmp2.<a class="code" href="structd__point.html#a922a3b5d82a119168ba85e5f939d02c3">x</a>;
<a name="l00832"></a>00832               fcube_point.<a class="code" href="structpx__point.html#a2d02b900722a71f22a8d5100822bda61">y</a> = (<span class="keywordtype">int</span>)tmp2.<a class="code" href="structd__point.html#ad9846a025508bf8873a501ca5fcefbf4">y</a>;
<a name="l00833"></a>00833 
<a name="l00834"></a>00834               <span class="comment">// check whether the coordinate point actually</span>
<a name="l00835"></a>00835               <span class="comment">// does belong to the spectral beam</span>
<a name="l00836"></a>00836               <span class="keywordflow">if</span> ( gsl_matrix_int_get(fcube-&gt;<a class="code" href="structflux__cube.html#a5003df20f749b61b1b9ba3818460ca0c">segmentation</a>, fcube_point.<a class="code" href="structpx__point.html#ab715a558731a820a25b50bd7797dd004">x</a>,fcube_point.<a class="code" href="structpx__point.html#a2d02b900722a71f22a8d5100822bda61">y</a>) == actdir-&gt;<a class="code" href="structdirobject.html#ac7f75c9d3cdd6d50adc84ec001beee5b">ID</a>)
<a name="l00837"></a>00837                 {
<a name="l00838"></a>00838 
<a name="l00839"></a>00839                   <span class="comment">// transfer the flux information from the current pixel</span>
<a name="l00840"></a>00840                   <span class="comment">// to the SED of the direct object</span>
<a name="l00841"></a>00841                   <a class="code" href="spc__fluxcube_8c.html#a2177a42473f70dd15e8fd25315589552">fill_fluxvalues</a>(fcube, fcube_point, actdir, inter_type);
<a name="l00842"></a>00842 
<a name="l00843"></a>00843                   <span class="comment">// fill theflux-vector of the tracedata</span>
<a name="l00844"></a>00844                   <a class="code" href="model__utils_8c.html#ab5aca9ee955a502955517d541422cc27">fill_fluxfrom_SED</a>(actdir, acttrace);
<a name="l00845"></a>00845 
<a name="l00846"></a>00846                   <span class="comment">// compute the contribution of the current pixel to the</span>
<a name="l00847"></a>00847                   <span class="comment">// current beam object</span>
<a name="l00848"></a>00848                   <a class="code" href="spc__model_8c.html#a069e0ff507381b9e8d1351c4fcd7f788">fill_pixel_in_speed</a>(actdir, acttrace, dflt_point, resp, speclist[i], wl_calibration);
<a name="l00849"></a>00849                 }
<a name="l00850"></a>00850             }
<a name="l00851"></a>00851         }
<a name="l00852"></a>00852 
<a name="l00853"></a>00853       <span class="comment">// release the space fpr the various structures</span>
<a name="l00854"></a>00854       fprintf(stdout, <span class="stringliteral">&quot; Done\n&quot;</span>);
<a name="l00855"></a>00855       <a class="code" href="spc__wl__calib_8c.html#ac0c65c345f1f8183331d4b858f5c5b29">free_calib</a>(wl_calibration);
<a name="l00856"></a>00856       <a class="code" href="spc__spc_8c.html#a7e957a43837d35fe0e2195ddcdcda221">free_spectrum</a>(resp);
<a name="l00857"></a>00857       <a class="code" href="model__utils_8c.html#aa698da13e1ad04e38c6ce9c51e4d2923">free_tracedata</a>(acttrace);
<a name="l00858"></a>00858 
<a name="l00859"></a>00859       i++;
<a name="l00860"></a>00860     }
<a name="l00861"></a>00861   <span class="comment">// release memory</span>
<a name="l00862"></a>00862   <a class="code" href="aper__conf_8c.html#a608428f59a2adb25874101610cd6afe4">free_aperture_conf</a>(conf);
<a name="l00863"></a>00863 
<a name="l00864"></a>00864   <span class="comment">// return the spectrum list</span>
<a name="l00865"></a>00865   <span class="keywordflow">return</span> speclist;
<a name="l00866"></a>00866 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a64acb42dee15b4bd66149391bbdb982e"></a><!-- doxytag: member="spc_model.h::make_gauss_dirim" ref="a64acb42dee15b4bd66149391bbdb982e" args="(object **oblist, dirobject **dirlist, const double lambda_psf, const px_point npixels, char CONF_file[], observation *obs)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">gsl_matrix* make_gauss_dirim </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structobject.html">object</a> **&nbsp;</td>
          <td class="paramname"> <em>oblist</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structdirobject.html">dirobject</a> **&nbsp;</td>
          <td class="paramname"> <em>dirlist</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const double&nbsp;</td>
          <td class="paramname"> <em>lambda_psf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structpx__point.html">px_point</a>&nbsp;</td>
          <td class="paramname"> <em>npixels</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char&nbsp;</td>
          <td class="paramname"> <em>CONF_file</em>[], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structobservation.html">observation</a> *&nbsp;</td>
          <td class="paramname"> <em>obs</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Function: make_gauss_dirim The function creates a spectral model for the beams that are considered in the contamination. The modelled beams are returned as a list.</p>
<p>Parameters: </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>oblist</em>&nbsp;</td><td>- the <a class="el" href="structobject.html">object</a> list as input to select beams </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>dirlist</em>&nbsp;</td><td>- the direct <a class="el" href="structobject.html">object</a> list to dimension the models </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>npixels</em>&nbsp;</td><td>- the dimensions of the model for the whole image </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>CONF_file</em>&nbsp;</td><td>- the name of the configuration file</td></tr>
  </table>
  </dd>
</dl>
<p>Returns: </p>
<dl class="return"><dt><b>Returns:</b></dt><dd>speclist - the list of modelled beams </dd></dl>

<p><div class="fragment"><pre class="fragment"><a name="l01894"></a>01894 {
<a name="l01895"></a>01895   <a class="code" href="aXe__grism_8h.html#a6117e17bb3108107676f4486e62d40e5">gsl_matrix</a> *all_models;
<a name="l01896"></a>01896   <a class="code" href="structdirobject.html">dirobject</a>       *actdir;
<a name="l01897"></a>01897   <a class="code" href="structbeam.html">beam</a>             actbeam;
<a name="l01898"></a>01898 
<a name="l01899"></a>01899   <span class="comment">//int nspecs;</span>
<a name="l01900"></a>01900   <span class="comment">//int i=0;</span>
<a name="l01901"></a>01901   <span class="comment">//int j=0;</span>
<a name="l01902"></a>01902   <span class="comment">//int jj=0;</span>
<a name="l01903"></a>01903   <span class="keywordtype">int</span> ii=0;
<a name="l01904"></a>01904   <span class="keywordtype">int</span> nobjects;
<a name="l01905"></a>01905 
<a name="l01906"></a>01906   <span class="comment">//int kk, ll;</span>
<a name="l01907"></a>01907   <span class="keywordtype">double</span> sval=0.0;
<a name="l01908"></a>01908   <span class="keywordtype">double</span> flux=0.0;
<a name="l01909"></a>01909   <span class="keywordtype">double</span> value=0.0;
<a name="l01910"></a>01910 
<a name="l01911"></a>01911   <span class="keywordtype">int</span> nx, ny;
<a name="l01912"></a>01912   <a class="code" href="structd__point.html">d_point</a> dpixel;
<a name="l01913"></a>01913 
<a name="l01914"></a>01914   <span class="comment">// determine the number of objects in the object list</span>
<a name="l01915"></a>01915   nobjects = <a class="code" href="inout__aper_8c.html#aa4bd812673400180537c7ea98650d3fe">object_list_size</a>(oblist);
<a name="l01916"></a>01916 
<a name="l01917"></a>01917   <span class="comment">// allocate space for the result,</span>
<a name="l01918"></a>01918   <span class="comment">// set the matrix to 0.0</span>
<a name="l01919"></a>01919   <span class="comment">//  all_models = gsl_matrix_alloc(npixels.x, npixels.y);</span>
<a name="l01920"></a>01920   all_models = obs-&gt;<a class="code" href="structobservation.html#a012c0ff489fbb74fc6c9abfbd7c6e320">grism</a>;
<a name="l01921"></a>01921   <a class="code" href="aXe__grism_8h.html#af6161aeb008a1ffa7d888df6ccbef7cc">gsl_matrix_set_all</a>(all_models,0.0);
<a name="l01922"></a>01922 
<a name="l01923"></a>01923   <span class="comment">// go over each beam model</span>
<a name="l01924"></a>01924   ii = 0;
<a name="l01925"></a>01925   <span class="keywordflow">while</span> (oblist[ii] != NULL)
<a name="l01926"></a>01926     {
<a name="l01927"></a>01927 
<a name="l01928"></a>01928       <span class="comment">// get the direct object for the actual model spectrum</span>
<a name="l01929"></a>01929       actdir = <a class="code" href="model__utils_8c.html#a39965b9d4410809472bb1a5fd4328026">get_dirobject_from_list</a>(dirlist, oblist[ii]-&gt;ID);
<a name="l01930"></a>01930 
<a name="l01931"></a>01931       <span class="comment">// get the beam for the actual model spectrum</span>
<a name="l01932"></a>01932       actbeam = oblist[ii]-&gt;<a class="code" href="structobject.html#ad643757142781f8265b430e19700cfe5">beams</a>[0];
<a name="l01933"></a>01933 
<a name="l01934"></a>01934       fprintf(stdout, <span class="stringliteral">&quot;aXe_PETCONT: modelling object %i ...&quot;</span>, oblist[ii]-&gt;ID);
<a name="l01935"></a>01935 
<a name="l01936"></a>01936       <span class="comment">// go over each pixel in the direct object area</span>
<a name="l01937"></a>01937       <span class="keywordflow">for</span> (nx=actdir-&gt;<a class="code" href="structdirobject.html#ac068f35c585eec4cd1e5d3392c2dd698">ix_min</a>; nx&lt;=actdir-&gt;ix_max; nx++)
<a name="l01938"></a>01938         {
<a name="l01939"></a>01939           <span class="keywordflow">for</span> (ny=actdir-&gt;<a class="code" href="structdirobject.html#af24c9a92fa18516591e43d96eec13272">iy_min</a>; ny&lt;=actdir-&gt;iy_max; ny++)
<a name="l01940"></a>01940             {
<a name="l01941"></a>01941 
<a name="l01942"></a>01942               <span class="comment">// fill the dpixel structure</span>
<a name="l01943"></a>01943               dpixel.<a class="code" href="structd__point.html#a922a3b5d82a119168ba85e5f939d02c3">x</a> = (double)nx;
<a name="l01944"></a>01944               dpixel.<a class="code" href="structd__point.html#ad9846a025508bf8873a501ca5fcefbf4">y</a> = (double)ny;
<a name="l01945"></a>01945 
<a name="l01946"></a>01946               sval = <a class="code" href="model__utils_8c.html#a5d8695af668aaed17d349ca4eb36292c">get_sub_emodel_value</a>(dpixel, actbeam, actdir-&gt;<a class="code" href="structdirobject.html#a1e61e87181abdea5dab21eb1dc3564dc">drzscale</a>);
<a name="l01947"></a>01947               flux = <a class="code" href="model__utils_8c.html#ac6e79df79a058ccf4d82853e08a0c2df">get_flux_from_SED</a>(actdir-&gt;<a class="code" href="structdirobject.html#a79645e83aebf3988bd3464b2079d24c1">SED</a>, 890.0);
<a name="l01948"></a>01948 
<a name="l01949"></a>01949               <span class="keywordflow">if</span> (nx &gt; -1 &amp;&amp; ny &gt; -1 &amp;&amp; nx &lt; npixels.<a class="code" href="structpx__point.html#ab715a558731a820a25b50bd7797dd004">x</a> &amp;&amp; ny &lt; npixels.<a class="code" href="structpx__point.html#a2d02b900722a71f22a8d5100822bda61">y</a>)
<a name="l01950"></a>01950                 {
<a name="l01951"></a>01951                   value = <a class="code" href="aXe__grism_8h.html#acf709ee71c580f1cd65d726ed03200ea">gsl_matrix_get</a>(all_models, nx, ny) + sval*flux;
<a name="l01952"></a>01952                   <a class="code" href="aXe__grism_8h.html#a1f386ef5cd5a3b916246c2bee80f083a">gsl_matrix_set</a>(all_models, nx, ny, value);
<a name="l01953"></a>01953                 }
<a name="l01954"></a>01954             }
<a name="l01955"></a>01955         }
<a name="l01956"></a>01956 
<a name="l01957"></a>01957       <span class="comment">// release the space for the various structures</span>
<a name="l01958"></a>01958       fprintf(stdout, <span class="stringliteral">&quot; Done\n&quot;</span>);
<a name="l01959"></a>01959 
<a name="l01960"></a>01960       ii++;
<a name="l01961"></a>01961     }
<a name="l01962"></a>01962 
<a name="l01963"></a>01963   <span class="keywordflow">return</span> all_models;
<a name="l01964"></a>01964 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a537ee6c7685fe9d7749342e56437f02d"></a><!-- doxytag: member="spc_model.h::make_gauss_spectra" ref="a537ee6c7685fe9d7749342e56437f02d" args="(object **oblist, dirobject **dirlist, const double lambda_psf, const px_point npixels, char CONF_file[])" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structbeamspec.html">beamspec</a>** make_gauss_spectra </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structobject.html">object</a> **&nbsp;</td>
          <td class="paramname"> <em>oblist</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structdirobject.html">dirobject</a> **&nbsp;</td>
          <td class="paramname"> <em>dirlist</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const double&nbsp;</td>
          <td class="paramname"> <em>lambda_psf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structpx__point.html">px_point</a>&nbsp;</td>
          <td class="paramname"> <em>npixels</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char&nbsp;</td>
          <td class="paramname"> <em>CONF_file</em>[]</td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Function: make_gauss_spectra The function creates a spectral model for the beams that are considered in the contamination. The modelled beams are returned as a list.</p>
<p>Parameters: </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>oblist</em>&nbsp;</td><td>- the <a class="el" href="structobject.html">object</a> list as input to select beams </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>dirlist</em>&nbsp;</td><td>- the direct <a class="el" href="structobject.html">object</a> list to dimension the models </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>lambda_psf</em>&nbsp;</td><td>- the wavelength the <a class="el" href="structobject.html">object</a> psf was determined at </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>npixels</em>&nbsp;</td><td>- the dimensions of the model for the whole image </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>CONF_file</em>&nbsp;</td><td>- the name of the configuration file</td></tr>
  </table>
  </dd>
</dl>
<p>Returns: </p>
<dl class="return"><dt><b>Returns:</b></dt><dd>speclist - the list of modelled beams </dd></dl>

<p><div class="fragment"><pre class="fragment"><a name="l00457"></a>00457 {
<a name="l00458"></a>00458   <a class="code" href="structbeamspec.html">beamspec</a>       **speclist;
<a name="l00459"></a>00459   <a class="code" href="structdirobject.html">dirobject</a>       *actdir;
<a name="l00460"></a>00460   <a class="code" href="structaperture__conf.html">aperture_conf</a>   *conf;
<a name="l00461"></a>00461   <a class="code" href="structcalib__function.html">calib_function</a>  *wl_calibration;
<a name="l00462"></a>00462   <a class="code" href="structspectrum.html">spectrum</a>        *resp;
<a name="l00463"></a>00463   <a class="code" href="structbeam.html">beam</a>             actbeam;
<a name="l00464"></a>00464   <a class="code" href="structtracedata.html">tracedata</a>       *acttrace;
<a name="l00465"></a>00465 
<a name="l00466"></a>00466   <span class="comment">//double eval=0.0;</span>
<a name="l00467"></a>00467   <span class="keywordtype">double</span> psf_offset=0;
<a name="l00468"></a>00468 
<a name="l00469"></a>00469   <span class="keywordtype">int</span> nspecs;
<a name="l00470"></a>00470   <span class="keywordtype">int</span> i=0;
<a name="l00471"></a>00471   <span class="keywordtype">int</span> j=0;
<a name="l00472"></a>00472   <span class="keywordtype">int</span> jj=0,ii=0;
<a name="l00473"></a>00473   <span class="keywordtype">int</span> nobjects;
<a name="l00474"></a>00474 
<a name="l00475"></a>00475   <span class="comment">//int kk, ll;</span>
<a name="l00476"></a>00476   <span class="keywordtype">double</span> sval;
<a name="l00477"></a>00477 
<a name="l00478"></a>00478   <span class="keywordtype">int</span> nx, ny;
<a name="l00479"></a>00479   <a class="code" href="structd__point.html">d_point</a> dpixel;
<a name="l00480"></a>00480 
<a name="l00481"></a>00481   <span class="comment">// determine the number of objects in the object list</span>
<a name="l00482"></a>00482   nobjects = <a class="code" href="inout__aper_8c.html#aa4bd812673400180537c7ea98650d3fe">object_list_size</a>(oblist);
<a name="l00483"></a>00483 
<a name="l00484"></a>00484   <span class="comment">// load the configuration file</span>
<a name="l00485"></a>00485   conf = <a class="code" href="aper__conf_8c.html#a45d84f2fc00f438b5da9054c45b7736c">get_aperture_descriptor</a> (CONF_file);
<a name="l00486"></a>00486 
<a name="l00487"></a>00487   <span class="comment">// get the number of beams included in the contamination</span>
<a name="l00488"></a>00488   <span class="comment">// (mag &lt; mag_mark(BEAM)</span>
<a name="l00489"></a>00489   nspecs = <a class="code" href="inout__aper_8c.html#aa120fb983e10b94e79858e51b4d3e25e">get_beamspec_size</a>(oblist);
<a name="l00490"></a>00490   speclist = (<a class="code" href="structbeamspec.html">beamspec</a>  **) malloc((nspecs+1) * <span class="keyword">sizeof</span>(<a class="code" href="structbeamspec.html">beamspec</a>  *));
<a name="l00491"></a>00491   <span class="keywordflow">if</span> (speclist == NULL)
<a name="l00492"></a>00492     <a class="code" href="aXe__errors_8c.html#a7ef7588e5f91237ba7ce4084e6ed3c11">aXe_message</a> (<a class="code" href="aXe__errors_8h.html#a2556a67874555249b07691c37aa6d6e9">aXe_M_FATAL</a>, __FILE__, __LINE__,
<a name="l00493"></a>00493                  <span class="stringliteral">&quot;make_model_spectra:&quot;</span> <span class="stringliteral">&quot; Could not allocate&quot;</span>
<a name="l00494"></a>00494                  <span class="stringliteral">&quot; memory for pointers to %i beamspec objects&quot;</span>, nspecs+1);
<a name="l00495"></a>00495 
<a name="l00496"></a>00496   fprintf(stdout, <span class="stringliteral">&quot;aXe_PETCONT: %i beams are included in the contamination.\n&quot;</span>,nspecs);
<a name="l00497"></a>00497 
<a name="l00498"></a>00498   <span class="comment">// go over all objects</span>
<a name="l00499"></a>00499   <span class="keywordflow">for</span> (i = 0; i &lt; nobjects; i++)
<a name="l00500"></a>00500     {
<a name="l00501"></a>00501 
<a name="l00502"></a>00502       <span class="comment">// go over each beam in an object</span>
<a name="l00503"></a>00503       <span class="keywordflow">for</span> (j=0; j &lt; oblist[i]-&gt;<a class="code" href="structobject.html#a14120e3b048a2118f7acd75ea1571c60">nbeams</a>; j++)
<a name="l00504"></a>00504         {
<a name="l00505"></a>00505 
<a name="l00506"></a>00506           <span class="comment">// check whether the beam is included in the contamination</span>
<a name="l00507"></a>00507           <span class="keywordflow">if</span> (oblist[i]-&gt;beams[j].ignore != 1)
<a name="l00508"></a>00508             {
<a name="l00509"></a>00509 
<a name="l00510"></a>00510               <span class="comment">// get the direct object for the beam</span>
<a name="l00511"></a>00511               actdir = <a class="code" href="model__utils_8c.html#a39965b9d4410809472bb1a5fd4328026">get_dirobject_from_list</a>(dirlist, oblist[i]-&gt;ID);
<a name="l00512"></a>00512 
<a name="l00513"></a>00513               <span class="comment">// check whether the beam is inside the image,</span>
<a name="l00514"></a>00514               <span class="comment">// if yes, allocate space for the beam model</span>
<a name="l00515"></a>00515               speclist[jj] = <a class="code" href="spc__model_8c.html#a8a1e63b6f29be161a726a1c08a26ebb9">dimension_beamspec</a>(actdir, oblist[i],  npixels, conf, j);
<a name="l00516"></a>00516 
<a name="l00517"></a>00517               <span class="comment">// increment the counter if space was allocated</span>
<a name="l00518"></a>00518               <span class="keywordflow">if</span> (speclist[jj] != NULL)
<a name="l00519"></a>00519                 jj++;
<a name="l00520"></a>00520 
<a name="l00521"></a>00521             }
<a name="l00522"></a>00522         }
<a name="l00523"></a>00523     }
<a name="l00524"></a>00524 
<a name="l00525"></a>00525   fprintf(stdout, <span class="stringliteral">&quot;aXe_PETCONT: %i beams are modelled.\n&quot;</span>,jj);
<a name="l00526"></a>00526 
<a name="l00527"></a>00527   <span class="comment">// terminate the beamspec list with NULL&apos;s</span>
<a name="l00528"></a>00528   <span class="keywordflow">for</span> (ii=jj; ii &lt; nspecs+1; ii++)
<a name="l00529"></a>00529     speclist[ii] = NULL;
<a name="l00530"></a>00530 
<a name="l00531"></a>00531   <span class="comment">// go over each beam model</span>
<a name="l00532"></a>00532   ii = 0;
<a name="l00533"></a>00533   <span class="keywordflow">while</span> (speclist[ii] != NULL)
<a name="l00534"></a>00534     {
<a name="l00535"></a>00535 
<a name="l00536"></a>00536       <span class="comment">//      fprintf(stdout, &quot;modelling 1: %i\n&quot;, ii);</span>
<a name="l00537"></a>00537 
<a name="l00538"></a>00538       <span class="comment">// get the direct object for the actual model spectrum</span>
<a name="l00539"></a>00539       actdir = <a class="code" href="model__utils_8c.html#a39965b9d4410809472bb1a5fd4328026">get_dirobject_from_list</a>(dirlist, speclist[ii]-&gt;objectID);
<a name="l00540"></a>00540 
<a name="l00541"></a>00541       <span class="comment">// get the beam for the actual model spectrum</span>
<a name="l00542"></a>00542       actbeam = <a class="code" href="model__utils_8c.html#a457e67339a8e12cee377ffebf7410c0d">get_beam_for_beamspec</a>(oblist,nobjects,speclist[ii]);
<a name="l00543"></a>00543 
<a name="l00544"></a>00544       <span class="comment">//      fprintf(stdout, &quot;modelling 2: %i\n&quot;, ii);</span>
<a name="l00545"></a>00545       psf_offset = <a class="code" href="aper__conf_8c.html#a8164c87851c09beb885a55483557a0f2">get_psf_offset</a>(conf, actbeam);
<a name="l00546"></a>00546 
<a name="l00547"></a>00547       <span class="comment">//      fprintf(stdout, &quot;modelling 3: %i\n&quot;, ii);</span>
<a name="l00548"></a>00548 
<a name="l00549"></a>00549       <span class="comment">// get the wavelength calibration for the actual model spectrum</span>
<a name="l00550"></a>00550       wl_calibration = <a class="code" href="model__utils_8c.html#a89e076f16fb5ab1d68d6fd60a8c56818">get_calib_function</a>(speclist[ii], actdir, CONF_file, conf);
<a name="l00551"></a>00551 
<a name="l00552"></a>00552       <span class="comment">// get the sensitivity data for the actual model spectrum</span>
<a name="l00553"></a>00553       resp = <a class="code" href="model__utils_8c.html#ac1c970f8545c70717925e789935baf15">get_throughput_spec</a>(speclist[ii], CONF_file);
<a name="l00554"></a>00554 
<a name="l00555"></a>00555       <span class="comment">// fill the tracedata structure for the model spectrum</span>
<a name="l00556"></a>00556       acttrace = <a class="code" href="model__utils_8c.html#a88c32a3ad7593c46dfa166a806205e05">compute_tracedata</a>(actbeam,actdir, wl_calibration,speclist[ii]);
<a name="l00557"></a>00557       <span class="comment">//      fprintf(stdout, &quot;modelling 4: %i\n&quot;, ii);</span>
<a name="l00558"></a>00558       <span class="keywordflow">if</span> (acttrace-&gt;<a class="code" href="structtracedata.html#af5aed7b8f1629b86be33dc7d57056bcc">npoints</a> &lt; 1)
<a name="l00559"></a>00559         {
<a name="l00560"></a>00560           <span class="comment">// release the space for the various structures</span>
<a name="l00561"></a>00561           <span class="comment">//      fprintf(stdout, &quot;modelling 50: %i\n&quot;, ii);</span>
<a name="l00562"></a>00562           <a class="code" href="spc__wl__calib_8c.html#ac0c65c345f1f8183331d4b858f5c5b29">free_calib</a>(wl_calibration);
<a name="l00563"></a>00563           <a class="code" href="spc__spc_8c.html#a7e957a43837d35fe0e2195ddcdcda221">free_spectrum</a>(resp);
<a name="l00564"></a>00564           <a class="code" href="model__utils_8c.html#aa698da13e1ad04e38c6ce9c51e4d2923">free_tracedata</a>(acttrace);
<a name="l00565"></a>00565       fprintf(stderr, <span class="stringliteral">&quot;aXe_PETCONT: skipping object %i beam %c ...&quot;</span>, speclist[ii]-&gt;objectID, <a class="code" href="aXe__grism_8h.html#a7d90dabb6016bb0e09b6ab84087b70a7">BEAM</a>(speclist[ii]-&gt;beamID));
<a name="l00566"></a>00566 
<a name="l00567"></a>00567           ii++;
<a name="l00568"></a>00568           <span class="keywordflow">continue</span>;
<a name="l00569"></a>00569         }
<a name="l00570"></a>00570 
<a name="l00571"></a>00571       <span class="comment">//      fprintf(stdout, &quot;modelling 51: %i\n&quot;, ii);</span>
<a name="l00572"></a>00572       <span class="comment">// fill the flux information int the tracedata</span>
<a name="l00573"></a>00573       <a class="code" href="model__utils_8c.html#ab5aca9ee955a502955517d541422cc27">fill_fluxfrom_SED</a>(actdir, acttrace);
<a name="l00574"></a>00574       <span class="comment">//      fprintf(stderr, &quot;modelling 6: %i\n&quot;, ii);</span>
<a name="l00575"></a>00575 
<a name="l00576"></a>00576       fprintf(stdout, <span class="stringliteral">&quot;aXe_PETCONT: modelling object %i beam %c ...&quot;</span>, speclist[ii]-&gt;objectID, <a class="code" href="aXe__grism_8h.html#a7d90dabb6016bb0e09b6ab84087b70a7">BEAM</a>(speclist[ii]-&gt;beamID));
<a name="l00577"></a>00577 
<a name="l00578"></a>00578       <span class="comment">// go over each pixel in the direct object area</span>
<a name="l00579"></a>00579       <span class="keywordflow">for</span> (nx=actdir-&gt;<a class="code" href="structdirobject.html#ac068f35c585eec4cd1e5d3392c2dd698">ix_min</a>; nx&lt;=actdir-&gt;ix_max; nx++)
<a name="l00580"></a>00580         {
<a name="l00581"></a>00581           <span class="keywordflow">for</span> (ny=actdir-&gt;<a class="code" href="structdirobject.html#af24c9a92fa18516591e43d96eec13272">iy_min</a>; ny&lt;=actdir-&gt;iy_max; ny++)
<a name="l00582"></a>00582             {
<a name="l00583"></a>00583 
<a name="l00584"></a>00584               <span class="comment">//fprintf(stderr, &quot;point %i %i %i &lt;-&gt; %i %i &lt;-&gt; %i \n&quot;, nx, ny, actdir-&gt;ix_min, actdir-&gt;ix_max, actdir-&gt;iy_min, actdir-&gt;iy_max);</span>
<a name="l00585"></a>00585               <span class="comment">// fill the dpixel structure</span>
<a name="l00586"></a>00586               dpixel.<a class="code" href="structd__point.html#a922a3b5d82a119168ba85e5f939d02c3">x</a> = (double)nx;
<a name="l00587"></a>00587               dpixel.<a class="code" href="structd__point.html#ad9846a025508bf8873a501ca5fcefbf4">y</a> = (double)ny;
<a name="l00588"></a>00588 
<a name="l00589"></a>00589 
<a name="l00590"></a>00590               <span class="comment">// check whether a wavelength-dependent</span>
<a name="l00591"></a>00591               <span class="comment">// emission profile is given</span>
<a name="l00592"></a>00592               <span class="keywordflow">if</span> ((conf-&gt;<a class="code" href="structaperture__conf.html#a904a154040bedf410b669b65791c96e2">psfcoeffs</a> &amp;&amp; conf-&gt;<a class="code" href="structaperture__conf.html#a469dc826e363a3b9e340aa99824e2f30">psfrange</a>) || psf_offset)
<a name="l00593"></a>00593                 {
<a name="l00594"></a>00594                   <span class="comment">// fill in the wavelength dependend</span>
<a name="l00595"></a>00595                   <span class="comment">// emission values</span>
<a name="l00596"></a>00596                   <a class="code" href="model__utils_8c.html#ae73d0c2c001f041062d3f9776fd55dc1">fill_gaussvalues</a>(dpixel, actbeam, actdir, lambda_psf, conf, psf_offset, acttrace);
<a name="l00597"></a>00597                 }
<a name="l00598"></a>00598               <span class="keywordflow">else</span>
<a name="l00599"></a>00599                 {
<a name="l00600"></a>00600                   <span class="comment">// do a subsampling over the pixel</span>
<a name="l00601"></a>00601                   <span class="comment">// to get a more appropriate value for the</span>
<a name="l00602"></a>00602                   <span class="comment">// emission val</span>
<a name="l00603"></a>00603                   sval = <a class="code" href="model__utils_8c.html#a5d8695af668aaed17d349ca4eb36292c">get_sub_emodel_value</a>(dpixel, actbeam, actdir-&gt;<a class="code" href="structdirobject.html#a1e61e87181abdea5dab21eb1dc3564dc">drzscale</a>);
<a name="l00604"></a>00604                   gsl_vector_set_all (acttrace-&gt;<a class="code" href="structtracedata.html#a263d2f1a51308e73d79c77f5e62c01fb">gvalue</a>, sval);
<a name="l00605"></a>00605                 }
<a name="l00606"></a>00606 
<a name="l00607"></a>00607               <span class="comment">//</span>
<a name="l00608"></a>00608               <a class="code" href="spc__model_8c.html#a069e0ff507381b9e8d1351c4fcd7f788">fill_pixel_in_speed</a>(actdir, acttrace, dpixel, resp, speclist[ii], wl_calibration);
<a name="l00609"></a>00609             }
<a name="l00610"></a>00610         }
<a name="l00611"></a>00611 
<a name="l00612"></a>00612       <span class="comment">// release the space for the various structures</span>
<a name="l00613"></a>00613       fprintf(stdout, <span class="stringliteral">&quot; Done\n&quot;</span>);
<a name="l00614"></a>00614       <a class="code" href="spc__wl__calib_8c.html#ac0c65c345f1f8183331d4b858f5c5b29">free_calib</a>(wl_calibration);
<a name="l00615"></a>00615       <a class="code" href="spc__spc_8c.html#a7e957a43837d35fe0e2195ddcdcda221">free_spectrum</a>(resp);
<a name="l00616"></a>00616       <a class="code" href="model__utils_8c.html#aa698da13e1ad04e38c6ce9c51e4d2923">free_tracedata</a>(acttrace);
<a name="l00617"></a>00617 
<a name="l00618"></a>00618       <span class="comment">// enhance the counter</span>
<a name="l00619"></a>00619       ii++;
<a name="l00620"></a>00620     }
<a name="l00621"></a>00621 
<a name="l00622"></a>00622   <span class="comment">// fre the memory in the conf structure</span>
<a name="l00623"></a>00623   <a class="code" href="aper__conf_8c.html#a608428f59a2adb25874101610cd6afe4">free_aperture_conf</a>(conf);
<a name="l00624"></a>00624 
<a name="l00625"></a>00625   <span class="comment">// return the list of modelled beams</span>
<a name="l00626"></a>00626   <span class="keywordflow">return</span> speclist;
<a name="l00627"></a>00627 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ae7dcf882713246ce40e28942522142a5"></a><!-- doxytag: member="spc_model.h::make_gauss_spectra2" ref="ae7dcf882713246ce40e28942522142a5" args="(object **oblist, dirobject **dirlist, const double lambda_psf, const px_point npixels, char CONF_file[])" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structbeamspec.html">beamspec</a>** make_gauss_spectra2 </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structobject.html">object</a> **&nbsp;</td>
          <td class="paramname"> <em>oblist</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structdirobject.html">dirobject</a> **&nbsp;</td>
          <td class="paramname"> <em>dirlist</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const double&nbsp;</td>
          <td class="paramname"> <em>lambda_psf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structpx__point.html">px_point</a>&nbsp;</td>
          <td class="paramname"> <em>npixels</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char&nbsp;</td>
          <td class="paramname"> <em>CONF_file</em>[]</td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Function: make_gauss_spectra2 The function creates a spectral model for the beams that are considered in the contamination. The modelled beams are returned as a list.</p>
<p>Parameters: </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>oblist</em>&nbsp;</td><td>- the <a class="el" href="structobject.html">object</a> list as input to select beams </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>dirlist</em>&nbsp;</td><td>- the direct <a class="el" href="structobject.html">object</a> list to dimension the models </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>lambda_psf</em>&nbsp;</td><td>- the wavelength the <a class="el" href="structobject.html">object</a> psf was determined at </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>npixels</em>&nbsp;</td><td>- the dimensions of the model for the whole image </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>CONF_file</em>&nbsp;</td><td>- the name of the configuration file</td></tr>
  </table>
  </dd>
</dl>
<p>Returns: </p>
<dl class="return"><dt><b>Returns:</b></dt><dd>speclist - the list of modelled beams </dd></dl>

<p><div class="fragment"><pre class="fragment"><a name="l00288"></a>00288 {
<a name="l00289"></a>00289   <a class="code" href="structbeamspec.html">beamspec</a>       **speclist;
<a name="l00290"></a>00290   <a class="code" href="structdirobject.html">dirobject</a>       *actdir;
<a name="l00291"></a>00291   <a class="code" href="structaperture__conf.html">aperture_conf</a>   *conf;
<a name="l00292"></a>00292   <a class="code" href="structcalib__function.html">calib_function</a>  *wl_calibration;
<a name="l00293"></a>00293   <a class="code" href="structspectrum.html">spectrum</a>        *resp;
<a name="l00294"></a>00294   <a class="code" href="structbeam.html">beam</a>             actbeam;
<a name="l00295"></a>00295   <a class="code" href="structtracedata.html">tracedata</a>       *acttrace;
<a name="l00296"></a>00296 
<a name="l00297"></a>00297   <span class="comment">//double eval=0.0;</span>
<a name="l00298"></a>00298   <span class="keywordtype">double</span> psf_offset=0;
<a name="l00299"></a>00299 
<a name="l00300"></a>00300   <span class="comment">//int nspecs;</span>
<a name="l00301"></a>00301   <span class="comment">//int i=0;</span>
<a name="l00302"></a>00302   <span class="comment">//int j=0;</span>
<a name="l00303"></a>00303   <span class="comment">//int jj=0;</span>
<a name="l00304"></a>00304   <span class="keywordtype">int</span> ii=0;
<a name="l00305"></a>00305   <span class="keywordtype">int</span> nobjects;
<a name="l00306"></a>00306 
<a name="l00307"></a>00307   <span class="comment">//int kk, ll;</span>
<a name="l00308"></a>00308   <span class="keywordtype">double</span> sval;
<a name="l00309"></a>00309   <span class="keywordtype">double</span> frac_prev, frac;
<a name="l00310"></a>00310 
<a name="l00311"></a>00311   <span class="keywordtype">int</span> nx, ny;
<a name="l00312"></a>00312   <a class="code" href="structd__point.html">d_point</a> dpixel;
<a name="l00313"></a>00313 
<a name="l00314"></a>00314   <span class="comment">// determine the number of objects in the object list</span>
<a name="l00315"></a>00315   nobjects = <a class="code" href="inout__aper_8c.html#aa4bd812673400180537c7ea98650d3fe">object_list_size</a>(oblist);
<a name="l00316"></a>00316 
<a name="l00317"></a>00317   <span class="comment">// load the configuration file</span>
<a name="l00318"></a>00318   conf = <a class="code" href="aper__conf_8c.html#a45d84f2fc00f438b5da9054c45b7736c">get_aperture_descriptor</a> (CONF_file);
<a name="l00319"></a>00319 
<a name="l00320"></a>00320   <span class="comment">// allocate ther list of spectral beams</span>
<a name="l00321"></a>00321   speclist = <a class="code" href="spc__model_8c.html#aba4320035294553956a3f535cc484ead">alloc_beamlist_from_dirlist</a>(oblist, dirlist, npixels, conf);
<a name="l00322"></a>00322 
<a name="l00323"></a>00323   <span class="comment">// go over each beam model</span>
<a name="l00324"></a>00324   ii = 0;
<a name="l00325"></a>00325   <span class="keywordflow">while</span> (speclist[ii] != NULL)
<a name="l00326"></a>00326     {
<a name="l00327"></a>00327       <span class="comment">// get the direct object for the actual model spectrum</span>
<a name="l00328"></a>00328       actdir = <a class="code" href="model__utils_8c.html#a39965b9d4410809472bb1a5fd4328026">get_dirobject_from_list</a>(dirlist, speclist[ii]-&gt;objectID);
<a name="l00329"></a>00329 
<a name="l00330"></a>00330       <span class="comment">// get the beam for the actual model spectrum</span>
<a name="l00331"></a>00331       actbeam = <a class="code" href="model__utils_8c.html#a457e67339a8e12cee377ffebf7410c0d">get_beam_for_beamspec</a>(oblist,nobjects,speclist[ii]);
<a name="l00332"></a>00332 
<a name="l00333"></a>00333       <span class="comment">// get the psf offset values</span>
<a name="l00334"></a>00334       psf_offset = <a class="code" href="aper__conf_8c.html#a8164c87851c09beb885a55483557a0f2">get_psf_offset</a>(conf, actbeam);
<a name="l00335"></a>00335 
<a name="l00336"></a>00336       <span class="comment">// get the wavelength calibration for the actual model spectrum</span>
<a name="l00337"></a>00337       wl_calibration = <a class="code" href="model__utils_8c.html#a89e076f16fb5ab1d68d6fd60a8c56818">get_calib_function</a>(speclist[ii], actdir, CONF_file, conf);
<a name="l00338"></a>00338 
<a name="l00339"></a>00339       <span class="comment">// get the sensitivity data for the actual model spectrum</span>
<a name="l00340"></a>00340       resp = <a class="code" href="model__utils_8c.html#ac1c970f8545c70717925e789935baf15">get_throughput_spec</a>(speclist[ii], CONF_file);
<a name="l00341"></a>00341 
<a name="l00342"></a>00342       <span class="comment">// fill the tracedata structure for the model spectrum</span>
<a name="l00343"></a>00343       <span class="comment">//acttrace = compute_tracedata(actbeam,actdir, wl_calibration,speclist[ii]);</span>
<a name="l00344"></a>00344       acttrace = <a class="code" href="model__utils_8c.html#a0ad6a3c9e3542d3085e0b4d840e76ad1">compute_short_tracedata</a>(conf, actbeam,actdir, wl_calibration,speclist[ii]);
<a name="l00345"></a>00345 
<a name="l00346"></a>00346       <span class="keywordflow">if</span> (acttrace-&gt;<a class="code" href="structtracedata.html#af5aed7b8f1629b86be33dc7d57056bcc">npoints</a> &lt; 1)
<a name="l00347"></a>00347         {
<a name="l00348"></a>00348           <span class="comment">// release the space for the various structures</span>
<a name="l00349"></a>00349           <a class="code" href="spc__wl__calib_8c.html#ac0c65c345f1f8183331d4b858f5c5b29">free_calib</a>(wl_calibration);
<a name="l00350"></a>00350           <a class="code" href="spc__spc_8c.html#a7e957a43837d35fe0e2195ddcdcda221">free_spectrum</a>(resp);
<a name="l00351"></a>00351           <a class="code" href="model__utils_8c.html#aa698da13e1ad04e38c6ce9c51e4d2923">free_tracedata</a>(acttrace);
<a name="l00352"></a>00352 
<a name="l00353"></a>00353           <span class="comment">// give feedback to the screen</span>
<a name="l00354"></a>00354           fprintf(stderr, <span class="stringliteral">&quot;aXe_PETCONT: skipping object %i beam %c ...&quot;</span>, speclist[ii]-&gt;objectID, <a class="code" href="aXe__grism_8h.html#a7d90dabb6016bb0e09b6ab84087b70a7">BEAM</a>(speclist[ii]-&gt;beamID));
<a name="l00355"></a>00355 
<a name="l00356"></a>00356           <span class="comment">// enhance the spectral beam counter</span>
<a name="l00357"></a>00357           <span class="comment">// and go to the next</span>
<a name="l00358"></a>00358           ii++;
<a name="l00359"></a>00359           <span class="keywordflow">continue</span>;
<a name="l00360"></a>00360         }
<a name="l00361"></a>00361 
<a name="l00362"></a>00362       <span class="comment">// fill the flux information int the tracedata</span>
<a name="l00363"></a>00363       <a class="code" href="model__utils_8c.html#ab5aca9ee955a502955517d541422cc27">fill_fluxfrom_SED</a>(actdir, acttrace);
<a name="l00364"></a>00364 
<a name="l00365"></a>00365       <span class="comment">// give feedback to the screen</span>
<a name="l00366"></a>00366       fprintf(stdout, <span class="stringliteral">&quot;aXe_PETCONT: modelling object %i beam %c ...&quot;</span>, speclist[ii]-&gt;objectID, <a class="code" href="aXe__grism_8h.html#a7d90dabb6016bb0e09b6ab84087b70a7">BEAM</a>(speclist[ii]-&gt;beamID));
<a name="l00367"></a>00367 
<a name="l00368"></a>00368       frac_prev=10.0;
<a name="l00369"></a>00369       <span class="comment">// go over each pixel in the direct object area</span>
<a name="l00370"></a>00370       <span class="keywordflow">for</span> (nx=actdir-&gt;<a class="code" href="structdirobject.html#ac068f35c585eec4cd1e5d3392c2dd698">ix_min</a>; nx&lt;=actdir-&gt;ix_max; nx++)
<a name="l00371"></a>00371         {
<a name="l00372"></a>00372           <span class="comment">//----------------------------------------------</span>
<a name="l00373"></a>00373           <span class="comment">// compute the percentage that has been computed</span>
<a name="l00374"></a>00374           <span class="comment">// report progress in 10% increments</span>
<a name="l00375"></a>00375           frac = fmod(100.0*(nx - actdir-&gt;<a class="code" href="structdirobject.html#ac068f35c585eec4cd1e5d3392c2dd698">ix_min</a>)/(actdir-&gt;<a class="code" href="structdirobject.html#ac8c6104f2c2e1384c64bba61ecf40d69">ix_max</a> - actdir-&gt;<a class="code" href="structdirobject.html#ac068f35c585eec4cd1e5d3392c2dd698">ix_min</a>),10);
<a name="l00376"></a>00376           <span class="keywordflow">if</span> (frac &lt; frac_prev)
<a name="l00377"></a>00377           {
<a name="l00378"></a>00378             fprintf(stdout, <span class="stringliteral">&quot; %i &quot;</span>, (<span class="keywordtype">int</span>)100.0*(nx - actdir-&gt;<a class="code" href="structdirobject.html#ac068f35c585eec4cd1e5d3392c2dd698">ix_min</a>)/(actdir-&gt;<a class="code" href="structdirobject.html#ac8c6104f2c2e1384c64bba61ecf40d69">ix_max</a> - actdir-&gt;<a class="code" href="structdirobject.html#ac068f35c585eec4cd1e5d3392c2dd698">ix_min</a>));
<a name="l00379"></a>00379             fflush(stdout);
<a name="l00380"></a>00380           }
<a name="l00381"></a>00381           frac_prev=frac;
<a name="l00382"></a>00382           <span class="comment">//----------------------------------------------</span>
<a name="l00383"></a>00383 
<a name="l00384"></a>00384           <span class="keywordflow">for</span> (ny=actdir-&gt;<a class="code" href="structdirobject.html#af24c9a92fa18516591e43d96eec13272">iy_min</a>; ny&lt;=actdir-&gt;iy_max; ny++)
<a name="l00385"></a>00385             {
<a name="l00386"></a>00386               <span class="comment">// fill the dpixel structure</span>
<a name="l00387"></a>00387               dpixel.<a class="code" href="structd__point.html#a922a3b5d82a119168ba85e5f939d02c3">x</a> = (double)nx;
<a name="l00388"></a>00388               dpixel.<a class="code" href="structd__point.html#ad9846a025508bf8873a501ca5fcefbf4">y</a> = (double)ny;
<a name="l00389"></a>00389 
<a name="l00390"></a>00390               <span class="keywordflow">if</span> (actdir-&gt;<a class="code" href="structdirobject.html#a484dadbe6f9bdade97aa303366b4ef6a">dirim</a>)
<a name="l00391"></a>00391                 {
<a name="l00392"></a>00392                   sval = <a class="code" href="specmodel__utils_8c.html#a90e8278f78014bbbaa595341f92cedb5">get_diremission_value</a>(actdir-&gt;<a class="code" href="structdirobject.html#a484dadbe6f9bdade97aa303366b4ef6a">dirim</a>, dpixel.<a class="code" href="structd__point.html#a922a3b5d82a119168ba85e5f939d02c3">x</a> - actbeam.<a class="code" href="structbeam.html#a54c64670a8b3e8732c1468d156ddb0ca">refpoint</a>.<a class="code" href="structd__point.html#a922a3b5d82a119168ba85e5f939d02c3">x</a>, dpixel.<a class="code" href="structd__point.html#ad9846a025508bf8873a501ca5fcefbf4">y</a> - actbeam.<a class="code" href="structbeam.html#a54c64670a8b3e8732c1468d156ddb0ca">refpoint</a>.<a class="code" href="structd__point.html#ad9846a025508bf8873a501ca5fcefbf4">y</a>);
<a name="l00393"></a>00393                   gsl_vector_set_all (acttrace-&gt;<a class="code" href="structtracedata.html#a263d2f1a51308e73d79c77f5e62c01fb">gvalue</a>, sval);
<a name="l00394"></a>00394                 }
<a name="l00395"></a>00395               <span class="keywordflow">else</span>
<a name="l00396"></a>00396                 {
<a name="l00397"></a>00397                   <span class="comment">// check whether a wavelength-dependent</span>
<a name="l00398"></a>00398                   <span class="comment">// emission profile is given</span>
<a name="l00399"></a>00399                   <span class="keywordflow">if</span> ((conf-&gt;<a class="code" href="structaperture__conf.html#a904a154040bedf410b669b65791c96e2">psfcoeffs</a> &amp;&amp; conf-&gt;<a class="code" href="structaperture__conf.html#a469dc826e363a3b9e340aa99824e2f30">psfrange</a>) || psf_offset)
<a name="l00400"></a>00400                     {
<a name="l00401"></a>00401                       <span class="comment">// fill in the wavelength dependend</span>
<a name="l00402"></a>00402                       <span class="comment">// emission values</span>
<a name="l00403"></a>00403                       <a class="code" href="model__utils_8c.html#ae73d0c2c001f041062d3f9776fd55dc1">fill_gaussvalues</a>(dpixel, actbeam, actdir, lambda_psf, conf, psf_offset, acttrace);
<a name="l00404"></a>00404                     }
<a name="l00405"></a>00405                   <span class="keywordflow">else</span>
<a name="l00406"></a>00406                     {
<a name="l00407"></a>00407                       <span class="comment">// do a subsampling over the pixel</span>
<a name="l00408"></a>00408                       <span class="comment">// to get a more appropriate value for the</span>
<a name="l00409"></a>00409                       <span class="comment">// emission val</span>
<a name="l00410"></a>00410                       sval = <a class="code" href="model__utils_8c.html#a5d8695af668aaed17d349ca4eb36292c">get_sub_emodel_value</a>(dpixel, actbeam, actdir-&gt;<a class="code" href="structdirobject.html#a1e61e87181abdea5dab21eb1dc3564dc">drzscale</a>);
<a name="l00411"></a>00411                       gsl_vector_set_all (acttrace-&gt;<a class="code" href="structtracedata.html#a263d2f1a51308e73d79c77f5e62c01fb">gvalue</a>, sval);
<a name="l00412"></a>00412                     }
<a name="l00413"></a>00413                 }
<a name="l00414"></a>00414 
<a name="l00415"></a>00415               <span class="comment">// insert the spectrum of this direct object pixel in the beam spectrum</span>
<a name="l00416"></a>00416               <a class="code" href="spc__model_8c.html#a069e0ff507381b9e8d1351c4fcd7f788">fill_pixel_in_speed</a>(actdir, acttrace, dpixel, resp, speclist[ii], wl_calibration);
<a name="l00417"></a>00417             }
<a name="l00418"></a>00418         }
<a name="l00419"></a>00419 
<a name="l00420"></a>00420       <span class="comment">// release the space for the various structures</span>
<a name="l00421"></a>00421       fprintf(stdout, <span class="stringliteral">&quot; Done\n&quot;</span>);
<a name="l00422"></a>00422       <a class="code" href="spc__wl__calib_8c.html#ac0c65c345f1f8183331d4b858f5c5b29">free_calib</a>(wl_calibration);
<a name="l00423"></a>00423       <a class="code" href="spc__spc_8c.html#a7e957a43837d35fe0e2195ddcdcda221">free_spectrum</a>(resp);
<a name="l00424"></a>00424       <a class="code" href="model__utils_8c.html#aa698da13e1ad04e38c6ce9c51e4d2923">free_tracedata</a>(acttrace);
<a name="l00425"></a>00425 
<a name="l00426"></a>00426       <span class="comment">// enhance the counter</span>
<a name="l00427"></a>00427       ii++;
<a name="l00428"></a>00428     }
<a name="l00429"></a>00429 
<a name="l00430"></a>00430   <span class="comment">// free the memory in the conf structure</span>
<a name="l00431"></a>00431   <a class="code" href="aper__conf_8c.html#a608428f59a2adb25874101610cd6afe4">free_aperture_conf</a>(conf);
<a name="l00432"></a>00432 
<a name="l00433"></a>00433   <span class="comment">// return the list of modelled beams</span>
<a name="l00434"></a>00434   <span class="keywordflow">return</span> speclist;
<a name="l00435"></a>00435 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="aa210c0aa4d37a6f3914b73a39162301b"></a><!-- doxytag: member="spc_model.h::make_model_image" ref="aa210c0aa4d37a6f3914b73a39162301b" args="(const px_point npixels, observation *obs, beamspec **speclist)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">gsl_matrix* make_model_image </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="structpx__point.html">px_point</a>&nbsp;</td>
          <td class="paramname"> <em>npixels</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structobservation.html">observation</a> *&nbsp;</td>
          <td class="paramname"> <em>obs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structbeamspec.html">beamspec</a> **&nbsp;</td>
          <td class="paramname"> <em>speclist</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Function: make_model_image Sums up the modeled spectral beams to create a spectral model for the whole image.</p>
<p>Parameters: </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>npixels</em>&nbsp;</td><td>- the dimensions of the input grism image </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>speclist</em>&nbsp;</td><td>- the list of modelled beams</td></tr>
  </table>
  </dd>
</dl>
<p>Returns: </p>
<dl class="return"><dt><b>Returns:</b></dt><dd>all_models - the model for the whole image </dd></dl>

<p><div class="fragment"><pre class="fragment"><a name="l01479"></a>01479 {
<a name="l01480"></a>01480 
<a name="l01481"></a>01481   <a class="code" href="aXe__grism_8h.html#a6117e17bb3108107676f4486e62d40e5">gsl_matrix</a> *all_models;
<a name="l01482"></a>01482 
<a name="l01483"></a>01483   <span class="keywordtype">double</span> oldval, addval;
<a name="l01484"></a>01484 
<a name="l01485"></a>01485   <span class="keywordtype">int</span> i=0;
<a name="l01486"></a>01486   <span class="keywordtype">int</span> xact, yact;
<a name="l01487"></a>01487   <span class="keywordtype">int</span> ix, iy;
<a name="l01488"></a>01488 
<a name="l01489"></a>01489   <span class="comment">// allocate space for the result,</span>
<a name="l01490"></a>01490   <span class="comment">// set the matrix to 0.0</span>
<a name="l01491"></a>01491   <span class="comment">//  all_models = gsl_matrix_alloc(npixels.x, npixels.y);</span>
<a name="l01492"></a>01492   all_models = obs-&gt;<a class="code" href="structobservation.html#a012c0ff489fbb74fc6c9abfbd7c6e320">grism</a>;
<a name="l01493"></a>01493   <a class="code" href="aXe__grism_8h.html#af6161aeb008a1ffa7d888df6ccbef7cc">gsl_matrix_set_all</a>(all_models,0.0);
<a name="l01494"></a>01494 
<a name="l01495"></a>01495   fprintf (stdout, <span class="stringliteral">&quot;\naXe_PETCONT: Summing up the model beam spectra\n&quot;</span>);
<a name="l01496"></a>01496 
<a name="l01497"></a>01497   <span class="comment">// go over each beam in the list</span>
<a name="l01498"></a>01498    <span class="keywordflow">while</span> (speclist[i] != NULL)
<a name="l01499"></a>01499      {
<a name="l01500"></a>01500 
<a name="l01501"></a>01501        fprintf(stdout, <span class="stringliteral">&quot;aXe_PETCONT: summing up object %i beam %c ...&quot;</span>, speclist[i]-&gt;objectID, <a class="code" href="aXe__grism_8h.html#a7d90dabb6016bb0e09b6ab84087b70a7">BEAM</a>(speclist[i]-&gt;beamID));
<a name="l01502"></a>01502 
<a name="l01503"></a>01503        <span class="comment">// go over each pixel in the array of the beam model</span>
<a name="l01504"></a>01504        <span class="keywordflow">for</span> (xact=0; xact &lt; speclist[i]-&gt;<a class="code" href="structbeamspec.html#a5585f5d3885305e980e09fed9a79a618">model</a>-&gt;size1; xact++)
<a name="l01505"></a>01505          {
<a name="l01506"></a>01506            <span class="keywordflow">for</span> (yact=0; yact &lt; speclist[i]-&gt;<a class="code" href="structbeamspec.html#a5585f5d3885305e980e09fed9a79a618">model</a>-&gt;size2; yact++)
<a name="l01507"></a>01507              {
<a name="l01508"></a>01508 
<a name="l01509"></a>01509                <span class="comment">// find the coordinates of the pixels in the whole image model</span>
<a name="l01510"></a>01510                ix = speclist[i]-&gt;<a class="code" href="structbeamspec.html#a4526cf634c09ad9fbd3f566dba8ea0fd">model_ref</a>.<a class="code" href="structd__point.html#a922a3b5d82a119168ba85e5f939d02c3">x</a> + xact;
<a name="l01511"></a>01511                iy = speclist[i]-&gt;<a class="code" href="structbeamspec.html#a4526cf634c09ad9fbd3f566dba8ea0fd">model_ref</a>.<a class="code" href="structd__point.html#ad9846a025508bf8873a501ca5fcefbf4">y</a> + yact;
<a name="l01512"></a>01512 
<a name="l01513"></a>01513                <span class="comment">// check for safety reasons whether the coordinates are inside</span>
<a name="l01514"></a>01514                <span class="keywordflow">if</span> (ix &lt; 0 || iy &lt; 0 || ix &gt; (npixels.<a class="code" href="structpx__point.html#ab715a558731a820a25b50bd7797dd004">x</a>-1) || ix &gt; (npixels.<a class="code" href="structpx__point.html#ab715a558731a820a25b50bd7797dd004">x</a>-1)){
<a name="l01515"></a>01515                  fprintf(stdout, <span class="stringliteral">&quot;This should not happen!\n&quot;</span>);
<a name="l01516"></a>01516                }
<a name="l01517"></a>01517                <span class="keywordflow">else</span>{
<a name="l01518"></a>01518 
<a name="l01519"></a>01519                  <span class="comment">// summ up the pixel</span>
<a name="l01520"></a>01520                  addval = <a class="code" href="aXe__grism_8h.html#acf709ee71c580f1cd65d726ed03200ea">gsl_matrix_get</a>(speclist[i]-&gt;model, xact, yact);
<a name="l01521"></a>01521                  oldval = <a class="code" href="aXe__grism_8h.html#acf709ee71c580f1cd65d726ed03200ea">gsl_matrix_get</a>(all_models, ix, iy);
<a name="l01522"></a>01522                  <a class="code" href="aXe__grism_8h.html#a1f386ef5cd5a3b916246c2bee80f083a">gsl_matrix_set</a>(all_models, ix, iy, oldval+addval);
<a name="l01523"></a>01523                }
<a name="l01524"></a>01524              }
<a name="l01525"></a>01525          }
<a name="l01526"></a>01526 
<a name="l01527"></a>01527        fprintf(stdout, <span class="stringliteral">&quot; Done\n&quot;</span>);
<a name="l01528"></a>01528 
<a name="l01529"></a>01529        <span class="comment">// increment the counter</span>
<a name="l01530"></a>01530        i++;
<a name="l01531"></a>01531      }
<a name="l01532"></a>01532 
<a name="l01533"></a>01533    <span class="comment">// return the model</span>
<a name="l01534"></a>01534   <span class="keywordflow">return</span> all_models;
<a name="l01535"></a>01535 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a39fc258229e615e5b82c1f81b8c09bde"></a><!-- doxytag: member="spc_model.h::no_diffuse_spectrum" ref="a39fc258229e615e5b82c1f81b8c09bde" args="(int ix, int iy, double cps, beamspec *actspec)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int no_diffuse_spectrum </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>ix</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>iy</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>cps</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structbeamspec.html">beamspec</a> *&nbsp;</td>
          <td class="paramname"> <em>actspec</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Function no_diffuse_spectrum Adds the simulated flux for one pixel exactly into one pixel, using the integer value of the correct position.</p>
<p>Parameters: </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>ix</em>&nbsp;</td><td>- the integer x-position in the <a class="el" href="structbeam.html">beam</a> </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>iy</em>&nbsp;</td><td>- the integer y-position in the <a class="el" href="structbeam.html">beam</a> </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>cps</em>&nbsp;</td><td>- the cps-value for one entire pixel </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>actspec</em>&nbsp;</td><td>- the <a class="el" href="structbeam.html">beam</a> to model</td></tr>
  </table>
  </dd>
</dl>
<p>Returns: </p>
<dl class="return"><dt><b>Returns:</b></dt><dd>1.0 - return a dummy value </dd></dl>

<p><div class="fragment"><pre class="fragment"><a name="l01256"></a>01256 {
<a name="l01257"></a>01257   <span class="keywordtype">double</span> tmp  = 0.0;
<a name="l01258"></a>01258 
<a name="l01259"></a>01259   <span class="keywordflow">if</span> ( ! (ix &lt; 0 || iy &lt; 0 || ix &gt; (actspec-&gt;<a class="code" href="structbeamspec.html#a5585f5d3885305e980e09fed9a79a618">model</a>-&gt;size1-1) || iy &gt; (actspec-&gt;<a class="code" href="structbeamspec.html#a5585f5d3885305e980e09fed9a79a618">model</a>-&gt;size2-1)))
<a name="l01260"></a>01260   {
<a name="l01261"></a>01261     <span class="comment">// add the contribution of the actual dx value to the model spectrum</span>
<a name="l01262"></a>01262     tmp = <a class="code" href="aXe__grism_8h.html#acf709ee71c580f1cd65d726ed03200ea">gsl_matrix_get</a>(actspec-&gt;<a class="code" href="structbeamspec.html#a5585f5d3885305e980e09fed9a79a618">model</a>, ix, iy);
<a name="l01263"></a>01263 
<a name="l01264"></a>01264     <span class="comment">// set the new value</span>
<a name="l01265"></a>01265     <a class="code" href="aXe__grism_8h.html#a1f386ef5cd5a3b916246c2bee80f083a">gsl_matrix_set</a>(actspec-&gt;<a class="code" href="structbeamspec.html#a5585f5d3885305e980e09fed9a79a618">model</a>, ix, iy, cps + tmp);
<a name="l01266"></a>01266   }
<a name="l01267"></a>01267 
<a name="l01268"></a>01268   <span class="comment">// return a dummy</span>
<a name="l01269"></a>01269   <span class="keywordflow">return</span> 1;
<a name="l01270"></a>01270 }
</pre></div></p>

</div>
</div>
</div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&nbsp;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&nbsp;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr size="1"/><address style="text-align: right;"><small>Generated on 12 Oct 2014 for TIPS by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
