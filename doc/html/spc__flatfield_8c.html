<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>TIPS: /renoir/fourmano/Desktop/OUSIM/TIPS/branches/tips_build/src/axesim/spc_flatfield.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>/renoir/fourmano/Desktop/OUSIM/TIPS/branches/tips_build/src/axesim/spc_flatfield.c File Reference</h1><code>#include &quot;<a class="el" href="spc__flatfield_8h_source.html">spc_flatfield.h</a>&quot;</code><br/>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Namespaces</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">namespace &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacespc__flatfield.html">spc_flatfield</a></td></tr>
<tr><td colspan="2"><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="spc__flatfield_8c.html#ab649f643965f102de18156563d7e4485">MAX_FLATS</a>&nbsp;&nbsp;&nbsp;10</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="spc__flatfield_8c.html#aa7866fa5e4e0ee9b034e9dab6599a9cc">SQR</a>(x)&nbsp;&nbsp;&nbsp;((x)*(x))</td></tr>
<tr><td colspan="2"><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">gsl_matrix *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="spc__flatfield_8c.html#ae2aa85ce31eaebd4dc92e346ec6c4a6c">simulate_flatfield</a> (<a class="el" href="structs__flatfield.html">flatfield_d</a> *const flat, double stdev)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="structpoly__cube__flatfield.html">poly_cube_flatfield</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="spc__flatfield_8c.html#a83750e7a1e9eaf61ee280a730786f115">load_flat_poly_cube</a> (char *fname)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">double&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="spc__flatfield_8c.html#a453e895ac1865f71f8b5126a0bcfb519">poly_cube_flatfield_lambda</a> (const double lambda, const int x, const int y, <a class="el" href="structpoly__cube__flatfield.html">poly_cube_flatfield</a> *poly_cube)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="spc__flatfield_8c.html#ace74cc16d90b32b8af96da0408dc3c73">free_flat_poly_cube</a> (<a class="el" href="structpoly__cube__flatfield.html">poly_cube_flatfield</a> *poly_cube)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="spc__flatfield_8c.html#a227e9ce54a81906562b5e061fb17ddc5">flat_poly_func</a> (const double lambda, const int x, const int y, PIXEL_T *const val, PIXEL_T *const err, const <a class="el" href="structs__flatfield.html">flatfield_d</a> *const flat)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">gsl_matrix *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="spc__flatfield_8c.html#a1a2a238a4168103d4c9db69848e6fdd7">load_flatfield</a> (<a class="el" href="structs__flatfield.html">flatfield_d</a> *const flat, const char *const flat_name)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">gsl_matrix *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="spc__flatfield_8c.html#a0229b077b2df672da892c786e598710f">load_flatfield_errors</a> (<a class="el" href="structs__flatfield.html">flatfield_d</a> *const ff, const char *const flat_name)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="structs__flatfield.html">flatfield_d</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="spc__flatfield_8c.html#a61ceaeabc2a6965c33467d72546bd725">make_poly_flatfield</a> (const <a class="el" href="structbeam.html">beam</a> *const curbeam, const char *const flat_name, const int order, const double coeffs[])</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="spc__flatfield_8c.html#a03bd2122ca164d01776dbba8f479b72a">free_poly_flatfield</a> (<a class="el" href="structs__flatfield.html">flatfield_d</a> *flat)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="spc__flatfield_8c.html#ad05bdab9660f9325c11b117b254d42e1">flat_multi_func</a> (const double lambda, const int x, const int y, PIXEL_T *const val, PIXEL_T *const err, const <a class="el" href="structs__flatfield.html">flatfield_d</a> *const flat)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="structs__flatfield.html">flatfield_d</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="spc__flatfield_8c.html#a51dc63c9e14b10df5c589cbf97eedd20">make_multi_flatfield</a> (const <a class="el" href="structbeam.html">beam</a> *const curbeam, const int num_flats, const double lambda, const char *const flat_name,...)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="spc__flatfield_8c.html#acac9d4bc28ad40bd261f407ea697811e">free_multi_flatfield</a> (<a class="el" href="structs__flatfield.html">flatfield_d</a> *flat)</td></tr>
</table>
<hr/><h2>Define Documentation</h2>
<a class="anchor" id="ab649f643965f102de18156563d7e4485"></a><!-- doxytag: member="spc_flatfield.c::MAX_FLATS" ref="ab649f643965f102de18156563d7e4485" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define MAX_FLATS&nbsp;&nbsp;&nbsp;10</td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="aa7866fa5e4e0ee9b034e9dab6599a9cc"></a><!-- doxytag: member="spc_flatfield.c::SQR" ref="aa7866fa5e4e0ee9b034e9dab6599a9cc" args="(x)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define SQR</td>
          <td>(</td>
          <td class="paramtype">x&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td>&nbsp;&nbsp;&nbsp;((x)*(x))</td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="ad05bdab9660f9325c11b117b254d42e1"></a><!-- doxytag: member="spc_flatfield.c::flat_multi_func" ref="ad05bdab9660f9325c11b117b254d42e1" args="(const double lambda, const int x, const int y, PIXEL_T *const val, PIXEL_T *const err, const flatfield_d *const flat)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void flat_multi_func </td>
          <td>(</td>
          <td class="paramtype">const double&nbsp;</td>
          <td class="paramname"> <em>lambda</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const int&nbsp;</td>
          <td class="paramname"> <em>x</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const int&nbsp;</td>
          <td class="paramname"> <em>y</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PIXEL_T *const &nbsp;</td>
          <td class="paramname"> <em>val</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PIXEL_T *const &nbsp;</td>
          <td class="paramname"> <em>err</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structs__flatfield.html">flatfield_d</a> *const &nbsp;</td>
          <td class="paramname"> <em>flat</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>computes the relative efficiency of a pixel from a set of flatfields at various lambdas.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>lambda</em>&nbsp;</td><td>the wave length to assume </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>x</em>&nbsp;</td><td>x coordinate of the pixel in question relative to the origin of the entire image </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>y</em>&nbsp;</td><td>ditto for y </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>flat</em>&nbsp;</td><td>pointer to the flatfielding structure containing information for the aperture </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>relative efficiency for (x,y) </dd></dl>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000003">Todo:</a></b></dt><dd>check if the interpolation is good at the borders of the lambda range </dd></dl>

<p><div class="fragment"><pre class="fragment"><a name="l00356"></a>00356 {
<a name="l00357"></a>00357   <span class="keywordtype">int</span> i;
<a name="l00358"></a>00358   <span class="keywordtype">double</span> xvals[<a class="code" href="spc__flatfield_8c.html#ab649f643965f102de18156563d7e4485">MAX_FLATS</a>], yvals[<a class="code" href="spc__flatfield_8c.html#ab649f643965f102de18156563d7e4485">MAX_FLATS</a>];
<a name="l00359"></a>00359   <span class="comment">//gsl_interp_factory factory = gsl_interp_factory_cspline_natural;</span>
<a name="l00360"></a>00360   <span class="comment">//gsl_interp_obj *interpolator;</span>
<a name="l00361"></a>00361   <span class="comment">//gsl_interp_accel *accelerator;</span>
<a name="l00362"></a>00362   gsl_interp_accel *acc;
<a name="l00363"></a>00363   gsl_spline *spline;
<a name="l00364"></a>00364   <span class="keywordtype">double</span> d_val;
<a name="l00365"></a>00365   
<a name="l00366"></a>00366   <span class="keywordflow">for</span> (i = 0; i &lt; flat-&gt;<a class="code" href="structs__flatfield.html#a8f036c9091ac39aa9d42968bb770af09">data</a>.<a class="code" href="structs__flatfield.html#a34eb871ec49e718e1e1b87d5f219c18d">multi</a>-&gt;<a class="code" href="structmulti__flatfield.html#a1445b447b76505577b98dead719a86b7">num_flats</a>; i++)
<a name="l00367"></a>00367     {
<a name="l00368"></a>00368       xvals[i] = flat-&gt;<a class="code" href="structs__flatfield.html#a8f036c9091ac39aa9d42968bb770af09">data</a>.<a class="code" href="structs__flatfield.html#a34eb871ec49e718e1e1b87d5f219c18d">multi</a>-&gt;<a class="code" href="structmulti__flatfield.html#a174bf56a945c6149cb95ba3bcc2fcea7">lambdas</a>[i];
<a name="l00369"></a>00369       yvals[i] =
<a name="l00370"></a>00370         <a class="code" href="aXe__grism_8h.html#acf709ee71c580f1cd65d726ed03200ea">gsl_matrix_get</a> (flat-&gt;<a class="code" href="structs__flatfield.html#a8f036c9091ac39aa9d42968bb770af09">data</a>.<a class="code" href="structs__flatfield.html#a34eb871ec49e718e1e1b87d5f219c18d">multi</a>-&gt;<a class="code" href="structmulti__flatfield.html#ac18df4cfe74dac5ef4ae036ffc24bddd">flatfields</a>[i],
<a name="l00371"></a>00371                         x - flat-&gt;<a class="code" href="structs__flatfield.html#a1d7f7b9c4eff24588fe25d35f2a0e3ea">ll_x</a>, y - flat-&gt;<a class="code" href="structs__flatfield.html#affab7067e6e424adb423dc8de163bd5e">ll_y</a>);
<a name="l00372"></a>00372     }
<a name="l00373"></a>00373   <span class="comment">//interpolator = factory.create(xvals, yvals, flat-&gt;data.multi-&gt;num_flats); </span>
<a name="l00374"></a>00374   <span class="comment">//accelerator = gsl_interp_accel_new();</span>
<a name="l00375"></a>00375   <span class="comment">//gsl_interp_eval_impl(interpolator, xvals, yvals, </span>
<a name="l00376"></a>00376   <span class="comment">//  lambda, accelerator, &amp;d_val);</span>
<a name="l00377"></a>00377 
<a name="l00378"></a>00378   acc = gsl_interp_accel_alloc ();
<a name="l00379"></a>00379   spline =
<a name="l00380"></a>00380     gsl_spline_alloc (gsl_interp_cspline, flat-&gt;<a class="code" href="structs__flatfield.html#a8f036c9091ac39aa9d42968bb770af09">data</a>.<a class="code" href="structs__flatfield.html#a34eb871ec49e718e1e1b87d5f219c18d">multi</a>-&gt;<a class="code" href="structmulti__flatfield.html#a1445b447b76505577b98dead719a86b7">num_flats</a>);
<a name="l00381"></a>00381   gsl_spline_init (spline, xvals, yvals, flat-&gt;<a class="code" href="structs__flatfield.html#a8f036c9091ac39aa9d42968bb770af09">data</a>.<a class="code" href="structs__flatfield.html#a34eb871ec49e718e1e1b87d5f219c18d">multi</a>-&gt;<a class="code" href="structmulti__flatfield.html#a1445b447b76505577b98dead719a86b7">num_flats</a>);
<a name="l00382"></a>00382   d_val = gsl_spline_eval (spline, lambda, acc);
<a name="l00383"></a>00383   
<a name="l00384"></a>00384   *val = (<a class="code" href="aXe__grism_8h.html#ab4472600f4f77bd72e51d116ed5138ed">PIXEL_T</a>) d_val;
<a name="l00385"></a>00385   *err = 0;
<a name="l00386"></a>00386 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a227e9ce54a81906562b5e061fb17ddc5"></a><!-- doxytag: member="spc_flatfield.c::flat_poly_func" ref="a227e9ce54a81906562b5e061fb17ddc5" args="(const double lambda, const int x, const int y, PIXEL_T *const val, PIXEL_T *const err, const flatfield_d *const flat)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void flat_poly_func </td>
          <td>(</td>
          <td class="paramtype">const double&nbsp;</td>
          <td class="paramname"> <em>lambda</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const int&nbsp;</td>
          <td class="paramname"> <em>x</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const int&nbsp;</td>
          <td class="paramname"> <em>y</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PIXEL_T *const &nbsp;</td>
          <td class="paramname"> <em>val</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PIXEL_T *const &nbsp;</td>
          <td class="paramname"> <em>err</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structs__flatfield.html">flatfield_d</a> *const &nbsp;</td>
          <td class="paramname"> <em>flat</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>computes the relative efficiency of a pixel from a base flat field and a polynomial describing the wavelength dependence of the efficiency.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>lambda</em>&nbsp;</td><td>the wave length to assume </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>x</em>&nbsp;</td><td>x coordinate of the pixel in question relative to the origin of the entire image </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>y</em>&nbsp;</td><td>ditto for y </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>flat</em>&nbsp;</td><td>pointer to the flatfielding structure containing information for the ture </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>relative efficiency for (x,y) </dd></dl>

<p><div class="fragment"><pre class="fragment"><a name="l00164"></a>00164 {
<a name="l00165"></a>00165   <span class="keywordtype">int</span> i;
<a name="l00166"></a>00166   <span class="keywordtype">double</span> *coeffs = flat-&gt;<a class="code" href="structs__flatfield.html#a8f036c9091ac39aa9d42968bb770af09">data</a>.<a class="code" href="structs__flatfield.html#a15327899ebefeb485896f96b795d846e">poly</a>-&gt;<a class="code" href="structpolynom__flatfield.html#a1c036a8e0217763384459507643a5f80">poly_coeffs</a>;
<a name="l00167"></a>00167   <span class="keywordtype">double</span> res = 0;
<a name="l00168"></a>00168   
<a name="l00169"></a>00169   <span class="keywordflow">for</span> (i = flat-&gt;<a class="code" href="structs__flatfield.html#a8f036c9091ac39aa9d42968bb770af09">data</a>.<a class="code" href="structs__flatfield.html#a15327899ebefeb485896f96b795d846e">poly</a>-&gt;<a class="code" href="structpolynom__flatfield.html#adb6281055bfa0626320e1c79ca284a77">poly_order</a>; i &gt; 0; i--)
<a name="l00170"></a>00170     {
<a name="l00171"></a>00171       res += coeffs[i];
<a name="l00172"></a>00172       res *= lambda;
<a name="l00173"></a>00173     }
<a name="l00174"></a>00174   res += coeffs[0];
<a name="l00175"></a>00175   <span class="comment">//fprintf(stderr,&quot;poly: %f %f\n&quot;,res,gsl_matrix_get(flat-&gt;data.poly-&gt;flatfield,</span>
<a name="l00176"></a>00176   <span class="comment">//  x-flat-&gt;ll_x, y-flat-&gt;ll_y));</span>
<a name="l00177"></a>00177   
<a name="l00178"></a>00178   *val =
<a name="l00179"></a>00179     res * <a class="code" href="aXe__grism_8h.html#acf709ee71c580f1cd65d726ed03200ea">gsl_matrix_get</a> (flat-&gt;<a class="code" href="structs__flatfield.html#a8f036c9091ac39aa9d42968bb770af09">data</a>.<a class="code" href="structs__flatfield.html#a15327899ebefeb485896f96b795d846e">poly</a>-&gt;<a class="code" href="structpolynom__flatfield.html#a489ee68b385052b07372fa0ae768106c">flatfield</a>, x - flat-&gt;<a class="code" href="structs__flatfield.html#a1d7f7b9c4eff24588fe25d35f2a0e3ea">ll_x</a>,
<a name="l00180"></a>00180                                 y - flat-&gt;<a class="code" href="structs__flatfield.html#affab7067e6e424adb423dc8de163bd5e">ll_y</a>);
<a name="l00181"></a>00181   <span class="keywordflow">if</span> (flat-&gt;<a class="code" href="structs__flatfield.html#a8f036c9091ac39aa9d42968bb770af09">data</a>.<a class="code" href="structs__flatfield.html#a15327899ebefeb485896f96b795d846e">poly</a>-&gt;<a class="code" href="structpolynom__flatfield.html#a7cb096f2701bd64b8f57d27aef51e8ce">errors</a>)
<a name="l00182"></a>00182     {
<a name="l00183"></a>00183       *err =
<a name="l00184"></a>00184         <a class="code" href="aXe__grism_8h.html#acf709ee71c580f1cd65d726ed03200ea">gsl_matrix_get</a> (flat-&gt;<a class="code" href="structs__flatfield.html#a8f036c9091ac39aa9d42968bb770af09">data</a>.<a class="code" href="structs__flatfield.html#a15327899ebefeb485896f96b795d846e">poly</a>-&gt;<a class="code" href="structpolynom__flatfield.html#a7cb096f2701bd64b8f57d27aef51e8ce">errors</a>, x - flat-&gt;<a class="code" href="structs__flatfield.html#a1d7f7b9c4eff24588fe25d35f2a0e3ea">ll_x</a>,
<a name="l00185"></a>00185                         y - flat-&gt;<a class="code" href="structs__flatfield.html#affab7067e6e424adb423dc8de163bd5e">ll_y</a>);
<a name="l00186"></a>00186     }
<a name="l00187"></a>00187   <span class="keywordflow">else</span>
<a name="l00188"></a>00188     {
<a name="l00189"></a>00189       *err = 0;
<a name="l00190"></a>00190     }
<a name="l00191"></a>00191 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ace74cc16d90b32b8af96da0408dc3c73"></a><!-- doxytag: member="spc_flatfield.c::free_flat_poly_cube" ref="ace74cc16d90b32b8af96da0408dc3c73" args="(poly_cube_flatfield *poly_cube)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void free_flat_poly_cube </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structpoly__cube__flatfield.html">poly_cube_flatfield</a> *&nbsp;</td>
          <td class="paramname"> <em>poly_cube</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Completely frees up the space allocated to a gsl_matrix </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>poly_cube</em>&nbsp;</td><td>a pointer to a <a class="el" href="structpoly__cube__flatfield.html">poly_cube_flatfield</a> structure </td></tr>
  </table>
  </dd>
</dl>

<p><div class="fragment"><pre class="fragment"><a name="l00134"></a>00134 {
<a name="l00135"></a>00135   <span class="keywordtype">int</span> i=0;
<a name="l00136"></a>00136   
<a name="l00137"></a>00137   <span class="keywordflow">if</span> (poly_cube!=NULL) {
<a name="l00138"></a>00138     <span class="keywordflow">for</span> (i=0;i&lt;poly_cube-&gt;<a class="code" href="structpoly__cube__flatfield.html#a43ded1d19ab5c7a6d34ffc75788e6fdf">poly_order</a>;i++)
<a name="l00139"></a>00139       <a class="code" href="aXe__grism_8h.html#a61aa1d37853a90711852146f18d0b85f">gsl_matrix_free</a>(poly_cube-&gt;<a class="code" href="structpoly__cube__flatfield.html#a5e941be5d850641c8f11e35e48d9266e">coeffs</a>[i]);
<a name="l00140"></a>00140     free(poly_cube-&gt;<a class="code" href="structpoly__cube__flatfield.html#a5e941be5d850641c8f11e35e48d9266e">coeffs</a>);
<a name="l00141"></a>00141     <span class="keywordflow">if</span> (poly_cube) free(poly_cube);
<a name="l00142"></a>00142     poly_cube=NULL;
<a name="l00143"></a>00143   }
<a name="l00144"></a>00144 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="acac9d4bc28ad40bd261f407ea697811e"></a><!-- doxytag: member="spc_flatfield.c::free_multi_flatfield" ref="acac9d4bc28ad40bd261f407ea697811e" args="(flatfield_d *flat)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void free_multi_flatfield </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structs__flatfield.html">flatfield_d</a> *&nbsp;</td>
          <td class="paramname"> <em>flat</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>frees a flatfield consisting of multiple images and its assoicated data structures</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>flat</em>&nbsp;</td><td>the flatfield to free </td></tr>
  </table>
  </dd>
</dl>

<p><div class="fragment"><pre class="fragment"><a name="l00472"></a>00472 {
<a name="l00473"></a>00473   <span class="keywordtype">int</span> i;
<a name="l00474"></a>00474 
<a name="l00475"></a>00475   <span class="keywordflow">for</span> (i = 0; i &lt; flat-&gt;<a class="code" href="structs__flatfield.html#a8f036c9091ac39aa9d42968bb770af09">data</a>.<a class="code" href="structs__flatfield.html#a34eb871ec49e718e1e1b87d5f219c18d">multi</a>-&gt;<a class="code" href="structmulti__flatfield.html#a1445b447b76505577b98dead719a86b7">num_flats</a>; i++)
<a name="l00476"></a>00476     {
<a name="l00477"></a>00477       <a class="code" href="aXe__grism_8h.html#a61aa1d37853a90711852146f18d0b85f">gsl_matrix_free</a> (flat-&gt;<a class="code" href="structs__flatfield.html#a8f036c9091ac39aa9d42968bb770af09">data</a>.<a class="code" href="structs__flatfield.html#a34eb871ec49e718e1e1b87d5f219c18d">multi</a>-&gt;<a class="code" href="structmulti__flatfield.html#ac18df4cfe74dac5ef4ae036ffc24bddd">flatfields</a>[i]);
<a name="l00478"></a>00478       <span class="keywordflow">if</span> (flat-&gt;<a class="code" href="structs__flatfield.html#a8f036c9091ac39aa9d42968bb770af09">data</a>.<a class="code" href="structs__flatfield.html#a34eb871ec49e718e1e1b87d5f219c18d">multi</a>-&gt;<a class="code" href="structmulti__flatfield.html#a524bb3759060a0ac556ab8d6b1e0f146">errors</a>[i])
<a name="l00479"></a>00479         {
<a name="l00480"></a>00480           <a class="code" href="aXe__grism_8h.html#a61aa1d37853a90711852146f18d0b85f">gsl_matrix_free</a> (flat-&gt;<a class="code" href="structs__flatfield.html#a8f036c9091ac39aa9d42968bb770af09">data</a>.<a class="code" href="structs__flatfield.html#a34eb871ec49e718e1e1b87d5f219c18d">multi</a>-&gt;<a class="code" href="structmulti__flatfield.html#a524bb3759060a0ac556ab8d6b1e0f146">errors</a>[i]);
<a name="l00481"></a>00481         }
<a name="l00482"></a>00482     }
<a name="l00483"></a>00483   free (flat-&gt;<a class="code" href="structs__flatfield.html#a8f036c9091ac39aa9d42968bb770af09">data</a>.<a class="code" href="structs__flatfield.html#a34eb871ec49e718e1e1b87d5f219c18d">multi</a>-&gt;<a class="code" href="structmulti__flatfield.html#ac18df4cfe74dac5ef4ae036ffc24bddd">flatfields</a>);
<a name="l00484"></a>00484   flat-&gt;<a class="code" href="structs__flatfield.html#a8f036c9091ac39aa9d42968bb770af09">data</a>.<a class="code" href="structs__flatfield.html#a34eb871ec49e718e1e1b87d5f219c18d">multi</a>-&gt;<a class="code" href="structmulti__flatfield.html#ac18df4cfe74dac5ef4ae036ffc24bddd">flatfields</a> = NULL;
<a name="l00485"></a>00485   free (flat-&gt;<a class="code" href="structs__flatfield.html#a8f036c9091ac39aa9d42968bb770af09">data</a>.<a class="code" href="structs__flatfield.html#a34eb871ec49e718e1e1b87d5f219c18d">multi</a>-&gt;<a class="code" href="structmulti__flatfield.html#a524bb3759060a0ac556ab8d6b1e0f146">errors</a>);
<a name="l00486"></a>00486   flat-&gt;<a class="code" href="structs__flatfield.html#a8f036c9091ac39aa9d42968bb770af09">data</a>.<a class="code" href="structs__flatfield.html#a34eb871ec49e718e1e1b87d5f219c18d">multi</a>-&gt;<a class="code" href="structmulti__flatfield.html#a524bb3759060a0ac556ab8d6b1e0f146">errors</a> = NULL;
<a name="l00487"></a>00487   free (flat-&gt;<a class="code" href="structs__flatfield.html#a8f036c9091ac39aa9d42968bb770af09">data</a>.<a class="code" href="structs__flatfield.html#a34eb871ec49e718e1e1b87d5f219c18d">multi</a>-&gt;<a class="code" href="structmulti__flatfield.html#a174bf56a945c6149cb95ba3bcc2fcea7">lambdas</a>);
<a name="l00488"></a>00488   flat-&gt;<a class="code" href="structs__flatfield.html#a8f036c9091ac39aa9d42968bb770af09">data</a>.<a class="code" href="structs__flatfield.html#a34eb871ec49e718e1e1b87d5f219c18d">multi</a>-&gt;<a class="code" href="structmulti__flatfield.html#a174bf56a945c6149cb95ba3bcc2fcea7">lambdas</a> = NULL;
<a name="l00489"></a>00489   free (flat-&gt;<a class="code" href="structs__flatfield.html#a8f036c9091ac39aa9d42968bb770af09">data</a>.<a class="code" href="structs__flatfield.html#a34eb871ec49e718e1e1b87d5f219c18d">multi</a>);
<a name="l00490"></a>00490   flat-&gt;<a class="code" href="structs__flatfield.html#a8f036c9091ac39aa9d42968bb770af09">data</a>.<a class="code" href="structs__flatfield.html#a34eb871ec49e718e1e1b87d5f219c18d">multi</a> = NULL;
<a name="l00491"></a>00491   free (flat);
<a name="l00492"></a>00492   flat = NULL;
<a name="l00493"></a>00493 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a03bd2122ca164d01776dbba8f479b72a"></a><!-- doxytag: member="spc_flatfield.c::free_poly_flatfield" ref="a03bd2122ca164d01776dbba8f479b72a" args="(flatfield_d *flat)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void free_poly_flatfield </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structs__flatfield.html">flatfield_d</a> *&nbsp;</td>
          <td class="paramname"> <em>flat</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>frees a polynom flatfield and its assoicated data structures</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>flat</em>&nbsp;</td><td>the flatfield to free </td></tr>
  </table>
  </dd>
</dl>

<p><div class="fragment"><pre class="fragment"><a name="l00324"></a>00324 {
<a name="l00325"></a>00325   <a class="code" href="aXe__grism_8h.html#a61aa1d37853a90711852146f18d0b85f">gsl_matrix_free</a> (flat-&gt;<a class="code" href="structs__flatfield.html#a8f036c9091ac39aa9d42968bb770af09">data</a>.<a class="code" href="structs__flatfield.html#a15327899ebefeb485896f96b795d846e">poly</a>-&gt;<a class="code" href="structpolynom__flatfield.html#a489ee68b385052b07372fa0ae768106c">flatfield</a>);
<a name="l00326"></a>00326   <span class="keywordflow">if</span> (flat-&gt;<a class="code" href="structs__flatfield.html#a8f036c9091ac39aa9d42968bb770af09">data</a>.<a class="code" href="structs__flatfield.html#a15327899ebefeb485896f96b795d846e">poly</a>-&gt;<a class="code" href="structpolynom__flatfield.html#a7cb096f2701bd64b8f57d27aef51e8ce">errors</a>)
<a name="l00327"></a>00327     {
<a name="l00328"></a>00328       <a class="code" href="aXe__grism_8h.html#a61aa1d37853a90711852146f18d0b85f">gsl_matrix_free</a> (flat-&gt;<a class="code" href="structs__flatfield.html#a8f036c9091ac39aa9d42968bb770af09">data</a>.<a class="code" href="structs__flatfield.html#a15327899ebefeb485896f96b795d846e">poly</a>-&gt;<a class="code" href="structpolynom__flatfield.html#a7cb096f2701bd64b8f57d27aef51e8ce">errors</a>);
<a name="l00329"></a>00329     }
<a name="l00330"></a>00330   free (flat-&gt;<a class="code" href="structs__flatfield.html#a8f036c9091ac39aa9d42968bb770af09">data</a>.<a class="code" href="structs__flatfield.html#a15327899ebefeb485896f96b795d846e">poly</a>-&gt;<a class="code" href="structpolynom__flatfield.html#a1c036a8e0217763384459507643a5f80">poly_coeffs</a>);
<a name="l00331"></a>00331   flat-&gt;<a class="code" href="structs__flatfield.html#a8f036c9091ac39aa9d42968bb770af09">data</a>.<a class="code" href="structs__flatfield.html#a15327899ebefeb485896f96b795d846e">poly</a>-&gt;<a class="code" href="structpolynom__flatfield.html#a1c036a8e0217763384459507643a5f80">poly_coeffs</a> = NULL;
<a name="l00332"></a>00332   free (flat-&gt;<a class="code" href="structs__flatfield.html#a8f036c9091ac39aa9d42968bb770af09">data</a>.<a class="code" href="structs__flatfield.html#a15327899ebefeb485896f96b795d846e">poly</a>);
<a name="l00333"></a>00333   flat-&gt;<a class="code" href="structs__flatfield.html#a8f036c9091ac39aa9d42968bb770af09">data</a>.<a class="code" href="structs__flatfield.html#a15327899ebefeb485896f96b795d846e">poly</a> = NULL;
<a name="l00334"></a>00334   free (flat);
<a name="l00335"></a>00335   flat = NULL;
<a name="l00336"></a>00336 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a83750e7a1e9eaf61ee280a730786f115"></a><!-- doxytag: member="spc_flatfield.c::load_flat_poly_cube" ref="a83750e7a1e9eaf61ee280a730786f115" args="(char *fname)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structpoly__cube__flatfield.html">poly_cube_flatfield</a>* load_flat_poly_cube </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>fname</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Load and return a gsl cube whose planes (z-direction) contain the coefficients of a polynomial of the form ff(i,j,lambda) = a0+a1*lambda+...</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>fname</em>&nbsp;</td><td>the name of a flat cube to read and load</td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>a pointer to a NULL terminated array of gsl_matrix </dd></dl>

<p><div class="fragment"><pre class="fragment"><a name="l00051"></a>00051 {
<a name="l00052"></a>00052   <span class="keywordtype">int</span> i;
<a name="l00053"></a>00053   <span class="keywordtype">int</span> order = 0;
<a name="l00054"></a>00054   <a class="code" href="structpoly__cube__flatfield.html">poly_cube_flatfield</a> *poly_cube;
<a name="l00055"></a>00055     
<a name="l00056"></a>00056   <span class="comment">/* Getting the number of extension sin the file */</span>
<a name="l00057"></a>00057   order = <a class="code" href="aXe__utils_8c.html#a791e8209e46381315c39a27890280053">FITSextnum</a>(fname);
<a name="l00058"></a>00058     
<a name="l00059"></a>00059   <span class="comment">/* Allocating the memory */</span>
<a name="l00060"></a>00060   poly_cube = (<a class="code" href="structpoly__cube__flatfield.html">poly_cube_flatfield</a> *) malloc(<span class="keyword">sizeof</span>(<a class="code" href="structpoly__cube__flatfield.html">poly_cube_flatfield</a>));
<a name="l00061"></a>00061   poly_cube-&gt;<a class="code" href="structpoly__cube__flatfield.html#a43ded1d19ab5c7a6d34ffc75788e6fdf">poly_order</a> = order;
<a name="l00062"></a>00062   poly_cube-&gt;<a class="code" href="structpoly__cube__flatfield.html#a5e941be5d850641c8f11e35e48d9266e">coeffs</a> = (<a class="code" href="aXe__grism_8h.html#a6117e17bb3108107676f4486e62d40e5">gsl_matrix</a> **) malloc(poly_cube-&gt;<a class="code" href="structpoly__cube__flatfield.html#a43ded1d19ab5c7a6d34ffc75788e6fdf">poly_order</a> * <span class="keyword">sizeof</span>(<a class="code" href="aXe__grism_8h.html#a6117e17bb3108107676f4486e62d40e5">gsl_matrix</a> *));
<a name="l00063"></a>00063   
<a name="l00064"></a>00064   <span class="comment">/* Load the FF coefficients, on eplane at a time */</span>
<a name="l00065"></a>00065   <span class="keywordflow">for</span> (i=0;i&lt;poly_cube-&gt;<a class="code" href="structpoly__cube__flatfield.html#a43ded1d19ab5c7a6d34ffc75788e6fdf">poly_order</a>;i++)  
<a name="l00066"></a>00066     {
<a name="l00067"></a>00067       poly_cube-&gt;<a class="code" href="structpoly__cube__flatfield.html#a5e941be5d850641c8f11e35e48d9266e">coeffs</a>[i] = <a class="code" href="aXe__utils_8c.html#ae608ee7bf2717c17c842cd3dfd327884">FITSimage_to_gsl</a> (fname, i+1, 1);
<a name="l00068"></a>00068     }
<a name="l00069"></a>00069   <span class="comment">/* Load the minimum and maximum wavelengths this cube applies to */</span>
<a name="l00070"></a>00070   poly_cube-&gt;<a class="code" href="structpoly__cube__flatfield.html#a1ffb6722301a4c505bf12fa1b465ba40">wmin</a> = <a class="code" href="aXe__utils_8c.html#a8817e86558786acb16965f3ac1215992">get_float_from_keyword</a>(fname, 1, <span class="stringliteral">&quot;WMIN&quot;</span>);
<a name="l00071"></a>00071   poly_cube-&gt;<a class="code" href="structpoly__cube__flatfield.html#a84506df8267a17616949e9f34424dd62">wmax</a> = <a class="code" href="aXe__utils_8c.html#a8817e86558786acb16965f3ac1215992">get_float_from_keyword</a>(fname, 1, <span class="stringliteral">&quot;WMAX&quot;</span>);
<a name="l00072"></a>00072   
<a name="l00073"></a>00073   <span class="keywordflow">return</span> poly_cube;
<a name="l00074"></a>00074 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a1a2a238a4168103d4c9db69848e6fdd7"></a><!-- doxytag: member="spc_flatfield.c::load_flatfield" ref="a1a2a238a4168103d4c9db69848e6fdd7" args="(flatfield_d *const flat, const char *const flat_name)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">gsl_matrix* load_flatfield </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structs__flatfield.html">flatfield_d</a> *const &nbsp;</td>
          <td class="paramname"> <em>flat</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *const &nbsp;</td>
          <td class="paramname"> <em>flat_name</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>loads (a part) of a flatfield file</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>flat</em>&nbsp;</td><td>a pointer to the flatfield descriptor </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>flat_name</em>&nbsp;</td><td>the name of the file containing the flat field </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>a pointer to a gsl_matrix containing the relative efficiencies for each pixel in the bbox defined in flat </dd></dl>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000001">Todo:</a></b></dt><dd>do real fits io </dd></dl>

<p><div class="fragment"><pre class="fragment"><a name="l00205"></a>00205 {
<a name="l00206"></a>00206   <a class="code" href="aXe__grism_8h.html#a6117e17bb3108107676f4486e62d40e5">gsl_matrix</a> *flat_pixels;
<a name="l00207"></a>00207   
<a name="l00208"></a>00208   <span class="keywordflow">if</span> (!flat_name)
<a name="l00209"></a>00209     {
<a name="l00210"></a>00210       flat_pixels = <a class="code" href="spc__flatfield_8c.html#ae2aa85ce31eaebd4dc92e346ec6c4a6c">simulate_flatfield</a> (flat, 0.);
<a name="l00211"></a>00211     }
<a name="l00212"></a>00212   <span class="keywordflow">else</span>
<a name="l00213"></a>00213     {
<a name="l00214"></a>00214       flat_pixels = NULL;
<a name="l00215"></a>00215       <a class="code" href="aXe__errors_8c.html#a7ef7588e5f91237ba7ce4084e6ed3c11">aXe_message</a> (<a class="code" href="aXe__errors_8h.html#a2556a67874555249b07691c37aa6d6e9">aXe_M_FATAL</a>, __FILE__, __LINE__,
<a name="l00216"></a>00216                    <span class="stringliteral">&quot;FITS loading for flatfields not yet implemented&quot;</span>);
<a name="l00217"></a>00217     }
<a name="l00218"></a>00218   <span class="keywordflow">return</span> flat_pixels;
<a name="l00219"></a>00219 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a0229b077b2df672da892c786e598710f"></a><!-- doxytag: member="spc_flatfield.c::load_flatfield_errors" ref="a0229b077b2df672da892c786e598710f" args="(flatfield_d *const ff, const char *const flat_name)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">gsl_matrix* load_flatfield_errors </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structs__flatfield.html">flatfield_d</a> *const &nbsp;</td>
          <td class="paramname"> <em>ff</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *const &nbsp;</td>
          <td class="paramname"> <em>flat_name</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>loads (a part) of the error extension from a flatfield file</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>flat</em>&nbsp;</td><td>a pointer to the flatfield function containing the bounding box </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>flat_name</em>&nbsp;</td><td>the name of the file containing the flat field </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>a pointer to a gsl_matrix containing the relative efficiencies for each pixel in the bbox defined in flat </dd></dl>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000002">Todo:</a></b></dt><dd>do real fits io </dd></dl>

<p><div class="fragment"><pre class="fragment"><a name="l00234"></a>00234 {
<a name="l00235"></a>00235   <a class="code" href="aXe__grism_8h.html#a6117e17bb3108107676f4486e62d40e5">gsl_matrix</a> *err_pixels;
<a name="l00236"></a>00236   
<a name="l00237"></a>00237   <span class="keywordflow">if</span> (!flat_name)
<a name="l00238"></a>00238     {
<a name="l00239"></a>00239       <span class="keywordtype">int</span> i, j;
<a name="l00240"></a>00240       
<a name="l00241"></a>00241       err_pixels =
<a name="l00242"></a>00242         <a class="code" href="aXe__grism_8h.html#a1214ab1bea5fd80474d7a27db0bfb429">gsl_matrix_alloc</a> (ff-&gt;<a class="code" href="structs__flatfield.html#a8f036c9091ac39aa9d42968bb770af09">data</a>.<a class="code" href="structs__flatfield.html#a15327899ebefeb485896f96b795d846e">poly</a>-&gt;<a class="code" href="structpolynom__flatfield.html#a489ee68b385052b07372fa0ae768106c">flatfield</a>-&gt;size1,
<a name="l00243"></a>00243                           ff-&gt;<a class="code" href="structs__flatfield.html#a8f036c9091ac39aa9d42968bb770af09">data</a>.<a class="code" href="structs__flatfield.html#a15327899ebefeb485896f96b795d846e">poly</a>-&gt;<a class="code" href="structpolynom__flatfield.html#a489ee68b385052b07372fa0ae768106c">flatfield</a>-&gt;size2);
<a name="l00244"></a>00244       <span class="keywordflow">for</span> (i = 0; i &lt; err_pixels-&gt;size1; i++)
<a name="l00245"></a>00245         {
<a name="l00246"></a>00246           <span class="keywordflow">for</span> (j = 0; j &lt; err_pixels-&gt;size2; j++)
<a name="l00247"></a>00247             {
<a name="l00248"></a>00248               <span class="comment">//gsl_matrix_set(err_pixels, i, j, </span>
<a name="l00249"></a>00249               <span class="comment">//  1-gsl_matrix_get(ff-&gt;data.poly-&gt;flatfield, i, j));</span>
<a name="l00250"></a>00250               <a class="code" href="aXe__grism_8h.html#a1f386ef5cd5a3b916246c2bee80f083a">gsl_matrix_set</a> (err_pixels, i, j, .01);
<a name="l00251"></a>00251             }
<a name="l00252"></a>00252         }
<a name="l00253"></a>00253     }
<a name="l00254"></a>00254   <span class="keywordflow">else</span>
<a name="l00255"></a>00255     {
<a name="l00256"></a>00256       err_pixels = NULL;
<a name="l00257"></a>00257       <a class="code" href="aXe__errors_8c.html#a7ef7588e5f91237ba7ce4084e6ed3c11">aXe_message</a> (<a class="code" href="aXe__errors_8h.html#a2556a67874555249b07691c37aa6d6e9">aXe_M_FATAL</a>, __FILE__, __LINE__,
<a name="l00258"></a>00258                    <span class="stringliteral">&quot;FITS loading for flatfields not yet implemented&quot;</span>);
<a name="l00259"></a>00259     }
<a name="l00260"></a>00260   <span class="keywordflow">return</span> err_pixels;
<a name="l00261"></a>00261 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a51dc63c9e14b10df5c589cbf97eedd20"></a><!-- doxytag: member="spc_flatfield.c::make_multi_flatfield" ref="a51dc63c9e14b10df5c589cbf97eedd20" args="(const beam *const curbeam, const int num_flats, const double lambda, const char *const flat_name,...)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structs__flatfield.html">flatfield_d</a>* make_multi_flatfield </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="structbeam.html">beam</a> *const &nbsp;</td>
          <td class="paramname"> <em>curbeam</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const int&nbsp;</td>
          <td class="paramname"> <em>num_flats</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const double&nbsp;</td>
          <td class="paramname"> <em>lambda</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *const &nbsp;</td>
          <td class="paramname"> <em>flat_name</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&nbsp;</td>
          <td class="paramname"> <em>...</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>creates a descriptor for a flatfield with multiple flatfields at various wavelengths</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>curbeam</em>&nbsp;</td><td>the <a class="el" href="structbeam.html">beam</a> to create the flatfield for, with the bbox filled out (e.g., after <a class="el" href="namespacespc__extract.html">spc_extract</a> has run) </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>num_flats</em>&nbsp;</td><td>the number of (lambda,flatfield) pairs </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>lambda</em>&nbsp;</td><td>(and the next num_flats odd parameters) the wave length of the following flat field </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>flat_name</em>&nbsp;</td><td>(and the next num_flats even parameters) name of the flat field </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>an allocated flatfield descriptor </dd></dl>

<p><div class="fragment"><pre class="fragment"><a name="l00405"></a>00405 {
<a name="l00406"></a>00406   <a class="code" href="structs__flatfield.html">flatfield_d</a> *ff = malloc (<span class="keyword">sizeof</span> (<a class="code" href="structs__flatfield.html">flatfield_d</a>));
<a name="l00407"></a>00407   va_list args;
<a name="l00408"></a>00408   <span class="keywordtype">int</span> i;
<a name="l00409"></a>00409   
<a name="l00410"></a>00410   <span class="keywordflow">if</span> (num_flats &lt; 3)
<a name="l00411"></a>00411     {
<a name="l00412"></a>00412       <a class="code" href="aXe__errors_8c.html#a7ef7588e5f91237ba7ce4084e6ed3c11">aXe_message</a> (<a class="code" href="aXe__errors_8h.html#a2556a67874555249b07691c37aa6d6e9">aXe_M_FATAL</a>, __FILE__, __LINE__,
<a name="l00413"></a>00413                    <span class="stringliteral">&quot;Number of flats must be&quot;</span> <span class="stringliteral">&quot; larger than 3.&quot;</span>);
<a name="l00414"></a>00414     }
<a name="l00415"></a>00415   <span class="keywordflow">if</span> (num_flats &gt; <a class="code" href="spc__flatfield_8c.html#ab649f643965f102de18156563d7e4485">MAX_FLATS</a>)
<a name="l00416"></a>00416     {
<a name="l00417"></a>00417       <a class="code" href="aXe__errors_8c.html#a7ef7588e5f91237ba7ce4084e6ed3c11">aXe_message</a> (<a class="code" href="aXe__errors_8h.html#a2556a67874555249b07691c37aa6d6e9">aXe_M_FATAL</a>, __FILE__, __LINE__,
<a name="l00418"></a>00418                    <span class="stringliteral">&quot;Too many flatfields.&quot;</span> <span class="stringliteral">&quot; Increase MAX_FLATS in &quot;</span>
<a name="l00419"></a>00419                    __FILE__ <span class="stringliteral">&quot; and recompile me.&quot;</span>);
<a name="l00420"></a>00420     }
<a name="l00421"></a>00421   
<a name="l00422"></a>00422   <span class="keywordflow">if</span> (!ff)
<a name="l00423"></a>00423     {
<a name="l00424"></a>00424       <a class="code" href="aXe__errors_8c.html#a7ef7588e5f91237ba7ce4084e6ed3c11">aXe_message</a> (<a class="code" href="aXe__errors_8h.html#a2556a67874555249b07691c37aa6d6e9">aXe_M_FATAL</a>, __FILE__, __LINE__, <span class="stringliteral">&quot;Out of memory&quot;</span>);
<a name="l00425"></a>00425     }
<a name="l00426"></a>00426   ff-&gt;<a class="code" href="structs__flatfield.html#a1d7f7b9c4eff24588fe25d35f2a0e3ea">ll_x</a> = curbeam-&gt;<a class="code" href="structbeam.html#aa703d04290c347c35197ff52993b98f3">bbox</a>[0].<a class="code" href="structpx__point.html#ab715a558731a820a25b50bd7797dd004">x</a>;
<a name="l00427"></a>00427   ff-&gt;<a class="code" href="structs__flatfield.html#affab7067e6e424adb423dc8de163bd5e">ll_y</a> = curbeam-&gt;<a class="code" href="structbeam.html#aa703d04290c347c35197ff52993b98f3">bbox</a>[0].<a class="code" href="structpx__point.html#a2d02b900722a71f22a8d5100822bda61">y</a>;
<a name="l00428"></a>00428   ff-&gt;<a class="code" href="structs__flatfield.html#a06769e5af56e9be88885af9cd2e25dd9">w</a> = curbeam-&gt;<a class="code" href="structbeam.html#aa703d04290c347c35197ff52993b98f3">bbox</a>[1].<a class="code" href="structpx__point.html#ab715a558731a820a25b50bd7797dd004">x</a> - curbeam-&gt;<a class="code" href="structbeam.html#aa703d04290c347c35197ff52993b98f3">bbox</a>[0].<a class="code" href="structpx__point.html#ab715a558731a820a25b50bd7797dd004">x</a> + 1;
<a name="l00429"></a>00429   ff-&gt;<a class="code" href="structs__flatfield.html#a8d217598ba3babf676e72e2d8e1d5068">h</a> = curbeam-&gt;<a class="code" href="structbeam.html#aa703d04290c347c35197ff52993b98f3">bbox</a>[1].<a class="code" href="structpx__point.html#a2d02b900722a71f22a8d5100822bda61">y</a> - curbeam-&gt;<a class="code" href="structbeam.html#aa703d04290c347c35197ff52993b98f3">bbox</a>[0].<a class="code" href="structpx__point.html#a2d02b900722a71f22a8d5100822bda61">y</a> + 1;
<a name="l00430"></a>00430   ff-&gt;<a class="code" href="structs__flatfield.html#a27ed375a08ad88a9a25ab15f1186daba">func</a> = <a class="code" href="spc__flatfield_8c.html#ad05bdab9660f9325c11b117b254d42e1">flat_multi_func</a>;
<a name="l00431"></a>00431   
<a name="l00432"></a>00432   ff-&gt;<a class="code" href="structs__flatfield.html#a8f036c9091ac39aa9d42968bb770af09">data</a>.<a class="code" href="structs__flatfield.html#a34eb871ec49e718e1e1b87d5f219c18d">multi</a> = malloc (<span class="keyword">sizeof</span> (<a class="code" href="structmulti__flatfield.html">multi_flatfield</a>));
<a name="l00433"></a>00433   <span class="keywordflow">if</span> (!ff-&gt;<a class="code" href="structs__flatfield.html#a8f036c9091ac39aa9d42968bb770af09">data</a>.<a class="code" href="structs__flatfield.html#a34eb871ec49e718e1e1b87d5f219c18d">multi</a>)
<a name="l00434"></a>00434     {
<a name="l00435"></a>00435       <a class="code" href="aXe__errors_8c.html#a7ef7588e5f91237ba7ce4084e6ed3c11">aXe_message</a> (<a class="code" href="aXe__errors_8h.html#a2556a67874555249b07691c37aa6d6e9">aXe_M_FATAL</a>, __FILE__, __LINE__, <span class="stringliteral">&quot;Out of memory&quot;</span>);
<a name="l00436"></a>00436     }
<a name="l00437"></a>00437   ff-&gt;<a class="code" href="structs__flatfield.html#a8f036c9091ac39aa9d42968bb770af09">data</a>.<a class="code" href="structs__flatfield.html#a34eb871ec49e718e1e1b87d5f219c18d">multi</a>-&gt;<a class="code" href="structmulti__flatfield.html#a1445b447b76505577b98dead719a86b7">num_flats</a> = num_flats;
<a name="l00438"></a>00438   ff-&gt;<a class="code" href="structs__flatfield.html#a8f036c9091ac39aa9d42968bb770af09">data</a>.<a class="code" href="structs__flatfield.html#a34eb871ec49e718e1e1b87d5f219c18d">multi</a>-&gt;<a class="code" href="structmulti__flatfield.html#a524bb3759060a0ac556ab8d6b1e0f146">errors</a> = malloc (<span class="keyword">sizeof</span> (<a class="code" href="aXe__grism_8h.html#a6117e17bb3108107676f4486e62d40e5">gsl_matrix</a> *) * num_flats);
<a name="l00439"></a>00439   ff-&gt;<a class="code" href="structs__flatfield.html#a8f036c9091ac39aa9d42968bb770af09">data</a>.<a class="code" href="structs__flatfield.html#a34eb871ec49e718e1e1b87d5f219c18d">multi</a>-&gt;<a class="code" href="structmulti__flatfield.html#ac18df4cfe74dac5ef4ae036ffc24bddd">flatfields</a> = malloc (<span class="keyword">sizeof</span> (<a class="code" href="aXe__grism_8h.html#a6117e17bb3108107676f4486e62d40e5">gsl_matrix</a> *) * num_flats);
<a name="l00440"></a>00440   ff-&gt;<a class="code" href="structs__flatfield.html#a8f036c9091ac39aa9d42968bb770af09">data</a>.<a class="code" href="structs__flatfield.html#a34eb871ec49e718e1e1b87d5f219c18d">multi</a>-&gt;<a class="code" href="structmulti__flatfield.html#a174bf56a945c6149cb95ba3bcc2fcea7">lambdas</a> = malloc (<span class="keyword">sizeof</span> (<span class="keywordtype">double</span>) * num_flats);
<a name="l00441"></a>00441   <span class="keywordflow">if</span> ((!ff-&gt;<a class="code" href="structs__flatfield.html#a8f036c9091ac39aa9d42968bb770af09">data</a>.<a class="code" href="structs__flatfield.html#a34eb871ec49e718e1e1b87d5f219c18d">multi</a>-&gt;<a class="code" href="structmulti__flatfield.html#a524bb3759060a0ac556ab8d6b1e0f146">errors</a>) || (!ff-&gt;<a class="code" href="structs__flatfield.html#a8f036c9091ac39aa9d42968bb770af09">data</a>.<a class="code" href="structs__flatfield.html#a34eb871ec49e718e1e1b87d5f219c18d">multi</a>-&gt;<a class="code" href="structmulti__flatfield.html#ac18df4cfe74dac5ef4ae036ffc24bddd">flatfields</a>)
<a name="l00442"></a>00442       || (!ff-&gt;<a class="code" href="structs__flatfield.html#a8f036c9091ac39aa9d42968bb770af09">data</a>.<a class="code" href="structs__flatfield.html#a34eb871ec49e718e1e1b87d5f219c18d">multi</a>-&gt;<a class="code" href="structmulti__flatfield.html#a174bf56a945c6149cb95ba3bcc2fcea7">lambdas</a>))
<a name="l00443"></a>00443     {
<a name="l00444"></a>00444       <a class="code" href="aXe__errors_8c.html#a7ef7588e5f91237ba7ce4084e6ed3c11">aXe_message</a> (<a class="code" href="aXe__errors_8h.html#a2556a67874555249b07691c37aa6d6e9">aXe_M_FATAL</a>, __FILE__, __LINE__, <span class="stringliteral">&quot;Out of memory&quot;</span>);
<a name="l00445"></a>00445     }
<a name="l00446"></a>00446   
<a name="l00447"></a>00447   ff-&gt;<a class="code" href="structs__flatfield.html#a8f036c9091ac39aa9d42968bb770af09">data</a>.<a class="code" href="structs__flatfield.html#a34eb871ec49e718e1e1b87d5f219c18d">multi</a>-&gt;<a class="code" href="structmulti__flatfield.html#a174bf56a945c6149cb95ba3bcc2fcea7">lambdas</a>[0] = lambda;
<a name="l00448"></a>00448   ff-&gt;<a class="code" href="structs__flatfield.html#a8f036c9091ac39aa9d42968bb770af09">data</a>.<a class="code" href="structs__flatfield.html#a34eb871ec49e718e1e1b87d5f219c18d">multi</a>-&gt;<a class="code" href="structmulti__flatfield.html#ac18df4cfe74dac5ef4ae036ffc24bddd">flatfields</a>[0] = <a class="code" href="spc__flatfield_8c.html#a1a2a238a4168103d4c9db69848e6fdd7">load_flatfield</a> (ff, flat_name);
<a name="l00449"></a>00449   ff-&gt;<a class="code" href="structs__flatfield.html#a8f036c9091ac39aa9d42968bb770af09">data</a>.<a class="code" href="structs__flatfield.html#a34eb871ec49e718e1e1b87d5f219c18d">multi</a>-&gt;<a class="code" href="structmulti__flatfield.html#a524bb3759060a0ac556ab8d6b1e0f146">errors</a>[0] = NULL;
<a name="l00450"></a>00450   va_start (args, flat_name);
<a name="l00451"></a>00451   <span class="keywordflow">for</span> (i = 1; i &lt; num_flats; i++)
<a name="l00452"></a>00452     {
<a name="l00453"></a>00453       ff-&gt;<a class="code" href="structs__flatfield.html#a8f036c9091ac39aa9d42968bb770af09">data</a>.<a class="code" href="structs__flatfield.html#a34eb871ec49e718e1e1b87d5f219c18d">multi</a>-&gt;<a class="code" href="structmulti__flatfield.html#a174bf56a945c6149cb95ba3bcc2fcea7">lambdas</a>[i] = va_arg (args, <span class="keywordtype">double</span>);
<a name="l00454"></a>00454       ff-&gt;<a class="code" href="structs__flatfield.html#a8f036c9091ac39aa9d42968bb770af09">data</a>.<a class="code" href="structs__flatfield.html#a34eb871ec49e718e1e1b87d5f219c18d">multi</a>-&gt;<a class="code" href="structmulti__flatfield.html#ac18df4cfe74dac5ef4ae036ffc24bddd">flatfields</a>[i] =
<a name="l00455"></a>00455         <a class="code" href="spc__flatfield_8c.html#a1a2a238a4168103d4c9db69848e6fdd7">load_flatfield</a> (ff, va_arg (args, <span class="keywordtype">char</span> *));
<a name="l00456"></a>00456       ff-&gt;<a class="code" href="structs__flatfield.html#a8f036c9091ac39aa9d42968bb770af09">data</a>.<a class="code" href="structs__flatfield.html#a34eb871ec49e718e1e1b87d5f219c18d">multi</a>-&gt;<a class="code" href="structmulti__flatfield.html#a524bb3759060a0ac556ab8d6b1e0f146">errors</a>[i] = NULL;
<a name="l00457"></a>00457     }
<a name="l00458"></a>00458   va_end (args);
<a name="l00459"></a>00459   
<a name="l00460"></a>00460   <span class="keywordflow">return</span> ff;
<a name="l00461"></a>00461 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a61ceaeabc2a6965c33467d72546bd725"></a><!-- doxytag: member="spc_flatfield.c::make_poly_flatfield" ref="a61ceaeabc2a6965c33467d72546bd725" args="(const beam *const curbeam, const char *const flat_name, const int order, const double coeffs[])" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structs__flatfield.html">flatfield_d</a>* make_poly_flatfield </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="structbeam.html">beam</a> *const &nbsp;</td>
          <td class="paramname"> <em>curbeam</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *const &nbsp;</td>
          <td class="paramname"> <em>flat_name</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const int&nbsp;</td>
          <td class="paramname"> <em>order</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const double&nbsp;</td>
          <td class="paramname"> <em>coeffs</em>[]</td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>creates a descriptor for a flatfield with a single flat field and a polynomial wave length dependence, such that the efficiency at wavelength lambda is flat(x,y)*poly(lambda).</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>curbeam</em>&nbsp;</td><td>the <a class="el" href="structbeam.html">beam</a> to create the flatfield for, with the bbox filled out (e.g., after <a class="el" href="namespacespc__extract.html">spc_extract</a> has run) </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>flat_name</em>&nbsp;</td><td>name of a flat field file </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>order</em>&nbsp;</td><td>the order of the polynomial </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>coeffs</em>&nbsp;</td><td>the coefficients of the polynomial (contains order+1 doubles) </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>an allocated flatfield descriptor </dd></dl>

<p><div class="fragment"><pre class="fragment"><a name="l00279"></a>00279 {
<a name="l00280"></a>00280   <a class="code" href="structs__flatfield.html">flatfield_d</a> *<span class="keyword">const</span> ff = malloc (<span class="keyword">sizeof</span> (<a class="code" href="structs__flatfield.html">flatfield_d</a>));
<a name="l00281"></a>00281   <span class="keywordtype">int</span> i;
<a name="l00282"></a>00282   
<a name="l00283"></a>00283   <span class="keywordflow">if</span> (!ff)
<a name="l00284"></a>00284     {
<a name="l00285"></a>00285       <a class="code" href="aXe__errors_8c.html#a7ef7588e5f91237ba7ce4084e6ed3c11">aXe_message</a> (<a class="code" href="aXe__errors_8h.html#a2556a67874555249b07691c37aa6d6e9">aXe_M_FATAL</a>, __FILE__, __LINE__, <span class="stringliteral">&quot;Out of memory&quot;</span>);
<a name="l00286"></a>00286     }
<a name="l00287"></a>00287   
<a name="l00288"></a>00288   ff-&gt;<a class="code" href="structs__flatfield.html#a8f036c9091ac39aa9d42968bb770af09">data</a>.<a class="code" href="structs__flatfield.html#a15327899ebefeb485896f96b795d846e">poly</a> = malloc (<span class="keyword">sizeof</span> (<a class="code" href="structpolynom__flatfield.html">polynom_flatfield</a>));
<a name="l00289"></a>00289   <span class="keywordflow">if</span> (!ff-&gt;<a class="code" href="structs__flatfield.html#a8f036c9091ac39aa9d42968bb770af09">data</a>.<a class="code" href="structs__flatfield.html#a15327899ebefeb485896f96b795d846e">poly</a>)
<a name="l00290"></a>00290     {
<a name="l00291"></a>00291       <a class="code" href="aXe__errors_8c.html#a7ef7588e5f91237ba7ce4084e6ed3c11">aXe_message</a> (<a class="code" href="aXe__errors_8h.html#a2556a67874555249b07691c37aa6d6e9">aXe_M_FATAL</a>, __FILE__, __LINE__, <span class="stringliteral">&quot;Out of memory&quot;</span>);
<a name="l00292"></a>00292     }
<a name="l00293"></a>00293   ff-&gt;<a class="code" href="structs__flatfield.html#a8f036c9091ac39aa9d42968bb770af09">data</a>.<a class="code" href="structs__flatfield.html#a15327899ebefeb485896f96b795d846e">poly</a>-&gt;<a class="code" href="structpolynom__flatfield.html#adb6281055bfa0626320e1c79ca284a77">poly_order</a> = order;
<a name="l00294"></a>00294   ff-&gt;<a class="code" href="structs__flatfield.html#a8f036c9091ac39aa9d42968bb770af09">data</a>.<a class="code" href="structs__flatfield.html#a15327899ebefeb485896f96b795d846e">poly</a>-&gt;<a class="code" href="structpolynom__flatfield.html#a1c036a8e0217763384459507643a5f80">poly_coeffs</a> = malloc ((order + 1) * <span class="keyword">sizeof</span> (<span class="keywordtype">double</span>));
<a name="l00295"></a>00295   <span class="keywordflow">if</span> (!ff-&gt;<a class="code" href="structs__flatfield.html#a8f036c9091ac39aa9d42968bb770af09">data</a>.<a class="code" href="structs__flatfield.html#a15327899ebefeb485896f96b795d846e">poly</a>-&gt;<a class="code" href="structpolynom__flatfield.html#a1c036a8e0217763384459507643a5f80">poly_coeffs</a>)
<a name="l00296"></a>00296     {
<a name="l00297"></a>00297       <a class="code" href="aXe__errors_8c.html#a7ef7588e5f91237ba7ce4084e6ed3c11">aXe_message</a> (<a class="code" href="aXe__errors_8h.html#a2556a67874555249b07691c37aa6d6e9">aXe_M_FATAL</a>, __FILE__, __LINE__, <span class="stringliteral">&quot;Out of memory&quot;</span>);
<a name="l00298"></a>00298     }
<a name="l00299"></a>00299   
<a name="l00300"></a>00300   <span class="keywordflow">for</span> (i = 0; i &lt;= order; i++)
<a name="l00301"></a>00301     {
<a name="l00302"></a>00302       ff-&gt;<a class="code" href="structs__flatfield.html#a8f036c9091ac39aa9d42968bb770af09">data</a>.<a class="code" href="structs__flatfield.html#a15327899ebefeb485896f96b795d846e">poly</a>-&gt;<a class="code" href="structpolynom__flatfield.html#a1c036a8e0217763384459507643a5f80">poly_coeffs</a>[i] = coeffs[i];
<a name="l00303"></a>00303     }
<a name="l00304"></a>00304   ff-&gt;<a class="code" href="structs__flatfield.html#a27ed375a08ad88a9a25ab15f1186daba">func</a> = <a class="code" href="spc__flatfield_8c.html#a227e9ce54a81906562b5e061fb17ddc5">flat_poly_func</a>;
<a name="l00305"></a>00305   
<a name="l00306"></a>00306   ff-&gt;<a class="code" href="structs__flatfield.html#a1d7f7b9c4eff24588fe25d35f2a0e3ea">ll_x</a> = curbeam-&gt;<a class="code" href="structbeam.html#aa703d04290c347c35197ff52993b98f3">bbox</a>[0].<a class="code" href="structpx__point.html#ab715a558731a820a25b50bd7797dd004">x</a>;
<a name="l00307"></a>00307   ff-&gt;<a class="code" href="structs__flatfield.html#affab7067e6e424adb423dc8de163bd5e">ll_y</a> = curbeam-&gt;<a class="code" href="structbeam.html#aa703d04290c347c35197ff52993b98f3">bbox</a>[0].<a class="code" href="structpx__point.html#a2d02b900722a71f22a8d5100822bda61">y</a>;
<a name="l00308"></a>00308   ff-&gt;<a class="code" href="structs__flatfield.html#a06769e5af56e9be88885af9cd2e25dd9">w</a> = curbeam-&gt;<a class="code" href="structbeam.html#aa703d04290c347c35197ff52993b98f3">bbox</a>[1].<a class="code" href="structpx__point.html#ab715a558731a820a25b50bd7797dd004">x</a> - curbeam-&gt;<a class="code" href="structbeam.html#aa703d04290c347c35197ff52993b98f3">bbox</a>[0].<a class="code" href="structpx__point.html#ab715a558731a820a25b50bd7797dd004">x</a> + 1;
<a name="l00309"></a>00309   ff-&gt;<a class="code" href="structs__flatfield.html#a8d217598ba3babf676e72e2d8e1d5068">h</a> = curbeam-&gt;<a class="code" href="structbeam.html#aa703d04290c347c35197ff52993b98f3">bbox</a>[1].<a class="code" href="structpx__point.html#a2d02b900722a71f22a8d5100822bda61">y</a> - curbeam-&gt;<a class="code" href="structbeam.html#aa703d04290c347c35197ff52993b98f3">bbox</a>[0].<a class="code" href="structpx__point.html#a2d02b900722a71f22a8d5100822bda61">y</a> + 1;
<a name="l00310"></a>00310   ff-&gt;<a class="code" href="structs__flatfield.html#a8f036c9091ac39aa9d42968bb770af09">data</a>.<a class="code" href="structs__flatfield.html#a15327899ebefeb485896f96b795d846e">poly</a>-&gt;<a class="code" href="structpolynom__flatfield.html#a489ee68b385052b07372fa0ae768106c">flatfield</a> = <a class="code" href="spc__flatfield_8c.html#a1a2a238a4168103d4c9db69848e6fdd7">load_flatfield</a> (ff, flat_name);
<a name="l00311"></a>00311   ff-&gt;<a class="code" href="structs__flatfield.html#a8f036c9091ac39aa9d42968bb770af09">data</a>.<a class="code" href="structs__flatfield.html#a15327899ebefeb485896f96b795d846e">poly</a>-&gt;<a class="code" href="structpolynom__flatfield.html#a7cb096f2701bd64b8f57d27aef51e8ce">errors</a> = <a class="code" href="spc__flatfield_8c.html#a0229b077b2df672da892c786e598710f">load_flatfield_errors</a> (ff, flat_name);
<a name="l00312"></a>00312   
<a name="l00313"></a>00313   <span class="keywordflow">return</span> ff;
<a name="l00314"></a>00314 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a453e895ac1865f71f8b5126a0bcfb519"></a><!-- doxytag: member="spc_flatfield.c::poly_cube_flatfield_lambda" ref="a453e895ac1865f71f8b5126a0bcfb519" args="(const double lambda, const int x, const int y, poly_cube_flatfield *poly_cube)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">double poly_cube_flatfield_lambda </td>
          <td>(</td>
          <td class="paramtype">const double&nbsp;</td>
          <td class="paramname"> <em>lambda</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const int&nbsp;</td>
          <td class="paramname"> <em>x</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const int&nbsp;</td>
          <td class="paramname"> <em>y</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structpoly__cube__flatfield.html">poly_cube_flatfield</a> *&nbsp;</td>
          <td class="paramname"> <em>poly_cube</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Evaluates and return the flatfielding value of pixel coordinates x,y and at wavelength lambda, using the field dependent polynomial description contained in a <a class="el" href="structpoly__cube__flatfield.html">poly_cube_flatfield</a> structure. Uses abs(lambda) for cosmetic reasons. If the sampled wavelength falls outside of the wmin&lt;w&lt;wmax range, then a warning is issued and no flat-field coefficient is computed, and 1.0 is returned [new version now returns the FF value at the closest known wavelength] </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>lambda</em>&nbsp;</td><td>the wavelength </td></tr>
  </table>
  </dd>
</dl>

<p><div class="fragment"><pre class="fragment"><a name="l00092"></a>00092 {
<a name="l00093"></a>00093   <span class="keywordtype">int</span> i;
<a name="l00094"></a>00094   <span class="keywordtype">double</span> ff=0.0;
<a name="l00095"></a>00095   <span class="keywordtype">double</span> w; <span class="comment">/* nomalized wavelength */</span>
<a name="l00096"></a>00096 
<a name="l00097"></a>00097     
<a name="l00098"></a>00098   <span class="comment">/* if ( (lambda&gt;poly_cube-&gt;wmax) || (lambda&lt;poly_cube-&gt;wmin) )</span>
<a name="l00099"></a>00099 <span class="comment">     {</span>
<a name="l00100"></a>00100 <span class="comment">     aXe_message (aXe_M_WARN4, __FILE__, __LINE__, &quot;Sampled wavelengh (%f)&quot;</span>
<a name="l00101"></a>00101 <span class="comment">     &quot; is outside of FF cube (%f &lt; ww &lt; %f). Returning 1.0\n&quot;,lambda,poly_cube-&gt;wmin,poly_cube-&gt;wmax);</span>
<a name="l00102"></a>00102 <span class="comment">     w = 1.0;</span>
<a name="l00103"></a>00103 <span class="comment">     for (i=0;i&lt;poly_cube-&gt;poly_order;i++) </span>
<a name="l00104"></a>00104 <span class="comment">     {</span>
<a name="l00105"></a>00105 <span class="comment">     ff = ff + gsl_matrix_get(poly_cube-&gt;coeffs[i],x,y)*pow(w,i);</span>
<a name="l00106"></a>00106 <span class="comment">     }</span>
<a name="l00107"></a>00107 <span class="comment">     return ff;</span>
<a name="l00108"></a>00108 <span class="comment">     }*/</span>
<a name="l00109"></a>00109     
<a name="l00110"></a>00110   w = (fabs(lambda) - poly_cube-&gt;<a class="code" href="structpoly__cube__flatfield.html#a1ffb6722301a4c505bf12fa1b465ba40">wmin</a>)/(poly_cube-&gt;<a class="code" href="structpoly__cube__flatfield.html#a84506df8267a17616949e9f34424dd62">wmax</a>-poly_cube-&gt;<a class="code" href="structpoly__cube__flatfield.html#a1ffb6722301a4c505bf12fa1b465ba40">wmin</a>);
<a name="l00111"></a>00111 
<a name="l00112"></a>00112   <span class="keywordflow">if</span> (lambda&lt;poly_cube-&gt;wmin)
<a name="l00113"></a>00113     {
<a name="l00114"></a>00114       w = .0;
<a name="l00115"></a>00115     }        
<a name="l00116"></a>00116   <span class="keywordflow">if</span> (lambda&gt;poly_cube-&gt;<a class="code" href="structpoly__cube__flatfield.html#a84506df8267a17616949e9f34424dd62">wmax</a>)
<a name="l00117"></a>00117     {
<a name="l00118"></a>00118       w = 1.0;
<a name="l00119"></a>00119     }    
<a name="l00120"></a>00120   
<a name="l00121"></a>00121   <span class="keywordflow">for</span> (i=0;i&lt;poly_cube-&gt;<a class="code" href="structpoly__cube__flatfield.html#a43ded1d19ab5c7a6d34ffc75788e6fdf">poly_order</a>;i++) 
<a name="l00122"></a>00122     {
<a name="l00123"></a>00123       ff = ff + <a class="code" href="aXe__grism_8h.html#acf709ee71c580f1cd65d726ed03200ea">gsl_matrix_get</a>(poly_cube-&gt;<a class="code" href="structpoly__cube__flatfield.html#a5e941be5d850641c8f11e35e48d9266e">coeffs</a>[i],x,y)*pow(w,i);
<a name="l00124"></a>00124     }
<a name="l00125"></a>00125   <span class="keywordflow">return</span> ff;
<a name="l00126"></a>00126 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ae2aa85ce31eaebd4dc92e346ec6c4a6c"></a><!-- doxytag: member="spc_flatfield.c::simulate_flatfield" ref="ae2aa85ce31eaebd4dc92e346ec6c4a6c" args="(flatfield_d *const flat, double stdev)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">gsl_matrix* simulate_flatfield </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structs__flatfield.html">flatfield_d</a> *const &nbsp;</td>
          <td class="paramname"> <em>flat</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>stdev</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Creates a simulation of a flat field using random numbers. Use only for debugging. </p>

<p><div class="fragment"><pre class="fragment"><a name="l00022"></a>00022 {
<a name="l00023"></a>00023   <span class="keywordtype">int</span> i, j;
<a name="l00024"></a>00024   <a class="code" href="aXe__grism_8h.html#a6117e17bb3108107676f4486e62d40e5">gsl_matrix</a> *flat_pixels;
<a name="l00025"></a>00025   
<a name="l00026"></a>00026   gsl_rng *r = gsl_rng_alloc (gsl_rng_ran0);
<a name="l00027"></a>00027   
<a name="l00028"></a>00028   flat_pixels = <a class="code" href="aXe__grism_8h.html#a1214ab1bea5fd80474d7a27db0bfb429">gsl_matrix_alloc</a> (flat-&gt;<a class="code" href="structs__flatfield.html#a06769e5af56e9be88885af9cd2e25dd9">w</a>, flat-&gt;<a class="code" href="structs__flatfield.html#a8d217598ba3babf676e72e2d8e1d5068">h</a>);
<a name="l00029"></a>00029   <span class="keywordflow">for</span> (i = 0; i &lt; flat_pixels-&gt;size1; i++)
<a name="l00030"></a>00030     {
<a name="l00031"></a>00031       <span class="keywordflow">for</span> (j = 0; j &lt; flat_pixels-&gt;size2; j++)
<a name="l00032"></a>00032         {
<a name="l00033"></a>00033           <a class="code" href="aXe__grism_8h.html#a1f386ef5cd5a3b916246c2bee80f083a">gsl_matrix_set</a> (flat_pixels, i, j,
<a name="l00034"></a>00034                           1. + gsl_ran_gaussian (r, stdev));
<a name="l00035"></a>00035         }
<a name="l00036"></a>00036     }
<a name="l00037"></a>00037   gsl_rng_free (r);
<a name="l00038"></a>00038   
<a name="l00039"></a>00039   <span class="keywordflow">return</span> flat_pixels;
<a name="l00040"></a>00040 }
</pre></div></p>

</div>
</div>
</div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&nbsp;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&nbsp;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr size="1"/><address style="text-align: right;"><small>Generated on 12 Oct 2014 for TIPS by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
