<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>TIPS: /renoir/fourmano/Desktop/OUSIM/TIPS/branches/tips_build/include/axesim/spce_binning.h File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>/renoir/fourmano/Desktop/OUSIM/TIPS/branches/tips_build/include/axesim/spce_binning.h File Reference</h1><code>#include &lt;math.h&gt;</code><br/>
<code>#include &lt;gsl/gsl_vector.h&gt;</code><br/>
<code>#include &quot;<a class="el" href="spce__output_8h_source.html">spce_output.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="spc__trace__functions_8h_source.html">spc_trace_functions.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="aXe__grism_8h_source.html">aXe_grism.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="spc__spc_8h_source.html">spc_spc.h</a>&quot;</code><br/>

<p><a href="spce__binning_8h_source.html">Go to the source code of this file.</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Data Structures</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structw__pixel__s.html">w_pixel_s</a></td></tr>
<tr><td colspan="2"><h2>Namespaces</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">namespace &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacespce__binning.html">spce_binning</a></td></tr>
<tr><td colspan="2"><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="spce__binning_8h.html#ad78a46aa43747fbba38c45a89e71f71f">_SPCE_BINNING_H</a>&nbsp;&nbsp;&nbsp;1</td></tr>
<tr><td colspan="2"><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">typedef struct <a class="el" href="structw__pixel__s.html">w_pixel_s</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="spce__binning_8h.html#ae50ade366409636597e730a9ed54acf6">w_pixel</a></td></tr>
<tr><td colspan="2"><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="structspectrum.html">spectrum</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="spce__binning_8h.html#aae5d0848d8dac6d3cecf1c6c4de7747d">bin_naive</a> (const <a class="el" href="structap__pixel.html">ap_pixel</a> *const ap_p, const double ob_width, const double ob_orient, const int quant_cont)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="structspectrum.html">spectrum</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="spce__binning_8h.html#a49f87c0ee85edafe3f007ded3eb2bef9">bin_weighted</a> (const <a class="el" href="structap__pixel.html">ap_pixel</a> *const ap_p, const double ob_orient, const <a class="el" href="structtrace__func.html">trace_func</a> *const trace, const int n_sub, const int flags)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="structspectrum.html">spectrum</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="spce__binning_8h.html#a48edf641b650f9cded24b2616dc93072">bin_optimal</a> (const <a class="el" href="structap__pixel.html">ap_pixel</a> *const ap_p, const <a class="el" href="structbeam.html">beam</a> curbeam, const int quant_cont, const gsl_matrix *weights, const <a class="el" href="structdrzstamp__dim.html">drzstamp_dim</a> dimension, gsl_matrix *coverage)</td></tr>
</table>
<hr/><h2>Define Documentation</h2>
<a class="anchor" id="ad78a46aa43747fbba38c45a89e71f71f"></a><!-- doxytag: member="spce_binning.h::_SPCE_BINNING_H" ref="ad78a46aa43747fbba38c45a89e71f71f" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define _SPCE_BINNING_H&nbsp;&nbsp;&nbsp;1</td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<hr/><h2>Typedef Documentation</h2>
<a class="anchor" id="ae50ade366409636597e730a9ed54acf6"></a><!-- doxytag: member="spce_binning.h::w_pixel" ref="ae50ade366409636597e730a9ed54acf6" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef struct <a class="el" href="structw__pixel__s.html">w_pixel_s</a>
 <a class="el" href="structw__pixel__s.html">w_pixel</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>defines a pixel for weighting purposes. Here, p0, p1, p2, p3 are the coordinates of the points where the square first contribute, where its contribution becomes constant, where it slopes down again, and where it doesn't contribute any more. For example, a pixel at (0,0) viewed at from a side has p0=p1=0, p2=p3=1, whereas the same pixel viewed from a corner has p0=-1, p1=p2=0, p3=1; slope is the ascent on the non-constant parts, fmax the maximum contribution. angle is the angle viewing. Its tangent tana or its cotangent cota may be undefined for certain viewing angles. The function weight_function is selected such that this is unimportatnt. x0, y0, and size are the coordinates of the lower left corner and the size of the square. </p>

</div>
</div>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="aae5d0848d8dac6d3cecf1c6c4de7747d"></a><!-- doxytag: member="spce_binning.h::bin_naive" ref="aae5d0848d8dac6d3cecf1c6c4de7747d" args="(const ap_pixel *const ap_p, const double ob_width, const double ob_orient, const int quant_cont)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structspectrum.html">spectrum</a>* bin_naive </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="structap__pixel.html">ap_pixel</a> *const &nbsp;</td>
          <td class="paramname"> <em>ap_p</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const double&nbsp;</td>
          <td class="paramname"> <em>ob_width</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const double&nbsp;</td>
          <td class="paramname"> <em>ob_orient</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const int&nbsp;</td>
          <td class="paramname"> <em>quant_cont</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Function: bin_naive computes a <a class="el" href="structspectrum.html">spectrum</a> from a table of aperture pixels generated from <a class="el" href="namespacespc__extract.html">spc_extract</a>. This is adds up the pixel values, distributing them over the trace, taking into account the fracton of the pixel that projects onto the given [xi,xi+1] interval. Return NULL if ap_p is NULL</p>
<p>Parameters: </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>ap_p</em>&nbsp;</td><td>the table of aperture pixels </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>px_width</em>&nbsp;</td><td>width of a pixel (=1 if not subsampled) </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>ob_width</em>&nbsp;</td><td>the width of the <a class="el" href="structobject.html">object</a> that has generated the <a class="el" href="structspectrum.html">spectrum</a> </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>ob_orientation</em>&nbsp;</td><td>the orientation of the <a class="el" href="structobject.html">object</a> that has generated the <a class="el" href="structspectrum.html">spectrum</a> </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>flags</em>&nbsp;</td><td>problems that were accumulated in generating ap_p; possible flags are defined for the warning member of the <a class="el" href="structspectrum.html">spectrum</a> struct</td></tr>
  </table>
  </dd>
</dl>
<p>Returns: </p>
<dl class="return"><dt><b>Returns:</b></dt><dd>spec - the 1D <a class="el" href="structspectrum.html">spectrum</a> </dd></dl>

<p><div class="fragment"><pre class="fragment"><a name="l00340"></a>00340 {
<a name="l00341"></a>00341   <span class="keyword">const</span> <a class="code" href="structap__pixel.html">ap_pixel</a> *cur_p;
<a name="l00342"></a>00342   <span class="keywordtype">int</span> upper, lower;
<a name="l00343"></a>00343 
<a name="l00344"></a>00344   <span class="keywordtype">int</span> bin;
<a name="l00345"></a>00345   <a class="code" href="structspectrum.html">spectrum</a> *spec, *tspec;
<a name="l00346"></a>00346   <span class="keywordtype">double</span> phi_trace;
<a name="l00347"></a>00347   <a class="code" href="structspc__entry.html">spc_entry</a> *spec_table;
<a name="l00348"></a>00348   <span class="keywordtype">double</span> d, frac;
<a name="l00349"></a>00349 
<a name="l00350"></a>00350   <span class="comment">// immediately return empty PET&apos;s</span>
<a name="l00351"></a>00351   <span class="keywordflow">if</span> (ap_p==NULL)
<a name="l00352"></a>00352     <span class="keywordflow">return</span> NULL;
<a name="l00353"></a>00353 
<a name="l00354"></a>00354   <span class="comment">// go through the PET,</span>
<a name="l00355"></a>00355   <span class="comment">// find the minimum and</span>
<a name="l00356"></a>00356   <span class="comment">// maximum in trace distance</span>
<a name="l00357"></a>00357   cur_p = ap_p;
<a name="l00358"></a>00358   upper = <a class="code" href="spce__binning_8c.html#a8dfe5270d79dd418c3e41042a3f59e07">NAIVE_VAL_TO_BININD</a> (cur_p-&gt;<a class="code" href="structap__pixel.html#aeae2e14e0f53bd1090acb2a8758104a5">xi</a>);
<a name="l00359"></a>00359   lower = <a class="code" href="spce__binning_8c.html#a8dfe5270d79dd418c3e41042a3f59e07">NAIVE_VAL_TO_BININD</a> (cur_p-&gt;<a class="code" href="structap__pixel.html#aeae2e14e0f53bd1090acb2a8758104a5">xi</a>);
<a name="l00360"></a>00360   <span class="keywordflow">while</span> (cur_p-&gt;<a class="code" href="structap__pixel.html#abca28f0936fbd5a569ad548fb25e5a38">p_x</a> != -1)
<a name="l00361"></a>00361     {
<a name="l00362"></a>00362       bin = <a class="code" href="spce__binning_8c.html#a8dfe5270d79dd418c3e41042a3f59e07">NAIVE_VAL_TO_BININD</a> (cur_p-&gt;<a class="code" href="structap__pixel.html#aeae2e14e0f53bd1090acb2a8758104a5">xi</a>);
<a name="l00363"></a>00363       upper = <a class="code" href="aper__conf_8c.html#aacc3ee1a7f283f8ef65cea31f4436a95">MAX</a> (bin, upper);
<a name="l00364"></a>00364       lower = <a class="code" href="aXe__utils_8c.html#a74e75242132eaabbc1c512488a135926">MIN</a> (bin, lower);
<a name="l00365"></a>00365       cur_p++;
<a name="l00366"></a>00366     }
<a name="l00367"></a>00367 
<a name="l00368"></a>00368   <span class="comment">// check whether the spectrum</span>
<a name="l00369"></a>00369   <span class="comment">// will ahve a finite length,</span>
<a name="l00370"></a>00370   <span class="comment">// exit if not</span>
<a name="l00371"></a>00371   <span class="keywordflow">if</span> (upper == lower)
<a name="l00372"></a>00372     {
<a name="l00373"></a>00373       <a class="code" href="aXe__errors_8c.html#a7ef7588e5f91237ba7ce4084e6ed3c11">aXe_message</a> (<a class="code" href="aXe__errors_8h.html#a3f3c2d017ceaf0b51cfb71efbcaeff44">aXe_M_WARN4</a>, __FILE__, __LINE__,
<a name="l00374"></a>00374                    <span class="stringliteral">&quot;Pixel table empty.\n&quot;</span>);
<a name="l00375"></a>00375       <span class="keywordflow">return</span> NULL;
<a name="l00376"></a>00376     }
<a name="l00377"></a>00377 
<a name="l00378"></a>00378   <span class="comment">// Thresh in some headway so we don&apos;t need to worry too much about</span>
<a name="l00379"></a>00379   <span class="comment">//     accessing invalid elements now and then</span>
<a name="l00380"></a>00380   lower -= 10;
<a name="l00381"></a>00381   upper += 10;
<a name="l00382"></a>00382   spec = <a class="code" href="spc__spc_8c.html#a2b7693a22a9e1b6d287465b8bff189de">allocate_spectrum</a> (upper - lower);
<a name="l00383"></a>00383 
<a name="l00384"></a>00384   spec_table = spec-&gt;<a class="code" href="structspectrum.html#a12640df5c0e35a9a377291dd11022bcf">spec</a>;
<a name="l00385"></a>00385   cur_p = ap_p;
<a name="l00386"></a>00386 
<a name="l00387"></a>00387   <span class="keywordflow">while</span> (cur_p-&gt;<a class="code" href="structap__pixel.html#abca28f0936fbd5a569ad548fb25e5a38">p_x</a> != -1)
<a name="l00388"></a>00388     {
<a name="l00389"></a>00389       <span class="comment">// Compute any fractional pixel that might fall within the</span>
<a name="l00390"></a>00390       <span class="comment">//desired extraction width</span>
<a name="l00391"></a>00391       d = ob_width;
<a name="l00392"></a>00392       frac = 1.;
<a name="l00393"></a>00393 
<a name="l00394"></a>00394       <span class="comment">// continue if the pixel is outside</span>
<a name="l00395"></a>00395       <span class="comment">// of the extraction region</span>
<a name="l00396"></a>00396       <span class="keywordflow">if</span> (fabs (cur_p-&gt;<a class="code" href="structap__pixel.html#abd0f197da151fac01c9e4cbd4146f212">dist</a>) &gt; d + .5)
<a name="l00397"></a>00397         {
<a name="l00398"></a>00398           cur_p++;
<a name="l00399"></a>00399           <span class="keywordflow">continue</span>;
<a name="l00400"></a>00400         }
<a name="l00401"></a>00401       <span class="keywordflow">if</span> ((fabs (cur_p-&gt;<a class="code" href="structap__pixel.html#abd0f197da151fac01c9e4cbd4146f212">dist</a>) &gt;= d - .5) &amp;&amp; (fabs (cur_p-&gt;<a class="code" href="structap__pixel.html#abd0f197da151fac01c9e4cbd4146f212">dist</a>) &lt;= d + .5))
<a name="l00402"></a>00402         {
<a name="l00403"></a>00403           frac = fabs (d - (fabs (cur_p-&gt;<a class="code" href="structap__pixel.html#abd0f197da151fac01c9e4cbd4146f212">dist</a>) - 0.5));
<a name="l00404"></a>00404         }
<a name="l00405"></a>00405 
<a name="l00406"></a>00406       <span class="comment">// store the local trace angle</span>
<a name="l00407"></a>00407       phi_trace = cur_p-&gt;<a class="code" href="structap__pixel.html#a92d9e84a233d0a1ad482830b23c5e5ba">dxs</a>;
<a name="l00408"></a>00408 
<a name="l00409"></a>00409       <span class="keywordflow">if</span> (1)
<a name="l00410"></a>00410         {
<a name="l00411"></a>00411           <span class="keywordtype">double</span> xi;
<a name="l00412"></a>00412           <a class="code" href="structw__pixel__s.html">w_pixel</a> pix;
<a name="l00413"></a>00413           <span class="keywordtype">double</span> sinp = sin (phi_trace);
<a name="l00414"></a>00414           <span class="keywordtype">double</span> cosp = cos (phi_trace);
<a name="l00415"></a>00415           <span class="keywordtype">double</span> xc, yc;
<a name="l00416"></a>00416           <span class="keywordtype">double</span> w;
<a name="l00417"></a>00417           <span class="keywordtype">double</span> sum = 0;
<a name="l00418"></a>00418 
<a name="l00419"></a>00419           <a class="code" href="spce__binning_8c.html#ab30f3a9057424879b1e59d544efe5f43">fill_w_pixel</a> (&amp;pix, cur_p-&gt;<a class="code" href="structap__pixel.html#a0ce028c33a28f543bd9255324800e9ea">x</a>, cur_p-&gt;<a class="code" href="structap__pixel.html#a1df90884734bfaea8ec545b69d802281">y</a>, ob_orient);
<a name="l00420"></a>00420 
<a name="l00421"></a>00421           xc = cur_p-&gt;<a class="code" href="structap__pixel.html#aa6a80bf7f2a556b5d846bb3b987450ee">xs</a>;
<a name="l00422"></a>00422           yc = cur_p-&gt;<a class="code" href="structap__pixel.html#a54b55a4bbb06f7a9065699d976dae956">ys</a>;
<a name="l00423"></a>00423 
<a name="l00424"></a>00424           <span class="comment">// at cur_p-&gt;xi, there has to be some contribution. We go back</span>
<a name="l00425"></a>00425           <span class="comment">// collecting, until w is zero</span>
<a name="l00426"></a>00426           <span class="keywordflow">for</span> (xi = cur_p-&gt;<a class="code" href="structap__pixel.html#aeae2e14e0f53bd1090acb2a8758104a5">xi</a>;; xi -= 1)
<a name="l00427"></a>00427             {
<a name="l00428"></a>00428               bin = <a class="code" href="spce__binning_8c.html#a8dfe5270d79dd418c3e41042a3f59e07">NAIVE_VAL_TO_BININD</a> (xi);
<a name="l00429"></a>00429               w = <a class="code" href="spce__binning_8c.html#a9f2dc7b6f44300d5c964969937761d6c">PIXWEIGHT</a> (xc + (bin - cur_p-&gt;<a class="code" href="structap__pixel.html#aeae2e14e0f53bd1090acb2a8758104a5">xi</a>) * cosp,
<a name="l00430"></a>00430                              yc + (bin - cur_p-&gt;<a class="code" href="structap__pixel.html#aeae2e14e0f53bd1090acb2a8758104a5">xi</a>) * sinp,
<a name="l00431"></a>00431                              xc + (bin + 1 - cur_p-&gt;<a class="code" href="structap__pixel.html#aeae2e14e0f53bd1090acb2a8758104a5">xi</a>) * cosp,
<a name="l00432"></a>00432                              yc + (bin + 1 - cur_p-&gt;<a class="code" href="structap__pixel.html#aeae2e14e0f53bd1090acb2a8758104a5">xi</a>) * sinp,
<a name="l00433"></a>00433                              &amp;pix);
<a name="l00434"></a>00434               <span class="keywordflow">if</span> (w &lt; 1e-10)
<a name="l00435"></a>00435                 <span class="keywordflow">break</span>;
<a name="l00436"></a>00436 
<a name="l00437"></a>00437               <a class="code" href="spce__binning_8c.html#a7518304380f3c574b4fd1564de70ef1a">add_to_spec_table</a> (spec, bin - lower, cur_p, quant_cont,
<a name="l00438"></a>00438                                  w * frac * cur_p-&gt;<a class="code" href="structap__pixel.html#a34600405e114d4bd366c1d33860aff14">weight</a>);
<a name="l00439"></a>00439               <span class="comment">//              if (cur_p-&gt;weight &gt; 10.0){</span>
<a name="l00440"></a>00440               <span class="comment">//                fprintf(stdout,&quot;weight: %f, distance: %f, ewidth: %f\n&quot;,</span>
<a name="l00441"></a>00441               <span class="comment">//                        cur_p-&gt;weight, cur_p-&gt;dist, d+0.5);</span>
<a name="l00442"></a>00442               <span class="comment">//              }</span>
<a name="l00443"></a>00443               sum += w;
<a name="l00444"></a>00444             }
<a name="l00445"></a>00445 
<a name="l00446"></a>00446           <span class="comment">/* Now collect contributions upward of cur_p-&gt;xi */</span>
<a name="l00447"></a>00447           <span class="keywordflow">for</span> (xi = cur_p-&gt;<a class="code" href="structap__pixel.html#aeae2e14e0f53bd1090acb2a8758104a5">xi</a> + 1;; xi += 1)
<a name="l00448"></a>00448             {
<a name="l00449"></a>00449               bin = <a class="code" href="spce__binning_8c.html#a8dfe5270d79dd418c3e41042a3f59e07">NAIVE_VAL_TO_BININD</a> (xi);
<a name="l00450"></a>00450 
<a name="l00451"></a>00451               w = <a class="code" href="spce__binning_8c.html#a9f2dc7b6f44300d5c964969937761d6c">PIXWEIGHT</a> (xc + (bin - cur_p-&gt;<a class="code" href="structap__pixel.html#aeae2e14e0f53bd1090acb2a8758104a5">xi</a>) * cosp,
<a name="l00452"></a>00452                              yc + (bin - cur_p-&gt;<a class="code" href="structap__pixel.html#aeae2e14e0f53bd1090acb2a8758104a5">xi</a>) * sinp,
<a name="l00453"></a>00453                              xc + (bin + 1 - cur_p-&gt;<a class="code" href="structap__pixel.html#aeae2e14e0f53bd1090acb2a8758104a5">xi</a>) * cosp,
<a name="l00454"></a>00454                              yc + (bin + 1 - cur_p-&gt;<a class="code" href="structap__pixel.html#aeae2e14e0f53bd1090acb2a8758104a5">xi</a>) * sinp,
<a name="l00455"></a>00455                              &amp;pix);
<a name="l00456"></a>00456               <span class="keywordflow">if</span> (w &lt; 1e-10)
<a name="l00457"></a>00457                 <span class="keywordflow">break</span>;
<a name="l00458"></a>00458 
<a name="l00459"></a>00459               <a class="code" href="spce__binning_8c.html#a7518304380f3c574b4fd1564de70ef1a">add_to_spec_table</a> (spec, bin - lower, cur_p, quant_cont,
<a name="l00460"></a>00460                                  w * frac * cur_p-&gt;<a class="code" href="structap__pixel.html#a34600405e114d4bd366c1d33860aff14">weight</a>);
<a name="l00461"></a>00461               sum += w;
<a name="l00462"></a>00462             }
<a name="l00463"></a>00463 
<a name="l00464"></a>00464           <span class="keywordflow">if</span> (fabs (sum - 1) &gt; 1e-6)
<a name="l00465"></a>00465             {
<a name="l00466"></a>00466               fprintf(stdout,
<a name="l00467"></a>00467                       <span class="stringliteral">&quot;Weights added up to only %f for pixel from %4d,%4d\n&quot;</span>,
<a name="l00468"></a>00468                       sum, cur_p-&gt;<a class="code" href="structap__pixel.html#abca28f0936fbd5a569ad548fb25e5a38">p_x</a>, cur_p-&gt;<a class="code" href="structap__pixel.html#aadf7ee52df3875792fbf13d4d52ed298">p_y</a>);
<a name="l00469"></a>00469             }
<a name="l00470"></a>00470         }
<a name="l00471"></a>00471       cur_p++;
<a name="l00472"></a>00472     }
<a name="l00473"></a>00473 
<a name="l00474"></a>00474   <span class="comment">/* Trimming the INDEF beginning and ending values in spectrum */</span>
<a name="l00475"></a>00475   tspec = <a class="code" href="spc__spc_8c.html#a3b09e9e958c00c75f26933bac7d0ffe8">trim_spectrum</a> (spec);
<a name="l00476"></a>00476   <a class="code" href="spc__spc_8c.html#a7e957a43837d35fe0e2195ddcdcda221">free_spectrum</a> (spec);
<a name="l00477"></a>00477   spec = NULL;
<a name="l00478"></a>00478 
<a name="l00479"></a>00479   <span class="comment">// return the spectrum</span>
<a name="l00480"></a>00480   <span class="keywordflow">return</span> tspec;
<a name="l00481"></a>00481 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a48edf641b650f9cded24b2616dc93072"></a><!-- doxytag: member="spce_binning.h::bin_optimal" ref="a48edf641b650f9cded24b2616dc93072" args="(const ap_pixel *const ap_p, const beam curbeam, const int quant_cont, const gsl_matrix *weights, const drzstamp_dim dimension, gsl_matrix *coverage)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structspectrum.html">spectrum</a>* bin_optimal </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="structap__pixel.html">ap_pixel</a> *const &nbsp;</td>
          <td class="paramname"> <em>ap_p</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structbeam.html">beam</a>&nbsp;</td>
          <td class="paramname"> <em>curbeam</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const int&nbsp;</td>
          <td class="paramname"> <em>quant_cont</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const gsl_matrix *&nbsp;</td>
          <td class="paramname"> <em>weights</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structdrzstamp__dim.html">drzstamp_dim</a>&nbsp;</td>
          <td class="paramname"> <em>dimension</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">gsl_matrix *&nbsp;</td>
          <td class="paramname"> <em>coverage</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Function: bin_optimal computes a <a class="el" href="structspectrum.html">spectrum</a> from a table of aperture pixels generated from <a class="el" href="namespacespc__extract.html">spc_extract</a>. This is adds up the pixel values, distributing them over the trace, taking into account the fracton of the pixel that projects onto the given [xi,xi+1] interval. Return NULL if ap_p is NULL</p>
<p>Parameters: </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>ap_p</em>&nbsp;</td><td>the table of aperture pixels </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>px_width</em>&nbsp;</td><td>width of a pixel (=1 if not subsampled) </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>ob_width</em>&nbsp;</td><td>the width of the <a class="el" href="structobject.html">object</a> that has generated the <a class="el" href="structspectrum.html">spectrum</a> </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>ob_orientation</em>&nbsp;</td><td>the orientation of the <a class="el" href="structobject.html">object</a> that has generated the <a class="el" href="structspectrum.html">spectrum</a> </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>flags</em>&nbsp;</td><td>problems that were accumulated in generating ap_p; possible flags are defined for the warning member of the <a class="el" href="structspectrum.html">spectrum</a> struct</td></tr>
  </table>
  </dd>
</dl>
<p>Returns: </p>
<dl class="return"><dt><b>Returns:</b></dt><dd>spec - the 1D <a class="el" href="structspectrum.html">spectrum</a> </dd></dl>

<p><div class="fragment"><pre class="fragment"><a name="l00507"></a>00507 {
<a name="l00508"></a>00508 
<a name="l00509"></a>00509   <span class="keyword">const</span> <a class="code" href="structap__pixel.html">ap_pixel</a> *cur_p;
<a name="l00510"></a>00510   <a class="code" href="structap__pixel.html">ap_pixel</a> *tmp_p;
<a name="l00511"></a>00511   <a class="code" href="structspectrum.html">spectrum</a> *spec;
<a name="l00512"></a>00512   <a class="code" href="structspectrum.html">spectrum</a> *tspec;
<a name="l00513"></a>00513   <a class="code" href="structspc__entry.html">spc_entry</a> *spec_table;
<a name="l00514"></a>00514 
<a name="l00515"></a>00515   <a class="code" href="structquadrangle.html">quadrangle</a> quad;
<a name="l00516"></a>00516   <span class="comment">//  drzstamp_dim dimension;</span>
<a name="l00517"></a>00517 
<a name="l00518"></a>00518   <span class="keywordtype">double</span> jacob, arr;
<a name="l00519"></a>00519   <span class="keywordtype">double</span> frac, totweight;
<a name="l00520"></a>00520 
<a name="l00521"></a>00521   <span class="keywordtype">int</span> jcen, icen;
<a name="l00522"></a>00522   <span class="keywordtype">int</span> jupp, iupp;
<a name="l00523"></a>00523   <span class="keywordtype">int</span> jlow, ilow;
<a name="l00524"></a>00524 
<a name="l00525"></a>00525   <span class="keywordtype">int</span> ii, jj;
<a name="l00526"></a>00526   <span class="keywordtype">int</span> stpi, stpj;
<a name="l00527"></a>00527 
<a name="l00528"></a>00528   <span class="comment">// return NULL if</span>
<a name="l00529"></a>00529   <span class="comment">// empty PET</span>
<a name="l00530"></a>00530   <span class="keywordflow">if</span> (ap_p==NULL)
<a name="l00531"></a>00531     <span class="keywordflow">return</span> NULL;
<a name="l00532"></a>00532 
<a name="l00533"></a>00533   <span class="comment">// allocate memory</span>
<a name="l00534"></a>00534   tmp_p = (<a class="code" href="structap__pixel.html">ap_pixel</a> *) malloc(<span class="keyword">sizeof</span>(<a class="code" href="structap__pixel.html">ap_pixel</a>));
<a name="l00535"></a>00535 
<a name="l00536"></a>00536 
<a name="l00537"></a>00537   <span class="comment">// allocate memory for the spectrum</span>
<a name="l00538"></a>00538   spec = <a class="code" href="spc__spc_8c.html#a2b7693a22a9e1b6d287465b8bff189de">allocate_spectrum</a> (weights-&gt;size1);
<a name="l00539"></a>00539   spec_table = spec-&gt;<a class="code" href="structspectrum.html#a12640df5c0e35a9a377291dd11022bcf">spec</a>;
<a name="l00540"></a>00540 
<a name="l00541"></a>00541 
<a name="l00542"></a>00542   <span class="comment">// go over each PET pixel</span>
<a name="l00543"></a>00543   cur_p = ap_p;
<a name="l00544"></a>00544   <span class="keywordflow">for</span> (cur_p = ap_p; cur_p-&gt;<a class="code" href="structap__pixel.html#abca28f0936fbd5a569ad548fb25e5a38">p_x</a> != -1; cur_p++)
<a name="l00545"></a>00545     {
<a name="l00546"></a>00546 
<a name="l00547"></a>00547       <span class="comment">// continue if the pixel is outside</span>
<a name="l00548"></a>00548       <span class="comment">// of the extraction region</span>
<a name="l00549"></a>00549       <span class="keywordflow">if</span> (fabs (cur_p-&gt;<a class="code" href="structap__pixel.html#abd0f197da151fac01c9e4cbd4146f212">dist</a>) &gt; curbeam.<a class="code" href="structbeam.html#ae99ff960c070381b6e76af5a58cb9c45">width</a> + .5)
<a name="l00550"></a>00550           <span class="keywordflow">continue</span>;
<a name="l00551"></a>00551 
<a name="l00552"></a>00552       <span class="comment">// determine which fraction</span>
<a name="l00553"></a>00553       <span class="comment">// of the pixel is inside of the extraction area</span>
<a name="l00554"></a>00554       <span class="keywordflow">if</span> ((fabs (cur_p-&gt;<a class="code" href="structap__pixel.html#abd0f197da151fac01c9e4cbd4146f212">dist</a>) &gt;= curbeam.<a class="code" href="structbeam.html#ae99ff960c070381b6e76af5a58cb9c45">width</a> - .5) &amp;&amp; (fabs (cur_p-&gt;<a class="code" href="structap__pixel.html#abd0f197da151fac01c9e4cbd4146f212">dist</a>) &lt;= curbeam.<a class="code" href="structbeam.html#ae99ff960c070381b6e76af5a58cb9c45">width</a> + .5))
<a name="l00555"></a>00555         frac = fabs (curbeam.<a class="code" href="structbeam.html#ae99ff960c070381b6e76af5a58cb9c45">width</a> - (fabs (cur_p-&gt;<a class="code" href="structap__pixel.html#abd0f197da151fac01c9e4cbd4146f212">dist</a>) - 0.5));
<a name="l00556"></a>00556       <span class="keywordflow">else</span>
<a name="l00557"></a>00557         frac = 1.;
<a name="l00558"></a>00558 
<a name="l00559"></a>00559       <span class="comment">// transfer values to the temporary pixel</span>
<a name="l00560"></a>00560       tmp_p-&gt;<a class="code" href="structap__pixel.html#ac36fd281b7d91081490e41ce07a60501">lambda</a>  = cur_p-&gt;<a class="code" href="structap__pixel.html#aeae2e14e0f53bd1090acb2a8758104a5">xi</a>;
<a name="l00561"></a>00561       tmp_p-&gt;<a class="code" href="structap__pixel.html#abd0f197da151fac01c9e4cbd4146f212">dist</a>    = cur_p-&gt;<a class="code" href="structap__pixel.html#abd0f197da151fac01c9e4cbd4146f212">dist</a>;
<a name="l00562"></a>00562       tmp_p-&gt;<a class="code" href="structap__pixel.html#a92d9e84a233d0a1ad482830b23c5e5ba">dxs</a>     = cur_p-&gt;<a class="code" href="structap__pixel.html#a92d9e84a233d0a1ad482830b23c5e5ba">dxs</a>;
<a name="l00563"></a>00563       tmp_p-&gt;<a class="code" href="structap__pixel.html#a8c1c7b5a35a04145fccfc3f84c420cde">dlambda</a> = 1.0;
<a name="l00564"></a>00564 
<a name="l00565"></a>00565       <span class="comment">// create the quadrangle for the current pixel</span>
<a name="l00566"></a>00566       quad = <a class="code" href="spce__output_8c.html#a0b04392e15823b7d3e07a84cc698d56d">get_quad_from_pixel</a>(tmp_p, curbeam.<a class="code" href="structbeam.html#a362f20c7f29a9d08731a03939103c8c1">orient</a>, dimension);
<a name="l00567"></a>00567 
<a name="l00568"></a>00568       <span class="comment">// get the jacobian (well, easy here)</span>
<a name="l00569"></a>00569       <span class="comment">// the term &quot;cos(cur_p-&gt;dxs)&quot; must be there</span>
<a name="l00570"></a>00570       <span class="comment">// to correct the enlargement necessary</span>
<a name="l00571"></a>00571       <span class="comment">// to cover the whole lambda-crossdispersion area!</span>
<a name="l00572"></a>00572       <span class="comment">// NOT COMPLETELY understood</span>
<a name="l00573"></a>00573       jacob = cos(cur_p-&gt;<a class="code" href="structap__pixel.html#a92d9e84a233d0a1ad482830b23c5e5ba">dxs</a>);
<a name="l00574"></a>00574 
<a name="l00575"></a>00575       <span class="comment">// get the central pixel (icen, jcen) of the current PET-pixel</span>
<a name="l00576"></a>00576       icen = (int) floor(cur_p-&gt;<a class="code" href="structap__pixel.html#aeae2e14e0f53bd1090acb2a8758104a5">xi</a>   - dimension.<a class="code" href="structdrzstamp__dim.html#af6df14c21230e289ef6abe7134de3cc3">xstart</a>+.5);
<a name="l00577"></a>00577       jcen = (int) floor(cur_p-&gt;<a class="code" href="structap__pixel.html#abd0f197da151fac01c9e4cbd4146f212">dist</a> - dimension.<a class="code" href="structdrzstamp__dim.html#a9ed53e0c679cabe8bd15189b7b9b7a62">ystart</a>+.5);
<a name="l00578"></a>00578 
<a name="l00579"></a>00579       <span class="comment">// get the uper and lower extend of the quadrangle in x</span>
<a name="l00580"></a>00580       iupp = (int)floor(quad.<a class="code" href="structquadrangle.html#a07cdc1aa08d997f3ecf4a4527e1958b1">xmax</a> - (<span class="keywordtype">double</span>)icen + 0.5)+1;
<a name="l00581"></a>00581       ilow = (int)floor(quad.<a class="code" href="structquadrangle.html#a4a693bbae5ab2389a2e89aba2cd1ec6c">xmin</a> - (<span class="keywordtype">double</span>)icen + 0.5);
<a name="l00582"></a>00582 
<a name="l00583"></a>00583       <span class="comment">// get the uper and lower extend of the quadrangle in x</span>
<a name="l00584"></a>00584       jupp = (int)floor(quad.<a class="code" href="structquadrangle.html#a9cd9de4d5ad81c686c3bbea6093d5f2a">ymax</a> - (<span class="keywordtype">double</span>)jcen + 0.5)+1;
<a name="l00585"></a>00585       jlow = (int)floor(quad.<a class="code" href="structquadrangle.html#a28f1d44685c1b1fc1302c23fa53e3c82">ymin</a> - (<span class="keywordtype">double</span>)jcen + 0.5);
<a name="l00586"></a>00586 
<a name="l00587"></a>00587       <span class="comment">// go over the extend in x</span>
<a name="l00588"></a>00588       <span class="keywordflow">for</span> (ii=ilow;ii&lt;iupp;ii++)
<a name="l00589"></a>00589         {
<a name="l00590"></a>00590           <span class="comment">// go over the extend in x</span>
<a name="l00591"></a>00591           <span class="keywordflow">for</span> (jj=jlow;jj&lt;jupp;jj++)
<a name="l00592"></a>00592             {
<a name="l00593"></a>00593 
<a name="l00594"></a>00594               <span class="comment">// get the coordinates of the current output pixel</span>
<a name="l00595"></a>00595               stpi = icen+ii;
<a name="l00596"></a>00596               stpj = jcen+jj;
<a name="l00597"></a>00597 
<a name="l00598"></a>00598               <span class="comment">// check whether the current output pixel is within</span>
<a name="l00599"></a>00599               <span class="comment">// the stamp image; continue if not</span>
<a name="l00600"></a>00600               <span class="keywordflow">if</span> ( (stpi&gt;=dimension.<a class="code" href="structdrzstamp__dim.html#a459626637b5697c339db9e2b31f3ded6">xsize</a>)||(stpi&lt;0)||(stpj&gt;=dimension.<a class="code" href="structdrzstamp__dim.html#a8e268f2124d4cc8783fe4f37708bbe8f">ysize</a>)||(stpj&lt;0) )
<a name="l00601"></a>00601                 <span class="keywordflow">continue</span>;
<a name="l00602"></a>00602 
<a name="l00603"></a>00603               <span class="comment">// get the area which falls onto the current output pixel</span>
<a name="l00604"></a>00604               arr = <a class="code" href="spc__driz_8c.html#a8aae79a1f68a0ac2de5f34e6e9f9f2df">boxer</a>(stpi,stpj,quad.<a class="code" href="structquadrangle.html#a2838cc41fa0d8d867757b05ed1cfdbc2">x</a>,quad.<a class="code" href="structquadrangle.html#a7a086b8fde718d39d81a1d0a5855beff">y</a>);
<a name="l00605"></a>00605 
<a name="l00606"></a>00606               <span class="comment">// compute the pixel weight from</span>
<a name="l00607"></a>00607               <span class="comment">// the various inputs</span>
<a name="l00608"></a>00608               totweight =  arr*frac*jacob*<a class="code" href="aXe__grism_8h.html#acf709ee71c580f1cd65d726ed03200ea">gsl_matrix_get</a>(weights, stpi, stpj);
<a name="l00609"></a>00609               <span class="comment">//totweight =  arr*frac*jacob;//*gsl_matrix_get(weights, stpi, stpj);</span>
<a name="l00610"></a>00610 
<a name="l00611"></a>00611               <span class="comment">//gsl_matrix_set(coverage, stpi, stpj, gsl_matrix_get(coverage, stpi, stpj) + arr*frac*jacob);</span>
<a name="l00612"></a>00612 
<a name="l00613"></a>00613               <span class="comment">// add the pixel to the spectrum</span>
<a name="l00614"></a>00614               <span class="keywordflow">if</span> (totweight &gt; 0.0)
<a name="l00615"></a>00615                 <a class="code" href="spce__binning_8c.html#a7518304380f3c574b4fd1564de70ef1a">add_to_spec_table</a> (spec, stpi, cur_p, quant_cont,totweight);
<a name="l00616"></a>00616               <span class="comment">//              gsl_matrix_set(coverage, stpi, stpj, sqrt (SQR (gsl_matrix_get(coverage, stpi, stpj)) + SQR (fabs(cur_p-&gt;error) * totweight)));</span>
<a name="l00617"></a>00617             }
<a name="l00618"></a>00618         }
<a name="l00619"></a>00619     }
<a name="l00620"></a>00620 
<a name="l00621"></a>00621 
<a name="l00622"></a>00622 
<a name="l00623"></a>00623   <span class="comment">/* Trimming the INDEF beginning and ending values in spectrum */</span>
<a name="l00624"></a>00624   tspec = <a class="code" href="spc__spc_8c.html#a3b09e9e958c00c75f26933bac7d0ffe8">trim_spectrum</a> (spec);
<a name="l00625"></a>00625   <a class="code" href="spc__spc_8c.html#a7e957a43837d35fe0e2195ddcdcda221">free_spectrum</a> (spec);
<a name="l00626"></a>00626   spec = NULL;
<a name="l00627"></a>00627 
<a name="l00628"></a>00628   free(tmp_p);
<a name="l00629"></a>00629 
<a name="l00630"></a>00630   <span class="comment">// return the spectrum</span>
<a name="l00631"></a>00631   <span class="keywordflow">return</span> tspec;
<a name="l00632"></a>00632 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a49f87c0ee85edafe3f007ded3eb2bef9"></a><!-- doxytag: member="spce_binning.h::bin_weighted" ref="a49f87c0ee85edafe3f007ded3eb2bef9" args="(const ap_pixel *const ap_p, const double ob_orient, const trace_func *const trace, const int n_sub, const int flags)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structspectrum.html">spectrum</a>* bin_weighted </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="structap__pixel.html">ap_pixel</a> *const &nbsp;</td>
          <td class="paramname"> <em>ap_p</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const double&nbsp;</td>
          <td class="paramname"> <em>ob_orient</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structtrace__func.html">trace_func</a> *const &nbsp;</td>
          <td class="paramname"> <em>trace</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const int&nbsp;</td>
          <td class="paramname"> <em>n_sub</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const int&nbsp;</td>
          <td class="paramname"> <em>flags</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>does a straight forward summation/binning of an aperture pixel table with appropriate weights (cf. Hornes 1986)</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>ap_p</em>&nbsp;</td><td>the table of aperture pixels </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>ob_orient</em>&nbsp;</td><td>the orientation of the <a class="el" href="structobject.html">object</a> that has generated the <a class="el" href="structspectrum.html">spectrum</a> </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>flags</em>&nbsp;</td><td>problems that were accumulated in generating ap_p; possible flags are defined for the warning member of the <a class="el" href="structspectrum.html">spectrum</a> struct </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>n_sub</em>&nbsp;</td><td>subsampling factor </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>an allocated <a class="el" href="structspectrum.html">spectrum</a> </dd></dl>
<dl class="see"><dt><b>See also:</b></dt><dd><a class="el" href="structspectrum.html">spectrum</a> </dd></dl>

<p><div class="fragment"><pre class="fragment"><a name="l00654"></a>00654 {
<a name="l00655"></a>00655      gsl_vector *binned_table;
<a name="l00656"></a>00656      gsl_vector *wei_table;
<a name="l00657"></a>00657      gsl_vector *wei2_table;
<a name="l00658"></a>00658 
<a name="l00659"></a>00659      <span class="keywordtype">double</span> xi, d, w, wei, wei2;
<a name="l00660"></a>00660      <span class="keywordtype">int</span> xii, num_bin, bin;
<a name="l00661"></a>00661      <span class="keyword">const</span> <a class="code" href="structap__pixel.html">ap_pixel</a> *cur_p = ap_p;
<a name="l00662"></a>00662      <span class="keywordtype">double</span> upper = cur_p-&gt;<a class="code" href="structap__pixel.html#aeae2e14e0f53bd1090acb2a8758104a5">xi</a>, lower = cur_p-&gt;<a class="code" href="structap__pixel.html#aeae2e14e0f53bd1090acb2a8758104a5">xi</a>;
<a name="l00663"></a>00663      <a class="code" href="structspectrum.html">spectrum</a> *spec;
<a name="l00664"></a>00664 
<a name="l00665"></a>00665      <span class="keywordflow">while</span> (cur_p-&gt;<a class="code" href="structap__pixel.html#abca28f0936fbd5a569ad548fb25e5a38">p_x</a> != -1)
<a name="l00666"></a>00666        {
<a name="l00667"></a>00667             upper = <a class="code" href="aper__conf_8c.html#aacc3ee1a7f283f8ef65cea31f4436a95">MAX</a> (cur_p-&gt;<a class="code" href="structap__pixel.html#aeae2e14e0f53bd1090acb2a8758104a5">xi</a>, upper);
<a name="l00668"></a>00668             lower = <a class="code" href="aXe__utils_8c.html#a74e75242132eaabbc1c512488a135926">MIN</a> (cur_p-&gt;<a class="code" href="structap__pixel.html#aeae2e14e0f53bd1090acb2a8758104a5">xi</a>, lower);
<a name="l00669"></a>00669             cur_p++;
<a name="l00670"></a>00670        }
<a name="l00671"></a>00671 
<a name="l00672"></a>00672      lower -= 10;
<a name="l00673"></a>00673      upper += 10;
<a name="l00674"></a>00674 
<a name="l00675"></a>00675      lower = floor (lower);
<a name="l00676"></a>00676      upper = floor (upper + 1);
<a name="l00677"></a>00677 
<a name="l00678"></a>00678      num_bin = floor ((upper - lower) / n_sub);
<a name="l00679"></a>00679      spec = <a class="code" href="spc__spc_8c.html#a2b7693a22a9e1b6d287465b8bff189de">allocate_spectrum</a> (num_bin);
<a name="l00680"></a>00680 
<a name="l00681"></a>00681      binned_table = gsl_vector_alloc (num_bin);
<a name="l00682"></a>00682      wei_table = gsl_vector_alloc (num_bin);
<a name="l00683"></a>00683      wei2_table = gsl_vector_alloc (num_bin);
<a name="l00684"></a>00684 
<a name="l00685"></a>00685      gsl_vector_set_all (binned_table, 0);
<a name="l00686"></a>00686      gsl_vector_set_all (wei_table, 0);
<a name="l00687"></a>00687      gsl_vector_set_all (wei2_table, 0);
<a name="l00688"></a>00688 
<a name="l00689"></a>00689      cur_p = ap_p;
<a name="l00690"></a>00690      <span class="keywordflow">while</span> (cur_p-&gt;<a class="code" href="structap__pixel.html#abca28f0936fbd5a569ad548fb25e5a38">p_x</a> != -1)
<a name="l00691"></a>00691        {
<a name="l00692"></a>00692             xi = (cur_p-&gt;<a class="code" href="structap__pixel.html#aeae2e14e0f53bd1090acb2a8758104a5">xi</a> - lower) / n_sub;
<a name="l00693"></a>00693             xii = floor (xi);
<a name="l00694"></a>00694 
<a name="l00695"></a>00695             d = fabs(cur_p-&gt;<a class="code" href="structap__pixel.html#abd0f197da151fac01c9e4cbd4146f212">dist</a>);
<a name="l00696"></a>00696             w = exp (-d * d / (2 * 6.66));
<a name="l00697"></a>00697             w = 1.;
<a name="l00698"></a>00698             <a class="code" href="spce__binning_8c.html#a7518304380f3c574b4fd1564de70ef1a">add_to_spec_table</a> (spec, xii - 1,cur_p, 0, w * (1 - (xi - xii)));
<a name="l00699"></a>00699             <a class="code" href="spce__binning_8c.html#a7518304380f3c574b4fd1564de70ef1a">add_to_spec_table</a> (spec, xii   , cur_p, 0, w * (xi - xii));
<a name="l00700"></a>00700 
<a name="l00701"></a>00701             gsl_vector_set (wei_table, xii - 1,
<a name="l00702"></a>00702                             gsl_vector_get (wei_table, xii - 1) + w);
<a name="l00703"></a>00703             gsl_vector_set (wei_table, xii,
<a name="l00704"></a>00704                             gsl_vector_get (wei_table, xii) + w);
<a name="l00705"></a>00705 
<a name="l00706"></a>00706             gsl_vector_set (wei2_table, xii - 1,
<a name="l00707"></a>00707                             gsl_vector_get (wei2_table, xii - 1) + w * w);
<a name="l00708"></a>00708             gsl_vector_set (wei2_table, xii,
<a name="l00709"></a>00709                             gsl_vector_get (wei2_table, xii) + w * w);
<a name="l00710"></a>00710 
<a name="l00711"></a>00711             <span class="comment">//fprintf(stderr,&quot;%f,%d,%d\n&quot;,xi,xii,xii+1);</span>
<a name="l00712"></a>00712             cur_p++;
<a name="l00713"></a>00713        }
<a name="l00714"></a>00714      cur_p = ap_p;
<a name="l00715"></a>00715      <span class="keywordflow">for</span> (bin = 0; bin &lt; num_bin; bin++)
<a name="l00716"></a>00716        {
<a name="l00717"></a>00717             wei = gsl_vector_get (wei_table, bin);
<a name="l00718"></a>00718             wei2 = gsl_vector_get (wei2_table, bin);
<a name="l00719"></a>00719             <span class="keywordflow">if</span> (wei2 != 0)
<a name="l00720"></a>00720               {
<a name="l00721"></a>00721                    spec-&gt;<a class="code" href="structspectrum.html#a12640df5c0e35a9a377291dd11022bcf">spec</a>[bin].<a class="code" href="structspc__entry.html#a80b739cd679fdd22fc316f86a210614b">count</a> = spec-&gt;<a class="code" href="structspectrum.html#a12640df5c0e35a9a377291dd11022bcf">spec</a>[bin].<a class="code" href="structspc__entry.html#a80b739cd679fdd22fc316f86a210614b">count</a> * wei / wei2;
<a name="l00722"></a>00722               }
<a name="l00723"></a>00723        }
<a name="l00724"></a>00724 
<a name="l00725"></a>00725      spec-&gt;<a class="code" href="structspectrum.html#a9db80753621188168361c845f8c2bd9a">warning</a> = 0;
<a name="l00726"></a>00726      <span class="keywordflow">return</span> spec;
<a name="l00727"></a>00727 }
</pre></div></p>

</div>
</div>
</div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&nbsp;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&nbsp;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr size="1"/><address style="text-align: right;"><small>Generated on 12 Oct 2014 for TIPS by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
